<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Servi√ßos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }

    .card-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .input-field {
      background: #ffffff;
      border: 2px solid #cbd5e1;
      color: #1e293b;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      width: 100%;
      font-weight: 500;
    }

    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .input-field option {
      background: #ffffff;
      color: #1e293b;
      padding: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #ffffff;
      padding: 14px 28px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      font-size: 15px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #ffffff;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #ffffff;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      border: 2px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .tab-button {
      background: rgba(255, 255, 255, 0.05);
      color: #94a3b8;
      padding: 14px 28px;
      border-radius: 10px 10px 0 0;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      font-size: 15px;
    }

    .tab-button:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #ffffff;
      border-bottom-color: #10b981;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 18px 28px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      animation: slideIn 0.4s ease;
      font-size: 15px;
    }

    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .data-table thead th {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      font-weight: 700;
      text-align: left;
      padding: 18px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }

    .data-table tbody tr {
      background: rgba(255, 255, 255, 0.03);
      transition: all 0.3s;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .data-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: scale(1.005);
    }

    .data-table tbody td {
      padding: 16px 18px;
      color: #e2e8f0;
      font-size: 15px;
    }

    .edit-mode-input {
      background: rgba(59, 130, 246, 0.2);
      border: 2px solid #3b82f6;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
    }

    .edit-mode-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .chart-container {
      background: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 32px;
    }

    .seller-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s;
    }

    .metric-card:hover {
      border-color: #3b82f6;
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
    }

    .metric-value {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .period-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .period-btn {
      background: rgba(255, 255, 255, 0.08);
      color: #94a3b8;
      padding: 12px 24px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 14px;
    }

    .period-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: #ffffff;
    }

    .period-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #ffffff;
      border-color: #3b82f6;
    }

    .annual-seller-card {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .annual-seller-header {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      padding: 18px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .annual-month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .annual-month-card {
      background: rgba(59, 130, 246, 0.1);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      padding: 14px;
      transition: all 0.3s;
    }

    .annual-month-card:hover {
      transform: translateY(-4px);
      border-color: #3b82f6;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .annual-month-card.good {
      border-color: rgba(16, 185, 129, 0.5);
      background: rgba(16, 185, 129, 0.1);
    }

    .annual-month-card.warning {
      border-color: rgba(245, 158, 11, 0.5);
      background: rgba(245, 158, 11, 0.1);
    }

    .annual-month-card.critical {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.1);
    }

    .annual-metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .annual-metric-row:last-child {
      border-bottom: none;
    }

    .performance-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .performance-badge.excellent {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .performance-badge.good {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }

    .performance-badge.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .performance-badge.critical {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
  
    
    .floating-menu-btn {
      position: relative;
      z-index: 10;
      background: linear-gradient(135deg, #0f172a 0%, #1f2937 40%, #2563eb 100%);
      color: #e5e7eb;
      border-radius: 999px;
      padding: 8px 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
    }

    .floating-menu-btn span {
      letter-spacing: 0.04em;
    }

    .floating-menu-btn:hover {
      background: linear-gradient(135deg, #1f2937 0%, #0f172a 40%, #3b82f6 100%);
      transform: translateY(-1px);
    }

    .main-top-bar {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 24px 4px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .main-top-title {
      display: flex;
      align-items: center;
      gap: 14px;
      color: #0f172a;
      font-weight: 800;
      font-size: 24px;
      letter-spacing: 0.03em;
      text-shadow: 0 2px 6px rgba(15, 23, 42, 0.45);
    }

    .main-top-title span:last-child {
      background: linear-gradient(120deg, #1e293b, #3b82f6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .main-top-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #60a5fa 45%, #1d4ed8 80%, #020617 100%);
      box-shadow:
        0 10px 25px rgba(15, 23, 42, 0.9),
        inset 0 0 12px rgba(15, 23, 42, 0.8);
      font-size: 22px;
    }

    @media (max-width: 640px) {
      .main-top-bar {
        padding: 14px 16px 4px 16px;
        flex-direction: row;
      }
      .main-top-title {
        font-size: 17px;
      }
      .main-top-badge {
        width: 38px;
        height: 38px;
        border-radius: 16px;
        font-size: 20px;
      }
      .floating-menu-btn {
        padding-inline: 12px;
        font-size: 13px;
      }
    }

.floating-menu-panel {
      position: fixed;
      top: 52px;
      right: 16px;
      z-index: 50;
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 12px;
      width: 260px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
    }

    .floating-menu-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .floating-menu-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .floating-menu-item {
      width: 100%;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      margin-bottom: 6px;
    }

    .floating-menu-item span {
      font-size: 11px;
      color: #9ca3af;
      display: block;
    }

    .floating-menu-item:hover {
      border-color: #3b82f6;
    }

  </style>
  <style>
    .security-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .security-overlay.hidden {
      display: none;
    }
    .security-modal {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(145deg, #020617, #020617, #020617);
      border-radius: 24px;
      padding: 28px 24px 24px;
      box-shadow: 0 24px 80px rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      color: #e5e7eb;
      position: relative;
      overflow: hidden;
    }
    .security-modal::before {
      content: "";
      position: absolute;
      inset: -120px;
      background: radial-gradient(circle at top, rgba(56,189,248,0.22), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .security-modal h2 {
      position: relative;
      margin: 0 0 4px;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .security-modal h2 span.lock-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5), 0 12px 25px rgba(15,23,42,0.9);
      font-size: 18px;
    }
    .security-modal p {
      position: relative;
      margin: 0 0 16px;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    .security-field-label {
      position: relative;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .security-input {
      position: relative;
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      padding: 10px 14px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    .security-input::placeholder {
      color: rgba(148,163,184,0.7);
    }
    .security-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.4);
      background: rgba(15,23,42,1);
    }
    .security-actions {
      position: relative;
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .security-primary-btn {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#3b82f6,#22c55e);
      color: #0b1120;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 0.8rem;
      box-shadow: 0 18px 35px rgba(15,23,42,0.8);
    }
    .security-secondary-btn {
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: transparent;
      color: #9ca3af;
      font-size: 0.78rem;
      padding: 9px 12px;
      cursor: pointer;
    }
    .security-error {
      position: relative;
      margin-top: 8px;
      min-height: 18px;
      font-size: 0.8rem;
      color: #f97373;
    }
    .security-footer {
      position: relative;
      margin-top: 12px;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: center;
    }
  </style>

  <style>@view-transition { navigation: auto; }</style>
 
  <!-- Charts e captura de imagem para o Painel Executivo -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
 <body class="h-full w-full">
<div id="security-overlay" class="security-overlay">
  <div class="security-modal">
    <h2><span class="lock-badge">üîí</span>Acesso Restrito</h2>
    <p>Informe seu <strong>nome de usu√°rio</strong> e <strong>senha pessoal</strong> para utilizar o painel.</p>
    <div class="security-field-block">
      <div class="security-field-label">Usu√°rio autorizado</div>
      <input id="sec_username" class="security-input" type="text" autocomplete="off" placeholder="Seu nome de usu√°rio" />
    </div>
    <div class="security-field-block" style="margin-top:12px;">
      <div class="security-field-label">Senha</div>
      <input id="sec_password" class="security-input" type="password" autocomplete="off" placeholder="Sua senha secreta" />
    </div>
    <div class="security-actions">
      <button id="sec_login_btn" class="security-primary-btn">Entrar no painel</button>
      <button id="sec_request_btn" class="security-secondary-btn">N√£o tenho acesso ‚Ä¢ Solicitar ao gerente</button>
    </div>
    <div id="sec_error_msg" class="security-error"></div>
    <div class="security-footer">Somente usu√°rios cadastrados pelo gerente podem utilizar este painel.</div>
  </div>
</div>


<!-- Top Header: T√≠tulo + Menu + Legenda -->
<div class="main-top-bar">
  <div class="main-top-title">
    <span class="main-top-badge">üìä</span>
    <span>Sistema de Gest√£o de Servi√ßos</span>
  </div>
  <button id="fs_menu_btn" class="floating-menu-btn">
    <span>‚ò∞</span>
  </button>
</div>

</div>

<div id="fs_menu_panel" class="floating-menu-panel hidden">
  <div class="floating-menu-title">Central de Dados</div>
  <div class="floating-menu-desc">Fa√ßa backup geral e restaure todos os registros.</div>

  <button id="fs_menu_download" class="floating-menu-item">
    <div>‚¨áÔ∏è Backup completo<br><span>Baixar todos os registros em JSON.</span></div>
  </button>

  <button id="fs_menu_upload" class="floating-menu-item">
    <div>‚¨ÜÔ∏è Restaurar backup<br><span>Importar arquivo JSON salvo anteriormente.</span></div>
  </button>

  
  <button id="fs_menu_users" class="floating-menu-item">
    <div>üë• Usu√°rios<br><span>Incluir ou remover nomes autorizados.</span></div>
  </button>

<p class="floating-menu-desc mt-1">Dica: use ap√≥s atualizar a vers√£o do painel.</p>
</div>

<input type="file" id="fs_menu_file" accept="application/json" style="display:none" />

</div>

  <div class="w-full h-full bg-slate-900 overflow-auto">
   <div class="w-full max-w-[1400px] mx-auto px-6 py-8"><!-- Header removido: t√≠tulo agora no topo -->
    
    <section class="mb-8">
     <div class="flex gap-3 border-b-2 border-slate-700 flex-wrap"><button class="tab-button active" data-tab="vendedores" type="button"> <span id="tab0_label">üë• Gerenciar Vendedores</span> </button> <button class="tab-button" data-tab="inserir" type="button"> <span id="tab1_label">1. Inserir Dados</span> </button> <button class="tab-button" data-tab="comparativos" type="button"> <span id="tab2_label">2. Comparativos e Crescimento</span> </button> <button class="tab-button" data-tab="anual" type="button"> <span id="tab3_label">3. Comparativo Ano a Ano</span> </button> <button class="tab-button" data-tab="loja" type="button"> <span id="tab4_label">üè™ An√°lise da Loja</span> </button> <button class="tab-button" data-tab="compilado" type="button"> <span id="tab5_label">üìä Compilado Geral</span> </button>
     </div>
    </section><!-- Tab Content --> <!-- Gerenciar Vendedores Tab -->
    <div id="tab_vendedores" class="tab-content"><!-- Sellers List -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow">
      <h2 class="text-2xl font-bold text-white mb-6">üìã Lista de Vendedores</h2>
      <p class="text-slate-300 mb-6">Os vendedores s√£o criados automaticamente quando voc√™ adiciona registros na aba "Inserir Dados". Aqui voc√™ pode editar os nomes dos vendedores existentes.</p>
      <div class="overflow-x-auto">
       <table class="data-table">
        <thead>
         <tr>
          <th>Nome do Vendedor</th>
          <th>Registros Associados</th>
          <th>A√ß√µes</th>
         </tr>
        </thead>
        <tbody id="sellers_table_body">
         <tr>
          <td colspan="3" class="text-center text-slate-400 py-10">Carregando vendedores...</td>
         </tr>
        </tbody>
       </table>
      </div>
     </section>
    </div>
    <div id="tab_inserir" class="tab-content hidden"><!-- Insert Form -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow mb-8">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-white">Adicionar Novo Registro</h2><button type="button" id="toggle_form_btn" class="btn-secondary"> <span id="toggle_icon">‚ñº</span> <span id="toggle_text">Recolher Formul√°rio</span> </button>
      </div>
      <form id="insert_form" class="form-container">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div><label for="seller_select" class="text-sm text-slate-300 block mb-2 font-semibold">Vendedor</label> <input type="text" id="seller_select" list="seller_list" class="input-field" placeholder="Digite ou selecione um vendedor" required autocomplete="off"> <datalist id="seller_list"> </datalist>
        </div>
        <div><label for="month_select" class="text-sm text-slate-300 block mb-2 font-semibold">M√™s</label> <select id="month_select" class="input-field" required> <option value="">Selecione...</option> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro">Dezembro</option> </select>
        </div>
        <div><label for="year_select" class="text-sm text-slate-300 block mb-2 font-semibold">Ano</label> <select id="year_select" class="input-field" required> <option value="">Selecione...</option> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div><label for="taxa_conversao" class="text-sm text-slate-300 block mb-2 font-semibold">Taxa de Convers√£o (%)</label> <input type="number" id="taxa_conversao" class="input-field" placeholder="Ex: 85.5" step="0.01" min="0" max="100" required>
        </div>
        <div><label for="eficiencia" class="text-sm text-slate-300 block mb-2 font-semibold">Efici√™ncia (%)</label> <input type="number" id="eficiencia" class="input-field" placeholder="Ex: 92.3" step="0.01" min="0" max="100" required>
        </div>
       </div><button type="submit" class="btn-primary" id="submit_btn"> <span id="submit_text">Salvar Registro</span>
        <div id="submit_spinner" class="loading-spinner hidden inline-block ml-2"></div></button>
      </form>
     </section><!-- Data Table -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-white">Registros Salvos (Atualiza√ß√£o em Tempo Real)</h2>
       <div style="min-width: 280px;"><label for="filter_seller_table" class="text-sm text-slate-300 block mb-2 font-semibold">Filtrar por Vendedor</label> <select id="filter_seller_table" class="input-field"> <option value="">Todos os Vendedores</option> </select>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="data-table">
        <thead>
         <tr>
          <th>Vendedor</th>
          <th>Per√≠odo</th>
          <th>Taxa Convers√£o (%)</th>
          <th>Efici√™ncia (%)</th>
          <th>A√ß√µes</th>
         </tr>
        </thead>
        <tbody id="data_table_body">
         <tr>
          <td colspan="6" class="text-center text-slate-400 py-10">Nenhum registro encontrado. Adicione dados acima.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </section>
    </div><!-- Comparativos Tab -->
    <div id="tab_comparativos" class="tab-content hidden"><!-- Filters -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow mb-8">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-white">Filtros de Compara√ß√£o</h2><button type="button" id="show_annual_view_btn" class="btn-primary"> Ver An√°lise Anual Completa </button>
       <button type="button" id="open_seller_dashboard_btn" class="btn-secondary ml-3">
        üìä Painel Executivo Individual
       </button>
      </div>
      <div class="mb-8"><label for="filter_seller_comparison" class="text-sm text-slate-300 block mb-3 font-semibold">Filtrar por Vendedor</label> <select id="filter_seller_comparison" class="input-field"> <option value="">Todos os Vendedores</option> </select>
      </div>
      <div class="mb-8"><label class="text-sm text-slate-300 block mb-4 font-semibold">M√©trica a Exibir</label>
       <div class="period-selector"><button class="period-btn active" data-metric="conversao" type="button">Taxa de Convers√£o (%)</button> <button class="period-btn" data-metric="eficiencia" type="button">Efici√™ncia (%)</button>
       </div>
      </div>
      <div class="mb-8"><label class="text-sm text-slate-300 block mb-4 font-semibold">Tipo de Compara√ß√£o</label>
       <div class="period-selector"><button class="period-btn active" data-mode="mensal" type="button">Comparar Mensal</button> <button class="period-btn" data-mode="periodo" type="button">Comparar por Per√≠odo</button>
       </div>
      </div><!-- Mensal Mode -->
      <div id="filter_mensal" class="filter-mode">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="compare_month" class="text-sm text-slate-300 block mb-2 font-semibold">Selecione o M√™s</label> <select id="compare_month" class="input-field"> <option value="">Todos os meses</option> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro">Dezembro</option> </select>
        </div>
        <div><label for="compare_year" class="text-sm text-slate-300 block mb-2 font-semibold">Selecione o Ano</label> <select id="compare_year" class="input-field"> <option value="">Todos os anos</option> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
        </div>
       </div>
      </div><!-- Periodo Mode -->
      <div id="filter_periodo" class="filter-mode hidden">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div><label for="period_start" class="text-sm text-slate-300 block mb-2 font-semibold">M√™s Inicial</label> <select id="period_start" class="input-field"> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro">Dezembro</option> </select>
        </div>
        <div><label for="period_end" class="text-sm text-slate-300 block mb-2 font-semibold">M√™s Final</label> <select id="period_end" class="input-field"> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro" selected>Dezembro</option> </select>
        </div>
        <div><label for="period_year" class="text-sm text-slate-300 block mb-2 font-semibold">Ano</label> <select id="period_year" class="input-field"> <option value="2024">2024</option> <option value="2025" selected>2025</option> <option value="2026">2026</option> </select>
        </div>
       </div>
      </div>
     </section><!-- Charts -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow mb-8" id="comparison_chart_section">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-white" id="chart_title">Gr√°fico Comparativo de Vendedores</h2>
       <div class="flex gap-3"><button type="button" id="download_chart_btn" class="btn-success"> üì• Baixar Imagem </button> <button type="button" id="view_chart_fullscreen_btn" class="btn-success"> üîç Visualizar em Tela Cheia </button>
       </div>
      </div>
      <div class="chart-container">
       <div style="height: 550px;">
        <svg id="comparison_chart" class="w-full h-full"></svg>
       </div>
      </div>
      <div id="chart_legend" class="mt-8 flex flex-wrap gap-6 justify-center"><!-- Legend will be populated dynamically -->
      </div>
     </section><!-- Metrics Cards -->
     <section>
      <h2 class="text-2xl font-bold text-white mb-6">M√©tricas Gerais</h2>
      <div id="metrics_container" class="grid grid-cols-1 md:grid-cols-3 gap-6"><!-- Dynamic metrics -->
      </div>
     </section>
    </div><!-- An√°lise da Loja Tab -->
    <div id="tab_loja" class="tab-content hidden"><!-- Filters -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow mb-8">
      <div class="flex items-center justify-between mb-6">
       <div>
        <h2 class="text-2xl font-bold text-white mb-2">üè™ An√°lise Exclusiva da Loja</h2>
        <p class="text-slate-300">Esta aba mostra apenas os dados registrados com o nome "Loja", separados dos vendedores individuais.</p>
       </div><button type="button" id="show_loja_annual_view_btn" class="btn-primary"> Ver An√°lise Anual da Loja </button>
      </div>
      <div class="mb-8"><label class="text-sm text-slate-300 block mb-4 font-semibold">M√©trica a Exibir</label>
       <div class="period-selector"><button class="period-btn active" data-loja-metric="conversao" type="button">Taxa de Convers√£o (%)</button> <button class="period-btn" data-loja-metric="eficiencia" type="button">Efici√™ncia (%)</button>
       </div>
      </div>
      <div class="mb-8"><label class="text-sm text-slate-300 block mb-4 font-semibold">Tipo de Compara√ß√£o</label>
       <div class="period-selector"><button class="period-btn active" data-loja-mode="mensal" type="button">Comparar Mensal</button> <button class="period-btn" data-loja-mode="periodo" type="button">Comparar por Per√≠odo</button>
       </div>
      </div><!-- Mensal Mode -->
      <div id="filter_loja_mensal" class="filter-mode">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="loja_compare_month" class="text-sm text-slate-300 block mb-2 font-semibold">Selecione o M√™s</label> <select id="loja_compare_month" class="input-field"> <option value="">Todos os meses</option> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro">Dezembro</option> </select>
        </div>
        <div><label for="loja_compare_year" class="text-sm text-slate-300 block mb-2 font-semibold">Selecione o Ano</label> <select id="loja_compare_year" class="input-field"> <option value="">Todos os anos</option> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
        </div>
       </div>
      </div><!-- Periodo Mode -->
      <div id="filter_loja_periodo" class="filter-mode hidden">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div><label for="loja_period_start" class="text-sm text-slate-300 block mb-2 font-semibold">M√™s Inicial</label> <select id="loja_period_start" class="input-field"> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro">Dezembro</option> </select>
        </div>
        <div><label for="loja_period_end" class="text-sm text-slate-300 block mb-2 font-semibold">M√™s Final</label> <select id="loja_period_end" class="input-field"> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro" selected>Dezembro</option> </select>
        </div>
        <div><label for="loja_period_year" class="text-sm text-slate-300 block mb-2 font-semibold">Ano</label> <select id="loja_period_year" class="input-field"> <option value="2024">2024</option> <option value="2025" selected>2025</option> <option value="2026">2026</option> </select>
        </div>
       </div>
      </div>
     </section><!-- Charts -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow mb-8" id="loja_chart_section">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-white" id="loja_chart_title">Gr√°fico de Performance da Loja</h2><button type="button" id="view_loja_chart_fullscreen_btn" class="btn-success"> üîç Visualizar em Tela Cheia </button>
      </div>
      <div class="chart-container">
       <div style="height: 550px;">
        <svg id="loja_chart" class="w-full h-full"></svg>
       </div>
      </div>
      <div id="loja_chart_legend" class="mt-6 flex flex-wrap gap-6 justify-center"><!-- Legend will be populated dynamically -->
      </div>
     </section><!-- Metrics Cards -->
     <section>
      <h2 class="text-2xl font-bold text-white mb-6">M√©tricas da Loja</h2>
      <div id="loja_metrics_container" class="grid grid-cols-1 md:grid-cols-3 gap-6"><!-- Dynamic metrics -->
      </div>
     </section><!-- Comparativo Ano a Ano da Loja -->
     <section class="gradient-bg rounded-2xl p-8 card-shadow mt-8">
      <h2 class="text-2xl font-bold text-white mb-6">Comparativo Ano a Ano - Loja</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
       <div><label for="loja_year_compare_1" class="text-sm text-slate-300 block mb-2 font-semibold">Ano Base (Anterior)</label> <select id="loja_year_compare_1" class="input-field"> <option value="">Selecione...</option> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
       </div>
       <div><label for="loja_year_compare_2" class="text-sm text-slate-300 block mb-2 font-semibold">Ano Atual (Compara√ß√£o)</label> <select id="loja_year_compare_2" class="input-field"> <option value="">Selecione...</option> <option value="2024">2024</option> <option value="2025" selected>2025</option> <option value="2026">2026</option> </select>
       </div>
      </div>
      <div id="loja_year_comparison_results"><!-- Content will be populated dynamically -->
      </div>
     </section>
    </div>
    <div id="tab_compilado" class="tab-content hidden">
      <section class="gradient-bg rounded-2xl p-8 card-shadow mb-8">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-white mb-2">üìä Compilado Geral por Vendedor</h2>
            <p class="text-slate-300 text-sm">
              Selecione um vendedor para visualizar, em uma √∫nica tela, todas as m√©tricas consolidadas em 6 blocos (3 em cima e 3 embaixo).
            </p>
          </div>
        </div>
        <div id="compilado_sellers_grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Cards de vendedores gerados em tempo real -->
        </div>
      </section>

      <section id="compilado_dashboard_section" class="gradient-bg rounded-2xl p-8 card-shadow mt-6 hidden">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 id="compilado_dashboard_title" class="text-2xl font-bold text-white mb-1">Dashboard do Vendedor</h2>
            <p class="text-slate-300 text-sm">Painel consolidado com convers√£o, efici√™ncia e comparativo ano a ano.</p>
          </div>
          <button type="button" id="compilado_back_btn" class="btn-secondary text-sm">
            ‚Üê Voltar para lista
          </button>
        </div>

        
        <!-- Linha 1: 2 gr√°ficos de barras + card de meses -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- Barras Convers√£o -->
          <div class="bg-white rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-slate-900">Taxa de Convers√£o (barras)</h3>
              <span class="text-[11px] text-slate-500">Por m√™s</span>
            </div>
            <canvas id="comp_chart_bar_conversao" height="170"></canvas>
          </div>

          <!-- Barras Efici√™ncia -->
          <div class="bg-white rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-slate-900">Efici√™ncia (barras)</h3>
              <span class="text-[11px] text-slate-500">Por m√™s</span>
            </div>
            <canvas id="comp_chart_bar_eficiencia" height="170"></canvas>
          </div>

          <!-- Meses com Meta Batida -->
          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs text-slate-300 uppercase tracking-wide">Meses com Meta Batida</span>
              <span class="text-xs text-slate-400">Conv. ‚â• 30% e Efic. ‚â• 7%</span>
            </div>
            <div class="flex items-end gap-2">
              <span id="comp_kpi_meses_ok" class="text-3xl font-bold text-white">0</span>
              <span id="comp_kpi_meses_total" class="text-sm font-semibold text-slate-300"></span>
            </div>
            <!-- Lista compacta de meses com status de meta, estilo similar aos cards mensais -->
            <div id="comp_meses_meta_list" class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2"></div>
          </div>
        </div>

        <!-- Linha 2: 2 gr√°ficos de linha + resumo ano a ano -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Convers√£o: linha + m√©dia -->
          <div class="bg-slate-800 rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-white">% Convers√£o por m√™s</h3>
              <span class="text-[11px] text-slate-400">Linha hist√≥rica com meta 30%</span>
            </div>
            <canvas id="comp_chart_conversao" height="170"></canvas>
            <div class="mt-4 border-t border-slate-700 pt-3">
              <div class="text-xs text-slate-300 uppercase tracking-wide mb-1">M√©dia Convers√£o</div>
              <div class="flex items-end gap-2">
                <span id="comp_kpi_conversao_media" class="text-3xl font-bold text-white">--%</span>
                <span id="comp_kpi_conversao_status" class="text-xs font-semibold text-slate-300"></span>
              </div>
            </div>
          </div>

          <!-- Efici√™ncia: linha + m√©dia -->
          <div class="bg-slate-800 rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-white">% Efici√™ncia por m√™s</h3>
              <span class="text-[11px] text-slate-400">Linha hist√≥rica com meta 7%</span>
            </div>
            <canvas id="comp_chart_eficiencia" height="170"></canvas>
            <div class="mt-4 border-t border-slate-700 pt-3">
              <div class="text-xs text-slate-300 uppercase tracking-wide mb-1">M√©dia Efici√™ncia</div>
              <div class="flex items-end gap-2">
                <span id="comp_kpi_eficiencia_media" class="text-3xl font-bold text-white">--%</span>
                <span id="comp_kpi_eficiencia_status" class="text-xs font-semibold text-slate-300"></span>
              </div>
            </div>
          </div>

          <!-- Resumo Ano a Ano (mantido) -->

          <!-- Resumo Ano a Ano -->
          <div class="bg-slate-800 rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-white">Resumo Ano a Ano</h3>
              <span id="comp_year_range" class="text-[11px] text-slate-400"></span>
            </div>
            <div class="space-y-3 text-sm text-slate-200">
              <div>
                <span class="text-xs uppercase tracking-wide text-slate-400">Crescimento em Convers√£o</span>
                <div class="text-xl font-bold" id="comp_conv_growth">--</div>
                <div class="text-xs text-slate-400" id="comp_conv_detail"></div>
              </div>
              <div>
                <span class="text-xs uppercase tracking-wide text-slate-400">Crescimento em Efici√™ncia</span>
                <div class="text-xl font-bold" id="comp_efic_growth">--</div>
                <div class="text-xs text-slate-400" id="comp_efic_detail"></div>
              </div>
            </div>

            <div class="mt-4 border-t border-slate-700 pt-3">
              <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Detalhamento por m√™s</div>
              <div class="overflow-x-auto">
                <table id="comp_year_table" class="min-w-full text-xs text-slate-200">
                  <thead class="text-slate-400">
                    <tr>
                      <th class="py-1 pr-2 text-left">M√™s</th>
                      <th class="py-1 px-2 text-right year1_conv">Ano A - Conv.</th>
                      <th class="py-1 px-2 text-right year2_conv">Ano B - Conv.</th>
                      <th class="py-1 px-2 text-right">Cresc. Conv.</th>
                      <th class="py-1 px-2 text-right year1_efic">Ano A - Efic.</th>
                      <th class="py-1 px-2 text-right year2_efic">Ano B - Efic.</th>
                      <th class="py-1 pl-2 text-right">Cresc. Efic.</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Linhas preenchidas dinamicamente -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
</section>
    </div>
<!-- Comparativo Ano a Ano Tab -->
    <div id="tab_anual" class="tab-content hidden"><!-- Year Selector -->
     <section class="gradient-bg rounded-2xl p-10 card-shadow mb-10">
      <h2 class="text-3xl font-bold text-white mb-8">Selecione os Anos para Comparar</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
       <div><label for="year_compare_1" class="text-sm text-slate-300 block mb-2 font-semibold">Ano Base (Anterior)</label> <select id="year_compare_1" class="input-field"> <option value="">Selecione...</option> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
       </div>
       <div><label for="year_compare_2" class="text-sm text-slate-300 block mb-2 font-semibold">Ano Atual (Compara√ß√£o)</label> <select id="year_compare_2" class="input-field"> <option value="">Selecione...</option> <option value="2024">2024</option> <option value="2025" selected>2025</option> <option value="2026">2026</option> </select>
       </div>
       <div><label for="seller_compare_filter" class="text-sm text-slate-300 block mb-2 font-semibold">Filtrar Vendedor (Opcional)</label> <select id="seller_compare_filter" class="input-field"> <option value="">Todos os Vendedores</option> </select>
       </div>
      </div>
      <div class="mb-8"><label class="text-sm text-slate-300 block mb-4 font-semibold">M√©trica para Compara√ß√£o</label>
       <div class="period-selector"><button class="period-btn active" data-year-metric="conversao" type="button">Taxa de Convers√£o (%)</button> <button class="period-btn" data-year-metric="eficiencia" type="button">Efici√™ncia (%)</button>
       </div>
      </div>
     </section><!-- Year Comparison Results -->
     <div id="year_comparison_results_wrapper">
      <div class="flex items-center justify-end mb-6"><button type="button" id="view_year_comparison_fullscreen_btn" class="btn-success hidden"> üîç Visualizar em Tela Cheia </button>
      </div>
      <div id="year_comparison_results"><!-- Content will be populated dynamically -->
      </div>
     </div>
    </div>
   </div>
  </div><!-- Annual View Modal -->
  <div id="annual_view_modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center" style="z-index: 9999; padding: 20px;">
   <div class="bg-slate-900 rounded-2xl w-full h-full overflow-auto" style="max-width: 95%; max-height: 95%;">
    <div class="sticky top-0 bg-slate-900 border-b-2 border-slate-700 p-8 flex items-center justify-between z-10">
     <h2 class="text-4xl font-bold text-white">üë• An√°lise Anuall Completa - Vendedores</h2><button type="button" id="close_annual_view_btn" class="btn-danger"> Fechar </button>
    </div>
    <div class="p-10">
     <div id="annual_view_content"><!-- Content will be populated dynamically -->
     </div>
    </div>
   </div>
  </div><!-- Loja Annual View Modal -->
  <div id="loja_annual_view_modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center" style="z-index: 9999; padding: 20px;">
   <div class="bg-slate-900 rounded-2xl w-full h-full overflow-auto" style="max-width: 95%; max-height: 95%;">
    <div class="sticky top-0 bg-slate-900 border-b-2 border-slate-700 p-8 flex items-center justify-between z-10">
     <h2 class="text-4xl font-bold text-white">üè™ An√°lise Anual Completa da Loja</h2><button type="button" id="close_loja_annual_view_btn" class="btn-danger"> Fechar </button>
    </div>
    <div class="p-10">
     <div id="loja_annual_view_content"><!-- Content will be populated dynamically -->
     </div>
    </div>
   </div>
  </div><!-- Chart Fullscreen Modal -->
  <div id="chart_fullscreen_modal" class="fixed inset-0 bg-black bg-opacity-95 hidden items-center justify-center" style="z-index: 9999; padding: 0;">
   <div class="bg-white rounded-none w-full h-full overflow-auto" style="max-width: 100%; max-height: 100%;">
    <div class="sticky top-0 bg-slate-900 border-b-2 border-slate-700 p-8 flex items-center justify-between z-10">
     <h2 class="text-4xl font-bold text-white" id="chart_fullscreen_title">Gr√°fico Comparativo</h2><button type="button" id="close_chart_fullscreen_btn" class="btn-danger"> Fechar </button>
    </div>
    <div class="p-10">
     <div id="chart_fullscreen_content" class="chart-container">
      <div style="height: 800px;">
       <svg id="comparison_chart_fullscreen" class="w-full h-full"></svg>
      </div>
     </div>
     <div id="chart_legend_fullscreen" class="mt-8 flex flex-wrap gap-6 justify-center"><!-- Legend will be populated dynamically -->
     </div>
    </div>
   </div>
  </div><!-- Year Comparison Fullscreen Modal -->
  <div id="year_comparison_fullscreen_modal" class="fixed inset-0 bg-black bg-opacity-95 hidden items-center justify-center" style="z-index: 9999; padding: 20px;">
   <div class="bg-slate-900 rounded-2xl w-full h-full overflow-auto" style="max-width: 98%; max-height: 98%;">
    <div class="sticky top-0 bg-slate-900 border-b-2 border-slate-700 p-8 flex items-center justify-between z-10">
     <h2 class="text-4xl font-bold text-white">Comparativo Ano a Ano - Visualiza√ß√£o Completa</h2><button type="button" id="close_year_comparison_fullscreen_btn" class="btn-danger"> Fechar </button>
    </div>
    <div class="p-10">
     <div id="year_comparison_fullscreen_content"><!-- Content will be populated dynamically -->
     </div>
    </div>
   </div>
  </div>
  <script>
    /********************************************************************
     * CONFIGURA√á√ÉO EDIT√ÅVEL (Element SDK)
     ********************************************************************/
    const defaultConfig = {
      panel_title: "Sistema de Gest√£o de Servi√ßos",
      tab1_label: "1. Inserir Dados",
      tab2_label: "2. Comparativos e Crescimento",
      tab3_label: "3. Comparativo Ano a Ano",
      background_color: "#0f172a",
      surface_color: "#1e293b",
      text_color: "#ffffff",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#10b981",
      font_family: "system-ui",
      font_size: 14
    };

    let allRecords = [];
    let allSellers = [];
    let currentTab = "vendedores";
    let editingRecordId = null;
    let editingSellerId = null;
    let comparisonMode = "mensal";
    let currentMetric = "conversao";
    let selectedSellerFilter = "";
    let selectedSellerComparison = "";
    let yearMetric = "conversao";
    let lojaComparisonMode = "mensal";
    let lojaCurrentMetric = "conversao";
    // Gr√°ficos do painel compilado
    let compConvChart = null;
    let compEficChart = null;
    let compBarConvChart = null;
    let compBarEficChart = null;
    // Vendedor atualmente aberto no dashboard compilado
    let currentCompiladoSeller = "";

    // Ordem fixa dos meses para o compilado
    const MONTHS_ORDER = [
      "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];



    // Element SDK initialization
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const merged = { ...defaultConfig, ...config };
          applyConfigToUI(merged);
        },
        mapToCapabilities: (config) => {
          const merged = { ...defaultConfig, ...config };
          return {
            recolorables: [
              {
                get: () => merged.background_color,
                set: (value) => window.elementSdk.setConfig({ background_color: value })
              },
              {
                get: () => merged.surface_color,
                set: (value) => window.elementSdk.setConfig({ surface_color: value })
              },
              {
                get: () => merged.text_color,
                set: (value) => window.elementSdk.setConfig({ text_color: value })
              },
              {
                get: () => merged.primary_action_color,
                set: (value) => window.elementSdk.setConfig({ primary_action_color: value })
              },
              {
                get: () => merged.secondary_action_color,
                set: (value) => window.elementSdk.setConfig({ secondary_action_color: value })
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => merged.font_family,
              set: (value) => window.elementSdk.setConfig({ font_family: value })
            },
            fontSizeable: {
              get: () => merged.font_size,
              set: (value) => window.elementSdk.setConfig({ font_size: value })
            }
          };
        },
        mapToEditPanelValues: (config) => {
          const merged = { ...defaultConfig, ...config };
          return new Map([
            ["panel_title", merged.panel_title],
            ["tab1_label", merged.tab1_label],
            ["tab2_label", merged.tab2_label],
            ["tab3_label", merged.tab3_label]
          ]);
        }
      });
    }

    function applyConfigToUI(config) {
      const panelTitle = document.getElementById("panel_title");
      const tab1Label = document.getElementById("tab1_label");
      const tab2Label = document.getElementById("tab2_label");
      const tab3Label = document.getElementById("tab3_label");

      if (panelTitle) panelTitle.textContent = config.panel_title;
      if (tab1Label) tab1Label.textContent = config.tab1_label;
      if (tab2Label) tab2Label.textContent = config.tab2_label;
      if (tab3Label) tab3Label.textContent = config.tab3_label;

      document.body.style.fontFamily = config.font_family + ", system-ui, sans-serif";
      document.body.style.fontSize = config.font_size + "px";
    }

    /********************************************************************
     * DATA SDK
     ********************************************************************/
    const dataHandler = {
      onDataChanged(data) {
        allRecords = data || [];
        extractSellersFromRecords();
        renderSellersTable();
        updateAllSellerDropdowns();
        renderTable();
        if (currentTab === "comparativos") {
          renderComparisons();
        }
        // Atualiza tamb√©m o Compilado Geral por Vendedor
        renderCompiladoSellers();
        // Se o dashboard compilado de um vendedor estiver aberto, atualiza em tempo real
        if (typeof currentCompiladoSeller === "string" && currentCompiladoSeller) {
          const registrosSeller = allRecords.filter(r => r.seller_name === currentCompiladoSeller);
          updateCompiladoFromRecords(registrosSeller);
        }
      }
    };

    
// =================== LOCALSTORAGE FALLBACK ===================
const LOCAL_KEY = "servicos_registros_v1";
let isLocalMode = false;

// Carrega registros do localStorage se dataSdk n√£o estiver dispon√≠vel
function loadLocalFallbackRecords() {
  try {
    const stored = localStorage.getItem(LOCAL_KEY);
    return stored ? JSON.parse(stored) : [];
  } catch {
    return [];
  }
}

// Salva localmente
function saveLocalFallbackRecords(records) {
  localStorage.setItem(LOCAL_KEY, JSON.stringify(records));
}

// Se n√£o existir backend dataSdk (arquivo aberto direto no navegador),
// criamos um adaptador usando localStorage para criar/atualizar/excluir registros.
if (typeof window !== "undefined" && !window.dataSdk) {
  window.dataSdk = {
    async init(handler) {
      isLocalMode = true;
      const records = loadLocalFallbackRecords();
      if (handler && typeof handler.onDataChanged === "function") {
        handler.onDataChanged(records);
      }
      return { isOk: true, isLocal: true };
    },
    async create(record) {
      let records = loadLocalFallbackRecords();
      const id = record.id || ("LOCAL-" + Date.now() + "-" + Math.floor(Math.random() * 1e6));
      const backendId = record.__backendId || id;
      const newRecord = { ...record, id, __backendId: backendId };
      records.push(newRecord);
      saveLocalFallbackRecords(records);
      if (typeof dataHandler !== "undefined" && typeof dataHandler.onDataChanged === "function") {
        dataHandler.onDataChanged(records);
      }
      return { isOk: true, isLocal: true, record: newRecord };
    },
    async update(record) {
      let records = loadLocalFallbackRecords();
      const idx = records.findIndex(r => r.__backendId === record.__backendId);
      if (idx === -1) {
        return { isOk: false, error: "not-found" };
      }
      records[idx] = { ...records[idx], ...record };
      saveLocalFallbackRecords(records);
      if (typeof dataHandler !== "undefined" && typeof dataHandler.onDataChanged === "function") {
        dataHandler.onDataChanged(records);
      }
      return { isOk: true, isLocal: true };
    },
    async delete(record) {
      let records = loadLocalFallbackRecords();
      records = records.filter(r => r.__backendId !== record.__backendId);
      saveLocalFallbackRecords(records);
      if (typeof dataHandler !== "undefined" && typeof dataHandler.onDataChanged === "function") {
        dataHandler.onDataChanged(records);
      }
      return { isOk: true, isLocal: true };
    }
  };
}


// Inicializa SDK ou modo local
async function initDataSdk() {
      if (!window.dataSdk) return;
      
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        showToast("Erro ao inicializar sistema", "error");
      }
    }

    function extractSellersFromRecords() {
      const uniqueSellerNames = [...new Set(allRecords.map(r => r.seller_name))].sort();
      allSellers = uniqueSellerNames.map(name => ({
        seller_name: name,
        recordCount: allRecords.filter(r => r.seller_name === name).length
      }));
    }

    /********************************************************************
     * SELLERS MANAGEMENT
     ********************************************************************/
    function renderSellersTable() {
      const tbody = document.getElementById("sellers_table_body");
      
      if (allSellers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="text-center text-slate-400 py-10">
              Nenhum vendedor cadastrado. Os vendedores ser√£o criados automaticamente quando voc√™ adicionar registros.
            </td>
          </tr>
        `;
        return;
      }

      const sorted = [...allSellers].sort((a, b) => a.seller_name.localeCompare(b.seller_name));

      let html = '';
      
      sorted.forEach(seller => {
        const recordCount = seller.recordCount || 0;
        const sellerRecords = allRecords.filter(r => r.seller_name === seller.seller_name);
        
        // Main seller row
        html += `
          <tr data-name="${seller.seller_name}" style="background: rgba(59, 130, 246, 0.1);">
            <td><span class="seller-badge">${seller.seller_name}</span></td>
            <td>${recordCount} registro(s)</td>
            <td>
              <button class="btn-success view-seller-records-btn" data-name="${seller.seller_name}" type="button">
                <span class="toggle-icon" data-seller="${seller.seller_name}">‚ñº</span> Ver Registros
              </button>
            </td>
          </tr>
        `;
        
        // Records detail row (initially hidden)
        html += `
          <tr class="seller-records-row seller-records-${seller.seller_name}" style="display: none;">
            <td colspan="3" style="padding: 0;">
              <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; margin: 10px;">
                <h4 style="color: #60a5fa; font-size: 16px; font-weight: 700; margin-bottom: 15px;">
                  üìã Registros de ${seller.seller_name}
                </h4>
                <div style="overflow-x: auto;">
                  <table class="data-table" style="margin: 0;">
                    <thead>
                      <tr>
                        <th>Per√≠odo</th>
                        <th>Taxa Convers√£o (%)</th>
                        <th>Efici√™ncia (%)</th>
                        <th>A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
        `;
        
        if (sellerRecords.length === 0) {
          html += `
            <tr>
              <td colspan="5" class="text-center text-slate-400 py-6">
                Nenhum registro encontrado para este vendedor.
              </td>
            </tr>
          `;
        } else {
          sellerRecords.sort((a, b) => {
            const dateA = new Date(a.createdAt);
            const dateB = new Date(b.createdAt);
            return dateB - dateA;
          }).forEach(record => {
            const isEditing = editingRecordId === record.__backendId;
            
            if (isEditing) {
              html += `
                <tr data-id="${record.__backendId}">
                  <td>
                    <div style="display: flex; gap: 8px;">
                      <select class="edit-mode-input" data-field="month" style="flex: 1;">
                        <option value="Janeiro" ${record.month === 'Janeiro' ? 'selected' : ''}>Janeiro</option>
                        <option value="Fevereiro" ${record.month === 'Fevereiro' ? 'selected' : ''}>Fevereiro</option>
                        <option value="Mar√ßo" ${record.month === 'Mar√ßo' ? 'selected' : ''}>Mar√ßo</option>
                        <option value="Abril" ${record.month === 'Abril' ? 'selected' : ''}>Abril</option>
                        <option value="Maio" ${record.month === 'Maio' ? 'selected' : ''}>Maio</option>
                        <option value="Junho" ${record.month === 'Junho' ? 'selected' : ''}>Junho</option>
                        <option value="Julho" ${record.month === 'Julho' ? 'selected' : ''}>Julho</option>
                        <option value="Agosto" ${record.month === 'Agosto' ? 'selected' : ''}>Agosto</option>
                        <option value="Setembro" ${record.month === 'Setembro' ? 'selected' : ''}>Setembro</option>
                        <option value="Outubro" ${record.month === 'Outubro' ? 'selected' : ''}>Outubro</option>
                        <option value="Novembro" ${record.month === 'Novembro' ? 'selected' : ''}>Novembro</option>
                        <option value="Dezembro" ${record.month === 'Dezembro' ? 'selected' : ''}>Dezembro</option>
                      </select>
                      <select class="edit-mode-input" data-field="year" style="flex: 1;">
                        <option value="2024" ${record.year === '2024' ? 'selected' : ''}>2024</option>
                        <option value="2025" ${record.year === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2026" ${record.year === '2026' ? 'selected' : ''}>2026</option>
                      </select>
                    </div>
                  </td>
                  <td><input type="number" class="edit-mode-input" data-field="taxa_conversao" value="${record.taxa_conversao}" step="0.01" min="0" max="100"></td>
                  <td><input type="number" class="edit-mode-input" data-field="eficiencia" value="${record.eficiencia}" step="0.01" min="0" max="100"></td>
                  <td>
                    <button class="btn-success save-edit-btn" data-id="${record.__backendId}" type="button">Salvar</button>
                    <button class="btn-secondary cancel-edit-btn" type="button" style="padding: 10px 18px; margin-left: 6px;">Cancelar</button>
                  </td>
                </tr>
              `;
            } else {
              html += `
                <tr data-id="${record.__backendId}">
                  <td><strong>${record.month}/${record.year}</strong></td>
                  <td>${record.taxa_conversao.toFixed(2)}%</td>
                  <td>${record.eficiencia.toFixed(2)}%</td>
                  <td>
                    <button class="btn-success edit-btn" data-id="${record.__backendId}" type="button">Editar</button>
                    <button class="btn-danger delete-btn" data-id="${record.__backendId}" type="button" style="margin-left: 6px;">Excluir</button>
                  </td>
                </tr>
              `;
            }
          });
        }
        
        html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;

      // Attach event listeners for view/hide records
      tbody.querySelectorAll('.view-seller-records-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const sellerName = e.target.closest('button').getAttribute('data-name');
          const recordsRows = document.querySelectorAll(`.seller-records-${sellerName}`);
          const icon = btn.querySelector('.toggle-icon');
          
          recordsRows.forEach(row => {
            if (row.style.display === 'none') {
              row.style.display = 'table-row';
              if (icon) icon.textContent = '‚ñ≤';
            } else {
              row.style.display = 'none';
              if (icon) icon.textContent = '‚ñº';
            }
          });
        });
      });

      // Attach event listeners for edit/delete
      tbody.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          editingRecordId = e.target.getAttribute('data-id');
          renderSellersTable();
        });
      });

      tbody.querySelectorAll('.cancel-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          editingRecordId = null;
          renderSellersTable();
        });
      });

      tbody.querySelectorAll('.save-edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          await saveEdit(id);
        });
      });

      tbody.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          await deleteRecord(id);
        });
      });
    }

    async function saveSellerEdit(oldName) {
      const row = document.querySelector(`#sellers_table_body tr[data-name="${oldName}"]`);
      const input = row.querySelector('.edit-mode-input');
      const newName = input.value.trim();

      if (!newName) {
        showToast("Nome do vendedor n√£o pode estar vazio", "error");
        return;
      }

      // Check if name already exists (excluding current seller)
      const nameExists = allSellers.some(s => s.seller_name === newName && s.seller_name !== oldName);
      if (nameExists) {
        showToast("J√° existe um vendedor com este nome", "error");
        return;
      }

      // Update all records with the old seller name
      const recordsToUpdate = allRecords.filter(r => r.seller_name === oldName);
      
      if (recordsToUpdate.length === 0) {
        showToast("Nenhum registro encontrado para este vendedor", "error");
        return;
      }

      for (const record of recordsToUpdate) {
        const updatedRecord = { ...record, seller_name: newName };
        const result = await window.dataSdk.update(updatedRecord);
        if (!result.isOk) {
          showToast("Erro ao atualizar registros", "error");
          return;
        }
      }
      
      showToast("Vendedor atualizado com sucesso!");
      editingSellerId = null;
    }

    async function deleteSeller(sellerName, recordCount) {
      if (recordCount > 0) {
        showToast(`N√£o √© poss√≠vel excluir ${sellerName}. Existem ${recordCount} registro(s) associado(s).`, "error");
        return;
      }

      showToast("Este vendedor n√£o possui registros e ser√° removido automaticamente", "error");
    }

    function updateAllSellerDropdowns() {
      const sellerNames = allSellers.map(s => s.seller_name).sort();
      
      // Update datalist for seller input
      const datalist = document.getElementById('seller_list');
      if (datalist) {
        datalist.innerHTML = '';
        sellerNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          datalist.appendChild(option);
        });
      }
      
      // Update filter dropdowns - EXCLUDE "Loja" from comparison filters
      const filterDropdowns = [
        'filter_seller_table',
        'filter_seller_comparison',
        'seller_compare_filter'
      ];

      filterDropdowns.forEach(dropdownId => {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;

        const currentValue = dropdown.value;
        
        dropdown.innerHTML = '<option value="">Todos os Vendedores</option>';
        
        // Filter out "Loja" from comparison dropdowns
        const filteredNames = sellerNames.filter(name => name.toLowerCase() !== 'loja');
        
        filteredNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          dropdown.appendChild(option);
        });

        // Restore previous selection if still valid
        if (currentValue && filteredNames.includes(currentValue)) {
          dropdown.value = currentValue;
        }
      });
    }



    /********************************************************************
     * FORM HANDLING
     ********************************************************************/
    document.getElementById("insert_form").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const seller = document.getElementById("seller_select").value;
      const month = document.getElementById("month_select").value;
      const year = document.getElementById("year_select").value;
      const taxaConversao = parseFloat(document.getElementById("taxa_conversao").value);
      const eficiencia = parseFloat(document.getElementById("eficiencia").value);

      if (!seller || !month || !year) {
        showToast("Preencha todos os campos obrigat√≥rios", "error");
        return;
      }

      if (allRecords.length >= 999) {
        showToast("Limite de 999 registros atingido", "error");
        return;
      }

      showLoading(true);

      const newRecord = {
        id: Date.now().toString(),
        seller_name: seller,
        month: month,
        year: year,
        taxa_conversao: taxaConversao,
        eficiencia: eficiencia,
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(newRecord);
      
      showLoading(false);

      if (result.isOk) {
        showToast("Registro salvo com sucesso!");
        document.getElementById("insert_form").reset();
      } else {
        showToast("Erro ao salvar registro", "error");
      }
    });

    /********************************************************************
     * TABLE RENDERING
     ********************************************************************/
    function renderTable() {
      const tbody = document.getElementById("data_table_body");
      
      // Apply seller filter
      let filteredRecords = [...allRecords];
      if (selectedSellerFilter) {
        filteredRecords = filteredRecords.filter(r => r.seller_name === selectedSellerFilter);
      }
      
      if (filteredRecords.length === 0) {
        const message = selectedSellerFilter 
          ? `Nenhum registro encontrado para ${selectedSellerFilter}. Adicione dados acima.`
          : "Nenhum registro encontrado. Adicione dados acima.";
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-slate-400 py-10">
              ${message}
            </td>
          </tr>
        `;
        return;
      }

      const sorted = [...filteredRecords].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      tbody.innerHTML = sorted.map(record => {
        const isEditing = editingRecordId === record.__backendId;

        if (isEditing) {
          const sellerOptions = allSellers.map(s => 
            `<option value="${s.seller_name}" ${record.seller_name === s.seller_name ? 'selected' : ''}>${s.seller_name}</option>`
          ).join('');
          
          return `
            <tr data-id="${record.__backendId}">
              <td>
                <select class="edit-mode-input" data-field="seller_name" style="width: 100%;">
                  ${sellerOptions}
                </select>
              </td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <select class="edit-mode-input" data-field="month" style="flex: 1;">
                    <option value="Janeiro" ${record.month === 'Janeiro' ? 'selected' : ''}>Janeiro</option>
                    <option value="Fevereiro" ${record.month === 'Fevereiro' ? 'selected' : ''}>Fevereiro</option>
                    <option value="Mar√ßo" ${record.month === 'Mar√ßo' ? 'selected' : ''}>Mar√ßo</option>
                    <option value="Abril" ${record.month === 'Abril' ? 'selected' : ''}>Abril</option>
                    <option value="Maio" ${record.month === 'Maio' ? 'selected' : ''}>Maio</option>
                    <option value="Junho" ${record.month === 'Junho' ? 'selected' : ''}>Junho</option>
                    <option value="Julho" ${record.month === 'Julho' ? 'selected' : ''}>Julho</option>
                    <option value="Agosto" ${record.month === 'Agosto' ? 'selected' : ''}>Agosto</option>
                    <option value="Setembro" ${record.month === 'Setembro' ? 'selected' : ''}>Setembro</option>
                    <option value="Outubro" ${record.month === 'Outubro' ? 'selected' : ''}>Outubro</option>
                    <option value="Novembro" ${record.month === 'Novembro' ? 'selected' : ''}>Novembro</option>
                    <option value="Dezembro" ${record.month === 'Dezembro' ? 'selected' : ''}>Dezembro</option>
                  </select>
                  <select class="edit-mode-input" data-field="year" style="flex: 1;">
                    <option value="2024" ${record.year === '2024' ? 'selected' : ''}>2024</option>
                    <option value="2025" ${record.year === '2025' ? 'selected' : ''}>2025</option>
                    <option value="2026" ${record.year === '2026' ? 'selected' : ''}>2026</option>
                  </select>
                </div>
              </td>
              <td><input type="number" class="edit-mode-input" data-field="taxa_conversao" value="${record.taxa_conversao}" step="0.01" min="0" max="100"></td>
              <td><input type="number" class="edit-mode-input" data-field="eficiencia" value="${record.eficiencia}" step="0.01" min="0" max="100"></td>
              <td>
                <button class="btn-success save-edit-btn" data-id="${record.__backendId}" type="button">Salvar</button>
                <button class="btn-secondary cancel-edit-btn" type="button" style="padding: 10px 18px; margin-left: 6px;">Cancelar</button>
              </td>
            </tr>
          `;
        }

        return `
          <tr data-id="${record.__backendId}">
            <td><span class="seller-badge">${record.seller_name}</span></td>
            <td>${record.month}/${record.year}</td>
            <td>${record.taxa_conversao.toFixed(2)}%</td>
            <td>${record.eficiencia.toFixed(2)}%</td>
            <td>
              <button class="btn-success edit-btn" data-id="${record.__backendId}" type="button">Editar</button>
              <button class="btn-danger delete-btn" data-id="${record.__backendId}" type="button" style="margin-left: 6px;">Excluir</button>
            </td>
          </tr>
        `;
      }).join('');

      // Attach event listeners
      tbody.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          editingRecordId = e.target.getAttribute('data-id');
          renderTable();
        });
      });

      tbody.querySelectorAll('.cancel-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          editingRecordId = null;
          renderTable();
        });
      });

      tbody.querySelectorAll('.save-edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          await saveEdit(id);
        });
      });

      tbody.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          await deleteRecord(id);
        });
      });
    }

    async function saveEdit(backendId) {
      const record = allRecords.find(r => r.__backendId === backendId);
      if (!record) return;

      const row = document.querySelector(`tr[data-id="${backendId}"]`);
      const inputs = row.querySelectorAll('.edit-mode-input');

      const updatedRecord = { ...record };
      inputs.forEach(input => {
        const field = input.getAttribute('data-field');
        if (field === 'seller_name' || field === 'month' || field === 'year') {
          updatedRecord[field] = input.value.trim();
        } else {
          updatedRecord[field] = parseFloat(input.value) || 0;
        }
      });

      const result = await window.dataSdk.update(updatedRecord);
      
      if (result.isOk) {
        showToast("Registro atualizado!");
        editingRecordId = null;
      } else {
        showToast("Erro ao atualizar registro", "error");
      }
    }

    async function deleteRecord(backendId) {
      const record = allRecords.find(r => r.__backendId === backendId);
      if (!record) return;

      const result = await window.dataSdk.delete(record);
      
      if (result.isOk) {
        showToast("Registro exclu√≠do");
      } else {
        showToast("Erro ao excluir registro", "error");
      }
    }

    /********************************************************************
     * COMPARISONS
     ********************************************************************/
    function renderComparisons() {
      // CRITICAL: EXCLUDE "Loja" from comparisons - this tab is ONLY for sellers
      // Filter out "Loja" FIRST before any other filtering
      let filtered = allRecords.filter(r => r.seller_name.toLowerCase() !== 'loja');

      // Apply seller filter
      if (selectedSellerComparison) {
        filtered = filtered.filter(r => r.seller_name === selectedSellerComparison);
      }

      if (comparisonMode === "mensal") {
        const month = document.getElementById("compare_month").value;
        const year = document.getElementById("compare_year").value;

        if (month) filtered = filtered.filter(r => r.month === month);
        if (year) filtered = filtered.filter(r => r.year === year);
      } else {
        const startMonth = document.getElementById("period_start").value;
        const endMonth = document.getElementById("period_end").value;
        const year = document.getElementById("period_year").value;

        const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const startIdx = months.indexOf(startMonth);
        const endIdx = months.indexOf(endMonth);

        filtered = filtered.filter(r => {
          if (r.year !== year) return false;
          const monthIdx = months.indexOf(r.month);
          return monthIdx >= startIdx && monthIdx <= endIdx;
        });
      }

      // Group by seller
      const sellerData = {};
      filtered.forEach(record => {
        if (!sellerData[record.seller_name]) {
          sellerData[record.seller_name] = {
            name: record.seller_name,
            avgConversao: 0,
            avgEficiencia: 0,
            count: 0
          };
        }
        sellerData[record.seller_name].avgConversao += record.taxa_conversao;
        sellerData[record.seller_name].avgEficiencia += record.eficiencia;
        sellerData[record.seller_name].count++;
      });

      // Calculate averages
      Object.values(sellerData).forEach(seller => {
        seller.avgConversao = seller.avgConversao / seller.count;
        seller.avgEficiencia = seller.avgEficiencia / seller.count;
      });

      const sellers = Object.values(sellerData).sort((a, b) => b.avgConversao - a.avgConversao);

      // Update chart title based on filter
      const chartTitle = document.getElementById("chart_title");
      if (chartTitle) {
        if (selectedSellerComparison) {
          const metricName = currentMetric === "conversao" ? "Taxa de Convers√£o" : "Efici√™ncia";
          chartTitle.textContent = `${metricName} - ${selectedSellerComparison}`;
        } else {
          chartTitle.textContent = "Gr√°fico Comparativo de Vendedores";
        }
      }

      renderComparisonChart(sellers);
      renderMetrics(sellers, filtered);
    }

    function getMonthColor(month) {
      const colors = {
        "Janeiro": "#ef4444",
        "Fevereiro": "#f97316",
        "Mar√ßo": "#f59e0b",
        "Abril": "#eab308",
        "Maio": "#84cc16",
        "Junho": "#22c55e",
        "Julho": "#10b981",
        "Agosto": "#14b8a6",
        "Setembro": "#06b6d4",
        "Outubro": "#0ea5e9",
        "Novembro": "#3b82f6",
        "Dezembro": "#6366f1"
      };
      return colors[month] || "#94a3b8";
    }

    function getYearColor(year) {
      const colors = {
        "2024": "#3b82f6",
        "2025": "#10b981",
        "2026": "#f59e0b"
      };
      return colors[year] || "#94a3b8";
    }

    function renderComparisonChart(sellers) {
      const svg = document.getElementById("comparison_chart");
      const legendContainer = document.getElementById("chart_legend");
      if (!svg) return;

      const width = svg.clientWidth || 800;
      const height = svg.clientHeight || 700;
      const padding = { top: 60, right: 40, bottom: 100, left: 80 };

      svg.innerHTML = "";
      legendContainer.innerHTML = "";

      if (allRecords.length === 0) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", width / 2);
        text.setAttribute("y", height / 2);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#94a3b8");
        text.setAttribute("font-size", "18");
        text.textContent = "Nenhum dado dispon√≠vel para o per√≠odo selecionado";
        svg.appendChild(text);
        return;
      }

      // Get filtered records based on current mode
      // CRITICAL: EXCLUDE "Loja" from chart - this is ONLY for sellers
      let filtered = allRecords.filter(r => r.seller_name.toLowerCase() !== 'loja');
      
      // Apply seller filter
      if (selectedSellerComparison) {
        filtered = filtered.filter(r => r.seller_name === selectedSellerComparison);
      }
      
      if (comparisonMode === "mensal") {
        const month = document.getElementById("compare_month").value;
        const year = document.getElementById("compare_year").value;
        if (month) filtered = filtered.filter(r => r.month === month);
        if (year) filtered = filtered.filter(r => r.year === year);
      } else {
        const startMonth = document.getElementById("period_start").value;
        const endMonth = document.getElementById("period_end").value;
        const year = document.getElementById("period_year").value;
        const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const startIdx = months.indexOf(startMonth);
        const endIdx = months.indexOf(endMonth);
        filtered = filtered.filter(r => {
          if (r.year !== year) return false;
          const monthIdx = months.indexOf(r.month);
          return monthIdx >= startIdx && monthIdx <= endIdx;
        });
      }

      if (filtered.length === 0) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", width / 2);
        text.setAttribute("y", height / 2);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#94a3b8");
        text.setAttribute("font-size", "18");
        text.textContent = "Nenhum dado dispon√≠vel para o per√≠odo selecionado";
        svg.appendChild(text);
        return;
      }

      // Determine if we're showing individual seller or all sellers
      const isIndividualSeller = selectedSellerComparison !== "";

      // Group data by seller and month/year
      const sellerNames = [...new Set(filtered.map(r => r.seller_name))];
      const periods = [...new Set(filtered.map(r => `${r.month}/${r.year}`))].sort();
      
      // Organize data structure
      const chartData = {};
      filtered.forEach(record => {
        const period = `${record.month}/${record.year}`;
        if (!chartData[record.seller_name]) {
          chartData[record.seller_name] = {};
        }
        if (!chartData[record.seller_name][period]) {
          chartData[record.seller_name][period] = {
            conversao: 0,
            eficiencia: 0,
            count: 0,
            month: record.month,
            year: record.year
          };
        }
        chartData[record.seller_name][period].conversao += record.taxa_conversao;
        chartData[record.seller_name][period].eficiencia += record.eficiencia;
        chartData[record.seller_name][period].count++;
      });

      // Calculate averages for percentage metrics
      Object.values(chartData).forEach(seller => {
        Object.values(seller).forEach(period => {
          if (period.count > 0) {
            period.conversao = period.conversao / period.count;
            period.eficiencia = period.eficiencia / period.count;
          }
        });
      });

      // Calculate average metric for each seller to sort them
      const sellerAverages = {};
      sellerNames.forEach(seller => {
        const periods = Object.values(chartData[seller] || {});
        if (periods.length > 0) {
          const sum = periods.reduce((acc, p) => acc + p[currentMetric], 0);
          sellerAverages[seller] = sum / periods.length;
        } else {
          sellerAverages[seller] = 0;
        }
      });

      // Sort sellers by average metric value (descending - highest first)
      // BUT only when showing all sellers
      if (!isIndividualSeller) {
        sellerNames.sort((a, b) => sellerAverages[b] - sellerAverages[a]);
      }

      // Calculate dynamic max value based on actual data
      let maxDataValue = 0;
      
      if (isIndividualSeller) {
        // For individual seller, check all periods
        const seller = sellerNames[0];
        periods.forEach(period => {
          const data = chartData[seller] && chartData[seller][period];
          if (data) {
            const value = data[currentMetric];
            if (value > maxDataValue) maxDataValue = value;
          }
        });
      } else {
        // For all sellers, check all combinations
        sellerNames.forEach(seller => {
          periods.forEach(period => {
            const data = chartData[seller] && chartData[seller][period];
            if (data) {
              const value = data[currentMetric];
              if (value > maxDataValue) maxDataValue = value;
            }
          });
        });
      }
      
      // Add 10% margin above the highest value, then round up to next whole number
      let maxValue = Math.ceil(maxDataValue * 1.1);
      
      // Ensure minimum scale of 5 for better visualization
      if (maxValue < 5) maxValue = 5;

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      // When showing individual seller, we group by periods (months)
      // When showing all sellers, we group by sellers
      let groupCount, barWidth, groupWidth;
      
      if (isIndividualSeller) {
        // Individual seller: show periods (months) on X-axis
        groupCount = periods.length;
        groupWidth = chartWidth / groupCount;
        barWidth = Math.min(groupWidth * 0.6, 60);
      } else {
        // All sellers: show sellers on X-axis
        groupCount = sellerNames.length;
        groupWidth = chartWidth / groupCount;
        barWidth = Math.min(groupWidth / (periods.length + 1), 40);
      }

      // Draw Y-axis grid lines and labels - dynamic intervals based on max value
      const numIntervals = Math.min(Math.ceil(maxValue), 20); // Max 20 lines, or less if maxValue is small
      
      for (let i = 0; i <= numIntervals; i++) {
        const y = padding.top + (chartHeight * (1 - i / numIntervals));
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", padding.left);
        line.setAttribute("y1", y);
        line.setAttribute("x2", width - padding.right);
        line.setAttribute("y2", y);
        line.setAttribute("stroke", "#cbd5e1");
        line.setAttribute("stroke-opacity", "0.5");
        line.setAttribute("stroke-dasharray", "4,4");
        svg.appendChild(line);

        const val = (maxValue * i / numIntervals);
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", padding.left - 10);
        label.setAttribute("y", y + 5);
        label.setAttribute("text-anchor", "end");
        label.setAttribute("fill", "#1e293b");
        label.setAttribute("font-size", "12");
        label.setAttribute("font-weight", "600");
        
        label.textContent = val.toFixed(1) + "%";
        svg.appendChild(label);
      }

      if (isIndividualSeller) {
        // INDIVIDUAL SELLER MODE: Show months on X-axis
        const seller = sellerNames[0];
        
        // Sort periods chronologically when showing individual seller
        const monthOrder = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                           "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        const sortedPeriods = [...periods].sort((a, b) => {
          const [monthA, yearA] = a.split('/');
          const [monthB, yearB] = b.split('/');
          
          // First compare years
          if (yearA !== yearB) {
            return yearA.localeCompare(yearB);
          }
          
          // Then compare months
          return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
        });
        
        sortedPeriods.forEach((period, periodIdx) => {
          const data = chartData[seller] && chartData[seller][period];
          if (!data) return;

          const metricValue = data[currentMetric];
          const barHeight = (metricValue / maxValue) * chartHeight;
          const groupX = padding.left + (periodIdx * groupWidth) + (groupWidth / 2);
          const x = groupX - (barWidth / 2);
          const y = padding.top + chartHeight - barHeight;

          // Determine bar color based on metric and value
          let barColor;
          if (currentMetric === "eficiencia") {
            // Efici√™ncia: 0-3 vermelho, 3-7 amarelo, 7+ verde
            if (metricValue < 3) {
              barColor = '#ef4444'; // Vermelho
            } else if (metricValue < 7) {
              barColor = '#f59e0b'; // Amarelo
            } else {
              barColor = '#10b981'; // Verde
            }
          } else if (currentMetric === "conversao") {
            // Convers√£o: 0-15 vermelho, 15-30 amarelo, 30+ verde
            if (metricValue < 15) {
              barColor = '#ef4444'; // Vermelho
            } else if (metricValue < 30) {
              barColor = '#f59e0b'; // Amarelo
            } else {
              barColor = '#10b981'; // Verde
            }
          }

          // Draw bar
          const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
          rect.setAttribute("x", x);
          rect.setAttribute("y", y);
          rect.setAttribute("width", barWidth);
          rect.setAttribute("height", barHeight);
          rect.setAttribute("fill", barColor);
          rect.setAttribute("rx", "4");
          rect.setAttribute("opacity", "0.9");
          svg.appendChild(rect);

          // Value label on top of bar - ALWAYS show
          const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          valueLabel.setAttribute("x", groupX);
          valueLabel.setAttribute("y", barHeight > 25 ? y - 5 : y - 5);
          valueLabel.setAttribute("text-anchor", "middle");
          valueLabel.setAttribute("fill", "#1e293b");
          valueLabel.setAttribute("font-size", "11");
          valueLabel.setAttribute("font-weight", "700");
          valueLabel.textContent = metricValue.toFixed(1) + "%";
          svg.appendChild(valueLabel);

          // Month label below X-axis
          const monthLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          monthLabel.setAttribute("x", groupX);
          monthLabel.setAttribute("y", height - padding.bottom + 30);
          monthLabel.setAttribute("text-anchor", "middle");
          monthLabel.setAttribute("fill", "#1e293b");
          monthLabel.setAttribute("font-size", "13");
          monthLabel.setAttribute("font-weight", "700");
          monthLabel.textContent = data.month;
          svg.appendChild(monthLabel);

          // Year label below month
          const yearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          yearLabel.setAttribute("x", groupX);
          yearLabel.setAttribute("y", height - padding.bottom + 50);
          yearLabel.setAttribute("text-anchor", "middle");
          yearLabel.setAttribute("fill", "#475569");
          yearLabel.setAttribute("font-size", "11");
          yearLabel.setAttribute("font-weight", "600");
          yearLabel.textContent = data.year;
          svg.appendChild(yearLabel);
        });

      } else {
        // ALL SELLERS MODE: Show sellers on X-axis

        const monthOrderAll = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                               "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        const sortedPeriodsAll = [...periods].sort((a, b) => {
          const [monthA, yearA] = a.split('/');
          const [monthB, yearB] = b.split('/');

          if (yearA !== yearB) {
            return yearA.localeCompare(yearB);
          }

          return monthOrderAll.indexOf(monthA) - monthOrderAll.indexOf(monthB);
        });

        sellerNames.forEach((seller, sellerIdx) => {
          const groupX = padding.left + (sellerIdx * groupWidth) + (groupWidth / 2);
          
          sortedPeriodsAll.forEach((period, periodIdx) => {
            const data = chartData[seller] && chartData[seller][period];
            if (!data) return;

            const metricValue = data[currentMetric];
            const barHeight = (metricValue / maxValue) * chartHeight;
            const x = groupX - ((periods.length * barWidth) / 2) + (periodIdx * barWidth);
            const y = padding.top + chartHeight - barHeight;

            // Determine bar color based on metric and value
            let barColor;
            if (currentMetric === "eficiencia") {
              // Efici√™ncia: 0-3 vermelho, 3-7 amarelo, 7+ verde
              if (metricValue < 3) {
                barColor = '#ef4444'; // Vermelho
              } else if (metricValue < 7) {
                barColor = '#f59e0b'; // Amarelo
              } else {
                barColor = '#10b981'; // Verde
              }
            } else if (currentMetric === "conversao") {
              // Convers√£o: 0-15 vermelho, 15-30 amarelo, 30+ verde
              if (metricValue < 15) {
                barColor = '#ef4444'; // Vermelho
              } else if (metricValue < 30) {
                barColor = '#f59e0b'; // Amarelo
              } else {
                barColor = '#10b981'; // Verde
              }
            }

            // Draw bar
            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("x", x);
            rect.setAttribute("y", y);
            rect.setAttribute("width", barWidth - 2);
            rect.setAttribute("height", barHeight);
            rect.setAttribute("fill", barColor);
            rect.setAttribute("rx", "4");
            rect.setAttribute("opacity", "0.9");
            svg.appendChild(rect);

            // Value label on top of bar - ALWAYS show
            const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            valueLabel.setAttribute("x", x + (barWidth - 2) / 2);
            valueLabel.setAttribute("y", barHeight > 25 ? y - 5 : y - 5);
            valueLabel.setAttribute("text-anchor", "middle");
            valueLabel.setAttribute("fill", "#1e293b");
            valueLabel.setAttribute("font-size", "10");
            valueLabel.setAttribute("font-weight", "700");
            valueLabel.textContent = metricValue.toFixed(1) + "%";
            svg.appendChild(valueLabel);

            // Month label inside bar for overall comparison view
            const periodParts = period.split('/');
            const monthName = periodParts[0];
            const monthCenterX = x + (barWidth - 2) / 2;
            const monthCenterY = y + barHeight / 2;
            const monthLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            monthLabel.setAttribute("x", monthCenterX);
            monthLabel.setAttribute("y", monthCenterY);
            monthLabel.setAttribute("text-anchor", "middle");
            monthLabel.setAttribute("fill", "#0f172a");
            monthLabel.setAttribute("fill-opacity", "0.45");
            monthLabel.setAttribute("font-size", "9");
            monthLabel.setAttribute("font-weight", "600");
            monthLabel.setAttribute("transform", "rotate(-90, " + monthCenterX + ", " + monthCenterY + ")");
            monthLabel.textContent = monthName;
            svg.appendChild(monthLabel);
          });

          // Seller name below X-axis
          const nameLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          nameLabel.setAttribute("x", groupX);
          nameLabel.setAttribute("y", height - padding.bottom + 30);
          nameLabel.setAttribute("text-anchor", "middle");
          nameLabel.setAttribute("fill", "#1e293b");
          nameLabel.setAttribute("font-size", "13");
          nameLabel.setAttribute("font-weight", "700");
          nameLabel.textContent = seller;
          svg.appendChild(nameLabel);
        });
      }

      // X-axis line
      const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      xAxis.setAttribute("x1", padding.left);
      xAxis.setAttribute("y1", padding.top + chartHeight);
      xAxis.setAttribute("x2", width - padding.right);
      xAxis.setAttribute("y2", padding.top + chartHeight);
      xAxis.setAttribute("stroke", "#475569");
      xAxis.setAttribute("stroke-width", "2");
      svg.appendChild(xAxis);

      // Add metric name at bottom left
      const metricNames = {
        "conversao": "Taxa de Convers√£o",
        "eficiencia": "Efici√™ncia"
      };
      
      const metricLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
      metricLabel.setAttribute("x", padding.left);
      metricLabel.setAttribute("y", height - 10);
      metricLabel.setAttribute("text-anchor", "start");
      metricLabel.setAttribute("fill", "#1e293b");
      metricLabel.setAttribute("font-size", "14");
      metricLabel.setAttribute("font-weight", "700");
      metricLabel.textContent = `M√©trica: ${metricNames[currentMetric]}`;
      svg.appendChild(metricLabel);

      // Add period information at bottom right
      let periodText = "";
      if (comparisonMode === "mensal") {
        const month = document.getElementById("compare_month").value;
        const year = document.getElementById("compare_year").value;
        
        // Se tem m√™s E ano selecionados, mostra ambos
        if (month && year) {
          periodText = `Per√≠odo: ${month}/${year}`;
        } 
        // Se tem s√≥ m√™s, mostra o m√™s
        else if (month && !year) {
          periodText = `Per√≠odo: ${month}`;
        } 
        // Se tem s√≥ ano, mostra o ano
        else if (!month && year) {
          periodText = `Per√≠odo: ${year}`;
        }
        // Se n√£o tem nenhum filtro, pega o primeiro per√≠odo dispon√≠vel dos dados filtrados
        else {
          if (filtered.length > 0) {
            // Pega todos os per√≠odos √∫nicos dos dados filtrados
            const uniquePeriods = [...new Set(filtered.map(r => `${r.month}/${r.year}`))];
            if (uniquePeriods.length === 1) {
              // Se s√≥ tem um per√≠odo, mostra ele
              periodText = `Per√≠odo: ${uniquePeriods[0]}`;
            } else {
              // Se tem m√∫ltiplos per√≠odos, mostra "Todos os meses"
              periodText = "Per√≠odo: Todos os meses";
            }
          } else {
            periodText = "Per√≠odo: Todos os meses";
          }
        }
      } else {
        const startMonth = document.getElementById("period_start").value;
        const endMonth = document.getElementById("period_end").value;
        const year = document.getElementById("period_year").value;
        periodText = `Per√≠odo: ${startMonth} a ${endMonth}/${year}`;
      }
      
      if (selectedSellerComparison) {
        periodText += ` | Vendedor: ${selectedSellerComparison}`;
      }
      
      const periodLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
      periodLabel.setAttribute("x", width - padding.right);
      periodLabel.setAttribute("y", height - 10);
      periodLabel.setAttribute("text-anchor", "end");
      periodLabel.setAttribute("fill", "#475569");
      periodLabel.setAttribute("font-size", "12");
      periodLabel.setAttribute("font-style", "italic");
      periodLabel.setAttribute("font-weight", "600");
      periodLabel.textContent = periodText;
      svg.appendChild(periodLabel);

      // Y-axis line
      const yAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      yAxis.setAttribute("x1", padding.left);
      yAxis.setAttribute("y1", padding.top);
      yAxis.setAttribute("x2", padding.left);
      yAxis.setAttribute("y2", padding.top + chartHeight);
      yAxis.setAttribute("stroke", "#475569");
      yAxis.setAttribute("stroke-width", "2");
      svg.appendChild(yAxis);

      // Create legend
      if (currentMetric === "eficiencia") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">0% a 3% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">3% a 7% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">7% ou mais (Bom)</span>
          </div>
        `;
      } else if (currentMetric === "conversao") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">0% a 15% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">15% a 30% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">30% ou mais (Bom)</span>
          </div>
        `;
      }
    }

    function renderMetrics(sellers, records) {
      const container = document.getElementById("metrics_container");
      
      const avgConversao = sellers.length > 0 ? sellers.reduce((sum, s) => sum + s.avgConversao, 0) / sellers.length : 0;
      const avgEficiencia = sellers.length > 0 ? sellers.reduce((sum, s) => sum + s.avgEficiencia, 0) / sellers.length : 0;

      container.innerHTML = `
        <div class="metric-card">
          <div class="text-slate-400 text-sm font-semibold mb-2">Total de Registros</div>
          <div class="metric-value">${records.length}</div>
          <div class="text-slate-500 text-xs mt-2">Registros no per√≠odo</div>
        </div>
        <div class="metric-card">
          <div class="text-slate-400 text-sm font-semibold mb-2">Taxa Convers√£o M√©dia</div>
          <div class="metric-value">${avgConversao.toFixed(1)}%</div>
          <div class="text-slate-500 text-xs mt-2">M√©dia geral do per√≠odo</div>
        </div>
        <div class="metric-card">
          <div class="text-slate-400 text-sm font-semibold mb-2">Efici√™ncia M√©dia</div>
          <div class="metric-value">${avgEficiencia.toFixed(1)}%</div>
          <div class="text-slate-500 text-xs mt-2">Performance geral</div>
        </div>
      `;
    }

    /********************************************************************
     * UI HELPERS
     ********************************************************************/
    function showLoading(show) {
      const spinner = document.getElementById("submit_spinner");
      const text = document.getElementById("submit_text");
      const btn = document.getElementById("submit_btn");
      
      if (show) {
        spinner.classList.remove("hidden");
        text.textContent = "Salvando...";
        btn.disabled = true;
      } else {
        spinner.classList.add("hidden");
        text.textContent = "Salvar Registro";
        btn.disabled = false;
      }
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = "toast" + (type === "error" ? " error" : "");
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transition = "opacity 0.3s";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    /********************************************************************
     * LOJA ANALYSIS FUNCTIONS
     ********************************************************************/
    function renderLojaAnalysis() {
      // Filter only "Loja" records
      let filtered = allRecords.filter(r => r.seller_name.toLowerCase() === "loja");

      if (lojaComparisonMode === "mensal") {
        const month = document.getElementById("loja_compare_month").value;
        const year = document.getElementById("loja_compare_year").value;

        if (month) filtered = filtered.filter(r => r.month === month);
        if (year) filtered = filtered.filter(r => r.year === year);
      } else {
        const startMonth = document.getElementById("loja_period_start").value;
        const endMonth = document.getElementById("loja_period_end").value;
        const year = document.getElementById("loja_period_year").value;

        const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const startIdx = months.indexOf(startMonth);
        const endIdx = months.indexOf(endMonth);

        filtered = filtered.filter(r => {
          if (r.year !== year) return false;
          const monthIdx = months.indexOf(r.month);
          return monthIdx >= startIdx && monthIdx <= endIdx;
        });
      }

      renderLojaChart(filtered);
      renderLojaMetrics(filtered);
    }

    function renderLojaChart(records) {
      const svg = document.getElementById("loja_chart");
      const legendContainer = document.getElementById("loja_chart_legend");
      if (!svg) return;

      const width = svg.clientWidth || 800;
      const height = svg.clientHeight || 700;
      const padding = { top: 60, right: 40, bottom: 100, left: 80 };

      svg.innerHTML = "";
      legendContainer.innerHTML = "";

      if (records.length === 0) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", width / 2);
        text.setAttribute("y", height / 2);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#94a3b8");
        text.setAttribute("font-size", "18");
        text.textContent = "Nenhum dado da Loja encontrado. Adicione registros com o nome 'Loja'.";
        svg.appendChild(text);
        return;
      }

      // Group by period
      const periods = [...new Set(records.map(r => `${r.month}/${r.year}`))];
      
      // Sort periods chronologically
      const monthOrder = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                         "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      
      const sortedPeriods = [...periods].sort((a, b) => {
        const [monthA, yearA] = a.split('/');
        const [monthB, yearB] = b.split('/');
        if (yearA !== yearB) return yearA.localeCompare(yearB);
        return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
      });

      const periodData = {};
      records.forEach(record => {
        const period = `${record.month}/${record.year}`;
        if (!periodData[period]) {
          periodData[period] = {
            conversao: 0,
            eficiencia: 0,
            count: 0,
            month: record.month,
            year: record.year
          };
        }
        periodData[period].conversao += record.taxa_conversao;
        periodData[period].eficiencia += record.eficiencia;
        periodData[period].count++;
      });

      // Calculate averages
      Object.values(periodData).forEach(period => {
        if (period.count > 0) {
          period.conversao = period.conversao / period.count;
          period.eficiencia = period.eficiencia / period.count;
        }
      });

      // Calculate max value
      let maxDataValue = 0;
      sortedPeriods.forEach(period => {
        const data = periodData[period];
        if (data) {
          const value = data[lojaCurrentMetric];
          if (value > maxDataValue) maxDataValue = value;
        }
      });
      
      let maxValue = Math.ceil(maxDataValue * 1.1);
      if (maxValue < 5) maxValue = 5;

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      const groupCount = sortedPeriods.length;
      const groupWidth = chartWidth / groupCount;
      const barWidth = Math.min(groupWidth * 0.6, 80);

      // Draw Y-axis grid lines
      const numIntervals = Math.min(Math.ceil(maxValue), 20);
      
      for (let i = 0; i <= numIntervals; i++) {
        const y = padding.top + (chartHeight * (1 - i / numIntervals));
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", padding.left);
        line.setAttribute("y1", y);
        line.setAttribute("x2", width - padding.right);
        line.setAttribute("y2", y);
        line.setAttribute("stroke", "#cbd5e1");
        line.setAttribute("stroke-opacity", "0.5");
        line.setAttribute("stroke-dasharray", "4,4");
        svg.appendChild(line);

        const val = (maxValue * i / numIntervals);
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", padding.left - 10);
        label.setAttribute("y", y + 5);
        label.setAttribute("text-anchor", "end");
        label.setAttribute("fill", "#94a3b8");
        label.setAttribute("font-size", "12");
        label.textContent = val.toFixed(1) + "%";
        svg.appendChild(label);
      }

      // Draw bars
      sortedPeriods.forEach((period, periodIdx) => {
        const data = periodData[period];
        if (!data) return;

        const metricValue = data[lojaCurrentMetric];
        const barHeight = (metricValue / maxValue) * chartHeight;
        const groupX = padding.left + (periodIdx * groupWidth) + (groupWidth / 2);
        const x = groupX - (barWidth / 2);
        const y = padding.top + chartHeight - barHeight;

        let barColor;
        if (lojaCurrentMetric === "eficiencia") {
          if (metricValue < 3) barColor = '#ef4444';
          else if (metricValue < 7) barColor = '#f59e0b';
          else barColor = '#10b981';
        } else if (lojaCurrentMetric === "conversao") {
          if (metricValue < 15) barColor = '#ef4444';
          else if (metricValue < 30) barColor = '#f59e0b';
          else barColor = '#10b981';
        }

        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("width", barWidth);
        rect.setAttribute("height", barHeight);
        rect.setAttribute("fill", barColor);
        rect.setAttribute("rx", "4");
        rect.setAttribute("opacity", "0.9");
        svg.appendChild(rect);

        const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          valueLabel.setAttribute("x", groupX);
          valueLabel.setAttribute("y", y - 5);
          valueLabel.setAttribute("text-anchor", "middle");
          valueLabel.setAttribute("fill", "#ffffff");
          valueLabel.setAttribute("font-size", "13");
          valueLabel.setAttribute("font-weight", "600");
          valueLabel.textContent = metricValue.toFixed(1) + "%";
          svg.appendChild(valueLabel);

        const monthLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        monthLabel.setAttribute("x", groupX);
        monthLabel.setAttribute("y", height - padding.bottom + 30);
        monthLabel.setAttribute("text-anchor", "middle");
        monthLabel.setAttribute("fill", "#ffffff");
        monthLabel.setAttribute("font-size", "15");
        monthLabel.setAttribute("font-weight", "700");
        monthLabel.textContent = data.month;
        svg.appendChild(monthLabel);

        const yearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        yearLabel.setAttribute("x", groupX);
        yearLabel.setAttribute("y", height - padding.bottom + 50);
        yearLabel.setAttribute("text-anchor", "middle");
        yearLabel.setAttribute("fill", "#94a3b8");
        yearLabel.setAttribute("font-size", "13");
        yearLabel.textContent = data.year;
        svg.appendChild(yearLabel);
      });

      // X-axis line
      const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      xAxis.setAttribute("x1", padding.left);
      xAxis.setAttribute("y1", padding.top + chartHeight);
      xAxis.setAttribute("x2", width - padding.right);
      xAxis.setAttribute("y2", padding.top + chartHeight);
      xAxis.setAttribute("stroke", "#475569");
      xAxis.setAttribute("stroke-width", "2");
      svg.appendChild(xAxis);

      // Y-axis line
      const yAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      yAxis.setAttribute("x1", padding.left);
      yAxis.setAttribute("y1", padding.top);
      yAxis.setAttribute("x2", padding.left);
      yAxis.setAttribute("y2", padding.top + chartHeight);
      yAxis.setAttribute("stroke", "#475569");
      yAxis.setAttribute("stroke-width", "2");
      svg.appendChild(yAxis);

      // Metric label
      const metricNames = {
        "conversao": "Taxa de Convers√£o",
        "eficiencia": "Efici√™ncia"
      };
      
      const metricLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
      metricLabel.setAttribute("x", padding.left);
      metricLabel.setAttribute("y", height - 10);
      metricLabel.setAttribute("text-anchor", "start");
      metricLabel.setAttribute("fill", "#60a5fa");
      metricLabel.setAttribute("font-size", "14");
      metricLabel.setAttribute("font-weight", "700");
      metricLabel.textContent = `M√©trica: ${metricNames[lojaCurrentMetric]}`;
      svg.appendChild(metricLabel);

      // Legend
      if (lojaCurrentMetric === "eficiencia") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">0% a 3% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">3% a 7% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">7% ou mais (Bom)</span>
          </div>
        `;
      } else if (lojaCurrentMetric === "conversao") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">0% a 15% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">15% a 30% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 24px; height: 24px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-sm font-semibold">30% ou mais (Bom)</span>
          </div>
        `;
      }
    }

    function renderLojaMetrics(records) {
      const container = document.getElementById("loja_metrics_container");
      
      if (records.length === 0) {
        container.innerHTML = `
          <div class="metric-card col-span-3">
            <div class="text-center py-8">
              <div class="text-5xl mb-4">üè™</div>
              <div class="text-slate-400 text-lg">Nenhum dado da Loja encontrado</div>
              <div class="text-slate-500 text-sm mt-2">Adicione registros com o nome "Loja" na aba Inserir Dados</div>
            </div>
          </div>
        `;
        return;
      }

      const avgConversao = records.reduce((sum, r) => sum + r.taxa_conversao, 0) / records.length;
      const avgEficiencia = records.reduce((sum, r) => sum + r.eficiencia, 0) / records.length;

      container.innerHTML = `
        <div class="metric-card">
          <div class="text-slate-400 text-sm font-semibold mb-2">Total de Registros</div>
          <div class="metric-value">${records.length}</div>
          <div class="text-slate-500 text-xs mt-2">Registros da Loja</div>
        </div>
        <div class="metric-card">
          <div class="text-slate-400 text-sm font-semibold mb-2">Taxa Convers√£o M√©dia</div>
          <div class="metric-value">${avgConversao.toFixed(1)}%</div>
          <div class="text-slate-500 text-xs mt-2">Performance da Loja</div>
        </div>
        <div class="metric-card">
          <div class="text-slate-400 text-sm font-semibold mb-2">Efici√™ncia M√©dia</div>
          <div class="metric-value">${avgEficiencia.toFixed(1)}%</div>
          <div class="text-slate-500 text-xs mt-2">Efici√™ncia da Loja</div>
        </div>
      `;
    }

    function renderLojaYearComparison() {
      const year1 = document.getElementById("loja_year_compare_1").value;
      const year2 = document.getElementById("loja_year_compare_2").value;
      const resultsContainer = document.getElementById("loja_year_comparison_results");

      if (!year1 || !year2) {
        resultsContainer.innerHTML = `
          <div class="text-center py-10">
            <div class="text-6xl mb-6">üìÖ</div>
            <h3 class="text-2xl font-bold text-white mb-3">Selecione os Anos</h3>
            <p class="text-slate-400">Escolha dois anos para comparar a performance da Loja.</p>
          </div>
        `;
        return;
      }

      // Filter only "Loja" records
      let records1 = allRecords.filter(r => r.seller_name.toLowerCase() === "loja" && r.year === year1);
      let records2 = allRecords.filter(r => r.seller_name.toLowerCase() === "loja" && r.year === year2);

      if (records1.length === 0 && records2.length === 0) {
        resultsContainer.innerHTML = `
          <div class="text-center py-10">
            <div class="text-6xl mb-6">üìä</div>
            <h3 class="text-2xl font-bold text-white mb-3">Nenhum Dado Encontrado</h3>
            <p class="text-slate-400">N√£o h√° registros da Loja para os anos selecionados.</p>
          </div>
        `;
        return;
      }

      const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                     "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      // Summary Cards
      const avgConvYear1 = records1.length > 0 ? records1.reduce((sum, r) => sum + r.taxa_conversao, 0) / records1.length : 0;
      const avgConvYear2 = records2.length > 0 ? records2.reduce((sum, r) => sum + r.taxa_conversao, 0) / records2.length : 0;
      const avgEficYear1 = records1.length > 0 ? records1.reduce((sum, r) => sum + r.eficiencia, 0) / records1.length : 0;
      const avgEficYear2 = records2.length > 0 ? records2.reduce((sum, r) => sum + r.eficiencia, 0) / records2.length : 0;

      const convGrowth = avgConvYear1 > 0 ? ((avgConvYear2 - avgConvYear1) / avgConvYear1 * 100) : 0;
      const eficGrowth = avgEficYear1 > 0 ? ((avgEficYear2 - avgEficYear1) / avgEficYear1 * 100) : 0;

      let html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
          <div class="metric-card">
            <div class="text-slate-400 text-sm font-semibold mb-2">Crescimento em Convers√£o</div>
            <div class="metric-value ${convGrowth >= 0 ? 'text-green-400' : 'text-red-400'}" style="background: ${convGrowth >= 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              ${convGrowth >= 0 ? '+' : ''}${convGrowth.toFixed(1)}%
            </div>
            <div class="text-slate-500 text-sm mt-2">
              ${year1}: ${avgConvYear1.toFixed(1)}% ‚Üí ${year2}: ${avgConvYear2.toFixed(1)}%
            </div>
          </div>
          <div class="metric-card">
            <div class="text-slate-400 text-sm font-semibold mb-2">Crescimento em Efici√™ncia</div>
            <div class="metric-value ${eficGrowth >= 0 ? 'text-green-400' : 'text-red-400'}" style="background: ${eficGrowth >= 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              ${eficGrowth >= 0 ? '+' : ''}${eficGrowth.toFixed(1)}%
            </div>
            <div class="text-slate-500 text-sm mt-2">
              ${year1}: ${avgEficYear1.toFixed(1)}% ‚Üí ${year2}: ${avgEficYear2.toFixed(1)}%
            </div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>M√™s</th>
                <th>${year1} - Convers√£o</th>
                <th>${year2} - Convers√£o</th>
                <th>Crescimento Conv.</th>
                <th>${year1} - Efici√™ncia</th>
                <th>${year2} - Efici√™ncia</th>
                <th>Crescimento Efic.</th>
              </tr>
            </thead>
            <tbody>
      `;

      months.forEach(month => {
        const rec1 = records1.find(r => r.month === month);
        const rec2 = records2.find(r => r.month === month);

        if (!rec1 && !rec2) return;

        const conv1 = rec1 ? rec1.taxa_conversao : 0;
        const conv2 = rec2 ? rec2.taxa_conversao : 0;
        const convGrowth = conv1 > 0 ? ((conv2 - conv1) / conv1 * 100) : 0;

        const efic1 = rec1 ? rec1.eficiencia : 0;
        const efic2 = rec2 ? rec2.eficiencia : 0;
        const eficGrowth = efic1 > 0 ? ((efic2 - efic1) / efic1 * 100) : 0;

        html += `
          <tr>
            <td><strong>${month}</strong></td>
            <td>${rec1 ? conv1.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
            <td>${rec2 ? conv2.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
            <td>
              ${rec1 && rec2 ? `<span class="${convGrowth >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${convGrowth >= 0 ? '+' : ''}${convGrowth.toFixed(1)}%</span>` : '<span class="text-slate-600">-</span>'}
            </td>
            <td>${rec1 ? efic1.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
            <td>${rec2 ? efic2.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
            <td>
              ${rec1 && rec2 ? `<span class="${eficGrowth >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${eficGrowth >= 0 ? '+' : ''}${eficGrowth.toFixed(1)}%</span>` : '<span class="text-slate-600">-</span>'}
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      resultsContainer.innerHTML = html;
    }

    /********************************************************************
     * YEAR TO YEAR COMPARISON
     ********************************************************************/
    function renderYearComparison() {
      const year1 = document.getElementById("year_compare_1").value;
      const year2 = document.getElementById("year_compare_2").value;
      const sellerFilter = document.getElementById("seller_compare_filter").value;
      const resultsContainer = document.getElementById("year_comparison_results");
      const viewBtn = document.getElementById("view_year_comparison_fullscreen_btn");

      if (!year1 || !year2) {
        viewBtn.classList.add("hidden");
        resultsContainer.innerHTML = `
          <div class="gradient-bg rounded-2xl p-10 card-shadow text-center">
            <div class="text-6xl mb-6">üìÖ</div>
            <h3 class="text-3xl font-bold text-white mb-3">Selecione os Anos</h3>
            <p class="text-slate-400 text-lg">Escolha o ano base e o ano atual para ver o comparativo de crescimento.</p>
          </div>
        `;
        return;
      }
      
      viewBtn.classList.remove("hidden");

      // Filter records by years - EXCLUDE "Loja" from year comparison
      let records1 = allRecords.filter(r => r.year === year1 && r.seller_name.toLowerCase() !== 'loja');
      let records2 = allRecords.filter(r => r.year === year2 && r.seller_name.toLowerCase() !== 'loja');

      if (sellerFilter) {
        records1 = records1.filter(r => r.seller_name === sellerFilter);
        records2 = records2.filter(r => r.seller_name === sellerFilter);
      }

      if (records1.length === 0 && records2.length === 0) {
        resultsContainer.innerHTML = `
          <div class="gradient-bg rounded-2xl p-10 card-shadow text-center">
            <div class="text-6xl mb-6">üìä</div>
            <h3 class="text-3xl font-bold text-white mb-3">Nenhum Dado Encontrado</h3>
            <p class="text-slate-400 text-lg">N√£o h√° registros para os anos selecionados${sellerFilter ? ' e vendedor filtrado' : ''}.</p>
          </div>
        `;
        return;
      }

      const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                     "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      // Group by seller and month
      const sellers = [...new Set([...records1.map(r => r.seller_name), ...records2.map(r => r.seller_name)])].sort();

      let html = '';

      // Summary Cards
      const avgConvYear1 = records1.length > 0 ? records1.reduce((sum, r) => sum + r.taxa_conversao, 0) / records1.length : 0;
      const avgConvYear2 = records2.length > 0 ? records2.reduce((sum, r) => sum + r.taxa_conversao, 0) / records2.length : 0;
      const avgEficYear1 = records1.length > 0 ? records1.reduce((sum, r) => sum + r.eficiencia, 0) / records1.length : 0;
      const avgEficYear2 = records2.length > 0 ? records2.reduce((sum, r) => sum + r.eficiencia, 0) / records2.length : 0;

      const convGrowth = avgConvYear1 > 0 ? ((avgConvYear2 - avgConvYear1) / avgConvYear1 * 100) : 0;
      const eficGrowth = avgEficYear1 > 0 ? ((avgEficYear2 - avgEficYear1) / avgEficYear1 * 100) : 0;

      html += `
        <section class="mb-10">
          <h2 class="text-3xl font-bold text-white mb-8">Resumo Geral: ${year1} vs ${year2}</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="metric-card">
              <div class="text-slate-400 text-sm font-semibold mb-2">Crescimento em Convers√£o</div>
              <div class="metric-value ${convGrowth >= 0 ? 'text-green-400' : 'text-red-400'}" style="background: ${convGrowth >= 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                ${convGrowth >= 0 ? '+' : ''}${convGrowth.toFixed(1)}%
              </div>
              <div class="text-slate-500 text-sm mt-2">
                ${year1}: ${avgConvYear1.toFixed(1)}% ‚Üí ${year2}: ${avgConvYear2.toFixed(1)}%
              </div>
            </div>
            <div class="metric-card">
              <div class="text-slate-400 text-sm font-semibold mb-2">Crescimento em Efici√™ncia</div>
              <div class="metric-value ${eficGrowth >= 0 ? 'text-green-400' : 'text-red-400'}" style="background: ${eficGrowth >= 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                ${eficGrowth >= 0 ? '+' : ''}${eficGrowth.toFixed(1)}%
              </div>
              <div class="text-slate-500 text-sm mt-2">
                ${year1}: ${avgEficYear1.toFixed(1)}% ‚Üí ${year2}: ${avgEficYear2.toFixed(1)}%
              </div>
            </div>
          </div>
        </section>
      `;

      // Detailed comparison by seller
      sellers.forEach(seller => {
        const sellerRecords1 = records1.filter(r => r.seller_name === seller);
        const sellerRecords2 = records2.filter(r => r.seller_name === seller);

        if (sellerRecords1.length === 0 && sellerRecords2.length === 0) return;

        // Create month-by-month comparison
        const monthData = {};
        months.forEach(month => {
          const rec1 = sellerRecords1.find(r => r.month === month);
          const rec2 = sellerRecords2.find(r => r.month === month);
          
          if (rec1 || rec2) {
            monthData[month] = {
              year1: rec1 || null,
              year2: rec2 || null
            };
          }
        });

        if (Object.keys(monthData).length === 0) return;

        // Calculate seller totals
        const sellerAvgConv1 = sellerRecords1.length > 0 ? sellerRecords1.reduce((sum, r) => sum + r.taxa_conversao, 0) / sellerRecords1.length : 0;
        const sellerAvgConv2 = sellerRecords2.length > 0 ? sellerRecords2.reduce((sum, r) => sum + r.taxa_conversao, 0) / sellerRecords2.length : 0;
        const sellerAvgEfic1 = sellerRecords1.length > 0 ? sellerRecords1.reduce((sum, r) => sum + r.eficiencia, 0) / sellerRecords1.length : 0;
        const sellerAvgEfic2 = sellerRecords2.length > 0 ? sellerRecords2.reduce((sum, r) => sum + r.eficiencia, 0) / sellerRecords2.length : 0;

        const sellerConvGrowth = sellerAvgConv1 > 0 ? ((sellerAvgConv2 - sellerAvgConv1) / sellerAvgConv1 * 100) : 0;
        const sellerEficGrowth = sellerAvgEfic1 > 0 ? ((sellerAvgEfic2 - sellerAvgEfic1) / sellerAvgEfic1 * 100) : 0;

        html += `
          <section class="gradient-bg rounded-2xl p-10 card-shadow mb-10">
            <div class="mb-8">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-3xl font-bold text-white">${seller}</h3>
                <div class="flex gap-4">
                  <span class="seller-badge" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">${year1}</span>
                  <span class="seller-badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">${year2}</span>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-slate-800 rounded-lg p-5">
                  <div class="text-slate-400 text-xs mb-2">Crescimento Convers√£o</div>
                  <div class="text-3xl font-bold ${sellerConvGrowth >= 0 ? 'text-green-400' : 'text-red-400'}">
                    ${sellerConvGrowth >= 0 ? '+' : ''}${sellerConvGrowth.toFixed(1)}%
                  </div>
                  <div class="text-slate-500 text-sm mt-2">
                    ${sellerAvgConv1.toFixed(1)}% ‚Üí ${sellerAvgConv2.toFixed(1)}%
                  </div>
                </div>
                <div class="bg-slate-800 rounded-lg p-5">
                  <div class="text-slate-400 text-xs mb-2">Crescimento Efici√™ncia</div>
                  <div class="text-3xl font-bold ${sellerEficGrowth >= 0 ? 'text-green-400' : 'text-red-400'}">
                    ${sellerEficGrowth >= 0 ? '+' : ''}${sellerEficGrowth.toFixed(1)}%
                  </div>
                  <div class="text-slate-500 text-sm mt-2">
                    ${sellerAvgEfic1.toFixed(1)}% ‚Üí ${sellerAvgEfic2.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>M√™s</th>
                    <th>${year1} - Convers√£o</th>
                    <th>${year2} - Convers√£o</th>
                    <th>Crescimento Conv.</th>
                    <th>${year1} - Efici√™ncia</th>
                    <th>${year2} - Efici√™ncia</th>
                    <th>Crescimento Efic.</th>
                  </tr>
                </thead>
                <tbody>
        `;

        months.forEach(month => {
          const data = monthData[month];
          if (!data) return;

          const rec1 = data.year1;
          const rec2 = data.year2;

          const conv1 = rec1 ? rec1.taxa_conversao : 0;
          const conv2 = rec2 ? rec2.taxa_conversao : 0;
          const convGrowth = conv1 > 0 ? ((conv2 - conv1) / conv1 * 100) : 0;

          const efic1 = rec1 ? rec1.eficiencia : 0;
          const efic2 = rec2 ? rec2.eficiencia : 0;
          const eficGrowth = efic1 > 0 ? ((efic2 - efic1) / efic1 * 100) : 0;

          html += `
            <tr>
              <td><strong>${month}</strong></td>
              <td>${rec1 ? conv1.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
              <td>${rec2 ? conv2.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
              <td>
                ${rec1 && rec2 ? `<span class="${convGrowth >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${convGrowth >= 0 ? '+' : ''}${convGrowth.toFixed(1)}%</span>` : '<span class="text-slate-600">-</span>'}
              </td>
              <td>${rec1 ? efic1.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
              <td>${rec2 ? efic2.toFixed(2) + '%' : '<span class="text-slate-600">-</span>'}</td>
              <td>
                ${rec1 && rec2 ? `<span class="${eficGrowth >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${eficGrowth >= 0 ? '+' : ''}${eficGrowth.toFixed(1)}%</span>` : '<span class="text-slate-600">-</span>'}
              </td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </section>
        `;
      });

      resultsContainer.innerHTML = html;
    }

    /********************************************************************
     * LOJA ANNUAL VIEW
     ********************************************************************/
    function renderLojaAnnualView() {
      const modal = document.getElementById("loja_annual_view_modal");
      const content = document.getElementById("loja_annual_view_content");
      
      // Filter only "Loja" records
      const lojaRecords = allRecords.filter(r => r.seller_name.toLowerCase() === "loja");
      
      if (lojaRecords.length === 0) {
        content.innerHTML = `
          <div class="text-center py-24">
            <div class="text-7xl mb-6">üè™</div>
            <h3 class="text-3xl font-bold text-white mb-3">Nenhum dado da Loja dispon√≠vel</h3>
            <p class="text-slate-400 text-lg">Adicione registros com o nome "Loja" na aba "Inserir Dados" para visualizar a an√°lise anual completa.</p>
          </div>
        `;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        return;
      }

      const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                     "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      // Get all unique years
      const years = [...new Set(lojaRecords.map(r => r.year))].sort();

      // Calculate overall metrics
      const avgConversao = lojaRecords.reduce((sum, r) => sum + r.taxa_conversao, 0) / lojaRecords.length;
      const avgEficiencia = lojaRecords.reduce((sum, r) => sum + r.eficiencia, 0) / lojaRecords.length;
      
      let overallPerformance = 'good';
      if (avgConversao >= 40 && avgEficiencia >= 8) {
        overallPerformance = 'excellent';
      } else if (avgConversao < 25 || avgEficiencia < 5) {
        overallPerformance = 'critical';
      } else if (avgConversao < 30 || avgEficiencia < 7) {
        overallPerformance = 'warning';
      }

      const performanceLabels = {
        'excellent': 'EXCELENTE',
        'good': 'BOM',
        'warning': 'ATEN√á√ÉO',
        'critical': 'CR√çTICO'
      };

      let html = `
        <div class="annual-seller-card">
          <div class="annual-seller-header">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-2xl font-bold text-white mb-2">üè™ Loja</h3>
                <div class="flex gap-4 text-sm">
                  <span class="text-blue-200">${lojaRecords.length} meses registrados</span>
                </div>
              </div>
              <div class="text-right">
                <span class="performance-badge ${overallPerformance}">${performanceLabels[overallPerformance]}</span>
                <div class="text-white text-sm mt-2">
                  <div>Convers√£o M√©dia: <strong>${avgConversao.toFixed(1)}%</strong></div>
                  <div>Efici√™ncia M√©dia: <strong>${avgEficiencia.toFixed(1)}%</strong></div>
                </div>
              </div>
            </div>
          </div>

          <div class="annual-month-grid">
      `;

      years.forEach(year => {
        months.forEach(month => {
          const record = lojaRecords.find(r => r.month === month && r.year === year);

          if (record) {
            let cardClass = 'annual-month-card';
            let statusIcon = 'üìä';
            
            if (record.taxa_conversao >= 40 && record.eficiencia >= 8) {
              cardClass += ' good';
              statusIcon = 'üü¢';
            } else if (record.taxa_conversao < 25 || record.eficiencia < 5) {
              cardClass += ' critical';
              statusIcon = 'üî¥';
            } else if (record.taxa_conversao < 30 || record.eficiencia < 7) {
              cardClass += ' warning';
              statusIcon = 'üü°';
            } else {
              cardClass += ' good';
              statusIcon = 'üü¢';
            }

            html += `
              <div class="${cardClass}">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-base font-bold text-white">${month} ${year}</h4>
                  <span class="text-2xl">${statusIcon}</span>
                </div>
                
                <div class="space-y-2">
                  <div class="annual-metric-row">
                    <span class="text-slate-400 text-xs">Taxa Convers√£o</span>
                    <span class="text-white font-bold text-xs ${record.taxa_conversao < 30 ? 'text-red-400' : 'text-green-400'}">
                      ${record.taxa_conversao.toFixed(1)}%
                    </span>
                  </div>
                  
                  <div class="annual-metric-row">
                    <span class="text-slate-400 text-xs">Efici√™ncia</span>
                    <span class="text-white font-bold text-xs ${record.eficiencia < 7 ? 'text-red-400' : 'text-green-400'}">
                      ${record.eficiencia.toFixed(1)}%
                    </span>
                  </div>
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="annual-month-card" style="opacity: 0.3; border-style: dashed;">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-base font-bold text-slate-500">${month} ${year}</h4>
                  <span class="text-2xl">‚ö™</span>
                </div>
                <div class="text-center py-4">
                  <span class="text-slate-600 text-xs">Sem dados</span>
                </div>
              </div>
            `;
          }
        });
      });

      html += `
          </div>
        </div>
      `;

      // Add legend
      html += `
        <div class="gradient-bg rounded-2xl p-8 mt-10">
          <h3 class="text-2xl font-bold text-white mb-6">Legenda de Performance</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="flex items-center gap-4">
              <span class="text-4xl">üü¢</span>
              <div>
                <div class="text-white font-semibold text-base">Bom / Excelente</div>
                <div class="text-slate-400 text-sm">Convers√£o ‚â• 30% e Efici√™ncia ‚â• 7%</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-4xl">üü°</span>
              <div>
                <div class="text-white font-semibold text-base">Aten√ß√£o</div>
                <div class="text-slate-400 text-sm">Convers√£o 25-30% ou Efici√™ncia 5-7%</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-4xl">üî¥</span>
              <div>
                <div class="text-white font-semibold text-base">Cr√≠tico</div>
                <div class="text-slate-400 text-sm">Convers√£o < 25% ou Efici√™ncia < 5%</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚ö™</span>
              <div>
                <div class="text-white font-semibold text-base">Sem Dados</div>
                <div class="text-slate-400 text-sm">M√™s sem registro</div>
              </div>
            </div>
          </div>
        </div>
      `;

      content.innerHTML = html;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    /********************************************************************
     * ANNUAL VIEW
     ********************************************************************/
    function renderAnnualView() {
      const modal = document.getElementById("annual_view_modal");
      const content = document.getElementById("annual_view_content");
      
      // EXCLUDE "Loja" from annual view - only show sellers
      const sellerRecords = allRecords.filter(r => r.seller_name.toLowerCase() !== 'loja');
      
      if (sellerRecords.length === 0) {
        content.innerHTML = `
          <div class="text-center py-24">
            <div class="text-7xl mb-6">üìä</div>
            <h3 class="text-3xl font-bold text-white mb-3">Nenhum dado dispon√≠vel</h3>
            <p class="text-slate-400 text-lg">Adicione registros de vendedores na aba "Inserir Dados" para visualizar a an√°lise anual completa.</p>
          </div>
        `;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        return;
      }

      // Group by seller
      const sellerData = {};
      sellerRecords.forEach(record => {
        if (!sellerData[record.seller_name]) {
          sellerData[record.seller_name] = {};
        }
        const key = `${record.month}-${record.year}`;
        sellerData[record.seller_name][key] = record;
      });

      const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                     "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      let html = '';

      // Sort sellers alphabetically
      const sortedSellers = Object.keys(sellerData).sort();

      sortedSellers.forEach(sellerName => {
        const sellerRecords = sellerData[sellerName];
        
        // Calculate overall metrics for this seller
        const allSellerRecords = Object.values(sellerRecords);
        const avgConversao = allSellerRecords.reduce((sum, r) => sum + r.taxa_conversao, 0) / allSellerRecords.length;
        const avgEficiencia = allSellerRecords.reduce((sum, r) => sum + r.eficiencia, 0) / allSellerRecords.length;
        
        // Determine overall performance
        let overallPerformance = 'good';
        if (avgConversao >= 40 && avgEficiencia >= 8) {
          overallPerformance = 'excellent';
        } else if (avgConversao < 25 || avgEficiencia < 5) {
          overallPerformance = 'critical';
        } else if (avgConversao < 30 || avgEficiencia < 7) {
          overallPerformance = 'warning';
        }

        const performanceLabels = {
          'excellent': 'EXCELENTE',
          'good': 'BOM',
          'warning': 'ATEN√á√ÉO',
          'critical': 'CR√çTICO'
        };

        html += `
          <div class="annual-seller-card">
            <div class="annual-seller-header">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-2xl font-bold text-white mb-2">${sellerName}</h3>
                  <div class="flex gap-4 text-sm">
                    <span class="text-blue-200">${allSellerRecords.length} meses registrados</span>
                  </div>
                </div>
                <div class="text-right">
                  <span class="performance-badge ${overallPerformance}">${performanceLabels[overallPerformance]}</span>
                  <div class="text-white text-sm mt-2">
                    <div>Convers√£o M√©dia: <strong>${avgConversao.toFixed(1)}%</strong></div>
                    <div>Efici√™ncia M√©dia: <strong>${avgEficiencia.toFixed(1)}%</strong></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="annual-month-grid">
        `;

        // Get all unique years for this seller
        const years = [...new Set(allSellerRecords.map(r => r.year))].sort();

        years.forEach(year => {
          months.forEach(month => {
            const key = `${month}-${year}`;
            const record = sellerRecords[key];

            if (record) {
              // Determine card status based on metrics
              let cardClass = 'annual-month-card';
              let statusIcon = 'üìä';
              
              if (record.taxa_conversao >= 40 && record.eficiencia >= 8) {
                cardClass += ' good';
                statusIcon = 'üü¢';
              } else if (record.taxa_conversao < 25 || record.eficiencia < 5) {
                cardClass += ' critical';
                statusIcon = 'üî¥';
              } else if (record.taxa_conversao < 30 || record.eficiencia < 7) {
                cardClass += ' warning';
                statusIcon = 'üü°';
              } else {
                cardClass += ' good';
                statusIcon = 'üü¢';
              }

              html += `
                <div class="${cardClass}">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-base font-bold text-white">${month} ${year}</h4>
                    <span class="text-2xl">${statusIcon}</span>
                  </div>
                  
                  <div class="space-y-2">
                    <div class="annual-metric-row">
                      <span class="text-slate-400 text-xs">Taxa Convers√£o</span>
                      <span class="text-white font-bold text-xs ${record.taxa_conversao < 30 ? 'text-red-400' : 'text-green-400'}">
                        ${record.taxa_conversao.toFixed(1)}%
                      </span>
                    </div>
                    
                    <div class="annual-metric-row">
                      <span class="text-slate-400 text-xs">Efici√™ncia</span>
                      <span class="text-white font-bold text-xs ${record.eficiencia < 7 ? 'text-red-400' : 'text-green-400'}">
                        ${record.eficiencia.toFixed(1)}%
                      </span>
                    </div>
                  </div>
                </div>
              `;
            } else {
              // Empty month placeholder
              html += `
                <div class="annual-month-card" style="opacity: 0.3; border-style: dashed;">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-base font-bold text-slate-500">${month} ${year}</h4>
                    <span class="text-2xl">‚ö™</span>
                  </div>
                  <div class="text-center py-4">
                    <span class="text-slate-600 text-xs">Sem dados</span>
                  </div>
                </div>
              `;
            }
          });
        });

        html += `
            </div>
          </div>
        `;
      });

      // Add legend at the bottom
      html += `
        <div class="gradient-bg rounded-2xl p-8 mt-10">
          <h3 class="text-2xl font-bold text-white mb-6">Legenda de Performance</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="flex items-center gap-4">
              <span class="text-4xl">üü¢</span>
              <div>
                <div class="text-white font-semibold text-base">Bom / Excelente</div>
                <div class="text-slate-400 text-sm">Convers√£o ‚â• 30% e Efici√™ncia ‚â• 7%</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-4xl">üü°</span>
              <div>
                <div class="text-white font-semibold text-base">Aten√ß√£o</div>
                <div class="text-slate-400 text-sm">Convers√£o 25-30% ou Efici√™ncia 5-7%</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-4xl">üî¥</span>
              <div>
                <div class="text-white font-semibold text-base">Cr√≠tico</div>
                <div class="text-slate-400 text-sm">Convers√£o < 25% ou Efici√™ncia < 5%</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚ö™</span>
              <div>
                <div class="text-white font-semibold text-base">Sem Dados</div>
                <div class="text-slate-400 text-sm">M√™s sem registro</div>
              </div>
            </div>
          </div>
        </div>
      `;

      content.innerHTML = html;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    /********************************************************************
     * FULLSCREEN VIEW FUNCTIONS
     ********************************************************************/
    
    function openChartFullscreen() {
      const modal = document.getElementById("chart_fullscreen_modal");
      const titleElement = document.getElementById("chart_fullscreen_title");
      const chartTitle = document.getElementById("chart_title");
      
      if (chartTitle) {
        titleElement.textContent = chartTitle.textContent;
      }
      
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      
      // Render chart in fullscreen
      setTimeout(() => {
        renderComparisonChartFullscreen();
      }, 100);
    }

    function openLojaChartFullscreen() {
      const modal = document.getElementById("chart_fullscreen_modal");
      const titleElement = document.getElementById("chart_fullscreen_title");
      const chartTitle = document.getElementById("loja_chart_title");
      
      if (chartTitle) {
        titleElement.textContent = chartTitle.textContent;
      }
      
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      
      // Render loja chart in fullscreen
      setTimeout(() => {
        renderLojaChartFullscreen();
      }, 100);
    }

    function renderComparisonChartFullscreen() {
      // Use the same logic as renderComparisonChart but target fullscreen SVG
      const svg = document.getElementById("comparison_chart_fullscreen");
      const legendContainer = document.getElementById("chart_legend_fullscreen");
      
      if (!svg) return;

      const width = svg.clientWidth || 1200;
      const height = 600;
      const padding = { top: 60, right: 40, bottom: 100, left: 80 };

      svg.innerHTML = "";
      legendContainer.innerHTML = "";

      // Get filtered records
      // CRITICAL: EXCLUDE "Loja" from fullscreen chart - this is ONLY for sellers
      let filtered = allRecords.filter(r => r.seller_name.toLowerCase() !== 'loja');
      
      if (selectedSellerComparison) {
        filtered = filtered.filter(r => r.seller_name === selectedSellerComparison);
      }
      
      if (comparisonMode === "mensal") {
        const month = document.getElementById("compare_month").value;
        const year = document.getElementById("compare_year").value;
        if (month) filtered = filtered.filter(r => r.month === month);
        if (year) filtered = filtered.filter(r => r.year === year);
      } else {
        const startMonth = document.getElementById("period_start").value;
        const endMonth = document.getElementById("period_end").value;
        const year = document.getElementById("period_year").value;
        const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const startIdx = months.indexOf(startMonth);
        const endIdx = months.indexOf(endMonth);
        filtered = filtered.filter(r => {
          if (r.year !== year) return false;
          const monthIdx = months.indexOf(r.month);
          return monthIdx >= startIdx && monthIdx <= endIdx;
        });
      }

      if (filtered.length === 0) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", width / 2);
        text.setAttribute("y", height / 2);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#94a3b8");
        text.setAttribute("font-size", "18");
        text.textContent = "Nenhum dado dispon√≠vel para o per√≠odo selecionado";
        svg.appendChild(text);
        return;
      }

      const isIndividualSeller = selectedSellerComparison !== "";
      const sellerNames = [...new Set(filtered.map(r => r.seller_name))];
      const periods = [...new Set(filtered.map(r => `${r.month}/${r.year}`))].sort();
      
      const chartData = {};
      filtered.forEach(record => {
        const period = `${record.month}/${record.year}`;
        if (!chartData[record.seller_name]) {
          chartData[record.seller_name] = {};
        }
        if (!chartData[record.seller_name][period]) {
          chartData[record.seller_name][period] = {
            conversao: 0,
            eficiencia: 0,
            count: 0,
            month: record.month,
            year: record.year
          };
        }
        chartData[record.seller_name][period].conversao += record.taxa_conversao;
        chartData[record.seller_name][period].eficiencia += record.eficiencia;
        chartData[record.seller_name][period].count++;
      });

      Object.values(chartData).forEach(seller => {
        Object.values(seller).forEach(period => {
          if (period.count > 0) {
            period.conversao = period.conversao / period.count;
            period.eficiencia = period.eficiencia / period.count;
          }
        });
      });

      const sellerAverages = {};
      sellerNames.forEach(seller => {
        const periods = Object.values(chartData[seller] || {});
        if (periods.length > 0) {
          const sum = periods.reduce((acc, p) => acc + p[currentMetric], 0);
          sellerAverages[seller] = sum / periods.length;
        } else {
          sellerAverages[seller] = 0;
        }
      });

      if (!isIndividualSeller) {
        sellerNames.sort((a, b) => sellerAverages[b] - sellerAverages[a]);
      }

      let maxDataValue = 0;
      
      if (isIndividualSeller) {
        const seller = sellerNames[0];
        periods.forEach(period => {
          const data = chartData[seller] && chartData[seller][period];
          if (data) {
            const value = data[currentMetric];
            if (value > maxDataValue) maxDataValue = value;
          }
        });
      } else {
        sellerNames.forEach(seller => {
          periods.forEach(period => {
            const data = chartData[seller] && chartData[seller][period];
            if (data) {
              const value = data[currentMetric];
              if (value > maxDataValue) maxDataValue = value;
            }
          });
        });
      }
      
      let maxValue = Math.ceil(maxDataValue * 1.1);
      if (maxValue < 5) maxValue = 5;

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      let groupCount, barWidth, groupWidth;
      
      if (isIndividualSeller) {
        groupCount = periods.length;
        groupWidth = chartWidth / groupCount;
        barWidth = Math.min(groupWidth * 0.6, 80);
      } else {
        groupCount = sellerNames.length;
        groupWidth = chartWidth / groupCount;
        barWidth = Math.min(groupWidth / (periods.length + 1), 50);
      }

      const numIntervals = Math.min(Math.ceil(maxValue), 20);
      
      for (let i = 0; i <= numIntervals; i++) {
        const y = padding.top + (chartHeight * (1 - i / numIntervals));
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", padding.left);
        line.setAttribute("y1", y);
        line.setAttribute("x2", width - padding.right);
        line.setAttribute("y2", y);
        line.setAttribute("stroke", "#cbd5e1");
        line.setAttribute("stroke-opacity", "0.5");
        line.setAttribute("stroke-dasharray", "4,4");
        svg.appendChild(line);

        const val = (maxValue * i / numIntervals);
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", padding.left - 10);
        label.setAttribute("y", y + 5);
        label.setAttribute("text-anchor", "end");
        label.setAttribute("fill", "#94a3b8");
        label.setAttribute("font-size", "14");
        label.textContent = val.toFixed(1) + "%";
        svg.appendChild(label);
      }

      if (isIndividualSeller) {
        const seller = sellerNames[0];
        const monthOrder = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                           "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        const sortedPeriods = [...periods].sort((a, b) => {
          const [monthA, yearA] = a.split('/');
          const [monthB, yearB] = b.split('/');
          if (yearA !== yearB) return yearA.localeCompare(yearB);
          return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
        });
        
        sortedPeriods.forEach((period, periodIdx) => {
          const data = chartData[seller] && chartData[seller][period];
          if (!data) return;

          const metricValue = data[currentMetric];
          const barHeight = (metricValue / maxValue) * chartHeight;
          const groupX = padding.left + (periodIdx * groupWidth) + (groupWidth / 2);
          const x = groupX - (barWidth / 2);
          const y = padding.top + chartHeight - barHeight;

          let barColor;
          if (currentMetric === "eficiencia") {
            if (metricValue < 3) barColor = '#ef4444';
            else if (metricValue < 7) barColor = '#f59e0b';
            else barColor = '#10b981';
          } else if (currentMetric === "conversao") {
            if (metricValue < 15) barColor = '#ef4444';
            else if (metricValue < 30) barColor = '#f59e0b';
            else barColor = '#10b981';
          }

          const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
          rect.setAttribute("x", x);
          rect.setAttribute("y", y);
          rect.setAttribute("width", barWidth);
          rect.setAttribute("height", barHeight);
          rect.setAttribute("fill", barColor);
          rect.setAttribute("rx", "4");
          rect.setAttribute("opacity", "0.9");
          svg.appendChild(rect);

          // SEMPRE mostrar o valor, independente da altura da barra
          const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          valueLabel.setAttribute("x", groupX);
          valueLabel.setAttribute("y", y - 8);
          valueLabel.setAttribute("text-anchor", "middle");
          valueLabel.setAttribute("fill", "#1e293b");
          valueLabel.setAttribute("font-size", "14");
          valueLabel.setAttribute("font-weight", "700");
          valueLabel.textContent = metricValue.toFixed(1) + "%";
          svg.appendChild(valueLabel);

          const monthLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          monthLabel.setAttribute("x", groupX);
          monthLabel.setAttribute("y", height - padding.bottom + 25);
          monthLabel.setAttribute("text-anchor", "middle");
          monthLabel.setAttribute("fill", "#1e293b");
          monthLabel.setAttribute("font-size", "15");
          monthLabel.setAttribute("font-weight", "700");
          monthLabel.textContent = data.month;
          svg.appendChild(monthLabel);

          const yearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          yearLabel.setAttribute("x", groupX);
          yearLabel.setAttribute("y", height - padding.bottom + 45);
          yearLabel.setAttribute("text-anchor", "middle");
          yearLabel.setAttribute("fill", "#475569");
          yearLabel.setAttribute("font-size", "13");
          yearLabel.setAttribute("font-weight", "600");
          yearLabel.textContent = data.year;
          svg.appendChild(yearLabel);
        });

      } else {
        sellerNames.forEach((seller, sellerIdx) => {
          const groupX = padding.left + (sellerIdx * groupWidth) + (groupWidth / 2);
          
          periods.forEach((period, periodIdx) => {
            const data = chartData[seller] && chartData[seller][period];
            if (!data) return;

            const metricValue = data[currentMetric];
            const barHeight = (metricValue / maxValue) * chartHeight;
            const x = groupX - ((periods.length * barWidth) / 2) + (periodIdx * barWidth);
            const y = padding.top + chartHeight - barHeight;

            let barColor;
            if (currentMetric === "eficiencia") {
              if (metricValue < 3) barColor = '#ef4444';
              else if (metricValue < 7) barColor = '#f59e0b';
              else barColor = '#10b981';
            } else if (currentMetric === "conversao") {
              if (metricValue < 15) barColor = '#ef4444';
              else if (metricValue < 30) barColor = '#f59e0b';
              else barColor = '#10b981';
            }

            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("x", x);
            rect.setAttribute("y", y);
            rect.setAttribute("width", barWidth - 2);
            rect.setAttribute("height", barHeight);
            rect.setAttribute("fill", barColor);
            rect.setAttribute("rx", "4");
            rect.setAttribute("opacity", "0.9");
            svg.appendChild(rect);

            // SEMPRE mostrar o valor, independente da altura da barra
            const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            valueLabel.setAttribute("x", x + (barWidth - 2) / 2);
            valueLabel.setAttribute("y", y - 8);
            valueLabel.setAttribute("text-anchor", "middle");
            valueLabel.setAttribute("fill", "#1e293b");
            valueLabel.setAttribute("font-size", "12");
            valueLabel.setAttribute("font-weight", "700");
            valueLabel.textContent = metricValue.toFixed(1) + "%";
            svg.appendChild(valueLabel);

            // Month label inside bar for overall comparison view
            const periodParts = period.split('/');
            const monthName = periodParts[0];
            const monthCenterX = x + (barWidth - 2) / 2;
            const monthCenterY = y + barHeight / 2;
            const monthLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            monthLabel.setAttribute("x", monthCenterX);
            monthLabel.setAttribute("y", monthCenterY);
            monthLabel.setAttribute("text-anchor", "middle");
            monthLabel.setAttribute("fill", "#0f172a");
            monthLabel.setAttribute("fill-opacity", "0.45");
            monthLabel.setAttribute("font-size", "9");
            monthLabel.setAttribute("font-weight", "600");
            monthLabel.setAttribute("transform", "rotate(-90, " + monthCenterX + ", " + monthCenterY + ")");
            monthLabel.textContent = monthName;
            svg.appendChild(monthLabel);
          });

          const nameLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          nameLabel.setAttribute("x", groupX);
          nameLabel.setAttribute("y", height - padding.bottom + 25);
          nameLabel.setAttribute("text-anchor", "middle");
          nameLabel.setAttribute("fill", "#1e293b");
          nameLabel.setAttribute("font-size", "15");
          nameLabel.setAttribute("font-weight", "700");
          nameLabel.textContent = seller;
          svg.appendChild(nameLabel);
        });
      }

      const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      xAxis.setAttribute("x1", padding.left);
      xAxis.setAttribute("y1", padding.top + chartHeight);
      xAxis.setAttribute("x2", width - padding.right);
      xAxis.setAttribute("y2", padding.top + chartHeight);
      xAxis.setAttribute("stroke", "#94a3b8");
      xAxis.setAttribute("stroke-width", "2");
      svg.appendChild(xAxis);

      const yAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      yAxis.setAttribute("x1", padding.left);
      yAxis.setAttribute("y1", padding.top);
      yAxis.setAttribute("x2", padding.left);
      yAxis.setAttribute("y2", padding.top + chartHeight);
      yAxis.setAttribute("stroke", "#94a3b8");
      yAxis.setAttribute("stroke-width", "2");
      svg.appendChild(yAxis);

      // Add metric name at bottom left for fullscreen
      const metricNamesFS = {
        "conversao": "Taxa de Convers√£o",
        "eficiencia": "Efici√™ncia"
      };
      
      const metricLabelFS = document.createElementNS("http://www.w3.org/2000/svg", "text");
      metricLabelFS.setAttribute("x", padding.left);
      metricLabelFS.setAttribute("y", height - 10);
      metricLabelFS.setAttribute("text-anchor", "start");
      metricLabelFS.setAttribute("fill", "#60a5fa");
      metricLabelFS.setAttribute("font-size", "16");
      metricLabelFS.setAttribute("font-weight", "700");
      metricLabelFS.textContent = `M√©trica: ${metricNamesFS[currentMetric]}`;
      svg.appendChild(metricLabelFS);

      // Add period information at bottom right for fullscreen
      let periodTextFS = "";
      if (comparisonMode === "mensal") {
        const month = document.getElementById("compare_month").value;
        const year = document.getElementById("compare_year").value;
        
        // Se tem m√™s E ano selecionados, mostra ambos
        if (month && year) {
          periodTextFS = `Per√≠odo: ${month}/${year}`;
        } 
        // Se tem s√≥ m√™s, mostra o m√™s
        else if (month && !year) {
          periodTextFS = `Per√≠odo: ${month}`;
        } 
        // Se tem s√≥ ano, mostra o ano
        else if (!month && year) {
          periodTextFS = `Per√≠odo: ${year}`;
        }
        // Se n√£o tem nenhum filtro, pega o primeiro per√≠odo dispon√≠vel dos dados filtrados
        else {
          if (filtered.length > 0) {
            // Pega todos os per√≠odos √∫nicos dos dados filtrados
            const uniquePeriods = [...new Set(filtered.map(r => `${r.month}/${r.year}`))];
            if (uniquePeriods.length === 1) {
              // Se s√≥ tem um per√≠odo, mostra ele
              periodTextFS = `Per√≠odo: ${uniquePeriods[0]}`;
            } else {
              // Se tem m√∫ltiplos per√≠odos, mostra "Todos os meses"
              periodTextFS = "Per√≠odo: Todos os meses";
            }
          } else {
            periodTextFS = "Per√≠odo: Todos os meses";
          }
        }
      } else {
        const startMonth = document.getElementById("period_start").value;
        const endMonth = document.getElementById("period_end").value;
        const year = document.getElementById("period_year").value;
        periodTextFS = `Per√≠odo: ${startMonth} a ${endMonth}/${year}`;
      }
      
      if (selectedSellerComparison) {
        periodTextFS += ` | Vendedor: ${selectedSellerComparison}`;
      }
      
      const periodLabelFS = document.createElementNS("http://www.w3.org/2000/svg", "text");
      periodLabelFS.setAttribute("x", width - padding.right);
      periodLabelFS.setAttribute("y", height - 10);
      periodLabelFS.setAttribute("text-anchor", "end");
      periodLabelFS.setAttribute("fill", "#94a3b8");
      periodLabelFS.setAttribute("font-size", "14");
      periodLabelFS.setAttribute("font-style", "italic");
      periodLabelFS.textContent = periodTextFS;
      svg.appendChild(periodLabelFS);

      if (currentMetric === "eficiencia") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">0% a 3% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">3% a 7% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">7% ou mais (Bom)</span>
          </div>
        `;
      } else if (currentMetric === "conversao") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">0% a 15% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">15% a 30% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">30% ou mais (Bom)</span>
          </div>
        `;
      }
    }

    function renderLojaChartFullscreen() {
      const svg = document.getElementById("comparison_chart_fullscreen");
      const legendContainer = document.getElementById("chart_legend_fullscreen");
      
      if (!svg) return;

      const width = svg.clientWidth || 1200;
      const height = 600;
      const padding = { top: 60, right: 40, bottom: 100, left: 80 };

      svg.innerHTML = "";
      legendContainer.innerHTML = "";

      // Filter only "Loja" records
      let filtered = allRecords.filter(r => r.seller_name.toLowerCase() === "loja");

      if (lojaComparisonMode === "mensal") {
        const month = document.getElementById("loja_compare_month").value;
        const year = document.getElementById("loja_compare_year").value;

        if (month) filtered = filtered.filter(r => r.month === month);
        if (year) filtered = filtered.filter(r => r.year === year);
      } else {
        const startMonth = document.getElementById("loja_period_start").value;
        const endMonth = document.getElementById("loja_period_end").value;
        const year = document.getElementById("loja_period_year").value;

        const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const startIdx = months.indexOf(startMonth);
        const endIdx = months.indexOf(endMonth);

        filtered = filtered.filter(r => {
          if (r.year !== year) return false;
          const monthIdx = months.indexOf(r.month);
          return monthIdx >= startIdx && monthIdx <= endIdx;
        });
      }

      if (filtered.length === 0) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", width / 2);
        text.setAttribute("y", height / 2);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#94a3b8");
        text.setAttribute("font-size", "18");
        text.textContent = "Nenhum dado da Loja encontrado. Adicione registros com o nome 'Loja'.";
        svg.appendChild(text);
        return;
      }

      // Group by period
      const periods = [...new Set(filtered.map(r => `${r.month}/${r.year}`))];
      
      // Sort periods chronologically
      const monthOrder = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                         "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      
      const sortedPeriods = [...periods].sort((a, b) => {
        const [monthA, yearA] = a.split('/');
        const [monthB, yearB] = b.split('/');
        if (yearA !== yearB) return yearA.localeCompare(yearB);
        return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
      });

      const periodData = {};
      filtered.forEach(record => {
        const period = `${record.month}/${record.year}`;
        if (!periodData[period]) {
          periodData[period] = {
            conversao: 0,
            eficiencia: 0,
            count: 0,
            month: record.month,
            year: record.year
          };
        }
        periodData[period].conversao += record.taxa_conversao;
        periodData[period].eficiencia += record.eficiencia;
        periodData[period].count++;
      });

      // Calculate averages
      Object.values(periodData).forEach(period => {
        if (period.count > 0) {
          period.conversao = period.conversao / period.count;
          period.eficiencia = period.eficiencia / period.count;
        }
      });

      // Calculate max value
      let maxDataValue = 0;
      sortedPeriods.forEach(period => {
        const data = periodData[period];
        if (data) {
          const value = data[lojaCurrentMetric];
          if (value > maxDataValue) maxDataValue = value;
        }
      });
      
      let maxValue = Math.ceil(maxDataValue * 1.1);
      if (maxValue < 5) maxValue = 5;

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      const groupCount = sortedPeriods.length;
      const groupWidth = chartWidth / groupCount;
      const barWidth = Math.min(groupWidth * 0.6, 100);

      // Draw Y-axis grid lines
      const numIntervals = Math.min(Math.ceil(maxValue), 20);
      
      for (let i = 0; i <= numIntervals; i++) {
        const y = padding.top + (chartHeight * (1 - i / numIntervals));
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", padding.left);
        line.setAttribute("y1", y);
        line.setAttribute("x2", width - padding.right);
        line.setAttribute("y2", y);
        line.setAttribute("stroke", "#cbd5e1");
        line.setAttribute("stroke-opacity", "0.5");
        line.setAttribute("stroke-dasharray", "4,4");
        svg.appendChild(line);

        const val = (maxValue * i / numIntervals);
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", padding.left - 10);
        label.setAttribute("y", y + 5);
        label.setAttribute("text-anchor", "end");
        label.setAttribute("fill", "#94a3b8");
        label.setAttribute("font-size", "14");
        label.textContent = val.toFixed(1) + "%";
        svg.appendChild(label);
      }

      // Draw bars
      sortedPeriods.forEach((period, periodIdx) => {
        const data = periodData[period];
        if (!data) return;

        const metricValue = data[lojaCurrentMetric];
        const barHeight = (metricValue / maxValue) * chartHeight;
        const groupX = padding.left + (periodIdx * groupWidth) + (groupWidth / 2);
        const x = groupX - (barWidth / 2);
        const y = padding.top + chartHeight - barHeight;

        let barColor;
        if (lojaCurrentMetric === "eficiencia") {
          if (metricValue < 3) barColor = '#ef4444';
          else if (metricValue < 7) barColor = '#f59e0b';
          else barColor = '#10b981';
        } else if (lojaCurrentMetric === "conversao") {
          if (metricValue < 15) barColor = '#ef4444';
          else if (metricValue < 30) barColor = '#f59e0b';
          else barColor = '#10b981';
        }

        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("width", barWidth);
        rect.setAttribute("height", barHeight);
        rect.setAttribute("fill", barColor);
        rect.setAttribute("rx", "4");
        rect.setAttribute("opacity", "0.9");
        svg.appendChild(rect);

        // SEMPRE mostrar o valor, independente da altura da barra
        const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        valueLabel.setAttribute("x", groupX);
        valueLabel.setAttribute("y", y - 8);
        valueLabel.setAttribute("text-anchor", "middle");
        valueLabel.setAttribute("fill", "#1e293b");
        valueLabel.setAttribute("font-size", "15");
        valueLabel.setAttribute("font-weight", "700");
        valueLabel.textContent = metricValue.toFixed(1) + "%";
        svg.appendChild(valueLabel);

        const monthLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        monthLabel.setAttribute("x", groupX);
        monthLabel.setAttribute("y", height - padding.bottom + 25);
        monthLabel.setAttribute("text-anchor", "middle");
        monthLabel.setAttribute("fill", "#1e293b");
        monthLabel.setAttribute("font-size", "17");
        monthLabel.setAttribute("font-weight", "700");
        monthLabel.textContent = data.month;
        svg.appendChild(monthLabel);

        const yearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        yearLabel.setAttribute("x", groupX);
        yearLabel.setAttribute("y", height - padding.bottom + 45);
        yearLabel.setAttribute("text-anchor", "middle");
        yearLabel.setAttribute("fill", "#475569");
        yearLabel.setAttribute("font-size", "15");
        yearLabel.setAttribute("font-weight", "600");
        yearLabel.textContent = data.year;
        svg.appendChild(yearLabel);
      });

      // X-axis line
      const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      xAxis.setAttribute("x1", padding.left);
      xAxis.setAttribute("y1", padding.top + chartHeight);
      xAxis.setAttribute("x2", width - padding.right);
      xAxis.setAttribute("y2", padding.top + chartHeight);
      xAxis.setAttribute("stroke", "#475569");
      xAxis.setAttribute("stroke-width", "2");
      svg.appendChild(xAxis);

      // Y-axis line
      const yAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
      yAxis.setAttribute("x1", padding.left);
      yAxis.setAttribute("y1", padding.top);
      yAxis.setAttribute("x2", padding.left);
      yAxis.setAttribute("y2", padding.top + chartHeight);
      yAxis.setAttribute("stroke", "#475569");
      yAxis.setAttribute("stroke-width", "2");
      svg.appendChild(yAxis);

      // Metric label
      const metricNames = {
        "conversao": "Taxa de Convers√£o",
        "eficiencia": "Efici√™ncia"
      };
      
      const metricLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
      metricLabel.setAttribute("x", padding.left);
      metricLabel.setAttribute("y", height - 10);
      metricLabel.setAttribute("text-anchor", "start");
      metricLabel.setAttribute("fill", "#60a5fa");
      metricLabel.setAttribute("font-size", "16");
      metricLabel.setAttribute("font-weight", "700");
      metricLabel.textContent = `M√©trica: ${metricNames[lojaCurrentMetric]}`;
      svg.appendChild(metricLabel);

      // Legend
      if (lojaCurrentMetric === "eficiencia") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">0% a 3% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">3% a 7% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">7% ou mais (Bom)</span>
          </div>
        `;
      } else if (lojaCurrentMetric === "conversao") {
        legendContainer.innerHTML = `
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #ef4444; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">0% a 15% (Cr√≠tico)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #f59e0b; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">15% a 30% (Aten√ß√£o)</span>
          </div>
          <div class="flex items-center gap-3">
            <div style="width: 28px; height: 28px; background: #10b981; border-radius: 4px;"></div>
            <span class="text-slate-300 text-base font-semibold">30% ou mais (Bom)</span>
          </div>
        `;
      }
    }

    function openYearComparisonFullscreen() {
      const modal = document.getElementById("year_comparison_fullscreen_modal");
      const content = document.getElementById("year_comparison_fullscreen_content");
      
      // Clone the year comparison results
      const resultsElement = document.getElementById("year_comparison_results");
      content.innerHTML = resultsElement.innerHTML;
      
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    /********************************************************************
     * EVENT LISTENERS
     ********************************************************************/
    
    // Tab switching
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        e.currentTarget.classList.add("active");
        
        currentTab = e.currentTarget.getAttribute("data-tab");
        
        document.querySelectorAll(".tab-content").forEach(content => {
          content.classList.add("hidden");
        });
        
        document.getElementById(`tab_${currentTab}`).classList.remove("hidden");
        
        if (currentTab === "comparativos") {
          renderComparisons();
        } else if (currentTab === "anual") {
          renderYearComparison();
        } else if (currentTab === "loja") {
          renderLojaAnalysis();
          renderLojaYearComparison();
        } else if (currentTab === "compilado") {
          renderCompiladoGeral();
        }
      });
    });

    // Metric switching
    document.querySelectorAll("[data-metric]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll("[data-metric]").forEach(b => b.classList.remove("active"));
        e.currentTarget.classList.add("active");
        
        currentMetric = e.currentTarget.getAttribute("data-metric");
        renderComparisons();
      });
    });

    // Comparison mode switching
    document.querySelectorAll("[data-mode]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll("[data-mode]").forEach(b => b.classList.remove("active"));
        e.currentTarget.classList.add("active");
        
        comparisonMode = e.currentTarget.getAttribute("data-mode");
        
        if (comparisonMode === "mensal") {
          document.getElementById("filter_mensal").classList.remove("hidden");
          document.getElementById("filter_periodo").classList.add("hidden");
        } else {
          document.getElementById("filter_mensal").classList.add("hidden");
          document.getElementById("filter_periodo").classList.remove("hidden");
        }
        
        renderComparisons();
      });
    });

    // Filter changes
    document.getElementById("filter_seller_comparison").addEventListener("change", (e) => {
      selectedSellerComparison = e.target.value;
      renderComparisons();
    });
    document.getElementById("compare_month").addEventListener("change", renderComparisons);
    document.getElementById("compare_year").addEventListener("change", renderComparisons);
    document.getElementById("period_start").addEventListener("change", renderComparisons);
    document.getElementById("period_end").addEventListener("change", renderComparisons);
    document.getElementById("period_year").addEventListener("change", renderComparisons);

    // Year comparison filters
    document.getElementById("year_compare_1").addEventListener("change", renderYearComparison);
    document.getElementById("year_compare_2").addEventListener("change", renderYearComparison);
    document.getElementById("seller_compare_filter").addEventListener("change", renderYearComparison);

    // Year metric switching
    document.querySelectorAll("[data-year-metric]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll("[data-year-metric]").forEach(b => b.classList.remove("active"));
        e.currentTarget.classList.add("active");
        
        yearMetric = e.currentTarget.getAttribute("data-year-metric");
        renderYearComparison();
      });
    });

    // Loja metric switching
    document.querySelectorAll("[data-loja-metric]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll("[data-loja-metric]").forEach(b => b.classList.remove("active"));
        e.currentTarget.classList.add("active");
        
        lojaCurrentMetric = e.currentTarget.getAttribute("data-loja-metric");
        renderLojaAnalysis();
      });
    });

    // Loja comparison mode switching
    document.querySelectorAll("[data-loja-mode]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll("[data-loja-mode]").forEach(b => b.classList.remove("active"));
        e.currentTarget.classList.add("active");
        
        lojaComparisonMode = e.currentTarget.getAttribute("data-loja-mode");
        
        if (lojaComparisonMode === "mensal") {
          document.getElementById("filter_loja_mensal").classList.remove("hidden");
          document.getElementById("filter_loja_periodo").classList.add("hidden");
        } else {
          document.getElementById("filter_loja_mensal").classList.add("hidden");
          document.getElementById("filter_loja_periodo").classList.remove("hidden");
        }
        
        renderLojaAnalysis();
      });
    });

    // Loja filter changes
    document.getElementById("loja_compare_month").addEventListener("change", renderLojaAnalysis);
    document.getElementById("loja_compare_year").addEventListener("change", renderLojaAnalysis);
    document.getElementById("loja_period_start").addEventListener("change", renderLojaAnalysis);
    document.getElementById("loja_period_end").addEventListener("change", renderLojaAnalysis);
    document.getElementById("loja_period_year").addEventListener("change", renderLojaAnalysis);

    // Loja year comparison filters
    document.getElementById("loja_year_compare_1").addEventListener("change", renderLojaYearComparison);
    document.getElementById("loja_year_compare_2").addEventListener("change", renderLojaYearComparison);
    
    // Seller filter in table
    document.getElementById("filter_seller_table").addEventListener("change", (e) => {
      selectedSellerFilter = e.target.value;
      renderTable();
    });

    // Toggle form visibility
    document.getElementById("toggle_form_btn").addEventListener("click", () => {
      const form = document.getElementById("insert_form");
      const icon = document.getElementById("toggle_icon");
      const text = document.getElementById("toggle_text");
      
      if (form.style.display === "none") {
        form.style.display = "block";
        icon.textContent = "‚ñº";
        text.textContent = "Recolher Formul√°rio";
      } else {
        form.style.display = "none";
        icon.textContent = "‚ñ∂";
        text.textContent = "Expandir Formul√°rio";
      }
    });

    // Annual view modal
    document.getElementById("show_annual_view_btn").addEventListener("click", () => {
      renderAnnualView();
    });

    document.getElementById("close_annual_view_btn").addEventListener("click", () => {
      const modal = document.getElementById("annual_view_modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    // Close modal on background click
    document.getElementById("annual_view_modal").addEventListener("click", (e) => {
      if (e.target.id === "annual_view_modal") {
        const modal = document.getElementById("annual_view_modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });

    // Loja annual view modal
    document.getElementById("show_loja_annual_view_btn").addEventListener("click", () => {
      renderLojaAnnualView();
    });

    document.getElementById("close_loja_annual_view_btn").addEventListener("click", () => {
      const modal = document.getElementById("loja_annual_view_modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    // Close loja modal on background click
    document.getElementById("loja_annual_view_modal").addEventListener("click", (e) => {
      if (e.target.id === "loja_annual_view_modal") {
        const modal = document.getElementById("loja_annual_view_modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });

    // Download chart button
    document.getElementById("download_chart_btn").addEventListener("click", () => {
      downloadChartAsImage();
    });

    function downloadChartAsImage() {
      const svg = document.getElementById("comparison_chart");
      
      // Get SVG data
      const svgData = new XMLSerializer().serializeToString(svg);
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      
      // Set canvas size to match SVG (with scale for better quality)
      const svgWidth = svg.clientWidth || 800;
      const svgHeight = svg.clientHeight || 700;
      const scale = 2; // Higher resolution
      canvas.width = svgWidth * scale;
      canvas.height = svgHeight * scale;
      
      // Scale context for better quality
      ctx.scale(scale, scale);
      
      // Fill white background
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, svgWidth, svgHeight);
      
      const img = new Image();
      const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);
      
      img.onload = function() {
        ctx.drawImage(img, 0, 0, svgWidth, svgHeight);
        URL.revokeObjectURL(url);
        
        // Convert to PNG and download
        canvas.toBlob(function(blob) {
          if (blob) {
            const link = document.createElement("a");
            const timestamp = new Date().toISOString().slice(0, 10);
            link.download = `grafico-comparativo-${timestamp}.png`;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
            showToast("Imagem baixada com sucesso!");
          } else {
            showToast("Erro ao gerar imagem", "error");
          }
        }, "image/png");
      };
      
      img.onerror = function() {
        URL.revokeObjectURL(url);
        showToast("Erro ao carregar gr√°fico", "error");
      };
      
      img.src = url;
    }

    // Fullscreen view buttons
    document.getElementById("view_chart_fullscreen_btn").addEventListener("click", () => {
      openChartFullscreen();
    });

    document.getElementById("view_loja_chart_fullscreen_btn").addEventListener("click", () => {
      openLojaChartFullscreen();
    });

    document.getElementById("view_year_comparison_fullscreen_btn").addEventListener("click", () => {
      openYearComparisonFullscreen();
    });

    // Close fullscreen modals
    document.getElementById("close_chart_fullscreen_btn").addEventListener("click", () => {
      const modal = document.getElementById("chart_fullscreen_modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    document.getElementById("close_year_comparison_fullscreen_btn").addEventListener("click", () => {
      const modal = document.getElementById("year_comparison_fullscreen_modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    // Close modals on background click
    document.getElementById("chart_fullscreen_modal").addEventListener("click", (e) => {
      if (e.target.id === "chart_fullscreen_modal") {
        const modal = document.getElementById("chart_fullscreen_modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });

    document.getElementById("year_comparison_fullscreen_modal").addEventListener("click", (e) => {
      if (e.target.id === "year_comparison_fullscreen_modal") {
        const modal = document.getElementById("year_comparison_fullscreen_modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });

    // Resize handling
    window.addEventListener("resize", () => {
      if (currentTab === "comparativos") {
        renderComparisons();
      }
    });

    /********************************************************************
     * INITIALIZATION
     ********************************************************************/
    document.addEventListener("DOMContentLoaded", async () => {
      await initDataSdk();
      
      if (window.elementSdk && window.elementSdk.config) {
        applyConfigToUI({ ...defaultConfig, ...window.elementSdk.config });
      } else {
        applyConfigToUI(defaultConfig);
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a852e1141386f85',t:'MTc2NDc4NzA5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <!-- Painel Executivo Individual - Dashboard por Vendedor -->
  <div id="seller_dashboard_modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center" style="z-index: 9999; padding: 20px;">
    <div class="bg-slate-900 rounded-2xl w-full h-full overflow-auto max-w-6xl mx-auto flex flex-col" style="max-height: 95vh;">
      <div class="sticky top-0 bg-slate-900 border-b border-slate-700 p-6 flex items-center justify-between z-10">
        <div>
          <h2 id="seller_dashboard_title" class="text-3xl font-bold text-white">Dashboard Individual</h2>
          <p class="text-slate-400 text-sm mt-1">Visualize desempenho por vendedor, ano e per√≠odo. Gr√°ficos atualizam em tempo real.</p>
        </div>
        <div class="flex gap-3 items-center">
          <button type="button" id="download_seller_dashboard_btn" class="btn-secondary text-sm">
            üì• Baixar imagem do dashboard
          </button>
          <button type="button" id="close_seller_dashboard_btn" class="btn-danger text-sm">
            Fechar
          </button>
        </div>
      </div>
      <div class="p-6 space-y-6" id="seller_dashboard_root">
        <!-- Filtros superiores -->
        <div class="flex flex-wrap gap-4 items-end mb-4">
          <div>
            <label class="text-xs text-slate-300 block mb-1 font-semibold">Vendedor</label>
            <select id="seller_dashboard_seller" class="input-field w-56">
              <option value="">Selecione um vendedor</option>
              <option value="__ALL__">Todos os vendedores</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-300 block mb-1 font-semibold">Ano</label>
            <select id="seller_dashboard_year" class="input-field w-32">
              <option value="todos">Todos</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-300 block mb-1 font-semibold">Per√≠odo</label>
            <select id="seller_dashboard_period" class="input-field w-40">
              <option value="ano">Ano completo</option>
              <option value="1tri">1¬∫ Trimestre (Jan‚ÄìMar)</option>
              <option value="2tri">2¬∫ Trimestre (Abr‚ÄìJun)</option>
              <option value="3tri">3¬∫ Trimestre (Jul‚ÄìSet)</option>
              <option value="4tri">4¬∫ Trimestre (Out‚ÄìDez)</option>
            </select>
          </div>
        </div>

        <!-- KPIs principais -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs text-slate-300 uppercase tracking-wide">M√©dia Convers√£o</span>
              <span class="text-xs text-slate-400">Meta ‚â• 30%</span>
            </div>
            <div class="flex items-end gap-2">
              <span id="kpi_conversao_media" class="text-3xl font-bold text-white">--%</span>
              <span id="kpi_conversao_status" class="text-sm font-semibold text-slate-300"></span>
            </div>
          </div>
          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs text-slate-300 uppercase tracking-wide">M√©dia Efici√™ncia</span>
              <span class="text-xs text-slate-400">Meta ‚â• 7%</span>
            </div>
            <div class="flex items-end gap-2">
              <span id="kpi_eficiencia_media" class="text-3xl font-bold text-white">--%</span>
              <span id="kpi_eficiencia_status" class="text-sm font-semibold text-slate-300"></span>
            </div>
          </div>
          <div class="metric-card">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs text-slate-300 uppercase tracking-wide">Meses com Meta Batida</span>
              <span class="text-xs text-slate-400">Conv. ‚â• 30% e Efic. ‚â• 7%</span>
            </div>
            <div class="flex items-end gap-2">
              <span id="kpi_meses_ok" class="text-3xl font-bold text-white">0</span>
              <span id="kpi_meses_total" class="text-sm font-semibold text-slate-300"></span>
            </div>
          </div>
        </div>

        <!-- Gr√°ficos principais (2 pain√©is enxutos) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Convers√£o (linha) -->
          <div class="bg-slate-800 rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-white">% Convers√£o por m√™s</h3>
              <span class="text-[11px] text-slate-400">Linha hist√≥rica com meta 30%</span>
            </div>
            <canvas id="chart_conversao_vendedor" height="180"></canvas>
          </div>

          <!-- Efici√™ncia (linha) -->
          <div class="bg-slate-800 rounded-2xl p-4 shadow-lg flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-white">% Efici√™ncia por m√™s</h3>
              <span class="text-[11px] text-slate-400">Linha hist√≥rica com meta 7%</span>
            </div>
            <canvas id="chart_eficiencia_vendedor" height="180"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================= PAINEL EXECUTIVO INDIVIDUAL (CHART.JS) =================
    const dashboardMonthsOrder = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];

    let sellerConversaoChart = null;
    let sellerEficienciaChart = null;
    let currentDashboardSeller = "";

    let compConversaoChart = null;
    let compEficienciaChart = null;

    function openSellerDashboard(initialSeller) {
      const modal = document.getElementById("seller_dashboard_modal");
      const sellerSelect = document.getElementById("seller_dashboard_seller");
      const yearSelect = document.getElementById("seller_dashboard_year");

      // Preencher select de vendedores com base em allSellers (exclui "Loja")
      const uniqueSellers = [...new Set(allRecords
        .filter(r => r.seller_name && r.seller_name.toLowerCase() !== "loja")
        .map(r => r.seller_name)
      )].sort();

      sellerSelect.innerHTML = '<option value="">Selecione um vendedor</option>' +
        '<option value="__ALL__">Todos os vendedores</option>' +
        uniqueSellers.map(name => '<option value="' + name + '">' + name + '</option>').join("");

      // Descobrir anos existentes nos dados
      const years = [...new Set(allRecords.map(r => r.year))]
        .filter(Boolean)
        .sort();

      yearSelect.innerHTML = '<option value="todos">Todos</option>' +
        years.map(y => '<option value="' + y + '">' + y + '</option>').join("");

      // Selecionar vendedor inicial (se passado)
      if (initialSeller && uniqueSellers.includes(initialSeller)) {
        sellerSelect.value = initialSeller;
      } else if (uniqueSellers.length === 1) {
        sellerSelect.value = uniqueSellers[0];
      }

      // Atualizar t√≠tulo
      const titleEl = document.getElementById("seller_dashboard_title");
      currentDashboardSeller = sellerSelect.value || "Dashboard Individual";
      titleEl.textContent = currentDashboardSeller === "Dashboard Individual"
        ? "Dashboard Individual"
        : "Dashboard de " + currentDashboardSeller;

      // Mostrar modal
      modal.classList.remove("hidden");

      // Renderizar dashboard inicial
      updateSellerDashboard();

      // Listeners (apenas atribui uma vez por seguran√ßa)
      sellerSelect.onchange = () => {
        currentDashboardSeller = sellerSelect.value;
        const titleEl = document.getElementById("seller_dashboard_title");
        if (!currentDashboardSeller) {
          titleEl.textContent = "Dashboard Individual";
        } else if (currentDashboardSeller === "__ALL__") {
          titleEl.textContent = "Dashboard Geral de Vendedores";
        } else {
          titleEl.textContent = "Dashboard de " + currentDashboardSeller;
        }
        updateSellerDashboard();
      };
      yearSelect.onchange = updateSellerDashboard;
      document.getElementById("seller_dashboard_period").onchange = updateSellerDashboard;
    }

    
    
function filterSellerRecordsForDashboard() {
      const seller = document.getElementById("seller_dashboard_seller").value;
      const year = document.getElementById("seller_dashboard_year").value;
      const period = document.getElementById("seller_dashboard_period").value;

      if (!seller) return [];

      let baseRecords;
      if (seller === "__ALL__") {
        // Todos os vendedores (exceto "Loja")
        baseRecords = allRecords.filter(r => r.seller_name && r.seller_name.toLowerCase() !== "loja");
      } else {
        // Vendedor individual
        baseRecords = allRecords.filter(r => r.seller_name === seller);
      }

      if (year !== "todos") {
        baseRecords = baseRecords.filter(r => String(r.year) === String(year));
      }

      // Ordenar por m√™s na ordem correta
      baseRecords.sort((a, b) => {
        const ai = dashboardMonthsOrder.indexOf(a.month);
        const bi = dashboardMonthsOrder.indexOf(b.month);
        return ai - bi;
      });

      let startIdx = 0;
      let endIdx = dashboardMonthsOrder.length - 1;

      if (period === "1tri") { endIdx = 2; }
      else if (period === "2tri") { startIdx = 3; endIdx = 5; }
      else if (period === "3tri") { startIdx = 6; endIdx = 8; }
      else if (period === "4tri") { startIdx = 9; }

      baseRecords = baseRecords.filter(r => {
        const idx = dashboardMonthsOrder.indexOf(r.month);
        return idx >= startIdx && idx <= endIdx;
      });

      if (seller !== "__ALL__") {
        return baseRecords;
      }

      // Agrega todos os vendedores por m√™s/ano (m√©dias)
      const grouped = {};
      baseRecords.forEach(r => {
        const key = r.month + "/" + r.year;
        if (!grouped[key]) {
          grouped[key] = {
            month: r.month,
            year: r.year,
            taxa_conversao: 0,
            eficiencia: 0,
            _count: 0
          };
        }
        grouped[key].taxa_conversao += Number(r.taxa_conversao) || 0;
        grouped[key].eficiencia += Number(r.eficiencia) || 0;
        grouped[key]._count += 1;
      });

      const aggregated = Object.values(grouped).map(g => ({
        month: g.month,
        year: g.year,
        taxa_conversao: g._count ? g.taxa_conversao / g._count : 0,
        eficiencia: g._count ? g.eficiencia / g._count : 0
      }));

      aggregated.sort((a, b) => {
        const ai = dashboardMonthsOrder.indexOf(a.month);
        const bi = dashboardMonthsOrder.indexOf(b.month);
        return ai - bi;
      });

      return aggregated;
  }


    function updateSellerDashboard() {
      const records = filterSellerRecordsForDashboard();

      const kpiConv = document.getElementById("kpi_conversao_media");
      const kpiConvStatus = document.getElementById("kpi_conversao_status");
      const kpiEfic = document.getElementById("kpi_eficiencia_media");
      const kpiEficStatus = document.getElementById("kpi_eficiencia_status");
      const kpiMesesOk = document.getElementById("kpi_meses_ok");
      const kpiMesesTotal = document.getElementById("kpi_meses_total");

      if (!records || records.length === 0) {
        kpiConv.textContent = "--%";
        kpiConvStatus.textContent = "Sem dados para o per√≠odo";
        kpiConvStatus.className = "text-xs font-semibold text-slate-400";
        kpiEfic.textContent = "--%";
        kpiEficStatus.textContent = "";
        kpiMesesOk.textContent = "0";
        kpiMesesTotal.textContent = "de 0 meses";

        renderSellerCharts([], []);
        return;
      }

      const avgConv = records.reduce((s, r) => s + (r.taxa_conversao || 0), 0) / records.length;
      const avgEfic = records.reduce((s, r) => s + (r.eficiencia || 0), 0) / records.length;

      const mesesOk = records.filter(r => (r.taxa_conversao || 0) >= 30 && (r.eficiencia || 0) >= 7).length;

      kpiConv.textContent = avgConv.toFixed(1) + "%";
      kpiEfic.textContent = avgEfic.toFixed(1) + "%";
      kpiMesesOk.textContent = String(mesesOk);
      kpiMesesTotal.textContent = "de " + records.length + " meses";

      kpiConvStatus.textContent = avgConv >= 30 ? "Meta de convers√£o OK" : "Abaixo da meta de convers√£o";
      kpiConvStatus.className = "text-xs font-semibold " + (avgConv >= 30 ? "text-emerald-400" : "text-red-400");

      kpiEficStatus.textContent = avgEfic >= 7 ? "Meta de efici√™ncia OK" : "Abaixo da meta de efici√™ncia";
      kpiEficStatus.className = "text-xs font-semibold " + (avgEfic >= 7 ? "text-emerald-400" : "text-red-400");

      const labels = records.map(r => r.month);
      const convValues = records.map(r => r.taxa_conversao || 0);
      const eficValues = records.map(r => r.eficiencia || 0);

      renderSellerCharts(labels, convValues, eficValues);
    }

    
    
    function renderSellerCharts(labels, convValues, eficValues) {
      const convCtx = document.getElementById("chart_conversao_vendedor").getContext("2d");
      const eficCtx = document.getElementById("chart_eficiencia_vendedor").getContext("2d");

      if (sellerConversaoChart) sellerConversaoChart.destroy();
      if (sellerEficienciaChart) sellerEficienciaChart.destroy();

      if (!labels || labels.length === 0) {
        // Apenas limpar os canvases
        [convCtx, eficCtx].forEach(ctx => {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        });
        return;
      }

      const maxConv = Math.max(30, ...convValues) * 1.2;
      const maxEfic = Math.max(7, ...eficValues) * 1.4;

      // Gr√°fico de linha - Convers√£o
      sellerConversaoChart = new Chart(convCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "% Convers√£o",
              data: convValues,
              tension: 0.3,
              borderWidth: 2.5,
              pointRadius: 4
            },
            {
              label: "Meta 30%",
              data: labels.map(() => 30),
              borderWidth: 1.5,
              borderDash: [6, 4],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.1,
          animation: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", boxWidth: 12 } },
            tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + "%" } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(148, 163, 184, 0.12)" } },
            y: {
              ticks: { color: "#9ca3af", callback: v => v + "%" },
              grid: { color: "rgba(148, 163, 184, 0.12)" },
              suggestedMin: 0,
              suggestedMax: maxConv
            }
          }
        }
      });

      // Gr√°fico de linha - Efici√™ncia
      sellerEficienciaChart = new Chart(eficCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "% Efici√™ncia",
              data: eficValues,
              tension: 0.3,
              borderWidth: 2.5,
              pointRadius: 4
            },
            {
              label: "Meta 7%",
              data: labels.map(() => 7),
              borderWidth: 1.5,
              borderDash: [6, 4],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.1,
          animation: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", boxWidth: 12 } },
            tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + "%" } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(148, 163, 184, 0.12)" } },
            y: {
              ticks: { color: "#9ca3af", callback: v => v + "%" },
              grid: { color: "rgba(148, 163, 184, 0.12)" },
              suggestedMin: 0,
              suggestedMax: maxEfic
            }
          }
        }
      });
    }

async function downloadSellerDashboardImage() {
      const root = document.getElementById("seller_dashboard_root");
      if (!root || typeof html2canvas === "undefined") return;

      const canvas = await html2canvas(root, {
        backgroundColor: "#020617",
        scale: 2
      });

      const link = document.createElement("a");
      const seller = currentDashboardSeller || "dashboard";
      link.download = seller.replace(/\s+/g, "_").toLowerCase() + "_servicos.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const openBtn = document.getElementById("open_seller_dashboard_btn");
      const closeBtn = document.getElementById("close_seller_dashboard_btn");
      const downloadBtn = document.getElementById("download_seller_dashboard_btn");
      const modal = document.getElementById("seller_dashboard_modal");

      if (openBtn) {
        openBtn.addEventListener("click", () => openSellerDashboard());
      }

      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          modal.classList.add("hidden");
        });
      }

      if (downloadBtn) {
        downloadBtn.addEventListener("click", downloadSellerDashboardImage);
      }

      // Fecha clicando no fundo escuro
      if (modal) {
        modal.addEventListener("click", (e) => {
          if (e.target.id === "seller_dashboard_modal") {
            modal.classList.add("hidden");
          }
        });
      }
    });
  
// ====== BACKUP / RESTORE MENU ======
(function() {
  const menuBtn = document.getElementById("fs_menu_btn");
  const menuPanel = document.getElementById("fs_menu_panel");
  const downloadBtn = document.getElementById("fs_menu_download");
  const uploadBtn = document.getElementById("fs_menu_upload");
  const fileInput = document.getElementById("fs_menu_file");

  if (!menuBtn || !menuPanel) return;

  function toggleMenu() {
    menuPanel.classList.toggle("hidden");
  }

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMenu();
  });

  document.addEventListener("click", (e) => {
    if (!menuPanel.classList.contains("hidden")) {
      if (!menuPanel.contains(e.target) && e.target !== menuBtn) {
        menuPanel.classList.add("hidden");
      }
    }
  });

  downloadBtn.addEventListener("click", () => {
    try {
      const payload = {
        version: "1.0",
        exportedAt: new Date().toISOString(),
        totalRegistros: allRecords.length,
        registros: allRecords
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup-servicos-" + new Date().toISOString().slice(0,10) + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert("Backup gerado com sucesso! Guarde esse arquivo em local seguro.");
    } catch (err) {
      console.error("Erro ao gerar backup:", err);
      alert("N√£o foi poss√≠vel gerar o backup. Veja o console para mais detalhes.");
    }
  });

  uploadBtn.addEventListener("click", () => {
    fileInput.click();
  });

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm("Isso vai substituir os registros atuais pelos dados do arquivo. Deseja continuar?")) {
      fileInput.value = "";
      return;
    }

    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data || !Array.isArray(data.registros)) {
        alert("Arquivo inv√°lido. Certifique-se de usar um backup gerado pelo pr√≥prio sistema.");
        fileInput.value = "";
        return;
      }

      // Limpa registros existentes no modo local
      if (typeof window !== "undefined" && window.dataSdk && isLocalMode) {
        // Sobrescreve localStorage diretamente
        saveLocalFallbackRecords(data.registros);
        if (typeof dataHandler !== "undefined" && typeof dataHandler.onDataChanged === "function") {
          dataHandler.onDataChanged(data.registros);
        }
        allRecords = data.registros;
        rebuildSellersFromRecords();
        renderCurrentTab();
        alert("Backup restaurado com sucesso (modo local).");
      } else if (window.dataSdk && !isLocalMode) {
        // Backend real: aqui fazemos uma sincroniza√ß√£o simples:
        // 1) ainda n√£o temos API de listagem/remo√ß√£o em massa, ent√£o s√≥ alertamos o usu√°rio
        alert("Importa√ß√£o em ambiente com backend ainda n√£o √© autom√°tica. Use este recurso apenas no modo local.");
      } else {
        // fallback: apenas recarrega em mem√≥ria
        allRecords = data.registros;
        rebuildSellersFromRecords();
        renderCurrentTab();
        alert("Backup carregado em mem√≥ria.");
      }

    } catch (err) {
      console.error("Erro ao restaurar backup:", err);
      alert("Erro ao restaurar backup. Veja o console para mais detalhes.");
    } finally {
      fileInput.value = "";
    }
  });
})();


    // ================== COMPILADO GERAL POR VENDEDOR ==================

    function renderCompiladoGeral() {
      const grid = document.getElementById("compilado_sellers_grid");
      const dashSection = document.getElementById("compilado_dashboard_section");
      if (!grid) return;

      dashSection.classList.add("hidden");

      // Usa todos os vendedores j√° extra√≠dos, exceto "Loja"
      const vendedores = (allSellers || [])
        .map(s => (typeof s === "string" ? s : s.seller_name))
        .filter(name => name && name.toLowerCase() !== "loja");

      if (!vendedores.length) {
        grid.innerHTML = '<p class="text-slate-300 text-sm">Nenhum vendedor cadastrado ainda.</p>';
        return;
      }

      grid.innerHTML = vendedores.map(v => `
        <button
          type="button"
          class="w-full text-left bg-slate-800 hover:bg-slate-700 transition rounded-2xl p-4 shadow-lg border border-slate-700 flex flex-col gap-1"
          data-comp-seller="${v}"
        >
          <span class="text-xs text-slate-400 uppercase tracking-wide">Vendedor</span>
          <span class="text-lg font-semibold text-white">${v}</span>
          <span class="text-[11px] text-slate-400 mt-1">Clique para ver o dashboard completo</span>
        </button>
      `).join("");

      grid.querySelectorAll("[data-comp-seller]").forEach(btn => {
        btn.addEventListener("click", () => {
          const seller = btn.getAttribute("data-comp-seller");
          openCompiladoDashboard(seller);
        });
      });

      const backBtn = document.getElementById("compilado_back_btn");
      if (backBtn && !backBtn._compListenerAttached) {
        backBtn.addEventListener("click", () => {
          dashSection.classList.add("hidden");
        });
        backBtn._compListenerAttached = true;
      }
    }

    function openCompiladoDashboard(sellerName) {
      // guarda o vendedor atual para atualizar em tempo real quando os dados mudarem
      currentCompiladoSeller = sellerName || "";
      const dashSection = document.getElementById("compilado_dashboard_section");
      const titleEl = document.getElementById("compilado_dashboard_title");
      if (!dashSection || !titleEl) return;

      titleEl.textContent = "Dashboard de " + sellerName;
      dashSection.classList.remove("hidden");

      const records = (allRecords || []).filter(r => r.seller_name === sellerName);
      updateCompiladoFromRecords(records);
    }

    function updateCompiladoFromRecords(records) {
      const convEl = document.getElementById("comp_kpi_conversao_media");
      const convStatusEl = document.getElementById("comp_kpi_conversao_status");
      const eficEl = document.getElementById("comp_kpi_eficiencia_media");
      const eficStatusEl = document.getElementById("comp_kpi_eficiencia_status");
      const mesesOkEl = document.getElementById("comp_kpi_meses_ok");
      const mesesTotalEl = document.getElementById("comp_kpi_meses_total");

      const yearRangeEl = document.getElementById("comp_year_range");
      const convGrowthEl = document.getElementById("comp_conv_growth");
      const convDetailEl = document.getElementById("comp_conv_detail");
      const eficGrowthEl = document.getElementById("comp_efic_growth");
      const eficDetailEl = document.getElementById("comp_efic_detail");
      const yearTableBody = document.querySelector("#comp_year_table tbody");
      const yearTableHead = document.querySelector("#comp_year_table thead tr");

      if (!records || !records.length) {
        if (convEl) {
          convEl.textContent = "--%";
          convStatusEl.textContent = "Sem dados";
          convStatusEl.className = "text-xs font-semibold text-slate-400";
          eficEl.textContent = "--%";
          eficStatusEl.textContent = "";
          mesesOkEl.textContent = "0";
          mesesTotalEl.textContent = "de 0 meses";
        }

        clearCompCharts();
        if (yearRangeEl) yearRangeEl.textContent = "";
        if (convGrowthEl) convGrowthEl.textContent = "--";
        if (convDetailEl) convDetailEl.textContent = "";
        if (eficGrowthEl) eficGrowthEl.textContent = "--";
        if (eficDetailEl) eficDetailEl.textContent = "";
        if (yearTableBody) yearTableBody.innerHTML = "";
        return;
      }

      // Ordena por ano e m√™s
      const ordered = [...records].sort((a, b) => {
        const ya = Number(a.year) || 0;
        const yb = Number(b.year) || 0;
        if (ya !== yb) return ya - yb;
        const ma = dashboardMonthsOrder.indexOf(a.month);
        const mb = dashboardMonthsOrder.indexOf(b.month);
        return ma - mb;
      });

      const convValues = ordered.map(r => r.taxa_conversao || 0);
      const eficValues = ordered.map(r => r.eficiencia || 0);
      const labels = ordered.map(r => (r.month || "") + "/" + (r.year || ""));

      // KPIs
      const convValid = convValues.filter(v => v > 0);
      const eficValid = eficValues.filter(v => v > 0);
      const convAvg = convValid.length ? convValid.reduce((a,b)=>a+b,0) / convValid.length : 0;
      const eficAvg = eficValid.length ? eficValid.reduce((a,b)=>a+b,0) / eficValid.length : 0;

      if (convEl) {
        convEl.textContent = convAvg.toFixed(1) + "%";
        const convOk = convAvg >= 30;
        convStatusEl.textContent = convOk ? "Dentro ou acima da meta" : "Abaixo da meta de convers√£o";
        convStatusEl.className = "text-xs font-semibold " + (convOk ? "text-emerald-400" : "text-rose-400");
      }
      if (eficEl) {
        eficEl.textContent = eficAvg.toFixed(1) + "%";
        const eficOk = eficAvg >= 7;
        eficStatusEl.textContent = eficOk ? "Dentro ou acima da meta" : "Abaixo da meta de efici√™ncia";
        eficStatusEl.className = "text-xs font-semibold " + (eficOk ? "text-emerald-400" : "text-rose-400");
      }

      
      const totalMeses = ordered.length;
      const mesesOk = ordered.filter(r => (r.taxa_conversao || 0) >= 30 && (r.eficiencia || 0) >= 7).length;
      if (mesesOkEl) {
        mesesOkEl.textContent = String(mesesOk);
        mesesTotalEl.textContent = "de " + totalMeses + " meses";
      }

      // Preenche a lista de meses dentro do card "Meses com Meta Batida"
      const mesesMetaListEl = document.getElementById("comp_meses_meta_list");
      if (mesesMetaListEl) {
        let htmlList = "";
        ordered.forEach(r => {
          const monthLabel = (r.month || "") + "/" + (r.year || "");
          const conv = Number(r.taxa_conversao || 0);
          const efic = Number(r.eficiencia || 0);

          // Define status do m√™s (bom, aten√ß√£o, cr√≠tico) similar aos cards mensais
          let statusClass = "";
          let icon = "‚ö™";
          if (conv >= 30 && efic >= 7) {
            statusClass = "good";
            icon = "üü¢";
          } else if (conv > 0 || efic > 0) {
            statusClass = "critical";
            icon = "üî¥";
          }

          if (conv > 0 || efic > 0) {
            htmlList += `
              <div class="annual-month-card ${statusClass}">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-[10px] font-semibold text-slate-200">${monthLabel}</span>
                  <span class="text-sm">${icon}</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-300">
                  <span>Conv.: ${conv.toFixed(1)}%</span>
                  <span>Efic.: ${efic.toFixed(1)}%</span>
                </div>
              </div>
            `;
          }
        });
        mesesMetaListEl.innerHTML = htmlList;
      }

      // Gr√°ficos de linha (usa Chart.js)
      renderCompiladoCharts(labels, convValues, eficValues);

      // Gr√°ficos de barras (topo) - usam os mesmos dados
      renderCompiladoBarCharts(labels, convValues, eficValues);

      // Resumo ano a ano
      buildCompiladoYearSummary(ordered, {
        yearRangeEl,
        convGrowthEl,
        convDetailEl,
        eficGrowthEl,
        eficDetailEl,
        yearTableBody,
        yearTableHead
      });
    }

    function clearCompCharts() {
      const convCanvas = document.getElementById("comp_chart_conversao");
      const eficCanvas = document.getElementById("comp_chart_eficiencia");
      if (convCanvas) {
        const ctx = convCanvas.getContext("2d");
        ctx && ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      }
      if (eficCanvas) {
        const ctx = eficCanvas.getContext("2d");
        ctx && ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      }
      if (compConversaoChart) { compConversaoChart.destroy(); compConversaoChart = null; }
      if (compEficienciaChart) { compEficienciaChart.destroy(); compEficienciaChart = null; }
    }

    function renderCompiladoCharts(labels, convValues, eficValues) {
      const convCtx = document.getElementById("comp_chart_conversao")?.getContext("2d");
      const eficCtx = document.getElementById("comp_chart_eficiencia")?.getContext("2d");

      if (!convCtx || !eficCtx) return;

      if (compConversaoChart) compConversaoChart.destroy();
      if (compEficienciaChart) compEficienciaChart.destroy();

      if (!labels || !labels.length) {
        clearCompCharts();
        return;
      }

      const maxConv = Math.max(30, ...convValues) * 1.2;
      const maxEfic = Math.max(7, ...eficValues) * 1.4;

      compConversaoChart = new Chart(convCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "% Convers√£o",
              data: convValues,
              borderWidth: 2.5,
              tension: 0.3,
              pointRadius: 4
            },
            {
              label: "Meta 30%",
              data: labels.map(() => 30),
              borderWidth: 1.5,
              borderDash: [6, 4],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.1,
          animation: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", boxWidth: 12 } },
            tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + "%" } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(148, 163, 184, 0.12)" } },
            y: {
              ticks: { color: "#9ca3af", callback: v => v + "%" },
              grid: { color: "rgba(148, 163, 184, 0.12)" },
              suggestedMin: 0,
              suggestedMax: maxConv
            }
          }
        }
      });

      compEficienciaChart = new Chart(eficCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "% Efici√™ncia",
              data: eficValues,
              borderWidth: 2.5,
              tension: 0.3,
              pointRadius: 4
            },
            {
              label: "Meta 7%",
              data: labels.map(() => 7),
              borderWidth: 1.5,
              borderDash: [6, 4],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.1,
          animation: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", boxWidth: 12 } },
            tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + "%" } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(148, 163, 184, 0.12)" } },
            y: {
              ticks: { color: "#9ca3af", callback: v => v + "%" },
              grid: { color: "rgba(148, 163, 184, 0.12)" },
              suggestedMin: 0,
              suggestedMax: maxEfic
            }
          }
        }
      });
    }

    

    function renderCompiladoBarCharts(labels, convValues, eficValues) {
      const convCtx = document.getElementById("comp_chart_bar_conversao")?.getContext("2d");
      const eficCtx = document.getElementById("comp_chart_bar_eficiencia")?.getContext("2d");

      if (!convCtx || !eficCtx) return;

      if (compBarConvChart) { compBarConvChart.destroy(); compBarConvChart = null; }
      if (compBarEficChart) { compBarEficChart.destroy(); compBarEficChart = null; }

      if (!labels || !labels.length) {
        const clear = ctx => { try { ctx && ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); } catch(e) {} };
        clear(convCtx);
        clear(eficCtx);
        return;
      }

      const convData = (convValues || []).map(v => typeof v === "number" ? v : Number(v) || 0);
      const eficData = (eficValues || []).map(v => typeof v === "number" ? v : Number(v) || 0);

      // Cores din√¢micas para as barras de convers√£o (vermelho, amarelo, verde)
      const convColors = convData.map(v => {
        const val = Number(v) || 0;
        if (val >= 30) return "#22c55e";      // verde - meta batida
        if (val >= 15) return "#eab308";      // amarelo - aten√ß√£o
        return "#ef4444";                     // vermelho - cr√≠tico
      });

      // Cores din√¢micas para as barras de efici√™ncia (vermelho, amarelo, verde)
      const eficColors = eficData.map(v => {
        const val = Number(v) || 0;
        if (val >= 7) return "#22c55e";       // verde - meta batida
        if (val >= 3) return "#eab308";       // amarelo - aten√ß√£o
        return "#ef4444";                     // vermelho - cr√≠tico
      });

      function calcDynamicYMax(maxVal) {
        const safe = !isFinite(maxVal) ? 0 : maxVal;
        if (safe <= 10) return 10;
        if (safe <= 20) return 25;
        if (safe <= 30) return 35;
        if (safe <= 40) return 45;
        return Math.ceil(safe / 10) * 10;
      }

      const convMax = calcDynamicYMax(convData.length ? Math.max(...convData) : 0);
      const eficMax = calcDynamicYMax(eficData.length ? Math.max(...eficData) : 0);

      compBarConvChart = new Chart(convCtx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "% Convers√£o",
              data: convData,
              backgroundColor: convColors,
              borderRadius: 6,
              maxBarThickness: 40
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.4,
          animation: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", boxWidth: 12 } },
            tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + "%" } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { display: false } },
            y: {
              beginAtZero: true,
              max: convMax,
              ticks: { color: "#9ca3af", callback: v => v + "%" },
              grid: { color: "rgba(148, 163, 184, 0.12)" }
            }
          }
        }
      });

      compBarEficChart = new Chart(eficCtx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "% Efici√™ncia",
              data: eficData,
              backgroundColor: eficColors,
              borderRadius: 6,
              maxBarThickness: 40
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.4,
          animation: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", boxWidth: 12 } },
            tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + "%" } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { display: false } },
            y: {
              beginAtZero: true,
              max: eficMax,
              ticks: { color: "#9ca3af", callback: v => v + "%" },
              grid: { color: "rgba(148, 163, 184, 0.12)" }
            }
          }
        }
      });
    }

function buildCompiladoYearSummary(orderedRecords, elements) {
      const {
        yearRangeEl,
        convGrowthEl,
        convDetailEl,
        eficGrowthEl,
        eficDetailEl,
        yearTableBody,
        yearTableHead
      } = elements || {};

      if (!orderedRecords || !orderedRecords.length) {
        if (yearRangeEl) yearRangeEl.textContent = "";
        if (yearTableBody) yearTableBody.innerHTML = "";
        return;
      }

      const yearGroups = {};
      orderedRecords.forEach(r => {
        const y = String(r.year || "");
        if (!yearGroups[y]) {
          yearGroups[y] = { conv: 0, efic: 0, count: 0 };
        }
        yearGroups[y].conv += r.taxa_conversao || 0;
        yearGroups[y].efic += r.eficiencia || 0;
        yearGroups[y].count += 1;
      });

      const years = Object.keys(yearGroups).filter(y => y).sort();
      if (years.length < 2) {
        if (yearRangeEl) yearRangeEl.textContent = "Somente um ano com dados";
        if (convGrowthEl) convGrowthEl.textContent = "--";
        if (convDetailEl) convDetailEl.textContent = "Cadastre outro ano para ver o comparativo.";
        if (eficGrowthEl) eficGrowthEl.textContent = "--";
        if (eficDetailEl) eficDetailEl.textContent = "";
        if (yearTableBody) yearTableBody.innerHTML = "";
        return;
      }

      const yearA = years[0];
      const yearB = years[years.length - 1];

      const avgConvA = yearGroups[yearA].count ? yearGroups[yearA].conv / yearGroups[yearA].count : 0;
      const avgConvB = yearGroups[yearB].count ? yearGroups[yearB].conv / yearGroups[yearB].count : 0;
      const avgEficA = yearGroups[yearA].count ? yearGroups[yearA].efic / yearGroups[yearA].count : 0;
      const avgEficB = yearGroups[yearB].count ? yearGroups[yearB].efic / yearGroups[yearB].count : 0;

      const convGrowth = avgConvA ? ((avgConvB - avgConvA) / avgConvA) * 100 : 0;
      const eficGrowth = avgEficA ? ((avgEficB - avgEficA) / avgEficA) * 100 : 0;

      if (yearRangeEl) yearRangeEl.textContent = yearA + " vs " + yearB;

      if (convGrowthEl) {
        convGrowthEl.textContent = (convGrowth >= 0 ? "+" : "") + convGrowth.toFixed(1) + "%";
        convGrowthEl.className = "text-xl font-bold " + (convGrowth >= 0 ? "text-emerald-400" : "text-rose-400");
      }
      if (convDetailEl) {
        convDetailEl.textContent = `${yearA}: ${avgConvA.toFixed(1)}% ‚Üí ${yearB}: ${avgConvB.toFixed(1)}%`;
      }

      if (eficGrowthEl) {
        eficGrowthEl.textContent = (eficGrowth >= 0 ? "+" : "") + eficGrowth.toFixed(1) + "%";
        eficGrowthEl.className = "text-xl font-bold " + (eficGrowth >= 0 ? "text-emerald-400" : "text-rose-400");
      }
      if (eficDetailEl) {
        eficDetailEl.textContent = `${yearA}: ${avgEficA.toFixed(1)}% ‚Üí ${yearB}: ${avgEficB.toFixed(1)}%`;
      }

      // Atualiza cabe√ßalho da tabela
      if (yearTableHead) {
        yearTableHead.querySelectorAll(".year1_conv").forEach(th => th.textContent = yearA + " - Conv.");
        yearTableHead.querySelectorAll(".year2_conv").forEach(th => th.textContent = yearB + " - Conv.");
        yearTableHead.querySelectorAll(".year1_efic").forEach(th => th.textContent = yearA + " - Efic.");
        yearTableHead.querySelectorAll(".year2_efic").forEach(th => th.textContent = yearB + " - Efic.");
      }

      if (!yearTableBody) return;

      const byYearMonth = {};
      orderedRecords.forEach(r => {
        const key = `${r.year}|${r.month}`;
        byYearMonth[key] = r;
      });

      const monthsSet = new Set();
      orderedRecords.forEach(r => {
        if (String(r.year) === yearA || String(r.year) === yearB) {
          monthsSet.add(r.month);
        }
      });

      const months = Array.from(monthsSet).sort((a, b) => {
        return dashboardMonthsOrder.indexOf(a) - dashboardMonthsOrder.indexOf(b);
      });

      yearTableBody.innerHTML = months.map(m => {
        const rA = byYearMonth[`${yearA}|${m}`] || {};
        const rB = byYearMonth[`${yearB}|${m}`] || {};
        const cA = rA.taxa_conversao || 0;
        const cB = rB.taxa_conversao || 0;
        const eA = rA.eficiencia || 0;
        const eB = rB.eficiencia || 0;

        const cGrowth = cA ? ((cB - cA) / cA) * 100 : 0;
        const eGrowth = eA ? ((eB - eA) / eA) * 100 : 0;

        const cGrowthStr = (cGrowth >= 0 ? "+" : "") + cGrowth.toFixed(1) + "%";
        const eGrowthStr = (eGrowth >= 0 ? "+" : "") + eGrowth.toFixed(1) + "%";

        const cClass = cGrowth >= 0 ? "text-emerald-400" : "text-rose-400";
        const eClass = eGrowth >= 0 ? "text-emerald-400" : "text-rose-400";

        return `
          <tr>
            <td class="py-1 pr-2 text-left">${m}</td>
            <td class="py-1 px-2 text-right">${cA ? cA.toFixed(1) + "%" : "-"}</td>
            <td class="py-1 px-2 text-right">${cB ? cB.toFixed(1) + "%" : "-"}</td>
            <td class="py-1 px-2 text-right ${cClass}">${cA && cB ? cGrowthStr : "-"}</td>
            <td class="py-1 px-2 text-right">${eA ? eA.toFixed(1) + "%" : "-"}</td>
            <td class="py-1 px-2 text-right">${eB ? eB.toFixed(1) + "%" : "-"}</td>
            <td class="py-1 pl-2 text-right ${eClass}">${eA && eB ? eGrowthStr : "-"}</td>
          </tr>
        `;
      }).join("");
    }
</script>

<script>
(function() {
  const FS_USERS_KEY = "fs_servicos_users_v1";
  const FS_CURRENT_USER_KEY = "fs_servicos_current_user_v1";
  const FS_DEV_USER = "Fildo";
  const FS_MANAGER_PASSWORD = "@fildO1060";

  function fsHash(str) {
    let h = 0, i, chr;
    if (!str || str.length === 0) return "0";
    for (i = 0; i < str.length; i++) {
      chr = str.charCodeAt(i);
      h = ((h << 5) - h) + chr;
      h |= 0;
    }
    return String(h);
  }

  function fsLoadUsers() {
    try {
      const raw = localStorage.getItem(FS_USERS_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e) {
      console.error("Erro ao carregar usu√°rios:", e);
      return [];
    }
  }

  function fsSaveUsers(list) {
    try {
      localStorage.setItem(FS_USERS_KEY, JSON.stringify(list || []));
    } catch(e) {
      console.error("Erro ao salvar usu√°rios:", e);
    }
  }

  function fsGetCurrentUser() {
    try {
      const raw = localStorage.getItem(FS_CURRENT_USER_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) {
      return null;
    }
  }

  function fsSetCurrentUser(user) {
    try {
      if (!user) {
        localStorage.removeItem(FS_CURRENT_USER_KEY);
      } else {
        localStorage.setItem(FS_CURRENT_USER_KEY, JSON.stringify(user));
      }
    } catch(e) {}
  }

  function fsManagerAuth() {
    const pwd = prompt("Senha gerencial para acessar a √°rea de usu√°rios:");
    if (pwd === null) return false;
    if (pwd !== FS_MANAGER_PASSWORD) {
      alert("Senha gerencial incorreta.");
      return false;
    }
    return true;
  }

  function fsValidateLogin(username, password) {
    const u = (username || "").trim();
    const p = (password || "").trim();
    if (!u || !p) return null;

    // Caminho especial: Desenvolvedor
    if (u.toLowerCase() === FS_DEV_USER.toLowerCase() && p === FS_MANAGER_PASSWORD) {
      const devUser = { username: FS_DEV_USER, isDev: true, isManager: true };
      fsSetCurrentUser(devUser);
      return devUser;
    }

    const users = fsLoadUsers();
    const uLower = u.toLowerCase();
    const existing = users.find(x => (x.username || "").toLowerCase() === uLower);

    // Se o nome est√° pr√©-cadastrado mas ainda sem senha, a primeira senha vira a senha definitiva
    if (existing && !existing.passHash) {
      const newHash = fsHash(p);
      existing.passHash = newHash;
      existing.isManager = !!existing.isManager;
      existing.isDev = !!existing.isDev;
      fsSaveUsers(users);
      const current = { username: existing.username, isDev: !!existing.isDev, isManager: !!existing.isManager };
      fsSetCurrentUser(current);
      return current;
    }

    // Nome j√° cadastrado com senha definida
    if (existing && existing.passHash) {
      const hash = fsHash(p);
      if (hash === existing.passHash) {
        const current = { username: existing.username, isDev: !!existing.isDev, isManager: !!existing.isManager };
        fsSetCurrentUser(current);
        return current;
      }
    }

    // Nome n√£o cadastrado ou senha errada
    return null;
  }

  function fsOpenUsersManager() {
    if (!fsManagerAuth()) return;

    const users = fsLoadUsers();
    let msg = "Usu√°rios autorizados atualmente:\n\n";
    if (!users.length) {
      msg += "(nenhum nome cadastrado ainda)\n";
    } else {
      users.forEach((u, i) => {
        const status = u.passHash ? "com senha" : "aguardando definir senha";
        msg += (i + 1) + ". " + (u.username || "(sem nome)") + " ‚Äî " + status + "\n";
      });
    }

    msg += "\nEscolha uma op√ß√£o:\n1 - Incluir novo usu√°rio\n2 - Deletar usu√°rio\nQualquer outra tecla para sair.";

    const op = prompt(msg);
    if (op === "1") {
      const name = prompt("Nome do novo usu√°rio autorizado (ex.: Eduardo, Iane):");
      if (!name) return;
      const trimmed = name.trim();
      if (!trimmed) return;
      const list = fsLoadUsers();
      const exists = list.some(x => (x.username || "").toLowerCase() === trimmed.toLowerCase());
      if (exists) {
        alert("J√° existe um usu√°rio com esse nome.");
        return;
      }
      list.push({
        username: trimmed,
        passHash: "",
        isDev: false,
        isManager: false
      });
      fsSaveUsers(list);
      alert("Usu√°rio autorizado com sucesso. Ao abrir o painel, ele digita o nome e define a pr√≥pria senha.");
    } else if (op === "2") {
      const name = prompt("Nome do usu√°rio que deseja deletar:");
      if (!name) return;
      const trimmed = name.trim();
      if (!trimmed) return;
      const list = fsLoadUsers();
      const filtered = list.filter(x => (x.username || "").toLowerCase() !== trimmed.toLowerCase());
      if (filtered.length === list.length) {
        alert("Nenhum usu√°rio encontrado com esse nome.");
        return;
      }
      fsSaveUsers(filtered);
      alert("Usu√°rio deletado com sucesso.");
    }
  }

  function fsInitSecurity() {
    const overlay = document.getElementById("security-overlay");
    const userInput = document.getElementById("sec_username");
    const passInput = document.getElementById("sec_password");
    const loginBtn = document.getElementById("sec_login_btn");
    const requestBtn = document.getElementById("sec_request_btn");
    const errorEl = document.getElementById("sec_error_msg");
    const usersBtn = document.getElementById("fs_menu_users");

    if (usersBtn) {
      usersBtn.addEventListener("click", fsOpenUsersManager);
    }

    if (!overlay || !userInput || !passInput || !loginBtn) {
      console.warn("Security overlay n√£o encontrado.");
      return;
    }

    const existing = fsGetCurrentUser();
    if (existing && existing.username) {
      overlay.classList.add("hidden");
      return;
    }

    function showError(msg) {
      if (errorEl) errorEl.textContent = msg || "";
    }

    async function handleLogin() {
      showError("");
      const u = userInput.value;
      const p = passInput.value;

      const logged = fsValidateLogin(u, p);
      if (logged) {
        overlay.classList.add("hidden");
        const firstName = (logged.username || "").split(" ")[0] || logged.username || "";
        if (logged.isDev) {
          alert("Acesso de desenvolvedor liberado para " + firstName + ".");
        } else {
          alert("Bem-vindo, " + firstName + "!");
        }
        return;
      }

      showError("Usu√°rio n√£o autorizado ou senha inv√°lida.");
    }

    loginBtn.addEventListener("click", handleLogin);
    passInput.addEventListener("keyup", function(ev) {
      if (ev.key === "Enter") {
        handleLogin();
      }
    });

    if (requestBtn) {
      requestBtn.addEventListener("click", function() {
        const u = (userInput.value || "").trim() || "Usu√°rio";
        const msg = "Ol√°, gerente!\n\nGostaria de solicitar acesso ao Sistema de Gest√£o de Servi√ßos.\n\nNome: " + u + "\nFun√ß√£o: ________________________\nLoja: ________________________";
        alert(msg);
      });
    }

    try {
      userInput.focus();
    } catch(e) {}
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", fsInitSecurity);
  } else {
    fsInitSecurity();
  }
})();

    /********************************************************************
     * COMPILADO GERAL POR VENDEDOR
     ********************************************************************/
    function renderCompiladoSellers() {
      const grid = document.getElementById("compilado_sellers_grid");
      if (!grid) return;

      const sellersOnly = allSellers
        .filter(s => s.seller_name && s.seller_name.toLowerCase() !== "loja");

      if (sellersOnly.length === 0) {
        grid.innerHTML = `
          <div class="col-span-1 md:col-span-3 text-center text-slate-300 py-8">
            Nenhum vendedor encontrado. Adicione registros na aba "Inserir Dados".
          </div>
        `;
        return;
      }

      let htmlCards = "";
      sellersOnly.forEach(seller => {
        const records = allRecords.filter(r => r.seller_name === seller.seller_name);
        const totalReg = records.length;

        const convVals = records.map(r => Number(r.taxa_conversao || 0));
        const eficVals = records.map(r => Number(r.eficiencia || 0));
        const convAvg = convVals.length ? convVals.reduce((a, b) => a + b, 0) / convVals.length : 0;
        const eficAvg = eficVals.length ? eficVals.reduce((a, b) => a + b, 0) / eficVals.length : 0;

        const mesesOK = records.filter(r =>
          Number(r.taxa_conversao) >= 30 && Number(r.eficiencia) >= 7
        ).length;

        htmlCards += `
          <button
            type="button"
            class="compilado-seller-card bg-slate-800/80 border border-slate-700 hover:border-blue-500 hover:-translate-y-1 transition-all rounded-2xl p-4 flex flex-col text-left"
            data-seller="${seller.seller_name.replace(/"/g, "&quot;")}"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="seller-badge">${seller.seller_name}</span>
              <span class="text-xs text-slate-400">${totalReg} reg.</span>
            </div>
            <div class="mt-1 text-xs text-slate-300">
              <div>‚ö° M√©dia Convers√£o: <span class="font-semibold">${convAvg.toFixed(1)}%</span></div>
              <div>üéØ M√©dia Efici√™ncia: <span class="font-semibold">${eficAvg.toFixed(1)}%</span></div>
              <div class="mt-1 text-[11px] text-slate-400">
                Meses com meta batida: <span class="font-semibold">${mesesOK}</span>
              </div>
            </div>
            <div class="mt-3 text-[11px] text-blue-300 flex items-center justify-between">
              <span>Ver painel completo</span>
              <span>‚ûú</span>
            </div>
          </button>
        `;
      });

      grid.innerHTML = htmlCards;
    }

    function openCompiladoDashboardForSeller(sellerName) {
      const section = document.getElementById("compilado_dashboard_section");
      const titleEl = document.getElementById("compilado_dashboard_title");
      if (!section || !titleEl) return;

      const sellerRecords = allRecords
        .filter(r => r.seller_name === sellerName)
        .map(r => ({
          ...r,
          year: String(r.year || r.ano || r.ano_ref || ""),
          month: r.month || r.mes || "",
          taxa_conversao: Number(r.taxa_conversao || 0),
          eficiencia: Number(r.eficiencia || 0)
        }));

      if (sellerRecords.length === 0) {
        showToast("Nenhum dado encontrado para " + sellerName, "error");
        return;
      }

      sellerRecords.sort((a, b) => {
        const ya = Number(a.year) || 0;
        const yb = Number(b.year) || 0;
        const ma = MONTHS_ORDER.indexOf(a.month);
        const mb = MONTHS_ORDER.indexOf(b.month);
        if (ya !== yb) return ya - yb;
        return ma - mb;
      });

      titleEl.textContent = "Dashboard de " + sellerName;

      const convVals = sellerRecords.map(r => r.taxa_conversao);
      const eficVals = sellerRecords.map(r => r.eficiencia);

      const convAvg = convVals.reduce((a, b) => a + b, 0) / convVals.length;
      const eficAvg = eficVals.reduce((a, b) => a + b, 0) / eficVals.length;

      const mesesOK = sellerRecords.filter(r =>
        r.taxa_conversao >= 30 && r.eficiencia >= 7
      ).length;

      const totalMeses = sellerRecords.length;

      const kpiConvEl = document.getElementById("comp_kpi_conversao_media");
      const kpiConvStatusEl = document.getElementById("comp_kpi_conversao_status");
      const kpiEficEl = document.getElementById("comp_kpi_eficiencia_media");
      const kpiEficStatusEl = document.getElementById("comp_kpi_eficiencia_status");
      const kpiMesesOkEl = document.getElementById("comp_kpi_meses_ok");
      const kpiMesesTotalEl = document.getElementById("comp_kpi_meses_total");

      if (kpiConvEl) kpiConvEl.textContent = convAvg.toFixed(1) + "%";
      if (kpiEficEl) kpiEficEl.textContent = eficAvg.toFixed(1) + "%";
      if (kpiMesesOkEl) kpiMesesOkEl.textContent = mesesOK;
      if (kpiMesesTotalEl) kpiMesesTotalEl.textContent = "/ " + totalMeses + " m√™s(es)";

      if (kpiConvStatusEl) {
        if (convAvg >= 30) {
          kpiConvStatusEl.textContent = "Meta atingida ou acima";
        } else {
          kpiConvStatusEl.textContent = "Abaixo da meta de 30%";
        }
      }

      if (kpiEficStatusEl) {
        if (eficAvg >= 7) {
          kpiEficStatusEl.textContent = "Meta atingida ou acima";
        } else {
          kpiEficStatusEl.textContent = "Abaixo da meta de 7%";
        }
      }

      const labels = sellerRecords.map(r => {
        const mIdx = MONTHS_ORDER.indexOf(r.month);
        const shortMonth = r.month ? r.month.substring(0, 3) : "";
        return `${(mIdx + 1).toString().padStart(2, "0")}/${shortMonth}/${r.year}`;
      });

      const convData = sellerRecords.map(r => r.taxa_conversao);
      const eficData = sellerRecords.map(r => r.eficiencia);

      const convCanvas = document.getElementById("comp_chart_conversao");
      const ctxConv = convCanvas ? convCanvas.getContext("2d") : null;
      const eficCanvas = document.getElementById("comp_chart_eficiencia");
      const ctxEfic = eficCanvas ? eficCanvas.getContext("2d") : null;

      const barConvCanvas = document.getElementById("comp_chart_bar_conversao");
      const ctxBarConv = barConvCanvas ? barConvCanvas.getContext("2d") : null;
      const barEficCanvas = document.getElementById("comp_chart_bar_eficiencia");
      const ctxBarEfic = barEficCanvas ? barEficCanvas.getContext("2d") : null;

      if (compConvChart) compConvChart.destroy();
      if (compEficChart) compEficChart.destroy();
      if (compBarConvChart) compBarConvChart.destroy();
      if (compBarEficChart) compBarEficChart.destroy();

      if (ctxConv) {
        compConvChart = new Chart(ctxConv, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "% Convers√£o",
                data: convData,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3
              },
              {
                label: "Meta 30%",
                data: labels.map(() => 30),
                borderWidth: 1,
                borderDash: [6, 4],
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      if (ctxEfic) {
        compEficChart = new Chart(ctxEfic, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "% Efici√™ncia",
                data: eficData,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3
              },
              {
                label: "Meta 7%",
                data: labels.map(() => 7),
                borderWidth: 1,
                borderDash: [6, 4],
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      if (ctxBarConv) {
        compBarConvChart = new Chart(ctxBarConv, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "% Convers√£o",
                data: convData
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      if (ctxBarEfic) {
        compBarEficChart = new Chart(ctxBarEfic, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "% Efici√™ncia",
                data: eficData
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      const yearsSet = new Set(sellerRecords.map(r => r.year).filter(Boolean));
      const years = Array.from(yearsSet).sort();
      const yearRangeEl = document.getElementById("comp_year_range");
      const convGrowthEl = document.getElementById("comp_conv_growth");
      const convDetailEl = document.getElementById("comp_conv_detail");
      const eficGrowthEl = document.getElementById("comp_efic_growth");
      const eficDetailEl = document.getElementById("comp_efic_detail");
      const yearTableEl = document.getElementById("comp_year_table");
      const yearTable = yearTableEl ? yearTableEl.querySelector("tbody") : null;

      if (years.length < 2) {
        if (yearRangeEl) yearRangeEl.textContent = "Apenas um ano dispon√≠vel";
        if (convGrowthEl) convGrowthEl.textContent = "--";
        if (eficGrowthEl) eficGrowthEl.textContent = "--";
        if (convDetailEl) convDetailEl.textContent = "Inclua dados de pelo menos 2 anos para ver o comparativo.";
        if (eficDetailEl) eficDetailEl.textContent = "";
        if (yearTable) yearTable.innerHTML = "";
      } else {
        const yearA = years[0];
        const yearB = years[years.length - 1];

        if (yearRangeEl) yearRangeEl.textContent = `${yearA} ‚Üí ${yearB}`;

        const recA = sellerRecords.filter(r => r.year === yearA);
        const recB = sellerRecords.filter(r => r.year === yearB);

        const avgConvA = recA.length ? recA.reduce((s, r) => s + r.taxa_conversao, 0) / recA.length : 0;
        const avgConvB = recB.length ? recB.reduce((s, r) => s + r.taxa_conversao, 0) / recB.length : 0;
        const avgEficA = recA.length ? recA.reduce((s, r) => s + r.eficiencia, 0) / recA.length : 0;
        const avgEficB = recB.length ? recB.reduce((s, r) => s + r.eficiencia, 0) / recB.length : 0;

        const diffConv = avgConvB - avgConvA;
        const diffEfic = avgEficB - avgEficA;

        const formatDiff = (val) => {
          if (Math.abs(val) < 0.01) return "0,0 p.p.";
          const sinal = val > 0 ? "+" : "";
          return `${sinal}${val.toFixed(1).replace(".", ",")} p.p.`;
        };

        if (convGrowthEl) convGrowthEl.textContent = formatDiff(diffConv);
        if (eficGrowthEl) eficGrowthEl.textContent = formatDiff(diffEfic);

        if (convDetailEl) {
          convDetailEl.textContent =
            `M√©dia de ${avgConvA.toFixed(1)}% em ${yearA} para ${avgConvB.toFixed(1)}% em ${yearB}.`;
        }
        if (eficDetailEl) {
          eficDetailEl.textContent =
            `M√©dia de ${avgEficA.toFixed(1)}% em ${yearA} para ${avgEficB.toFixed(1)}% em ${yearB}.`;
        }

        if (yearTable) {
          yearTable.innerHTML = "";
          MONTHS_ORDER.forEach(monthName => {
            const rA = recA.filter(r => r.month === monthName);
            const rB = recB.filter(r => r.month === monthName);

            const mConvA = rA.length ? rA.reduce((s, r) => s + r.taxa_conversao, 0) / rA.length : null;
            const mConvB = rB.length ? rB.reduce((s, r) => s + r.taxa_conversao, 0) / rB.length : null;
            const mEficA = rA.length ? rA.reduce((s, r) => s + r.eficiencia, 0) / rA.length : null;
            const mEficB = rB.length ? rB.reduce((s, r) => s + r.eficiencia, 0) / rB.length : null;

            const diffMC = (mConvA !== null && mConvB !== null) ? (mConvB - mConvA) : null;
            const diffME = (mEficA !== null && mEficB !== null) ? (mEficB - mEficA) : null;

            const formatVal = (v) => v === null ? "--" : v.toFixed(1) + "%";
            const formatDiffCell = (v) => {
              if (v === null) return "--";
              const sinal = v > 0 ? "+" : "";
              return `${sinal}${v.toFixed(1)}%`;
            };

            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="py-1 pr-2 text-left">${monthName}</td>
              <td class="py-1 px-2 text-right">${formatVal(mConvA)}</td>
              <td class="py-1 px-2 text-right">${formatVal(mConvB)}</td>
              <td class="py-1 px-2 text-right">${formatDiffCell(diffMC)}</td>
              <td class="py-1 px-2 text-right">${formatVal(mEficA)}</td>
              <td class="py-1 px-2 text-right">${formatVal(mEficB)}</td>
              <td class="py-1 pl-2 text-right">${formatDiffCell(diffME)}</td>
            `;
            yearTable.appendChild(row);
          });
        }
      }

      section.classList.remove("hidden");
      section.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("compilado_sellers_grid");
      const backBtn = document.getElementById("compilado_back_btn");

      if (grid) {
        grid.addEventListener("click", (ev) => {
          const card = ev.target.closest(".compilado-seller-card");
          if (!card) return;
          const sellerName = card.getAttribute("data-seller");
          if (sellerName) {
            openCompiladoDashboardForSeller(sellerName);
          }
        });
      }

      if (backBtn) {
        backBtn.addEventListener("click", () => {
          const section = document.getElementById("compilado_dashboard_section");
          if (section) {
            section.classList.add("hidden");
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      }
    });

  
    /********************************************************************
     * COMPILADO GERAL POR VENDEDOR
     ********************************************************************/
    function renderCompiladoSellers() {
      const grid = document.getElementById("compilado_sellers_grid");
      if (!grid) return;

      const sellersOnly = allSellers
        .filter(s => s.seller_name && s.seller_name.toLowerCase() !== "loja");

      if (sellersOnly.length === 0) {
        grid.innerHTML = `
          <div class="col-span-1 md:col-span-3 text-center text-slate-300 py-8">
            Nenhum vendedor encontrado. Adicione registros na aba "Inserir Dados".
          </div>
        `;
        return;
      }

      let htmlCards = "";
      sellersOnly.forEach(seller => {
        const records = allRecords.filter(r => r.seller_name === seller.seller_name);
        const totalReg = records.length;

        const convVals = records.map(r => Number(r.taxa_conversao || 0));
        const eficVals = records.map(r => Number(r.eficiencia || 0));
        const convAvg = convVals.length ? convVals.reduce((a, b) => a + b, 0) / convVals.length : 0;
        const eficAvg = eficVals.length ? eficVals.reduce((a, b) => a + b, 0) / eficVals.length : 0;

        const mesesOK = records.filter(r =>
          Number(r.taxa_conversao) >= 30 && Number(r.eficiencia) >= 7
        ).length;

        htmlCards += `
          <button
            type="button"
            class="compilado-seller-card bg-slate-800/80 border border-slate-700 hover:border-blue-500 hover:-translate-y-1 transition-all rounded-2xl p-4 flex flex-col text-left"
            data-seller="${seller.seller_name.replace(/"/g, "&quot;")}"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="seller-badge">${seller.seller_name}</span>
              <span class="text-xs text-slate-400">${totalReg} reg.</span>
            </div>
            <div class="mt-1 text-xs text-slate-300">
              <div>‚ö° M√©dia Convers√£o: <span class="font-semibold">${convAvg.toFixed(1)}%</span></div>
              <div>üéØ M√©dia Efici√™ncia: <span class="font-semibold">${eficAvg.toFixed(1)}%</span></div>
              <div class="mt-1 text-[11px] text-slate-400">
                Meses com meta batida: <span class="font-semibold">${mesesOK}</span>
              </div>
            </div>
            <div class="mt-3 text-[11px] text-blue-300 flex items-center justify-between">
              <span>Ver painel completo</span>
              <span>‚ûú</span>
            </div>
          </button>
        `;
      });

      grid.innerHTML = htmlCards;
    }

    function openCompiladoDashboardForSeller(sellerName) {
      const section = document.getElementById("compilado_dashboard_section");
      const titleEl = document.getElementById("compilado_dashboard_title");
      if (!section || !titleEl) return;

      const sellerRecords = allRecords
        .filter(r => r.seller_name === sellerName)
        .map(r => ({
          ...r,
          year: String(r.year || r.ano || r.ano_ref || ""),
          month: r.month || r.mes || "",
          taxa_conversao: Number(r.taxa_conversao || 0),
          eficiencia: Number(r.eficiencia || 0)
        }));

      if (sellerRecords.length === 0) {
        showToast("Nenhum dado encontrado para " + sellerName, "error");
        return;
      }

      sellerRecords.sort((a, b) => {
        const ya = Number(a.year) || 0;
        const yb = Number(b.year) || 0;
        const ma = MONTHS_ORDER.indexOf(a.month);
        const mb = MONTHS_ORDER.indexOf(b.month);
        if (ya !== yb) return ya - yb;
        return ma - mb;
      });

      titleEl.textContent = "Dashboard de " + sellerName;

      const convVals = sellerRecords.map(r => r.taxa_conversao);
      const eficVals = sellerRecords.map(r => r.eficiencia);

      const convAvg = convVals.reduce((a, b) => a + b, 0) / convVals.length;
      const eficAvg = eficVals.reduce((a, b) => a + b, 0) / eficVals.length;

      const mesesOK = sellerRecords.filter(r =>
        r.taxa_conversao >= 30 && r.eficiencia >= 7
      ).length;

      const totalMeses = sellerRecords.length;

      const kpiConvEl = document.getElementById("comp_kpi_conversao_media");
      const kpiConvStatusEl = document.getElementById("comp_kpi_conversao_status");
      const kpiEficEl = document.getElementById("comp_kpi_eficiencia_media");
      const kpiEficStatusEl = document.getElementById("comp_kpi_eficiencia_status");
      const kpiMesesOkEl = document.getElementById("comp_kpi_meses_ok");
      const kpiMesesTotalEl = document.getElementById("comp_kpi_meses_total");

      if (kpiConvEl) kpiConvEl.textContent = convAvg.toFixed(1) + "%";
      if (kpiEficEl) kpiEficEl.textContent = eficAvg.toFixed(1) + "%";
      if (kpiMesesOkEl) kpiMesesOkEl.textContent = mesesOK;
      if (kpiMesesTotalEl) kpiMesesTotalEl.textContent = "/ " + totalMeses + " m√™s(es)";

      if (kpiConvStatusEl) {
        if (convAvg >= 30) {
          kpiConvStatusEl.textContent = "Meta atingida ou acima";
        } else {
          kpiConvStatusEl.textContent = "Abaixo da meta de 30%";
        }
      }

      if (kpiEficStatusEl) {
        if (eficAvg >= 7) {
          kpiEficStatusEl.textContent = "Meta atingida ou acima";
        } else {
          kpiEficStatusEl.textContent = "Abaixo da meta de 7%";
        }
      }

      const labels = sellerRecords.map(r => {
        const mIdx = MONTHS_ORDER.indexOf(r.month);
        const shortMonth = r.month ? r.month.substring(0, 3) : "";
        return `${(mIdx + 1).toString().padStart(2, "0")}/${shortMonth}/${r.year}`;
      });

      const convData = sellerRecords.map(r => r.taxa_conversao);
      const eficData = sellerRecords.map(r => r.eficiencia);

      const convCanvas = document.getElementById("comp_chart_conversao");
      const ctxConv = convCanvas ? convCanvas.getContext("2d") : null;
      const eficCanvas = document.getElementById("comp_chart_eficiencia");
      const ctxEfic = eficCanvas ? eficCanvas.getContext("2d") : null;

      if (compConvChart) compConvChart.destroy();
      if (compEficChart) compEficChart.destroy();

      if (ctxConv) {
        compConvChart = new Chart(ctxConv, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "% Convers√£o",
                data: convData,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3
              },
              {
                label: "Meta 30%",
                data: labels.map(() => 30),
                borderWidth: 1,
                borderDash: [6, 4],
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      if (ctxEfic) {
        compEficChart = new Chart(ctxEfic, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "% Efici√™ncia",
                data: eficData,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3
              },
              {
                label: "Meta 7%",
                data: labels.map(() => 7),
                borderWidth: 1,
                borderDash: [6, 4],
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      const yearsSet = new Set(sellerRecords.map(r => r.year).filter(Boolean));
      const years = Array.from(yearsSet).sort();
      const yearRangeEl = document.getElementById("comp_year_range");
      const convGrowthEl = document.getElementById("comp_conv_growth");
      const convDetailEl = document.getElementById("comp_conv_detail");
      const eficGrowthEl = document.getElementById("comp_efic_growth");
      const eficDetailEl = document.getElementById("comp_efic_detail");
      const yearTableEl = document.getElementById("comp_year_table");
      const yearTable = yearTableEl ? yearTableEl.querySelector("tbody") : null;

      if (years.length < 2) {
        if (yearRangeEl) yearRangeEl.textContent = "Apenas um ano dispon√≠vel";
        if (convGrowthEl) convGrowthEl.textContent = "--";
        if (eficGrowthEl) eficGrowthEl.textContent = "--";
        if (convDetailEl) convDetailEl.textContent = "Inclua dados de pelo menos 2 anos para ver o comparativo.";
        if (eficDetailEl) eficDetailEl.textContent = "";
        if (yearTable) yearTable.innerHTML = "";
      } else {
        const yearA = years[0];
        const yearB = years[years.length - 1];

        if (yearRangeEl) yearRangeEl.textContent = `${yearA} ‚Üí ${yearB}`;

        const recA = sellerRecords.filter(r => r.year === yearA);
        const recB = sellerRecords.filter(r => r.year === yearB);

        const avgConvA = recA.length ? recA.reduce((s, r) => s + r.taxa_conversao, 0) / recA.length : 0;
        const avgConvB = recB.length ? recB.reduce((s, r) => s + r.taxa_conversao, 0) / recB.length : 0;
        const avgEficA = recA.length ? recA.reduce((s, r) => s + r.eficiencia, 0) / recA.length : 0;
        const avgEficB = recB.length ? recB.reduce((s, r) => s + r.eficiencia, 0) / recB.length : 0;

        const diffConv = avgConvB - avgConvA;
        const diffEfic = avgEficB - avgEficA;

        const formatDiff = (val) => {
          if (Math.abs(val) < 0.01) return "0,0 p.p.";
          const sinal = val > 0 ? "+" : "";
          return `${sinal}${val.toFixed(1).replace(".", ",")} p.p.`;
        };

        if (convGrowthEl) convGrowthEl.textContent = formatDiff(diffConv);
        if (eficGrowthEl) eficGrowthEl.textContent = formatDiff(diffEfic);

        if (convDetailEl) {
          convDetailEl.textContent =
            `M√©dia de ${avgConvA.toFixed(1)}% em ${yearA} para ${avgConvB.toFixed(1)}% em ${yearB}.`;
        }
        if (eficDetailEl) {
          eficDetailEl.textContent =
            `M√©dia de ${avgEficA.toFixed(1)}% em ${yearA} para ${avgEficB.toFixed(1)}% em ${yearB}.`;
        }

        if (yearTable) {
          yearTable.innerHTML = "";
          MONTHS_ORDER.forEach(monthName => {
            const rA = recA.filter(r => r.month === monthName);
            const rB = recB.filter(r => r.month === monthName);

            const mConvA = rA.length ? rA.reduce((s, r) => s + r.taxa_conversao, 0) / rA.length : null;
            const mConvB = rB.length ? rB.reduce((s, r) => s + r.taxa_conversao, 0) / rB.length : null;
            const mEficA = rA.length ? rA.reduce((s, r) => s + r.eficiencia, 0) / rA.length : null;
            const mEficB = rB.length ? rB.reduce((s, r) => s + r.eficiencia, 0) / rB.length : null;

            const diffMC = (mConvA !== null && mConvB !== null) ? (mConvB - mConvA) : null;
            const diffME = (mEficA !== null && mEficB !== null) ? (mEficB - mEficA) : null;

            const formatVal = (v) => v === null ? "--" : v.toFixed(1) + "%";
            const formatDiffCell = (v) => {
              if (v === null) return "--";
              const sinal = v > 0 ? "+" : "";
              return `${sinal}${v.toFixed(1)}%`;
            };

            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="py-1 pr-2 text-left">${monthName}</td>
              <td class="py-1 px-2 text-right">${formatVal(mConvA)}</td>
              <td class="py-1 px-2 text-right">${formatVal(mConvB)}</td>
              <td class="py-1 px-2 text-right">${formatDiffCell(diffMC)}</td>
              <td class="py-1 px-2 text-right">${formatVal(mEficA)}</td>
              <td class="py-1 px-2 text-right">${formatVal(mEficB)}</td>
              <td class="py-1 pl-2 text-right">${formatDiffCell(diffME)}</td>
            `;
            yearTable.appendChild(row);
          });
        }
      }

      section.classList.remove("hidden");
      section.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("compilado_sellers_grid");
      const backBtn = document.getElementById("compilado_back_btn");

      if (grid) {
        grid.addEventListener("click", (ev) => {
          const card = ev.target.closest(".compilado-seller-card");
          if (!card) return;
          const sellerName = card.getAttribute("data-seller");
          if (sellerName) {
            openCompiladoDashboardForSeller(sellerName);
          }
        });
      }

      if (backBtn) {
        backBtn.addEventListener("click", () => {
          const section = document.getElementById("compilado_dashboard_section");
          if (section) {
            section.classList.add("hidden");
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      }
    });

  </script>




    <!-- Bot√£o flutuante: Voltar ao In√≠cio -->
    <a href="index.html"
       style="position: fixed;
              bottom: 20px;
              right: 20px;
              background: linear-gradient(135deg, #4e7cff, #1e3bb3);
              color: #ffffff;
              padding: 12px 22px;
              border-radius: 999px;
              font-size: 14px;
              font-weight: 600;
              text-decoration: none;
              box-shadow: 0 4px 12px rgba(0,0,0,0.25);
              display: inline-flex;
              align-items: center;
              gap: 6px;
              z-index: 9999;
              transition: transform 0.18s ease, box-shadow 0.18s ease;">
        <span style="font-size:16px;">‚Üê</span>
        <span>Voltar ao in√≠cio</span>
    </a>

</body>
</html>
