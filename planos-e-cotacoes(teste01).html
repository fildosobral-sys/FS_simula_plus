<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planos e Cota√ß√µes</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    html {
      height: 100%;
    }
    .produto-item {
      transition: all 0.2s ease;
    }
    .produto-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-primary {
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100">
  <div id="app" class="min-h-full"><!-- Loading State -->
   <div id="loading" class="flex items-center justify-center min-h-full">
    <div class="text-center">
     <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
     <p class="text-gray-600 text-lg">Carregando m√≥dulo...</p>
    </div>
   </div><!-- Tela de Entrada (Welcome Screen) -->
   <div id="welcomeScreen" class="hidden min-h-full flex items-center justify-center p-4">
    <div class="max-w-2xl w-full">
     <div class="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-105 transition-transform duration-300">
      <div class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-700 p-8 relative overflow-hidden">
       <div class="absolute inset-0 opacity-20">
        <div class="absolute top-0 left-0 w-64 h-64 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"></div>
       </div>
       <div class="relative z-10 text-center mb-6">
        <div class="inline-block animate-bounce"><span class="text-8xl">üìä</span>
        </div>
        <h1 class="text-4xl font-extrabold text-white mt-6 mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Planos e Cota√ß√µes</h1>
        <p class="text-blue-100 text-lg font-medium">Sistema Profissional de Propostas Comerciais</p>
       </div>
      </div>
      <div class="p-8">
       <div class="mb-6"><label class="block text-gray-700 font-bold mb-3 text-lg" for="inputNomeVendedorInicial"> üë§ Qual √© o seu nome? </label> <input type="text" id="inputNomeVendedorInicial" class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Digite seu nome completo" autocomplete="off">
       </div><button id="btnEntrarSistema" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-xl hover:from-blue-700 hover:to-indigo-700 shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-3"> <span class="text-2xl">üöÄ</span> <span>Entrar no Sistema</span> </button>
      </div>
     </div>
     <div class="text-center mt-6">
      <p class="text-sm text-gray-600">‚ú® Crie propostas incr√≠veis em minutos</p>
     </div>
    </div>
   </div><!-- Main Content (hidden initially) -->
   <div id="mainContent" class="hidden pb-16"><!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-700 text-white shadow-2xl relative overflow-hidden">
     <div class="absolute inset-0 opacity-10">
      <div class="absolute top-0 left-0 w-96 h-96 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 right-0 w-96 h-96 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"></div>
     </div>
     <div class="container mx-auto px-4 py-8 relative z-10">
      <div class="flex justify-between items-center flex-wrap gap-4">
       <div class="flex items-center gap-4">
        <div class="hidden md:flex items-center justify-center w-16 h-16 bg-white bg-opacity-20 rounded-2xl backdrop-blur-sm"><span class="text-4xl">üìä</span>
        </div>
        <div>
         <h1 class="text-4xl font-extrabold tracking-tight mb-1">Planos e Cota√ß√µes</h1>
         <p class="text-blue-100 text-lg font-medium flex items-center gap-2">Bem-vindo(a), <span id="nomeUsuarioHeader" class="font-bold">Usu√°rio</span>!</p>
        </div>
       </div>
       <div class="flex items-center gap-3"><button id="btnNovaProposta" class="btn-primary bg-white text-blue-600 px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-50 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center gap-3"> <span class="text-2xl">‚ûï</span> <span>Nova Proposta</span> </button> <button id="btnAbrirMenu" class="bg-white bg-opacity-20 backdrop-blur-sm text-white px-6 py-4 rounded-xl font-bold text-lg hover:bg-opacity-30 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center gap-2"> <span class="text-2xl">‚ò∞</span> <span class="hidden md:inline">Menu</span> </button>
       </div>
      </div>
     </div>
     <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-30"></div>
    </header><!-- View Container -->
    <div id="viewContainer" class="container mx-auto px-4 py-6"><!-- LISTA DE PROPOSTAS -->
     <div id="listaView" class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-gray-800">üéØ Minhas Propostas</h2>
       <div class="text-sm text-gray-500"><span id="contadorPropostas">0 propostas</span>
       </div>
      </div>
      <div id="listaPropostas" class="space-y-4"><!-- Propostas ser√£o inseridas aqui -->
      </div>
      <div id="emptyState" class="text-center py-12">
       <div class="text-6xl mb-4">
        üìÑ
       </div>
       <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma proposta criada ainda</h3>
       <p class="text-gray-500 mb-6">Clique em "Nova Proposta" para come√ßar</p>
      </div>
     </div>
    </div><!-- Rodap√© Fixo -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-gray-800 to-gray-900 text-white py-3 text-center shadow-lg z-40">
     <p class="text-sm font-medium">Desenvolvido por üöÄ <span class="font-bold">Fildosobral</span></p>
    </footer>
   </div>
  </div>
  <script>
    // ========== CONFIG & STATE ==========
    const defaultConfig = {
      app_title: "Planos e Cota√ß√µes",
      primary_button_text: "Nova Proposta"
    };

    // TAXAS DE JUROS (12 parcelas)
    const TAXAS_CARNE = [1.0690, 0.5523, 0.3804, 0.2946, 0.2432, 0.2091, 0.1849, 0.1668, 0.1528, 0.1417, 0.1327, 0.1252];
    const TAXAS_CARTAO = [1.0292, 0.5220, 0.3530, 0.2685, 0.2179, 0.1841, 0.1600, 0.1420, 0.1280, 0.1168, 0.1076, 0.1000];

    let allProposals = [];
    let nomeVendedorLogado = '';

    // ========== DATA SDK SETUP ==========
    const dataHandler = {
      onDataChanged(data) {
        allProposals = data;
        renderListaPropostas(data);
        updateContador(data.length);
      }
    };

    async function initializeApp() {
      try {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Erro ao inicializar Data SDK");
          document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro ao carregar o m√≥dulo.</p>';
          return;
        }

        document.getElementById('loading').classList.add('hidden');
        
        const nomeSalvo = localStorage.getItem('nomeVendedorLogado');
        
        if (nomeSalvo) {
          nomeVendedorLogado = nomeSalvo;
          document.getElementById('nomeUsuarioHeader').textContent = nomeSalvo;
          document.getElementById('mainContent').classList.remove('hidden');
          showToast(`üëã Bem-vindo de volta, ${nomeSalvo}!`, 'success');
        } else {
          document.getElementById('welcomeScreen').classList.remove('hidden');
          
          document.getElementById('btnEntrarSistema').addEventListener('click', entrarNoSistema);
          
          document.getElementById('inputNomeVendedorInicial').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              entrarNoSistema();
            }
          });
          
          setTimeout(() => {
            document.getElementById('inputNomeVendedorInicial').focus();
          }, 300);
        }

        // Event Listeners
        document.getElementById('btnNovaProposta').addEventListener('click', () => {
          mostrarFormularioProposta();
        });

        document.getElementById('btnAbrirMenu').addEventListener('click', () => {
          mostrarMenu();
        });
      } catch (error) {
        console.error("Erro na inicializa√ß√£o:", error);
        document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro ao carregar o m√≥dulo.</p>';
      }
    }
    
    function entrarNoSistema() {
      const nomeInput = document.getElementById('inputNomeVendedorInicial');
      const nome = nomeInput.value.trim();
      
      if (!nome) {
        nomeInput.classList.add('border-red-500');
        nomeInput.placeholder = '‚ö†Ô∏è Por favor, digite seu nome';
        nomeInput.focus();
        
        setTimeout(() => {
          nomeInput.classList.remove('border-red-500');
          nomeInput.placeholder = 'Digite seu nome completo';
        }, 2000);
        return;
      }
      
      nomeVendedorLogado = nome;
      localStorage.setItem('nomeVendedorLogado', nome);
      document.getElementById('nomeUsuarioHeader').textContent = nome;
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      showToast(`üéâ Bem-vindo(a), ${nome}!`, 'success');
    }

    function renderListaPropostas(data) {
      const container = document.getElementById('listaPropostas');
      const emptyState = document.getElementById('emptyState');
      
      if (data.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      container.innerHTML = data.map(proposta => {
        return `
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-5 hover:shadow-lg transition-all">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <h3 class="text-xl font-bold text-gray-800 mb-2">${proposta.titulo || 'Proposta Comercial'}</h3>
              <div class="space-y-1 text-sm text-gray-600">
                <p><strong>Cliente:</strong> ${proposta.cliente_nome}</p>
                <p><strong>Contato:</strong> ${proposta.cliente_contato}</p>
                <p><strong>Vendedor:</strong> ${proposta.vendedor}</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm">
                üëÅÔ∏è Ver
              </button>
              <button class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-all text-sm">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    function updateContador(count) {
      document.getElementById('contadorPropostas').textContent = count + ' proposta' + (count !== 1 ? 's' : '');
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // ========== MENU ==========
    function mostrarMenu() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="bg-gradient-to-r from-gray-700 to-gray-900 text-white p-6 rounded-t-2xl flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üìã Menu Principal</h2>
              <p class="text-gray-300 text-sm mt-1">Ferramentas e Configura√ß√µes</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6 space-y-3">
            <button onclick="showToast('üöß Em desenvolvimento', 'error'); this.closest('.fixed').remove();" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üìä</span>
              <div class="flex-1">
                <div class="font-bold">Taxas de Juros</div>
                <div class="text-xs text-blue-600">Consulte as taxas de carn√™ e cart√£o</div>
              </div>
            </button>
            
            <button onclick="showToast('üöß Em desenvolvimento', 'error'); this.closest('.fixed').remove();" class="w-full bg-green-50 hover:bg-green-100 text-green-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üßÆ</span>
              <div class="flex-1">
                <div class="font-bold">Calculadora</div>
                <div class="text-xs text-green-600">Calcule parcelas e valores</div>
              </div>
            </button>
            
            <button onclick="showToast('üöß Em desenvolvimento', 'error'); this.closest('.fixed').remove();" class="w-full bg-purple-50 hover:bg-purple-100 text-purple-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üìà</span>
              <div class="flex-1">
                <div class="font-bold">Relat√≥rios</div>
                <div class="text-xs text-purple-600">Visualize estat√≠sticas e dados</div>
              </div>
            </button>
            
            <button onclick="showToast('üöß Em desenvolvimento', 'error'); this.closest('.fixed').remove();" class="w-full bg-orange-50 hover:bg-orange-100 text-orange-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üì±</span>
              <div class="flex-1">
                <div class="font-bold">Baixar App</div>
                <div class="text-xs text-orange-600">Instale no seu dispositivo</div>
              </div>
            </button>
            
            <button onclick="sairSistema(); this.closest('.fixed').remove();" class="w-full bg-red-50 hover:bg-red-100 text-red-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üö™</span>
              <div class="flex-1">
                <div class="font-bold">Sair</div>
                <div class="text-xs text-red-600">Fazer logout do sistema</div>
              </div>
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }
    
    function sairSistema() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="bg-gradient-to-r from-red-600 to-rose-600 text-white p-6 rounded-t-2xl text-center">
            <div class="text-5xl mb-3">üö™</div>
            <h2 class="text-2xl font-bold">Sair do Sistema</h2>
          </div>
          
          <div class="p-6">
            <p class="text-gray-700 mb-4 text-center">
              Tem certeza que deseja sair?
            </p>
            <p class="text-sm text-gray-500 mb-6 text-center">
              Voc√™ ser√° redirecionado para a tela de login.
            </p>
            
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 transition-all">
                Cancelar
              </button>
              <button onclick="confirmarSaida()" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all">
                Sair
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function confirmarSaida() {
      localStorage.removeItem('nomeVendedorLogado');
      location.reload();
    }

    // ========== FORMUL√ÅRIO DE PROPOSTA ==========
    function mostrarFormularioProposta() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.style.overflowY = 'auto';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
          <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
            <div>
              <h2 class="text-2xl font-bold">‚ûï Nova Proposta</h2>
              <p class="text-blue-100 text-sm mt-1">Preencha os dados da proposta</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6">
            <form id="formNovaProposta" class="space-y-6">
              
              <!-- Dados B√°sicos -->
              <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-6">
                <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                  <span>üìù</span>
                  <span>Dados B√°sicos</span>
                </h3>
                
                <div class="bg-blue-100 border border-blue-300 rounded-lg p-3 mb-4">
                  <p class="text-blue-800 font-semibold text-sm">üè™ Iguatu 3 - Ao lado do Bradesco</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Nome do Vendedor</label>
                    <input type="text" id="inputVendedor" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${nomeVendedorLogado}" readonly>
                  </div>
                  
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                      <span>üë§ Nome do Cliente *</span>
                    </label>
                    <input type="text" id="inputCliente" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Digite o nome do cliente">
                  </div>
                  
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                      <span>üì± WhatsApp do Cliente (com DDD) *</span>
                    </label>
                    <input type="tel" id="inputContato" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="(88) 99999-9999">
                  </div>
                  
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">üìÖ Data Atual</label>
                    <input type="date" id="inputDataAtual" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">‚è∞ Validade da Proposta</label>
                    <input type="date" id="inputValidade" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">T√≠tulo da Proposta</label>
                    <input type="text" id="inputTitulo" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="Proposta Comercial">
                  </div>
                </div>
              </div>

              <!-- Bot√µes de A√ß√£o -->
              <div class="flex gap-4">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-400 transition-all">
                  Cancelar
                </button>
                
                <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 shadow-lg transition-all flex items-center justify-center gap-2">
                  <span>üíæ</span>
                  <span>Salvar Proposta</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Define data atual
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('inputDataAtual').value = hoje;

      // Event listener do formul√°rio
      document.getElementById('formNovaProposta').addEventListener('submit', async (e) => {
        e.preventDefault();
        await salvarProposta();
      });
    }

    async function salvarProposta() {
      const clienteNome = document.getElementById('inputCliente').value.trim();
      const clienteContato = document.getElementById('inputContato').value.trim();
      
      if (!clienteNome || !clienteContato) {
        showToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      const proposta = {
        id: 'prop_' + Date.now(),
        vendedor: document.getElementById('inputVendedor').value || nomeVendedorLogado,
        cliente_nome: clienteNome,
        cliente_contato: clienteContato,
        titulo: document.getElementById('inputTitulo').value || 'Proposta Comercial',
        data: document.getElementById('inputDataAtual').value,
        validade: document.getElementById('inputValidade').value,
        criado_em: new Date().toISOString()
      };

      // Mostra loading
      const btnSalvar = document.querySelector('#formNovaProposta button[type="submit"]');
      const textoOriginal = btnSalvar.innerHTML;
      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<span class="animate-spin">‚è≥</span> Salvando...';

      const result = await window.dataSdk.create(proposta);
      
      if (result.isOk) {
        document.querySelector('.fixed').remove();
        showToast('‚úÖ Proposta criada com sucesso!', 'success');
      } else {
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
        showToast('‚ùå Erro ao salvar proposta. Tente novamente.', 'error');
      }
    }

    // Inicializa o app quando o DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
// ======================================================================
// üîå BLOCO FS ‚Äì WHATSAPP COM IMAGEM (CLIENTE / DIRETORIA)
// N√ÉO APAGA NADA DO QUE J√Å EXISTE. APENAS COLA ESSE TRECHO NO FINAL.
// ======================================================================

let visaoPreviewAtual = null;

// Envolve as fun√ß√µes existentes de visualiza√ß√£o para saber qual vis√£o est√° ativa
if (typeof visualizarPropostaCliente === 'function') {
  const _visualizarPropostaClienteOriginal = visualizarPropostaCliente;
  visualizarPropostaCliente = function () {
    visaoPreviewAtual = 'cliente';
    _visualizarPropostaClienteOriginal();
  };
}

if (typeof visualizarPropostaDiretoria === 'function') {
  const _visualizarPropostaDiretoriaOriginal = visualizarPropostaDiretoria;
  visualizarPropostaDiretoria = function () {
    visaoPreviewAtual = 'diretoria';
    _visualizarPropostaDiretoriaOriginal();
  };
}

// Assim que a tela carregar, cria os bot√µes de WhatsApp ao lado dos bot√µes principais
document.addEventListener('DOMContentLoaded', function () {
  try {
    const containerBotoes = document.querySelector('.flex.flex-wrap.gap-4');
    if (!containerBotoes) return;

    // Bot√£o para Cliente
    const btnWhatsCliente = document.createElement('button');
    btnWhatsCliente.className =
      'flex-1 min-w-max bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2';
    btnWhatsCliente.innerHTML = '<span>üì§</span><span>Enviar Whats ‚Äì Cliente</span>';
    btnWhatsCliente.addEventListener('click', function () {
      enviarWhatsappComImagem('cliente');
    });

    // Bot√£o para Diretoria
    const btnWhatsDiretoria = document.createElement('button');
    btnWhatsDiretoria.className =
      'flex-1 min-w-max bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2';
    btnWhatsDiretoria.innerHTML = '<span>üè¢</span><span>Enviar Whats ‚Äì Diretoria</span>';
    btnWhatsDiretoria.addEventListener('click', function () {
      enviarWhatsappComImagem('diretoria');
    });

    containerBotoes.appendChild(btnWhatsCliente);
    containerBotoes.appendChild(btnWhatsDiretoria);
  } catch (e) {
    console.error('Erro ao criar bot√µes de WhatsApp:', e);
  }
});

// Fun√ß√£o principal: gera imagem + abre WhatsApp
async function enviarWhatsappComImagem(tipo) {
  try {
    if (!window.html2canvas) {
      showToast('‚ùå html2canvas n√£o encontrado na p√°gina.', 'error');
      return;
    }

    // Garante que existe pelo menos 1 produto
    if (!Array.isArray(produtos) || produtos.length === 0) {
      showToast('Adicione pelo menos 1 produto antes de enviar.', 'error');
      return;
    }

    // Abre o preview correto (usa as fun√ß√µes que j√° existem)
    if (tipo === 'cliente') {
      if (typeof visualizarPropostaCliente === 'function') {
        visualizarPropostaCliente();
      } else {
        showToast('Fun√ß√£o visualizarPropostaCliente n√£o encontrada.', 'error');
        return;
      }
    } else {
      if (typeof visualizarPropostaDiretoria === 'function') {
        visualizarPropostaDiretoria();
      } else {
        showToast('Fun√ß√£o visualizarPropostaDiretoria n√£o encontrada.', 'error');
        return;
      }
    }

    // D√° um tempinho pro HTML montar o preview
    await delayFS(500);

    const previewContent = document.getElementById('previewContent');
    if (!previewContent) {
      showToast('Preview da proposta n√£o encontrado.', 'error');
      return;
    }

    // Gera imagem em alta qualidade do preview
    const canvas = await html2canvas(previewContent, {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff'
    });

    const dataUrl = canvas.toDataURL('image/png');

    // Nome do arquivo usando cliente + tipo de vis√£o
    const nomeCliente = (document.getElementById('inputClienteNome')?.value || 'cliente').trim() || 'cliente';
    const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
    const nomeArquivo = `proposta-${tipo}-${nomeCliente.replace(/\s+/g, '-').toLowerCase()}-${timestamp}.png`;

    // For√ßa o download da imagem
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = nomeArquivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('üì∏ Imagem da proposta gerada e baixada!', 'success');

    // Fecha o preview, se existir fun√ß√£o
    if (typeof fecharPreview === 'function') {
      fecharPreview();
    }

    // Pega o telefone do cliente (ou pergunta, se n√£o tiver)
    let numero = (document.getElementById('inputClienteTelefone')?.value || '').replace(/\D/g, '');
    if (!numero) {
      numero = prompt('Informe o n√∫mero do cliente (somente n√∫meros, com DDD):', '');
      if (!numero) {
        showToast('N√∫mero do cliente n√£o informado.', 'error');
        return;
      }
    }

    // Mensagem padr√£o para o WhatsApp
    const lojaNome = document.getElementById('inputLoja')?.value || 'Zenir';
    const tituloProposta = document.getElementById('inputTituloProposta')?.value || 'Proposta Especial';
    const saudacao = tipo === 'cliente'
      ? `Ol√°, ${nomeCliente}! Tudo bem?`
      : `Ol√°, boa tarde!`;

    let mensagem = `${saudacao}\n\n`;
    mensagem += `Envio em anexo a imagem da *${tipo === 'cliente' ? 'Proposta Comercial' : 'Cota√ß√£o para an√°lise da Diretoria'}*.\n`;
    mensagem += `üè™ Loja: ${lojaNome}\n`;
    mensagem += `üìã T√≠tulo: ${tituloProposta}\n\n`;
    mensagem += `üì∏ *Aten√ß√£o*: a proposta est√° detalhada na imagem que acabei de enviar.\n`;
    mensagem += `Qualquer d√∫vida, fico √† disposi√ß√£o!\n`;

    const mensagemCodificada = encodeURIComponent(mensagem);
    const numeroBrasil = numero.startsWith('55') ? numero : `55${numero}`;

    const urlWhats = `https://wa.me/${numeroBrasil}?text=${mensagemCodificada}`;
    window.open(urlWhats, '_blank');
  } catch (erro) {
    console.error('Erro ao gerar imagem / enviar WhatsApp:', erro);
    showToast('Erro ao gerar imagem ou enviar WhatsApp.', 'error');
  }
}

// Pequeno helper de delay
function delayFS(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ======================================================================
// üîö FIM DO BLOCO FS ‚Äì WHATSAPP COM IMAGEM
// ======================================================================

 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a51ac37236a4f83',t:'MTc2NDI0NzAwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>