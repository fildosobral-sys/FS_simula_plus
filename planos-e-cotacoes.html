<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planos e Cotacoes</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas para gerar imagem -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #eef2ff 40%, #f9fafb 100%);
    }

    /* Evita quebra feia quando gerar imagem A4 */
    .a4-page {
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
      box-sizing: border-box;
    }

    .no-print {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  </style>
</head>
<body class="h-full">

  <!-- TELA DE CARREGAMENTO -->
  <div id="loadingScreen" class="flex items-center justify-center h-full text-xl text-sky-700">
    <div class="flex flex-col items-center gap-3">
      <div class="w-12 h-12 border-4 border-sky-300 border-t-sky-600 rounded-full animate-spin"></div>
      <p>Carregando modulo...</p>
    </div>
  </div>

  <!-- APP -->
  <div id="appRoot" class="hidden h-full">

    <!-- TOPO -->
    <header class="bg-gradient-to-r from-sky-700 to-indigo-700 text-white shadow-lg">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold tracking-tight">FS Simula+ ‚Ä¢ Planos e Cotacoes</h1>
          <p class="text-xs text-sky-100 mt-1">
            Propostas comerciais com visao Cliente e Diretoria ‚Ä¢ Offline (salvo no navegador)
          </p>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right">
            <p class="text-xs text-sky-100">Vendedor logado</p>
            <p id="headerVendedor" class="text-sm font-semibold"></p>
          </div>
          <button id="btnTrocarVendedor"
                  class="text-xs px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 border border-sky-200">
            Trocar usuario
          </button>
        </div>
      </div>
    </header>

    <!-- CONTEUDO PRINCIPAL -->
    <main class="max-w-6xl mx-auto px-4 py-4 grid md:grid-cols-2 gap-4">

      <!-- COLUNA ESQUERDA ‚Äì FORMULARIO / LISTA -->
      <section class="space-y-4">

        <!-- Card: dados gerais -->
        <div class="bg-white rounded-xl shadow-md border border-sky-100 p-4">
          <h2 class="text-base font-bold text-sky-800 mb-3 flex items-center gap-2">
            <span>üìù</span> <span>Dados da Proposta</span>
          </h2>

          <div class="grid grid-cols-1 gap-3 text-sm">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Titulo da Proposta</label>
              <input id="inputTituloProposta" type="text"
                     class="w-full border rounded-lg px-3 py-2 text-sm"
                     placeholder="Ex: Iguatu 3 - Ao lado do Bradesco" />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600 mb-1">Loja</label>
                <input id="inputLojaNome" type="text"
                       class="w-full border rounded-lg px-3 py-2 text-sm"
                       placeholder="Ex: Iguatu 3" />
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">Data da Proposta</label>
                <input id="inputDataProposta" type="date"
                       class="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600 mb-1">Validade da Proposta</label>
                <input id="inputValidadeProposta" type="date"
                       class="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">Contato do Cliente (WhatsApp)</label>
                <input id="inputClienteContato" type="tel"
                       class="w-full border rounded-lg px-3 py-2 text-sm"
                       placeholder="(88) 9 9999-9999" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600 mb-1">Nome do Cliente</label>
                <input id="inputClienteNome" type="text"
                       class="w-full border rounded-lg px-3 py-2 text-sm"
                       placeholder="Nome do cliente" />
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">Vendedor</label>
                <input id="inputVendedorNome" type="text"
                       class="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
            </div>
          </div>
        </div>

        <!-- Card: PRODUTOS -->
        <div class="bg-white rounded-xl shadow-md border border-emerald-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-base font-bold text-emerald-800 flex items-center gap-2">
              <span>üõí</span> <span>Produtos da Proposta</span>
            </h2>
            <button id="btnAddProduto"
                    class="text-xs px-3 py-1 rounded-full bg-emerald-500 text-white font-semibold hover:bg-emerald-600">
              + Adicionar produto
            </button>
          </div>

          <!-- Form pequeno para produto -->
          <div class="grid grid-cols-1 gap-2 mb-3 text-xs border rounded-lg p-3 bg-emerald-50/60">
            <div class="grid grid-cols-3 gap-2">
              <div class="col-span-2">
                <label class="block mb-1 text-gray-600">Codigo / Descricao</label>
                <input id="inputProdutoNome" class="w-full border rounded-lg px-2 py-1"
                       type="text" placeholder="Ex: 11962 - Roupeiro..." />
              </div>
              <div>
                <label class="block mb-1 text-gray-600">Modalidade</label>
                <select id="inputModalidade" class="w-full border rounded-lg px-2 py-1">
                  <option value="carne">Carne</option>
                  <option value="cartao">Cartao</option>
                  <option value="avista">A vista</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block mb-1 text-gray-600">Parcelas</label>
                <input id="inputParcelas" class="w-full border rounded-lg px-2 py-1" type="number" min="1" max="24" value="12" />
              </div>
              <div>
                <label class="block mb-1 text-gray-600">Preco Normal (R$)</label>
                <input id="inputPrecoNormal" class="w-full border rounded-lg px-2 py-1" type="number" min="0" step="0.01" />
              </div>
              <div>
                <label class="block mb-1 text-gray-600">Preco Promo (R$)</label>
                <input id="inputPrecoPromo" class="w-full border rounded-lg px-2 py-1" type="number" min="0" step="0.01" />
              </div>
            </div>
          </div>

          <!-- Lista de produtos -->
          <div id="listaProdutosVazia" class="text-xs text-gray-500 text-center py-4 border border-dashed rounded-lg">
            Nenhum produto adicionado ainda.
          </div>
          <div id="listaProdutos" class="space-y-2 text-xs hidden"></div>
        </div>

        <!-- Card: CAMPOS INTERNOS -->
        <div class="bg-white rounded-xl shadow-md border border-amber-100 p-4">
          <h2 class="text-base font-bold text-amber-900 mb-3 flex items-center gap-2">
            <span>üè¢</span> <span>Campos para Diretoria / Observacoes</span>
          </h2>
          <div class="space-y-2 text-xs">
            <div>
              <label class="block mb-1 text-gray-600">Solicitante / Informacoes (historico da negociacao)</label>
              <textarea id="inputHistorico" rows="2"
                        class="w-full border rounded-lg px-2 py-1"></textarea>
            </div>
            <div>
              <label class="block mb-1 text-gray-600">Proposta da Gerencia (perdas x ganhos)</label>
              <textarea id="inputSimulacao" rows="2"
                        class="w-full border rounded-lg px-2 py-1"></textarea>
            </div>
            <div>
              <label class="block mb-1 text-gray-600">Observacoes importantes / Oportunidades</label>
              <textarea id="inputOportunidades" rows="2"
                        class="w-full border rounded-lg px-2 py-1"></textarea>
            </div>
          </div>
        </div>

        <!-- BOTOES SALVAR / NOVA -->
        <div class="flex gap-3">
          <button id="btnSalvarProposta"
                  class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 rounded-lg">
            üíæ Salvar proposta
          </button>
          <button id="btnNovaProposta"
                  class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg">
            ‚ú® Nova proposta
          </button>
        </div>

        <!-- LISTA DE PROPOSTAS SALVAS -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-base font-bold text-gray-800 flex items-center gap-2">
              <span>üìÇ</span> <span>Propostas Salvas</span>
            </h2>
            <span id="contadorPropostas" class="text-xs text-gray-500"></span>
          </div>
          <div id="listaPropostas" class="space-y-2 text-xs"></div>
          <div id="emptyStatePropostas" class="text-xs text-gray-500 text-center py-4">
            Nenhuma proposta salva ainda.
          </div>
        </div>

      </section>

      <!-- COLUNA DIREITA ‚Äì PREVIEW / ACOES -->
      <section class="space-y-4">

        <!-- TABS -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100">
          <div class="border-b border-gray-200 flex">
            <button id="tabCliente"
                    class="flex-1 px-4 py-2 text-sm font-semibold border-b-2 border-sky-600 text-sky-700">
              üë§ Visao Cliente
            </button>
            <button id="tabDiretoria"
                    class="flex-1 px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-500">
              üè¢ Visao Diretoria
            </button>
          </div>

          <div class="p-4 bg-slate-50">
            <!-- Conteudo Cliente -->
            <div id="contentClienteWrapper">
              <div id="contentCliente" class="bg-white rounded-lg shadow-inner p-4 text-xs text-gray-700">
                Nenhuma proposta selecionada.
              </div>
            </div>
            <!-- Conteudo Diretoria -->
            <div id="contentDiretoriaWrapper" class="hidden">
              <div id="contentDiretoria" class="bg-white rounded-lg shadow-inner p-4 text-xs text-gray-700">
                Nenhuma proposta selecionada.
              </div>
            </div>
          </div>
        </div>

        <!-- ACOES WHATS / IMAGEM -->
        <div class="bg-white rounded-xl shadow-md border border-sky-100 p-4 space-y-3">
          <h2 class="text-sm font-bold text-gray-800 mb-1 flex items-center gap-2">
            <span>üì§</span> <span>Enviar / Baixar</span>
          </h2>
          <p class="text-xs text-gray-500">
            1) Clique em <strong>Gerar/baixar imagem</strong> para salvar o arquivo PNG.<br>
            2) Em seguida, envie manualmente a imagem pelo WhatsApp junto com a mensagem pronta.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="btnImagemCliente"
                    class="flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold py-2 rounded-lg">
              <span>üì∏</span> <span>Gerar imagem - Cliente</span>
            </button>
            <button id="btnImagemDiretoria"
                    class="flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold py-2 rounded-lg">
              <span>üì∏</span> <span>Gerar imagem - Diretoria</span>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="btnWhatsCliente"
                    class="flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-2 rounded-lg">
              <span>üì±</span> <span>WhatsApp - Cliente</span>
            </button>
            <button id="btnWhatsDiretoria"
                    class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 rounded-lg">
              <span>üè¢</span> <span>WhatsApp - Diretoria</span>
            </button>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- MODAL LOGIN INICIAL -->
  <div id="modalLogin"
       class="fixed inset-0 bg-sky-900/70 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <div class="text-center mb-4">
        <div class="text-4xl mb-2">üëã</div>
        <h2 class="text-xl font-bold text-sky-800">Bem-vindo ao FS Simula+</h2>
        <p class="text-xs text-gray-500 mt-1">
          Informe seu nome para entrar no modulo <strong>Planos e Cotacoes</strong>.
        </p>
      </div>
      <div class="space-y-3 text-sm">
        <div>
          <label class="block text-xs text-gray-600 mb-1">Seu nome (como aparece na proposta)</label>
          <input id="inputNomeLogin" type="text"
                 class="w-full border rounded-lg px-3 py-2"
                 placeholder="Ex: FILDO" />
        </div>
        <button id="btnEntrarLogin"
                class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 rounded-lg">
          Entrar no sistema
        </button>
      </div>
      <p class="text-[11px] text-gray-400 mt-3 text-center">
        O nome fica salvo apenas neste dispositivo (localStorage).
      </p>
    </div>
  </div>

  <script>
    // ======================= STORAGE OFFLINE (SUBSTITUI CANVA) =======================
    const STORAGE_KEY = 'fs_planos_cotacoes_v1';

    function carregarTodasPropostas() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('Erro ao ler propostas do localStorage:', e);
        return [];
      }
    }

    function salvarTodasPropostas(lista) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
      } catch (e) {
        console.error('Erro ao salvar propostas no localStorage:', e);
      }
    }

    // ======================= VARIAVEIS GLOBAIS =======================
    let nomeVendedorLogado = '';
    let allProposals = [];
    let currentProposalId = null;
    let produtos = [];
    let currentProposalData = null;

    // ======================= HELPERS =======================
    function formatarMoedaBR(valor) {
      const n = Number(valor) || 0;
      return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function calcularDescontoProduto(p) {
      const normal = Number(p.preco_normal) || 0;
      const promo  = Number(p.preco_promo)  || 0;
      const valor  = Math.max(normal - promo, 0);
      const perc   = normal > 0 ? ((valor / normal) * 100) : 0;
      return {
        valor,
        percentual: perc.toFixed(1)
      };
    }

    function formatarDataBR(iso) {
      if (!iso) return 'N/A';
      const [y,m,d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }

    function showToast(msg, tipo = 'success') {
      const div = document.createElement('div');
      div.className =
        'fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-sm font-semibold z-50 ' +
        (tipo === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white');
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    function gerarId() {
      return 'p_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
    }

    // ======================= RENDER PRODUTOS NO EDITOR =======================
    function renderProdutosEditor() {
      const lista = document.getElementById('listaProdutos');
      const vazio = document.getElementById('listaProdutosVazia');

      if (!produtos.length) {
        lista.classList.add('hidden');
        vazio.classList.remove('hidden');
        lista.innerHTML = '';
        return;
      }

      vazio.classList.add('hidden');
      lista.classList.remove('hidden');

      lista.innerHTML = produtos.map((p, idx) => {
        const desc = calcularDescontoProduto(p);
        return `
          <div class="flex items-center justify-between border rounded-lg px-3 py-2 bg-white">
            <div class="flex-1">
              <p class="font-semibold text-gray-800">${p.produto_completo}</p>
              <p class="text-[11px] text-gray-500">
                ${p.modalidade.toUpperCase()} ‚Ä¢ ${p.parcelas}x ‚Ä¢
                Normal ${formatarMoedaBR(p.preco_normal)} ‚Üí
                Promo ${formatarMoedaBR(p.preco_promo)} (${desc.percentual}% OFF)
              </p>
            </div>
            <button onclick="removerProduto(${idx})"
                    class="ml-3 text-xs px-2 py-1 rounded bg-red-100 text-red-600 hover:bg-red-200">
              Excluir
            </button>
          </div>
        `;
      }).join('');
    }

    function removerProduto(index) {
      produtos.splice(index, 1);
      renderProdutosEditor();
      atualizarPreview();
    }

    // ======================= RENDER VISAO CLIENTE =======================
    function renderVisaoCliente(data) {
      if (!data || !data.produtos || !data.produtos.length) {
        document.getElementById('contentCliente').innerHTML =
          '<p class="text-xs text-gray-500 text-center py-6">Nenhuma proposta selecionada.</p>';
        return;
      }

      const totalNormal = data.produtos.reduce(
        (s, p) => s + (Number(p.preco_normal) || 0), 0
      );
      const totalPromo  = data.produtos.reduce(
        (s, p) => s + (Number(p.preco_promo)  || 0), 0
      );
      const economia = Math.max(totalNormal - totalPromo, 0);
      const percTotal = totalNormal > 0 ? ((economia / totalNormal) * 100).toFixed(1) : '0.0';

      // Para simplificar, usa o primeiro produto para destaque
      const primeiro = data.produtos[0];
      const descPrimeiro = calcularDescontoProduto(primeiro);

      const html = `
        <div class="a4-page mx-auto bg-slate-50">
          <!-- Cabecalho -->
          <div class="mb-4 border-b border-slate-200 pb-3">
            <h2 class="text-center text-lg font-bold text-sky-800">
              ${data.loja_nome || 'Loja'} - Proposta Comercial
            </h2>
            <p class="text-center text-xs text-gray-500 mt-1">
              Proposta para: <strong>${data.cliente_nome || 'Cliente'}</strong> ‚Ä¢
              Data: <strong>${formatarDataBR(data.data_proposta)}</strong>
            </p>
          </div>

          <!-- Produto destaque -->
          <div class="mb-4 rounded-xl bg-white shadow border border-sky-100 overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
              <div>
                <p class="text-xs text-gray-500">Produto principal</p>
                <p class="text-sm font-bold text-gray-800">
                  ${primeiro.produto_completo || 'Produto'}
                </p>
              </div>
              <div class="text-right text-xs">
                <p class="line-through text-gray-400">
                  De ${formatarMoedaBR(primeiro.preco_normal)}
                </p>
                <p class="text-emerald-600 font-bold text-base">
                  ${primeiro.parcelas}x de ${formatarMoedaBR(primeiro.preco_promo / (primeiro.parcelas || 1))}
                </p>
                <p class="text-[11px] text-gray-500">
                  Economia total: <span class="text-rose-500 font-semibold">
                  ${formatarMoedaBR(descPrimeiro.valor)} (${descPrimeiro.percentual}%)
                  </span>
                </p>
              </div>
            </div>
          </div>

          <!-- Resumo -->
          <div class="mb-4 rounded-xl border-2 border-emerald-300 bg-emerald-50 px-4 py-3">
            <h3 class="text-sm font-bold text-emerald-900 mb-2 flex items-center gap-2">
              <span>üí∞</span> <span>Resumo da Proposta</span>
            </h3>
            <div class="grid grid-cols-3 gap-3 text-xs">
              <div>
                <p class="text-gray-500">Valor normal</p>
                <p class="font-bold text-gray-700">${formatarMoedaBR(totalNormal)}</p>
              </div>
              <div>
                <p class="text-gray-500">Valor negociado</p>
                <p class="font-bold text-emerald-700">${formatarMoedaBR(totalPromo)}</p>
              </div>
              <div>
                <p class="text-gray-500">Economia total</p>
                <p class="font-bold text-rose-600">
                  ${formatarMoedaBR(economia)} (${percTotal}%)
                </p>
              </div>
            </div>
          </div>

          <!-- Tabela de produtos -->
          <div class="mb-4 bg-white rounded-xl border border-slate-200 overflow-hidden">
            <div class="px-4 py-2 border-b bg-slate-100 text-xs font-semibold text-slate-700 flex items-center gap-2">
              <span>üì¶</span> <span>Produtos incluidos</span>
            </div>
            <table class="w-full text-[11px]">
              <thead>
                <tr class="bg-slate-50 text-left">
                  <th class="px-3 py-2">Produto</th>
                  <th class="px-3 py-2 text-right">Normal</th>
                  <th class="px-3 py-2 text-right">Promo</th>
                  <th class="px-3 py-2 text-right">Desc. R$</th>
                  <th class="px-3 py-2 text-right">Desc. %</th>
                </tr>
              </thead>
              <tbody>
                ${data.produtos.map((p, i) => {
                  const d = calcularDescontoProduto(p);
                  return `
                    <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                      <td class="px-3 py-1">${p.produto_completo}</td>
                      <td class="px-3 py-1 text-right">${formatarMoedaBR(p.preco_normal)}</td>
                      <td class="px-3 py-1 text-right text-emerald-700 font-semibold">
                        ${formatarMoedaBR(p.preco_promo)}
                      </td>
                      <td class="px-3 py-1 text-right text-rose-600">${formatarMoedaBR(d.valor)}</td>
                      <td class="px-3 py-1 text-right text-rose-600">${d.percentual}%</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="pt-4 border-t border-slate-200 text-center text-[11px] text-gray-500">
            Proposta exclusiva e personalizada ‚Ä¢ ${data.loja_nome || 'Loja'}<br/>
            Vendedor: <strong>${data.vendedor_nome || 'Vendedor'}</strong>
          </div>
        </div>
      `;

      document.getElementById('contentCliente').innerHTML = html;
    }

    // ======================= RENDER VISAO DIRETORIA =======================
    function renderVisaoDiretoria(data) {
      if (!data || !data.produtos || !data.produtos.length) {
        document.getElementById('contentDiretoria').innerHTML =
          '<p class="text-xs text-gray-500 text-center py-6">Nenhuma proposta selecionada.</p>';
        return;
      }

      const totalNormal = data.produtos.reduce(
        (s, p) => s + (Number(p.preco_normal) || 0), 0
      );
      const totalPromo  = data.produtos.reduce(
        (s, p) => s + (Number(p.preco_promo)  || 0), 0
      );
      const economia = Math.max(totalNormal - totalPromo, 0);

      const html = `
        <div class="a4-page mx-auto bg-yellow-50 border border-yellow-300 rounded-xl p-4">
          <!-- cabecalho -->
          <div class="mb-3 pb-2 border-b-2 border-yellow-400 flex items-start justify-between">
            <div>
              <h2 class="text-sm font-bold text-gray-800">üîí VISAO DIRETORIA</h2>
              <p class="text-[11px] text-gray-600">Analise completa da proposta</p>
            </div>
            <div class="text-[11px] text-gray-600 text-right">
              <p>Loja: <strong>${data.loja_nome || 'N/A'}</strong></p>
              <p>Vendedor: <strong>${data.vendedor_nome || 'N/A'}</strong></p>
              <p>Data: <strong>${formatarDataBR(data.data_proposta)}</strong></p>
              ${data.validade_proposta ? `<p>Validade: <strong>${formatarDataBR(data.validade_proposta)}</strong></p>` : ''}
              ${data.cliente_nome ? `<p>Cliente: <strong>${data.cliente_nome}</strong></p>` : ''}
              ${data.cliente_contato ? `<p>Contato: <strong>${data.cliente_contato}</strong></p>` : ''}
            </div>
          </div>

          <!-- tabela -->
          <div class="mb-3">
            <h3 class="text-xs font-bold text-gray-800 mb-1 flex items-center gap-2">
              <span>üìä</span> <span>Tabela completa de produtos</span>
            </h3>
            <div class="overflow-x-auto border border-yellow-200 bg-white rounded-lg">
              <table class="w-full text-[10px] border-collapse">
                <thead>
                  <tr class="bg-yellow-100">
                    <th class="border border-yellow-200 px-2 py-1 text-left">Codigo / Produto</th>
                    <th class="border border-yellow-200 px-2 py-1 text-right">Preco Normal</th>
                    <th class="border border-yellow-200 px-2 py-1 text-right">Preco Promo</th>
                    <th class="border border-yellow-200 px-2 py-1 text-right">Desconto R$</th>
                    <th class="border border-yellow-200 px-2 py-1 text-right">Desconto %</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.produtos.map(p => {
                    const d = calcularDescontoProduto(p);
                    return `
                      <tr>
                        <td class="border border-yellow-200 px-2 py-1">${p.produto_completo}</td>
                        <td class="border border-yellow-200 px-2 py-1 text-right">${formatarMoedaBR(p.preco_normal)}</td>
                        <td class="border border-yellow-200 px-2 py-1 text-right text-emerald-700">
                          ${formatarMoedaBR(p.preco_promo)}
                        </td>
                        <td class="border border-yellow-200 px-2 py-1 text-right text-rose-600">
                          ${formatarMoedaBR(d.valor)}
                        </td>
                        <td class="border border-yellow-200 px-2 py-1 text-right text-rose-600">
                          ${d.percentual}%
                        </td>
                      </tr>
                    `;
                  }).join('')}
                  <tr class="bg-yellow-100 font-bold">
                    <td class="border border-yellow-200 px-2 py-1">TOTAL</td>
                    <td class="border border-yellow-200 px-2 py-1 text-right">${formatarMoedaBR(totalNormal)}</td>
                    <td class="border border-yellow-200 px-2 py-1 text-right text-emerald-700">
                      ${formatarMoedaBR(totalPromo)}
                    </td>
                    <td class="border border-yellow-200 px-2 py-1 text-right text-rose-600">
                      ${formatarMoedaBR(economia)}
                    </td>
                    <td class="border border-yellow-200 px-2 py-1"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- blocos de texto -->
          <div class="grid grid-cols-1 gap-2 text-[11px]">
            ${data.historico_negociacao ? `
              <div class="bg-white border border-yellow-200 rounded-lg p-2">
                <h4 class="font-semibold text-gray-800 mb-1">üìù Solicitante / Informacoes</h4>
                <p class="whitespace-pre-line text-gray-700 font-medium">${data.historico_negociacao}</p>
              </div>` : ''}

            ${data.simulacao_perdas_ganhos ? `
              <div class="bg-white border border-yellow-200 rounded-lg p-2">
                <h4 class="font-semibold text-gray-800 mb-1">üíº Proposta da gerencia</h4>
                <p class="whitespace-pre-line text-gray-700 font-medium">${data.simulacao_perdas_ganhos}</p>
              </div>` : ''}

            ${data.oportunidades_melhoria ? `
              <div class="bg-white border border-yellow-200 rounded-lg p-2">
                <h4 class="font-semibold text-gray-800 mb-1">üìå Observacoes importantes</h4>
                <p class="whitespace-pre-line text-gray-700">${data.oportunidades_melhoria}</p>
              </div>` : ''}
          </div>

          <div class="mt-3 pt-2 border-t border-yellow-300 text-center text-[11px] text-gray-600">
            Demonstrativo das solicitacoes de clientes.
          </div>
        </div>
      `;

      document.getElementById('contentDiretoria').innerHTML = html;
    }

    // ======================= PREVIEW GERAL =======================
    function atualizarPreview() {
      if (!currentProposalData) return;
      currentProposalData.produtos = produtos.slice();
      renderVisaoCliente(currentProposalData);
      renderVisaoDiretoria(currentProposalData);
    }

    // ======================= LISTA PROPOSTAS =======================
    function atualizarListaPropostas() {
      const cont = document.getElementById('listaPropostas');
      const empty = document.getElementById('emptyStatePropostas');
      const label = document.getElementById('contadorPropostas');

      if (!allProposals.length) {
        cont.innerHTML = '';
        empty.classList.remove('hidden');
        label.textContent = '0 propostas';
        return;
      }

      empty.classList.add('hidden');
      label.textContent = allProposals.length === 1
        ? '1 proposta' : `${allProposals.length} propostas`;

      cont.innerHTML = allProposals.map(p => {
        const totalPromo = p.produtos.reduce(
          (s, pr) => s + (Number(pr.preco_promo) || 0), 0
        );
        return `
          <div class="border border-gray-200 rounded-lg px-3 py-2 bg-white flex items-center justify-between">
            <div class="text-xs">
              <p class="font-semibold text-gray-800">${p.titulo_proposta || 'Sem titulo'}</p>
              <p class="text-[11px] text-gray-500">
                ${formatarDataBR(p.data_proposta)} ‚Ä¢ ${p.loja_nome || 'Loja'} ‚Ä¢
                ${p.produtos.length} prod. ‚Ä¢ Total ${formatarMoedaBR(totalPromo)}
              </p>
            </div>
            <div class="flex gap-2">
              <button onclick="carregarProposta('${p.id}')"
                      class="text-[11px] px-2 py-1 rounded bg-sky-100 text-sky-700 hover:bg-sky-200">
                Abrir
              </button>
              <button onclick="excluirProposta('${p.id}')"
                      class="text-[11px] px-2 py-1 rounded bg-red-100 text-red-600 hover:bg-red-200">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function carregarProposta(id) {
      const p = allProposals.find(x => x.id === id);
      if (!p) return;

      currentProposalId = p.id;
      currentProposalData = JSON.parse(JSON.stringify(p));
      produtos = currentProposalData.produtos.slice();

      // preencher formulario
      document.getElementById('inputTituloProposta').value     = p.titulo_proposta || '';
      document.getElementById('inputLojaNome').value           = p.loja_nome || '';
      document.getElementById('inputDataProposta').value       = p.data_proposta || '';
      document.getElementById('inputValidadeProposta').value   = p.validade_proposta || '';
      document.getElementById('inputClienteContato').value     = p.cliente_contato || '';
      document.getElementById('inputClienteNome').value        = p.cliente_nome || '';
      document.getElementById('inputVendedorNome').value       = p.vendedor_nome || '';
      document.getElementById('inputHistorico').value          = p.historico_negociacao || '';
      document.getElementById('inputSimulacao').value          = p.simulacao_perdas_ganhos || '';
      document.getElementById('inputOportunidades').value      = p.oportunidades_melhoria || '';

      renderProdutosEditor();
      atualizarPreview();
      showToast('Proposta carregada.');
    }

    function excluirProposta(id) {
      if (!confirm('Deseja realmente excluir esta proposta?')) return;
      allProposals = allProposals.filter(p => p.id !== id);
      salvarTodasPropostas(allProposals);
      atualizarListaPropostas();
      showToast('Proposta excluida.');
    }

    // ======================= FORMULARIO / SALVAR =======================
    function montarObjetoProposta() {
      return {
        id: currentProposalId || gerarId(),
        titulo_proposta: document.getElementById('inputTituloProposta').value.trim(),
        loja_nome: document.getElementById('inputLojaNome').value.trim(),
        data_proposta: document.getElementById('inputDataProposta').value,
        validade_proposta: document.getElementById('inputValidadeProposta').value,
        cliente_contato: document.getElementById('inputClienteContato').value.trim(),
        cliente_nome: document.getElementById('inputClienteNome').value.trim(),
        vendedor_nome: document.getElementById('inputVendedorNome').value.trim() || nomeVendedorLogado,
        historico_negociacao: document.getElementById('inputHistorico').value.trim(),
        simulacao_perdas_ganhos: document.getElementById('inputSimulacao').value.trim(),
        oportunidades_melhoria: document.getElementById('inputOportunidades').value.trim(),
        produtos: produtos.slice(),
        created_at: currentProposalData?.created_at || new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
    }

    function limparFormulario() {
      currentProposalId = null;
      currentProposalData = null;
      produtos = [];
      document.getElementById('inputTituloProposta').value   = '';
      document.getElementById('inputLojaNome').value         = '';
      document.getElementById('inputDataProposta').value     = '';
      document.getElementById('inputValidadeProposta').value = '';
      document.getElementById('inputClienteContato').value   = '';
      document.getElementById('inputClienteNome').value      = '';
      document.getElementById('inputVendedorNome').value     = nomeVendedorLogado || '';
      document.getElementById('inputHistorico').value        = '';
      document.getElementById('inputSimulacao').value        = '';
      document.getElementById('inputOportunidades').value    = '';
      renderProdutosEditor();
      atualizarPreview();
    }

    // ======================= WHATSAPP + IMAGEM =======================
    async function gerarImagem(tipo) {
      if (!currentProposalData) {
        showToast('Nenhuma proposta ativa para gerar imagem.', 'error');
        return;
      }

      const wrapperId = tipo === 'cliente' ? 'contentCliente' : 'contentDiretoria';
      const node = document.getElementById(wrapperId);
      if (!node) return;

      showToast('Gerando imagem...', 'success');

      const canvas = await html2canvas(node, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff'
      });

      return new Promise(resolve => {
        canvas.toBlob(blob => {
          if (!blob) {
            showToast('Erro ao criar imagem.', 'error');
            resolve(null);
            return;
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const nome = (tipo === 'cliente'
              ? 'proposta_cliente_'
              : 'proposta_diretoria_') +
            (currentProposalData.cliente_nome || currentProposalData.vendedor_nome || 'arquivo')
              .replace(/\s+/g, '_') +
            '.png';
          a.href = url;
          a.download = nome;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            a.remove();
            URL.revokeObjectURL(url);
          }, 500);
          resolve(true);
        }, 'image/png');
      });
    }

    function montarMensagemWhats(tipo) {
      const p = currentProposalData;
      if (!p) return '';

      const totalNormal = p.produtos.reduce(
        (s, pr) => s + (Number(pr.preco_normal) || 0), 0
      );
      const totalPromo  = p.produtos.reduce(
        (s, pr) => s + (Number(pr.preco_promo)  || 0), 0
      );
      const economia = Math.max(totalNormal - totalPromo, 0);
      const perc = totalNormal > 0 ? ((economia / totalNormal) * 100).toFixed(0) : '0';

      if (tipo === 'cliente') {
        const nomeV = p.vendedor_nome || nomeVendedorLogado || 'Vendedor';
        let msg = '';
        msg += `Ola *${p.cliente_nome || 'cliente'}*! üëã\n\n`;
        msg += `Aqui √© *${nomeV}* da *${p.loja_nome || 'loja'}*.\n`;
        msg += `Preparei uma *proposta especial* para voce.\n\n`;
        msg += `üì¶ *Resumo dos produtos:*\n`;
        p.produtos.forEach((pr, i) => {
          msg += `${i + 1}. *${pr.produto_completo}*\n`;
          msg += `   Normal: ${formatarMoedaBR(pr.preco_normal)}\n`;
          msg += `   Promo:  ${formatarMoedaBR(pr.preco_promo)}\n\n`;
        });
        msg += `üí∞ *Total negociado:* ${formatarMoedaBR(totalPromo)}\n`;
        if (economia > 0) {
          msg += `üéÅ *Economia total:* ${formatarMoedaBR(economia)} (${perc}% OFF)\n`;
        }
        if (p.validade_proposta) {
          msg += `‚è∞ Proposta valida ate: *${formatarDataBR(p.validade_proposta)}*\n`;
        }
        msg += `\nüì∏ *Enviei tambem a imagem com todos os detalhes da proposta.*\n`;
        msg += `Qualquer duvida estou a disposicao. üòä\n\n`;
        msg += `_${nomeV} - ${p.loja_nome || 'Loja'}_`;
        return msg;
      } else {
        let msg = '';
        msg += `üè¢ *SOLICITACAO DIRETORIA*\n\n`;
        msg += `Loja: *${p.loja_nome || 'N/A'}*\n`;
        msg += `Vendedor: *${p.vendedor_nome || 'N/A'}*\n`;
        msg += `Data: *${formatarDataBR(p.data_proposta)}*\n`;
        if (p.validade_proposta) {
          msg += `Validade para o cliente: *${formatarDataBR(p.validade_proposta)}*\n`;
        }
        msg += `\nüì¶ *Produtos:*\n`;
        p.produtos.forEach((pr, i) => {
          const d = calcularDescontoProduto(pr);
          msg += `${i + 1}. *${pr.produto_completo}*\n`;
          msg += `   Normal: ${formatarMoedaBR(pr.preco_normal)}\n`;
          msg += `   Promo:  ${formatarMoedaBR(pr.preco_promo)}\n`;
          msg += `   Desc.:  ${formatarMoedaBR(d.valor)} (${d.percentual}%)\n\n`;
        });
        msg += `üí∞ *Total negociado:* ${formatarMoedaBR(totalPromo)}\n`;
        if (economia > 0) {
          msg += `üìâ *Desconto total:* ${formatarMoedaBR(economia)} (${perc}%)\n\n`;
        }
        if (p.historico_negociacao) {
          msg += `üìù *Solicitante / informacoes:*\n${p.historico_negociacao}\n\n`;
        }
        if (p.simulacao_perdas_ganhos) {
          msg += `üíº *Proposta da gerencia:*\n${p.simulacao_perdas_ganhos}\n\n`;
        }
        if (p.oportunidades_melhoria) {
          msg += `üìå *Observacoes:*\n${p.oportunidades_melhoria}\n\n`;
        }
        msg += `üì∏ *Enviei anexo a imagem do demonstrativo para analise.*\n`;
        return msg;
      }
    }

    async function enviarWhats(tipo) {
      if (!currentProposalData) {
        showToast('Nenhuma proposta ativa para enviar.', 'error');
        return;
      }

      // Cliente precisa ter numero
      if (tipo === 'cliente') {
        const contato = (currentProposalData.cliente_contato || '').replace(/\D/g, '');
        if (!contato || contato.length < 10) {
          showToast('Numero de WhatsApp do cliente invalido ou nao informado.', 'error');
          return;
        }
      }

      await gerarImagem(tipo); // baixa a imagem

      const msg = montarMensagemWhats(tipo);
      const encoded = encodeURIComponent(msg);

      let url;
      if (tipo === 'cliente') {
        const contato = (currentProposalData.cliente_contato || '').replace(/\D/g, '');
        url = `https://wa.me/55${contato}?text=${encoded}`;
      } else {
        url = `https://wa.me/?text=${encoded}`;
      }
      window.open(url, '_blank');
    }

    // ======================= INIT / EVENTOS =======================
    async function initializeApp() {
      // carrega propostas
      allProposals = carregarTodasPropostas();
      atualizarListaPropostas();

      // nome vendedor salvo
      const salvo = localStorage.getItem('nomeVendedorLogado') || '';
      if (salvo) {
        nomeVendedorLogado = salvo;
        document.getElementById('headerVendedor').textContent = salvo;
        document.getElementById('inputVendedorNome').value = salvo;
        document.getElementById('modalLogin').classList.add('hidden');
      }

      renderProdutosEditor();
      atualizarPreview();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loader = document.getElementById('loadingScreen');
      const appRoot = document.getElementById('appRoot');

      try {
        await initializeApp();
        loader.classList.add('hidden');
        appRoot.classList.remove('hidden');
      } catch (e) {
        console.error('Erro ao inicializar app:', e);
        loader.textContent = 'Erro ao carregar modulo. Veja o console (F12).';
      }

      // LOGIN
      document.getElementById('btnEntrarLogin').addEventListener('click', () => {
        const nome = document.getElementById('inputNomeLogin').value.trim();
        if (!nome) {
          showToast('Digite seu nome para entrar.', 'error');
          return;
        }
        nomeVendedorLogado = nome;
        localStorage.setItem('nomeVendedorLogado', nome);
        document.getElementById('headerVendedor').textContent = nome;
        document.getElementById('inputVendedorNome').value = nome;
        document.getElementById('modalLogin').classList.add('hidden');
        showToast('Bem-vindo, ' + nome + '!');
      });

      document.getElementById('btnTrocarVendedor').addEventListener('click', () => {
        document.getElementById('modalLogin').classList.remove('hidden');
        document.getElementById('inputNomeLogin').value = nomeVendedorLogado || '';
      });

      // ADICIONAR PRODUTO
      document.getElementById('btnAddProduto').addEventListener('click', () => {
        const nome = document.getElementById('inputProdutoNome').value.trim();
        const modalidade = document.getElementById('inputModalidade').value;
        const parcelas = Number(document.getElementById('inputParcelas').value) || 1;
        const precoNormal = Number(document.getElementById('inputPrecoNormal').value) || 0;
        const precoPromo  = Number(document.getElementById('inputPrecoPromo').value)  || 0;

        if (!nome || !precoPromo) {
          showToast('Informe pelo menos a descricao e o preco promocional.', 'error');
          return;
        }

        produtos.push({
          produto_completo: nome,
          modalidade,
          parcelas,
          preco_normal: precoNormal,
          preco_promo: precoPromo
        });

        // limpa inputs de produto
        document.getElementById('inputProdutoNome').value = '';
        document.getElementById('inputPrecoNormal').value = '';
        document.getElementById('inputPrecoPromo').value  = '';

        renderProdutosEditor();

        if (!currentProposalData) {
          currentProposalData = montarObjetoProposta();
        }
        atualizarPreview();
      });

      // SALVAR PROPOSTA
      document.getElementById('btnSalvarProposta').addEventListener('click', () => {
        if (!produtos.length) {
          showToast('Adicione pelo menos um produto.', 'error');
          return;
        }
        const obj = montarObjetoProposta();
        currentProposalData = obj;
        currentProposalId = obj.id;

        const idx = allProposals.findIndex(p => p.id === obj.id);
        if (idx >= 0) {
          allProposals[idx] = obj;
        } else {
          allProposals.push(obj);
        }
        salvarTodasPropostas(allProposals);
        atualizarListaPropostas();
        atualizarPreview();
        showToast('Proposta salva com sucesso!');
      });

      // NOVA PROPOSTA
      document.getElementById('btnNovaProposta').addEventListener('click', () => {
        limparFormulario();
        showToast('Formulario limpo para nova proposta.');
      });

      // TABS
      document.getElementById('tabCliente').addEventListener('click', () => {
        document.getElementById('tabCliente').classList.add('border-sky-600','text-sky-700');
        document.getElementById('tabDiretoria').classList.remove('border-sky-600','text-sky-700');
        document.getElementById('tabDiretoria').classList.add('text-gray-500');
        document.getElementById('contentClienteWrapper').classList.remove('hidden');
        document.getElementById('contentDiretoriaWrapper').classList.add('hidden');
      });

      document.getElementById('tabDiretoria').addEventListener('click', () => {
        document.getElementById('tabDiretoria').classList.add('border-sky-600','text-sky-700');
        document.getElementById('tabCliente').classList.remove('border-sky-600','text-sky-700');
        document.getElementById('tabCliente').classList.add('text-gray-500');
        document.getElementById('contentClienteWrapper').classList.add('hidden');
        document.getElementById('contentDiretoriaWrapper').classList.remove('hidden');
      });

      // BOTOES DE IMAGEM
      document.getElementById('btnImagemCliente').addEventListener('click', () => gerarImagem('cliente'));
      document.getElementById('btnImagemDiretoria').addEventListener('click', () => gerarImagem('diretoria'));

      // BOTOES WHATS
      document.getElementById('btnWhatsCliente').addEventListener('click', () => enviarWhats('cliente'));
      document.getElementById('btnWhatsDiretoria').addEventListener('click', () => enviarWhats('diretoria'));
    });
  </script>
</body>
</html>
