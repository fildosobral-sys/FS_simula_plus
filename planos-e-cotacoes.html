<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Planos e Cota√ß√µes - FS Simula+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #e0f2ff 0, #eef2ff 40%, #e5e7eb 100%);
      min-height: 100vh;
    }
    .animate-slide-in {
      animation: slideIn .25s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body class="text-gray-800">
  <!-- TOAST -->
  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <!-- LOGIN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 border border-blue-100 animate-slide-in">
      <div class="flex flex-col items-center mb-6">
        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center mb-4 shadow-lg">
          <span class="text-3xl text-white">üìä</span>
        </div>
        <h1 class="text-2xl font-extrabold text-gray-900">Planos e Cota√ß√µes</h1>
        <p class="text-sm text-gray-500 mt-1">Sistema Comercial Profissional</p>
      </div>

      <label class="block text-sm font-semibold text-gray-700 mb-2" for="inputNomeLogin">
        Seu nome
      </label>
      <input
        id="inputNomeLogin"
        type="text"
        class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-5"
        placeholder="Digite seu nome completo"
      />

      <button
        onclick="entrarSistema()"
        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 text-sm"
      >
        <span>Entrar no sistema</span>
        <span>üöÄ</span>
      </button>

      <p class="text-xs text-gray-500 mt-4 text-center">
        üí° Crie propostas profissionais em minutos.
      </p>
    </div>
  </div>

  <!-- APLICATIVO -->
  <div id="appScreen" class="hidden min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-6">
      <!-- Cabe√ßalho -->
      <div class="bg-white/80 backdrop-blur rounded-3xl shadow-xl border border-blue-100 p-4 md:p-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl md:text-2xl font-extrabold text-gray-900 flex items-center gap-2">
            <span>üìä</span>
            <span>Planos e Cota√ß√µes</span>
          </h2>
          <p class="text-xs md:text-sm text-gray-500 mt-1">
            Monte propostas para o cliente e resumo completo para a diretoria.
          </p>
        </div>
        <div class="flex items-center gap-2 md:gap-3 justify-end">
          <span id="nomeVendedorHeader" class="text-xs md:text-sm font-semibold text-gray-700 bg-blue-50 px-3 py-1 rounded-full">
            Vendedor:
          </span>
          <button
            onclick="abrirMenu()"
            class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-gray-100 hover:bg-gray-200 text-xl shadow-sm"
            title="Menu"
          >
            ‚ò∞
          </button>
        </div>
      </div>

      <!-- Dados da proposta -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-xl border border-gray-100 p-4 md:p-6 space-y-4">
        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
          <span>üßæ</span>
          <span>Dados da proposta</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-xs md:text-sm">
          <div class="space-y-1">
            <label class="font-semibold">Loja</label>
            <input id="inputLoja" type="text" class="w-full border rounded-xl px-3 py-2"
                   value="Iguatu 3 - Ao lado do Bradesco">
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Vendedor</label>
            <input id="inputVendedorNome" type="text" class="w-full border rounded-xl px-3 py-2">
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Cliente</label>
            <input id="inputClienteNome" type="text" class="w-full border rounded-xl px-3 py-2">
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Contato do cliente</label>
            <input id="inputClienteContato" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="(88) 9 0000-0000">
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Data da proposta</label>
            <input id="inputDataAtual" type="date" class="w-full border rounded-xl px-3 py-2">
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Validade da proposta</label>
            <input id="inputValidadeProposta" type="date" class="w-full border rounded-xl px-3 py-2">
          </div>
          <div class="space-y-1 lg:col-span-3">
            <label class="font-semibold">T√≠tulo da proposta (opcional)</label>
            <input id="inputTituloProposta" type="text" class="w-full border rounded-xl px-3 py-2"
                   placeholder="Ex.: Plano completo de sala + cozinha">
          </div>
        </div>
      </div>

      <!-- Produtos -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-xl border border-gray-100 p-4 md:p-6 space-y-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
            <span>üõí</span>
            <span>Produtos / Planos</span>
          </h3>
          <button
            onclick="adicionarProduto()"
            class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white text-xs md:text-sm font-bold shadow-md gap-2"
          >
            <span>‚ûï</span><span>Adicionar produto</span>
          </button>
        </div>

        <div id="listaProdutosVazia" class="text-center text-xs md:text-sm text-gray-500 py-6 border border-dashed border-gray-300 rounded-2xl">
          Nenhum produto adicionado. Clique em <strong>‚ÄúAdicionar produto‚Äù</strong> para come√ßar.
        </div>

        <div id="listaProdutos" class="space-y-3"></div>
      </div>

      <!-- Observa√ß√µes internas (diretoria) -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-xl border border-purple-100 p-4 md:p-6 space-y-4">
        <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
          <span>üìã</span>
          <span>Informa√ß√µes adicionais para Diretoria</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs md:text-sm">
          <div class="space-y-1">
            <label class="font-semibold">Hist√≥rico de negocia√ß√£o</label>
            <textarea id="inputHistorico" rows="3" class="w-full border rounded-xl px-3 py-2"></textarea>
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Simula√ß√£o de perdas e ganhos</label>
            <textarea id="inputSimulacao" rows="3" class="w-full border rounded-xl px-3 py-2"></textarea>
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Oportunidades</label>
            <textarea id="inputOportunidades" rows="3" class="w-full border rounded-xl px-3 py-2"></textarea>
          </div>
          <div class="space-y-1">
            <label class="font-semibold">Sugest√£o de parcelamento para o cliente</label>
            <textarea id="inputSugestaoParcelamento" rows="3" class="w-full border rounded-xl px-3 py-2"></textarea>
          </div>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="bg-white/90 backdrop-blur rounded-3xl shadow-xl border border-gray-100 p-4 md:p-6 flex flex-col md:flex-row gap-3">
        <button
          onclick="salvarProposta()"
          class="flex-1 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2 shadow-md"
        >
          üíæ Salvar proposta
        </button>
        <button
          onclick="visualizarPropostaCliente()"
          class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2 shadow-md"
        >
          üëÄ Visualizar para Cliente
        </button>
        <button
          onclick="visualizarPropostaDiretoria()"
          class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2 shadow-md"
        >
          üìä Visualizar para Diretoria
        </button>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    // ================== UTILIT√ÅRIOS ==================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const id = 'toast-' + Date.now();
      const bg =
        type === 'success'
          ? 'bg-emerald-500'
          : type === 'error'
          ? 'bg-red-500'
          : 'bg-gray-800';

      const el = document.createElement('div');
      el.id = id;
      el.className = bg + ' text-white text-xs md:text-sm px-3 py-2 rounded-xl shadow-lg flex items-center gap-2 animate-slide-in';
      el.textContent = message;
      container.appendChild(el);

      setTimeout(() => {
        const t = document.getElementById(id);
        if (t) t.remove();
      }, 3500);
    }

    function parseMoeda(valorStr) {
      if (!valorStr) return 0;
      const limpo = valorStr.replace(/[R$\s.]/g, '').replace(',', '.');
      const n = parseFloat(limpo);
      return isNaN(n) ? 0 : n;
    }

    function formatarMoedaBR(valor) {
      const n = isNaN(valor) ? 0 : valor;
      return n.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2
      });
    }

    // ================== ESTADO GLOBAL ==================
    let nomeVendedorLogado = '';
    let produtos = [];
    let allProposals = [];
    let currentProposalId = null;
    let currentProposalData = null;

    // ================== LOGIN ==================
    function entrarSistema() {
      const nome = document.getElementById('inputNomeLogin').value.trim();
      if (!nome) {
        showToast('Preencha seu nome para entrar.', 'error');
        return;
      }
      nomeVendedorLogado = nome;
      document.getElementById('nomeVendedorHeader').textContent = 'Vendedor: ' + nome;
      document.getElementById('inputVendedorNome').value = nome;

      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('inputDataAtual').value = hoje;

      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');

      carregarPropostasLocalStorage();
      showToast('Bem-vindo, ' + nome + '!', 'success');
    }

    // ================== PRODUTOS ==================
    function adicionarProduto() {
      produtos.push({
        codigo_nome: '',
        modalidade: 'carne',     // 'avista', 'carne', 'cartao'
        parcelas: 10,
        preco_normal: 0,
        preco_promo: 0,
        tem_garantia: false,
        valor_garantia: 0
      });
      renderProdutos();
    }

    function removerProduto(index) {
      produtos.splice(index, 1);
      renderProdutos();
    }

    function atualizarProduto(index, campo, valor) {
      const p = produtos[index];
      if (!p) return;

      if (campo === 'parcelas') {
        p.parcelas = parseInt(valor) || 1;
      } else if (campo === 'preco_normal' || campo === 'preco_promo' || campo === 'valor_garantia') {
        p[campo] = parseMoeda(valor);
      } else if (campo === 'tem_garantia') {
        p.tem_garantia = valor;
      } else {
        p[campo] = valor;
      }
    }

    function renderProdutos() {
      const lista = document.getElementById('listaProdutos');
      const vazio = document.getElementById('listaProdutosVazia');

      if (!produtos.length) {
        lista.innerHTML = '';
        vazio.classList.remove('hidden');
        return;
      }

      vazio.classList.add('hidden');

      lista.innerHTML = produtos
        .map((p, index) => {
          return `
            <div class="border border-gray-200 rounded-2xl p-3 md:p-4 shadow-sm bg-gray-50 text-xs md:text-sm">
              <div class="flex justify-between items-center mb-2">
                <span class="font-bold text-gray-700">Produto #${index + 1}</span>
                <button
                  onclick="removerProduto(${index})"
                  class="text-red-500 hover:text-red-600 text-xs font-semibold"
                >
                  Excluir
                </button>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                <div class="space-y-1">
                  <label class="font-semibold">C√≥digo / Nome</label>
                  <input
                    type="text"
                    class="w-full border rounded-xl px-2 py-1.5"
                    value="${p.codigo_nome || ''}"
                    oninput="atualizarProduto(${index}, 'codigo_nome', this.value)"
                  />
                </div>

                <div class="space-y-1">
                  <label class="font-semibold">Modalidade</label>
                  <select
                    class="w-full border rounded-xl px-2 py-1.5"
                    onchange="atualizarProduto(${index}, 'modalidade', this.value)"
                  >
                    <option value="avista" ${p.modalidade === 'avista' ? 'selected' : ''}>√Ä vista</option>
                    <option value="carne" ${p.modalidade === 'carne' ? 'selected' : ''}>Carn√™</option>
                    <option value="cartao" ${p.modalidade === 'cartao' ? 'selected' : ''}>Cart√£o</option>
                  </select>
                </div>

                <div class="space-y-1">
                  <label class="font-semibold">Parcelas (se parcelado)</label>
                  <input
                    type="number"
                    min="1"
                    class="w-full border rounded-xl px-2 py-1.5"
                    value="${p.parcelas}"
                    onchange="atualizarProduto(${index}, 'parcelas', this.value)"
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                <div class="space-y-1">
                  <label class="font-semibold">Pre√ßo de tabela</label>
                  <input
                    type="text"
                    class="w-full border rounded-xl px-2 py-1.5"
                    value="${p.preco_normal ? formatarMoedaBR(p.preco_normal) : ''}"
                    onblur="this.value = this.value || ''; atualizarProduto(${index}, 'preco_normal', this.value)"
                    onfocus="this.value = this.value.replace(/[^0-9,]/g,'')"
                    placeholder="R$ 0,00"
                  />
                </div>

                <div class="space-y-1">
                  <label class="font-semibold">Pre√ßo promocional</label>
                  <input
                    type="text"
                    class="w-full border rounded-xl px-2 py-1.5"
                    value="${p.preco_promo ? formatarMoedaBR(p.preco_promo) : ''}"
                    onblur="this.value = this.value || ''; atualizarProduto(${index}, 'preco_promo', this.value)"
                    onfocus="this.value = this.value.replace(/[^0-9,]/g,'')"
                    placeholder="R$ 0,00"
                  />
                </div>

                <div class="space-y-1">
                  <label class="font-semibold flex items-center gap-1">
                    <input
                      type="checkbox"
                      ${p.tem_garantia ? 'checked' : ''}
                      onchange="atualizarProduto(${index}, 'tem_garantia', this.checked)"
                    />
                    Garantia estendida
                  </label>
                  <input
                    type="text"
                    class="w-full border rounded-xl px-2 py-1.5"
                    value="${p.valor_garantia ? formatarMoedaBR(p.valor_garantia) : ''}"
                    onblur="this.value = this.value || ''; atualizarProduto(${index}, 'valor_garantia', this.value)"
                    onfocus="this.value = this.value.replace(/[^0-9,]/g,'')"
                    placeholder="R$ 0,00"
                  />
                </div>

                <div class="space-y-1">
                  <label class="font-semibold">Resumo r√°pido</label>
                  <div class="bg-white border rounded-xl px-2 py-1.5 text-[11px] leading-snug">
                    ${renderResumoRapidoProduto(p)}
                  </div>
                </div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    function renderResumoRapidoProduto(p) {
      if (!p.preco_normal || !p.preco_promo) return 'Informe os valores para ver o resumo.';

      const totalNormal = p.preco_normal + (p.tem_garantia ? p.valor_garantia || 0 : 0);
      const totalPromo = p.preco_promo + (p.tem_garantia ? p.valor_garantia || 0 : 0);
      const economia = totalNormal - totalPromo;
      const perc = totalNormal > 0 ? ((economia / totalNormal) * 100).toFixed(1) : 0;

      if (p.modalidade === 'avista') {
        return `√Ä vista: de <span class="line-through text-red-600 font-semibold">${formatarMoedaBR(totalNormal)}</span> por <span class="text-green-600 font-semibold">${formatarMoedaBR(totalPromo)}</span> (economia ${formatarMoedaBR(economia)} ‚Äì ${perc}%).`;
      }

      const parcelaNormal = totalNormal / (p.parcelas || 1);
      const parcelaPromo = totalPromo / (p.parcelas || 1);

      const nomeMod =
        p.modalidade === 'carne'
          ? 'Carn√™'
          : p.modalidade === 'cartao'
          ? 'Cart√£o'
          : 'Parcelado';

      return `${p.parcelas}x de <span class="line-through text-red-600 font-semibold">${formatarMoedaBR(
        parcelaNormal
      )}</span> por <span class="text-green-600 font-semibold">${formatarMoedaBR(
        parcelaPromo
      )}</span> no ${nomeMod}. Economia total ${formatarMoedaBR(economia)} (${perc}%).`;
    }

    // ================== SALVAR / CARREGAR PROPOSTAS ==================
    function salvarPropostasLocalStorage() {
      try {
        localStorage.setItem('fs_planos_cotacoes_propostas', JSON.stringify(allProposals));
      } catch (e) {
        console.error(e);
      }
    }

    function carregarPropostasLocalStorage() {
      try {
        const text = localStorage.getItem('fs_planos_cotacoes_propostas');
        if (!text) {
          allProposals = [];
          return;
        }
        allProposals = JSON.parse(text) || [];
      } catch (e) {
        allProposals = [];
      }
    }

    function salvarProposta() {
      const vendedorNome = document.getElementById('inputVendedorNome').value.trim();
      const clienteNome = document.getElementById('inputClienteNome').value.trim();
      const loja = document.getElementById('inputLoja').value.trim();
      const clienteContato = document.getElementById('inputClienteContato').value.trim();
      const dataAtual = document.getElementById('inputDataAtual').value;
      const validadeProposta = document.getElementById('inputValidadeProposta').value;
      const tituloProposta = document.getElementById('inputTituloProposta').value.trim();

      if (!vendedorNome) {
        showToast('Preencha o nome do vendedor.', 'error');
        return;
      }
      if (!clienteNome) {
        showToast('Preencha o nome do cliente.', 'error');
        return;
      }
      if (!produtos.length) {
        showToast('Adicione pelo menos um produto.', 'error');
        return;
      }

      const historicoInfo = document.getElementById('inputHistorico').value.trim();
      const simulacaoInfo = document.getElementById('inputSimulacao').value.trim();
      const oportunidadesInfo = document.getElementById('inputOportunidades').value.trim();
      const sugestaoParcelamento = document.getElementById('inputSugestaoParcelamento').value.trim();

      const proposta = {
        id: currentProposalId || 'P' + Date.now(),
        criadoEm: new Date().toISOString(),
        loja,
        vendedorNome,
        clienteNome,
        clienteContato,
        dataAtual,
        validadeProposta,
        tituloProposta,
        produtos: JSON.parse(JSON.stringify(produtos)),
        historico: historicoInfo,
        simulacao: simulacaoInfo,
        oportunidades: oportunidadesInfo,
        sugestaoParcelamento
      };

      if (currentProposalId) {
        const idx = allProposals.findIndex(p => p.id === currentProposalId);
        if (idx !== -1) {
          allProposals[idx] = proposta;
        } else {
          allProposals.push(proposta);
        }
      } else {
        allProposals.push(proposta);
      }

      currentProposalId = proposta.id;
      currentProposalData = proposta;

      salvarPropostasLocalStorage();

      showToast('Proposta salva com sucesso!', 'success');
    }

    // ================== MENU & LISTA DE PROPOSTAS ==================
    function abrirMenu() {
      const menuHTML = `
        <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharMenu()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold flex items-center gap-2">
                  <span>‚ò∞</span>
                  <span>Menu</span>
                </h2>
                <button onclick="fecharMenu()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div class="p-6 space-y-3 text-sm">
              <button
                onclick="limparFormulario(); fecharMenu();"
                class="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg"
              >
                <span>üóëÔ∏è</span>
                <span>Limpar formul√°rio</span>
              </button>

              <button
                onclick="abrirListaPropostas();"
                class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg"
              >
                <span>üìÇ</span>
                <span>Propostas salvas</span>
              </button>
              
              <button
                onclick="fecharMenu()"
                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2"
              >
                <span>‚ùå</span>
                <span>Fechar menu</span>
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', menuHTML);
    }

    function fecharMenu() {
      const menu = document.getElementById('menuModal');
      if (menu) menu.remove();
    }

    function limparFormulario() {
      document.getElementById('inputLoja').value = 'Iguatu 3 - Ao lado do Bradesco';
      document.getElementById('inputVendedorNome').value = nomeVendedorLogado;
      document.getElementById('inputClienteNome').value = '';
      document.getElementById('inputClienteContato').value = '';
      document.getElementById('inputTituloProposta').value = '';
      document.getElementById('inputHistorico').value = '';
      document.getElementById('inputSimulacao').value = '';
      document.getElementById('inputOportunidades').value = '';
      document.getElementById('inputSugestaoParcelamento').value = '';

      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('inputDataAtual').value = hoje;
      document.getElementById('inputValidadeProposta').value = '';

      produtos = [];
      currentProposalId = null;
      currentProposalData = null;
      renderProdutos();

      showToast('Formul√°rio limpo!', 'success');
    }

    function abrirListaPropostas() {
      fecharMenu();

      if (!allProposals || !allProposals.length) {
        showToast('Nenhuma proposta salva at√© o momento.', 'error');
        return;
      }

      const linhas = allProposals
        .map((p, index) => {
          const dataBase = p.dataAtual || (p.criadoEm ? p.criadoEm.substring(0, 10) : null);
          const dataFormatada = dataBase
            ? new Date(dataBase + 'T00:00:00').toLocaleDateString('pt-BR')
            : '-';
          return `
            <tr class="hover:bg-gray-50 text-xs md:text-sm">
              <td class="p-2 text-center">${index + 1}</td>
              <td class="p-2">${p.clienteNome || '-'}</td>
              <td class="p-2">${p.vendedorNome || '-'}</td>
              <td class="p-2">${dataFormatada}</td>
              <td class="p-2">${p.tituloProposta || 'Proposta comercial'}</td>
              <td class="p-2 text-center">
                <button
                  onclick="carregarProposta('${p.id}')"
                  class="px-3 py-1 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-[11px] font-semibold"
                >
                  Carregar
                </button>
              </td>
              <td class="p-2 text-center">
                <button
                  onclick="excluirProposta('${p.id}')"
                  class="px-3 py-1 rounded-lg bg-red-500 hover:bg-red-600 text-white text-[11px] font-semibold"
                >
                  Excluir
                </button>
              </td>
            </tr>
          `;
        })
        .join('');

      const modalHTML = `
        <div id="listaPropostasModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharListaPropostas()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 rounded-t-2xl sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 class="text-lg md:text-2xl font-bold flex items-center gap-2">
                  <span>üìÇ</span>
                  <span>Propostas salvas</span>
                </h2>
                <button onclick="fecharListaPropostas()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-xl">‚úï</span>
                </button>
              </div>
            </div>

            <div class="p-4 md:p-6">
              <div class="overflow-x-auto">
                <table class="w-full border-collapse bg-white rounded-xl overflow-hidden shadow-md">
                  <thead>
                    <tr class="bg-gradient-to-r from-purple-100 to-indigo-100 text-[11px] md:text-xs">
                      <th class="p-2 text-center font-bold text-gray-700">#</th>
                      <th class="p-2 text-left font-bold text-gray-700">Cliente</th>
                      <th class="p-2 text-left font-bold text-gray-700">Vendedor</th>
                      <th class="p-2 text-left font-bold text-gray-700">Data</th>
                      <th class="p-2 text-left font-bold text-gray-700">T√≠tulo</th>
                      <th class="p-2 text-center font-bold text-gray-700">Carregar</th>
                      <th class="p-2 text-center font-bold text-gray-700">Excluir</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${linhas}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function fecharListaPropostas() {
      const modal = document.getElementById('listaPropostasModal');
      if (modal) modal.remove();
    }

    function carregarProposta(id) {
      const proposta = allProposals.find(p => p.id === id);
      if (!proposta) {
        showToast('N√£o encontrei essa proposta.', 'error');
        return;
      }

      currentProposalId = proposta.id;
      currentProposalData = proposta;

      document.getElementById('inputLoja').value = proposta.loja || '';
      document.getElementById('inputVendedorNome').value = proposta.vendedorNome || '';
      document.getElementById('inputClienteNome').value = proposta.clienteNome || '';
      document.getElementById('inputClienteContato').value = proposta.clienteContato || '';
      document.getElementById('inputDataAtual').value = proposta.dataAtual || '';
      document.getElementById('inputValidadeProposta').value = proposta.validadeProposta || '';
      document.getElementById('inputTituloProposta').value = proposta.tituloProposta || '';

      document.getElementById('inputHistorico').value = proposta.historico || '';
      document.getElementById('inputSimulacao').value = proposta.simulacao || '';
      document.getElementById('inputOportunidades').value = proposta.oportunidades || '';
      document.getElementById('inputSugestaoParcelamento').value = proposta.sugestaoParcelamento || '';

      produtos = proposta.produtos || [];
      renderProdutos();

      fecharListaPropostas();
      showToast('Proposta carregada para edi√ß√£o.', 'success');
    }

    function excluirProposta(id) {
      allProposals = allProposals.filter(p => p.id !== id);
      salvarPropostasLocalStorage();
      fecharListaPropostas();
      abrirListaPropostas();
      showToast('Proposta exclu√≠da.', 'success');
    }

    // ================== VISUALIZA√á√ÉO CLIENTE ==================
    function visualizarPropostaCliente() {
      const vendedorNome = document.getElementById('inputVendedorNome').value.trim();
      const clienteNome = document.getElementById('inputClienteNome').value.trim();
      const loja = document.getElementById('inputLoja').value.trim();
      const clienteContato = document.getElementById('inputClienteContato').value.trim();
      const dataAtual = document.getElementById('inputDataAtual').value;
      const validadeProposta = document.getElementById('inputValidadeProposta').value;
      const tituloProposta = document.getElementById('inputTituloProposta').value.trim();

      if (!vendedorNome || !clienteNome) {
        showToast('Preencha vendedor e cliente para visualizar.', 'error');
        return;
      }
      if (!produtos.length) {
        showToast('Adicione pelo menos um produto.', 'error');
        return;
      }

      const dataAtualFormatada = dataAtual ? new Date(dataAtual + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';
      const validadeFormatada = validadeProposta ? new Date(validadeProposta + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';

      let totalNormal = 0;
      let totalPromo = 0;

      const produtosHTML = produtos
        .map((p, index) => {
          const totalNormalProd = (p.preco_normal || 0) + (p.tem_garantia ? p.valor_garantia || 0 : 0);
          const totalPromoProd = (p.preco_promo || 0) + (p.tem_garantia ? p.valor_garantia || 0 : 0);
          const economia = totalNormalProd - totalPromoProd;
          const perc = totalNormalProd > 0 ? ((economia / totalNormalProd) * 100).toFixed(1) : 0;

          totalNormal += totalNormalProd;
          totalPromo += totalPromoProd;

          let linhaPre√ßo = '';
          if (p.modalidade === 'avista') {
            linhaPre√ßo = `
              <p class="text-sm text-gray-600 mb-1">De <span class="line-through text-red-600 font-bold">${formatarMoedaBR(
                totalNormalProd
              )}</span></p>
              <p class="text-3xl font-extrabold text-green-600 mb-1">${formatarMoedaBR(totalPromoProd)}</p>
              <p class="text-sm font-semibold text-blue-600">√Ä vista</p>
            `;
          } else {
            const parcelaNormal = totalNormalProd / (p.parcelas || 1);
            const parcelaPromo = totalPromoProd / (p.parcelas || 1);
            const nomeMod =
              p.modalidade === 'carne'
                ? 'Carn√™'
                : p.modalidade === 'cartao'
                ? 'Cart√£o'
                : 'Parcelado';
            linhaPre√ßo = `
              <p class="text-sm text-gray-600 mb-1">De <span class="line-through text-red-600 font-bold">${p.parcelas}x ${formatarMoedaBR(
                parcelaNormal
              )}</span></p>
              <p class="text-3xl font-extrabold text-green-600 mb-1">${p.parcelas}x de ${formatarMoedaBR(
              parcelaPromo
            )}</p>
              <p class="text-sm font-semibold text-blue-600">no ${nomeMod}</p>
            `;
          }

          return `
            <div class="bg-white rounded-2xl border border-blue-100 p-4 md:p-5 shadow-md">
              <h4 class="text-sm md:text-base font-bold text-gray-800 mb-2">
                ${p.codigo_nome || 'Produto #' + (index + 1)}
              </h4>
              <div class="text-center mb-3">
                ${linhaPre√ßo}
              </div>
              <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-3 border border-yellow-200">
                <p class="text-lg md:text-xl font-extrabold text-orange-600 text-center">${perc}% OFF</p>
                <p class="text-xs md:text-sm text-gray-700 font-semibold mt-1 text-center">
                  Economia de ${formatarMoedaBR(economia)}
                </p>
              </div>
            </div>
          `;
        })
        .join('');

      const economiaTotal = totalNormal - totalPromo;
      const percTotal = totalNormal > 0 ? ((economiaTotal / totalNormal) * 100).toFixed(1) : 0;

      const sugestaoParcelamento = document.getElementById('inputSugestaoParcelamento').value.trim();
      const sugestaoHTML = sugestaoParcelamento
        ? `
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 md:p-5 border border-blue-200 mb-5">
            <h3 class="text-base md:text-lg font-bold text-blue-800 mb-2 flex items-center gap-2">
              <span>üí°</span>
              <span>Nossa sugest√£o para voc√™</span>
            </h3>
            <p class="text-xs md:text-sm text-gray-700 leading-relaxed bg-white rounded-xl p-3">
              ${sugestaoParcelamento}
            </p>
          </div>
        `
        : '';

      const resumoHTML = `
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 md:p-5 border border-emerald-200">
          <h3 class="text-base md:text-lg font-bold text-emerald-800 mb-3 text-center">Resumo da proposta</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center text-xs md:text-sm">
            <div class="bg-white rounded-xl p-3 border border-red-100">
              <p class="text-gray-500 mb-1">Total tabela</p>
              <p class="text-base md:text-lg font-extrabold text-red-600 line-through">${formatarMoedaBR(totalNormal)}</p>
            </div>
            <div class="bg-white rounded-xl p-3 border border-emerald-200">
              <p class="text-gray-500 mb-1 font-semibold">Total proposto</p>
              <p class="text-lg md:text-xl font-extrabold text-emerald-600">${formatarMoedaBR(totalPromo)}</p>
            </div>
            <div class="bg-white rounded-xl p-3 border border-blue-200">
              <p class="text-gray-500 mb-1">Economia total</p>
              <p class="text-base md:text-lg font-extrabold text-blue-600">${formatarMoedaBR(economiaTotal)}</p>
              <p class="text-[11px] md:text-xs text-blue-500 font-semibold">(${percTotal}% de desconto)</p>
            </div>
          </div>
        </div>
      `;

      const previewHTML = `
        <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharPreview()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 md:p-6 rounded-t-2xl sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 class="text-base md:text-2xl font-bold flex items-center gap-2">
                  <span>üëÅÔ∏è</span>
                  <span>Proposta para Cliente</span>
                </h2>
                <button onclick="fecharPreview()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div class="p-4 md:p-6 text-xs md:text-sm">
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 md:p-5 mb-5 border border-blue-200">
                <h3 class="text-base md:text-lg font-bold text-blue-800 mb-3">
                  ${tituloProposta || 'Proposta Comercial'}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <p class="text-gray-600">üè™ <strong>Loja:</strong> ${loja}</p>
                    <p class="text-gray-600">üë§ <strong>Vendedor:</strong> ${vendedorNome}</p>
                    <p class="text-gray-600">üë• <strong>Cliente:</strong> ${clienteNome}</p>
                  </div>
                  <div>
                    ${clienteContato ? `<p class="text-gray-600">üìû <strong>Contato:</strong> ${clienteContato}</p>` : ''}
                    <p class="text-gray-600">üìÖ <strong>Data:</strong> ${dataAtualFormatada}</p>
                    <p class="text-gray-600">‚è∞ <strong>Validade:</strong> ${validadeFormatada}</p>
                  </div>
                </div>
              </div>

              <div class="space-y-4 mb-5">
                ${produtosHTML}
              </div>

              ${sugestaoHTML}
              ${resumoHTML}
            </div>

            <div class="p-4 md:p-6 bg-gray-50 rounded-b-2xl flex gap-3">
              <button
                onclick="imprimirProposta()"
                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2"
              >
                üñ®Ô∏è Imprimir
              </button>
              <button
                onclick="fecharPreview()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2"
              >
                ‚ùå Fechar
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', previewHTML);
    }

    // ================== VISUALIZA√á√ÉO DIRETORIA ==================
    function visualizarPropostaDiretoria() {
      const vendedorNome = document.getElementById('inputVendedorNome').value.trim();
      const clienteNome = document.getElementById('inputClienteNome').value.trim();
      const loja = document.getElementById('inputLoja').value.trim();
      const clienteContato = document.getElementById('inputClienteContato').value.trim();
      const dataAtual = document.getElementById('inputDataAtual').value;
      const validadeProposta = document.getElementById('inputValidadeProposta').value;
      const tituloProposta = document.getElementById('inputTituloProposta').value.trim();

      if (!vendedorNome || !clienteNome) {
        showToast('Preencha vendedor e cliente para visualizar.', 'error');
        return;
      }
      if (!produtos.length) {
        showToast('Adicione pelo menos um produto.', 'error');
        return;
      }

      const dataAtualFormatada = dataAtual ? new Date(dataAtual + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';
      const validadeFormatada = validadeProposta ? new Date(validadeProposta + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';

      const historicoInfo = document.getElementById('inputHistorico').value.trim();
      const simulacaoInfo = document.getElementById('inputSimulacao').value.trim();
      const oportunidadesInfo = document.getElementById('inputOportunidades').value.trim();
      const sugestaoParcelamento = document.getElementById('inputSugestaoParcelamento').value.trim();

      let totalNormalGeral = 0;
      let totalPromoGeral = 0;

      const linhasProdutos = produtos
        .map((p, index) => {
          const totalNormalProd = (p.preco_normal || 0) + (p.tem_garantia ? p.valor_garantia || 0 : 0);
          const totalPromoProd = (p.preco_promo || 0) + (p.tem_garantia ? p.valor_garantia || 0 : 0);
          const economia = totalNormalProd - totalPromoProd;
          const perc = totalNormalProd > 0 ? ((economia / totalNormalProd) * 100).toFixed(1) : 0;

          totalNormalGeral += totalNormalProd;
          totalPromoGeral += totalPromoProd;

          let modalidadeTxt = '√Ä vista';
          if (p.modalidade === 'carne' || p.modalidade === 'cartao') {
            const nomeMod = p.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o';
            modalidadeTxt = `${nomeMod} ${p.parcelas}x`;
          }

          return `
            <tr class="border-b border-gray-200 hover:bg-gray-50 text-xs md:text-sm">
              <td class="p-2">${p.codigo_nome || 'Produto #' + (index + 1)}</td>
              <td class="p-2 text-center">${modalidadeTxt}</td>
              <td class="p-2 text-right text-red-600 font-bold line-through">${formatarMoedaBR(totalNormalProd)}</td>
              <td class="p-2 text-right text-green-600 font-bold">${formatarMoedaBR(totalPromoProd)}</td>
              <td class="p-2 text-right text-blue-600 font-bold">${formatarMoedaBR(economia)}</td>
              <td class="p-2 text-center text-orange-600 font-bold">${perc}%</td>
            </tr>
          `;
        })
        .join('');

      const economiaTotal = totalNormalGeral - totalPromoGeral;
      const percTotal = totalNormalGeral > 0 ? ((economiaTotal / totalNormalGeral) * 100).toFixed(1) : 0;

      const sugestaoHTML2 = sugestaoParcelamento
        ? `
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 md:p-5 border border-blue-200 mb-5">
            <h3 class="text-base md:text-lg font-bold text-blue-800 mb-2 flex items-center gap-2">
              <span>üí°</span>
              <span>Sugest√£o de parcelamento para o cliente</span>
            </h3>
            <p class="text-xs md:text-sm text-gray-700 leading-relaxed bg-white rounded-xl p-3">
              ${sugestaoParcelamento}
            </p>
          </div>
        `
        : '';

      let infoAdicionaisHTML = '';
      if (historicoInfo || simulacaoInfo || oportunidadesInfo) {
        infoAdicionaisHTML = `
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-4 md:p-5 border border-purple-200 mb-5">
            <h3 class="text-base md:text-lg font-bold text-purple-800 mb-3 flex items-center gap-2">
              <span>üìã</span>
              <span>Informa√ß√µes adicionais</span>
            </h3>
            ${historicoInfo ? `
              <div class="mb-3">
                <h4 class="text-xs md:text-sm font-bold text-gray-700 mb-1">üìù Hist√≥rico de negocia√ß√£o</h4>
                <p class="text-xs md:text-sm text-gray-700 bg-white rounded-xl p-3">${historicoInfo}</p>
              </div>` : ''}

            ${simulacaoInfo ? `
              <div class="mb-3">
                <h4 class="text-xs md:text-sm font-bold text-gray-700 mb-1">üìà Simula√ß√£o de perdas e ganhos</h4>
                <p class="text-xs md:text-sm text-gray-700 bg-white rounded-xl p-3">${simulacaoInfo}</p>
              </div>` : ''}

            ${oportunidadesInfo ? `
              <div class="mb-1">
                <h4 class="text-xs md:text-sm font-bold text-gray-700 mb-1">üí° Oportunidades</h4>
                <p class="text-xs md:text-sm text-gray-700 bg-white rounded-xl p-3">${oportunidadesInfo}</p>
              </div>` : ''}
          </div>
        `;
      }

      const previewHTML = `
        <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharPreview()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 md:p-6 rounded-t-2xl sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 class="text-base md:text-2xl font-bold flex items-center gap-2">
                  <span>üìä</span>
                  <span>Proposta para Diretoria</span>
                </h2>
                <button onclick="fecharPreview()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div class="p-4 md:p-6 text-xs md:text-sm">
              <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 md:p-5 mb-5 border border-purple-200">
                <h3 class="text-base md:text-lg font-bold text-purple-800 mb-3">
                  ${tituloProposta || 'Proposta Comercial'}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <p class="text-gray-700">üè™ <strong>Loja:</strong> ${loja}</p>
                    <p class="text-gray-700">üë§ <strong>Vendedor:</strong> ${vendedorNome}</p>
                    <p class="text-gray-700">üë• <strong>Cliente:</strong> ${clienteNome}</p>
                  </div>
                  <div>
                    ${clienteContato ? `<p class="text-gray-700">üìû <strong>Contato:</strong> ${clienteContato}</p>` : ''}
                    <p class="text-gray-700">üìÖ <strong>Data:</strong> ${dataAtualFormatada}</p>
                    <p class="text-gray-700">‚è∞ <strong>Validade:</strong> ${validadeFormatada}</p>
                  </div>
                </div>
              </div>

              <div class="mb-5">
                <h3 class="text-sm md:text-base font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <span>üì¶</span>
                  <span>Resumo dos produtos</span>
                </h3>
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse bg-white rounded-xl overflow-hidden shadow-md">
                    <thead>
                      <tr class="bg-gradient-to-r from-purple-100 to-pink-100 text-[11px] md:text-xs">
                        <th class="p-2 text-left font-bold text-gray-700">Produto</th>
                        <th class="p-2 text-center font-bold text-gray-700">Modalidade</th>
                        <th class="p-2 text-right font-bold text-gray-700">Valor normal</th>
                        <th class="p-2 text-right font-bold text-gray-700">Valor proposto</th>
                        <th class="p-2 text-right font-bold text-gray-700">Desconto (R$)</th>
                        <th class="p-2 text-center font-bold text-gray-700">Desconto (%)</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${linhasProdutos}
                      <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 font-bold text-xs md:text-sm border-t-2 border-blue-200">
                        <td class="p-3" colspan="2">TOTAL GERAL</td>
                        <td class="p-3 text-right text-red-600 line-through">${formatarMoedaBR(totalNormalGeral)}</td>
                        <td class="p-3 text-right text-green-600 text-base md:text-lg">${formatarMoedaBR(totalPromoGeral)}</td>
                        <td class="p-3 text-right text-blue-600 text-base md:text-lg">${formatarMoedaBR(economiaTotal)}</td>
                        <td class="p-3 text-center text-orange-600 text-base md:text-lg">${percTotal}%</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              ${sugestaoHTML2}
              ${infoAdicionaisHTML}
            </div>

            <div class="p-4 md:p-6 bg-gray-50 rounded-b-2xl flex gap-3">
              <button
                onclick="imprimirProposta()"
                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2"
              >
                üñ®Ô∏è Imprimir
              </button>
              <button
                onclick="fecharPreview()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2"
              >
                ‚ùå Fechar
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', previewHTML);
    }

    function fecharPreview() {
      const preview = document.getElementById('previewModal');
      if (preview) preview.remove();
    }

    function imprimirProposta() {
      window.print();
    }
  </script>
</body>
</html>
