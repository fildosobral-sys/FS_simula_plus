<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planos e Cota√ß√µes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    #codigoPropostaFloat { display: none !important; }
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    html {
      height: 100%;
    }
    .produto-item {
      transition: all 0.2s ease;
    }
    .produto-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-primary {
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .tab-button {
      transition: all 0.2s ease;
    }
    .tab-active {
      border-bottom: 3px solid #2563eb;
      color: #2563eb;
      font-weight: 600;
    }
    @media print {
      .no-print {
        display: none !important;
      }
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .container {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
      }
      
      /* Header mobile */
      header .flex {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      header h1 {
        font-size: 1.5rem !important;
      }
      
      header p {
        font-size: 0.875rem;
      }
      
      /* Buttons mobile */
      button {
        font-size: 0.875rem !important;
        padding: 0.625rem 1rem !important;
      }
      
      /* Grid mobile - for√ßa 1 coluna (somente grids gen√©ricos, n√£o os que j√° t√™m grid-cols-x) */
      .grid:not(.grid-cols-2):not(.grid-cols-3):not(.grid-cols-4) {
        grid-template-columns: 1fr !important;
      }
      
      /* Tabs mobile */
      .tab-button {
        font-size: 0.875rem !important;
        padding: 0.75rem 1rem !important;
      }
      
      /* Cards mobile */
      .bg-white, .bg-gradient-to-br {
        padding: 1rem !important;
        margin-bottom: 1rem;
      }
      
      /* Inputs mobile */
      input, textarea, select {
        font-size: 1rem !important;
      }
      
      /* Produto item mobile */
      .produto-item .flex {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .produto-item .flex > div {
        width: 100%;
      }
      
      /* Tabela mobile - scroll horizontal */
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
      }
      
      table {
        font-size: 0.75rem !important;
      }
      
      table th, table td {
        padding: 0.5rem !important;
        white-space: nowrap;
      }
      
      /* Visualiza√ß√£o mobile */
      #contentCliente .text-4xl,
      #contentDiretoria .text-4xl {
        font-size: 1.75rem !important;
      }
      
      #contentCliente .text-2xl,
      #contentDiretoria .text-2xl {
        font-size: 1.25rem !important;
      }
      
      #contentCliente .text-xl,
      #contentDiretoria .text-xl {
        font-size: 1.125rem !important;
      }
      
      
      /* Tabela Vis√£o Diretoria - deixar tudo enquadrado e cabendo na largura */
      #contentDiretoria .fs-tabela-diretoria th {
        font-size: 0.60rem !important;
        padding-left: 0.20rem !important;
        padding-right: 0.20rem !important;
        white-space: normal;
        text-align: center !important;
      }
      #contentDiretoria .fs-tabela-diretoria td {
        font-size: 0.55rem !important;
        padding-left: 0.20rem !important;
        padding-right: 0.20rem !important;
        white-space: nowrap;
        text-align: center !important;
      }
/* Resumo financeiro mobile */
      .grid-cols-3 {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      /* Bot√µes de a√ß√£o mobile */
      .flex.gap-4 {
        flex-direction: column;
        gap: 0.75rem !important;
      }
      
      .flex.gap-4 button {
        width: 100%;
      }
      
      /* Lista de propostas mobile */
      #listaPropostas .flex {
        flex-direction: column;
        gap: 1rem;
      }
      
      #listaPropostas .flex > div:first-child {
        width: 100%;
      }
      
      #listaPropostas .flex.gap-2 {
        flex-direction: row;
        width: 100%;
        justify-content: space-between;
      }

      #listaPropostas .flex.gap-2 button {
        flex: 1 1 0;
        max-width: 25%;
        padding: 0.35rem 0.25rem !important;
        font-size: 0.75rem !important;
        min-height: 2.5rem;
        border-radius: 0.5rem !important;
      }

      /* Cabe√ßalho produto mobile */
      .produto-item > div:first-child .flex {
        flex-direction: column;
        align-items: flex-start !important;
      }
      
      .produto-item > div:first-child .flex .flex.gap-2 {
        flex-direction: column;
        width: 100%;
        gap: 0.5rem !important;
      }
      
      /* Tags mobile */
      .flex.gap-3.text-xs,
      .flex.gap-4.text-xs {
        flex-wrap: wrap;
        gap: 0.5rem !important;
      }
      
      /* Modal mobile */
      .fixed.inset-0 > div {
        margin: 1rem;
        max-height: 90%;
        overflow-y: auto;
      }
    }
    
    /* Tablet adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
      .grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      
      .md\:grid-cols-3 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 
  <style>
    .fs-login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .fs-login-card {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 18px;
      padding: 24px 20px 28px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.18);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .fs-login-logo-wrap {
      text-align: center;
      margin-bottom: 14px;
    }
    .fs-login-logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 0,#a5b4fc,#4f46e5);
      color: #ffffff;
      font-weight: 700;
      font-size: 20px;
      box-shadow: 0 10px 25px rgba(79,70,229,0.6);
    }
    .fs-login-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
      text-align: center;
    }
    .fs-login-sub {
      font-size: 13px;
      color: #6b7280;
      text-align: center;
      margin-bottom: 18px;
    }
    .fs-login-label {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
      display: block;
    }
    .fs-login-input-wrap {
      position: relative;
      margin-bottom: 14px;
    }
    .fs-login-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      outline: none;
      box-sizing: border-box;
    }
    .fs-login-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.4);
    }
    .fs-login-eye {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      font-size: 12px;
      color: #4b5563;
      cursor: pointer;
    }
    .fs-login-btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px 16px;
      margin-top: 4px;
      font-weight: 600;
      font-size: 15px;
      color: #ffffff;
      background: linear-gradient(90deg,#4f46e5,#6366f1);
      cursor: pointer;
    }
    .fs-login-link {
      font-size: 13px;
      color: #4f46e5;
      text-decoration: none;
    }
    .fs-login-footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 16px;
      text-align: center;
    }
    .fs-login-hidden {
      display: none;
    }
    .fs-user-badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      margin-left:4px;
    }
    .fs-user-badge-gerente { background:#eff6ff; color:#1d4ed8; }
    .fs-user-badge-vendedor{ background:#ecfdf5; color:#047857; }
    .fs-user-chip {
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:#f3f4f6;
      margin:2px;
      display:inline-block;
    }
  </style>

</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100">

  <div id="fsLoginPage" class="fs-login-page">
    <div class="fs-login-card">
      <div class="fs-login-logo-wrap">
        <div class="fs-login-logo">FS</div>
      </div>
      <div class="fs-login-title">Planos &amp; Cota√ß√µes</div>
      <div class="fs-login-sub">Acesso √† Plataforma</div>

      <label for="fsUser" class="fs-login-label">Seu nome de usu√°rio</label>
      <div class="fs-login-input-wrap">
        <input id="fsUser" class="fs-login-input" placeholder="Ex.: Fildo, Patr√≠cia" autocomplete="off">
      </div>

      <label for="fsPass" class="fs-login-label">Senha</label>
      <div class="fs-login-input-wrap">
        <input id="fsPass" type="password" class="fs-login-input" placeholder="Digite sua senha">
        <button type="button" class="fs-login-eye" onclick="fsTogglePass()">Ver</button>
      </div>

      <button class="fs-login-btn" onclick="fsLogin()">Entrar</button>

      <div style="margin-top:10px;text-align:center;">
        <a href="#" class="fs-login-link" onclick="fsShowMaster();return false;">Esqueci minha senha / Gerenciar usu√°rios</a>
      </div>
    </div>
  </div>

  <div id="fsMasterPage" class="fs-login-page fs-login-hidden">
    <div class="fs-login-card">
      <div class="fs-login-title">√Årea do Gerente</div>
      <div class="fs-login-sub">Use a senha mestre para redefinir senhas ou gerenciar usu√°rios.</div>

      <label for="fsMaster" class="fs-login-label">Senha mestre</label>
      <div class="fs-login-input-wrap">
        <input id="fsMaster" class="fs-login-input" placeholder="Digite a senha mestre">
      </div>

      <button class="fs-login-btn" onclick="fsValidarMasterParaReset()">Redefinir senha de usu√°rio</button>
      <button class="fs-login-btn" style="margin-top:8px;background:linear-gradient(90deg,#059669,#10b981);" onclick="fsValidarMasterParaAdmin()">Gerenciar usu√°rios</button>

      <div style="margin-top:10px;text-align:center;">
        <a href="#" class="fs-login-link" onclick="fsShowLogin();return false;">Voltar ao login</a>
      </div>
    </div>
  </div>

  <div id="fsNewPassPage" class="fs-login-page fs-login-hidden">
    <div class="fs-login-card">
      <div class="fs-login-title">Nova senha</div>
      <div class="fs-login-sub">Defina uma nova senha para o usu√°rio selecionado.</div>

      <label for="fsNewPassUser" class="fs-login-label">Nome do usu√°rio</label>
      <div class="fs-login-input-wrap">
        <input id="fsNewPassUser" class="fs-login-input" placeholder="Ex.: Fildo, Patr√≠cia">
      </div>

      <label for="fsNewPass" class="fs-login-label">Nova senha</label>
      <div class="fs-login-input-wrap">
        <input id="fsNewPass" type="password" class="fs-login-input" placeholder="Digite a nova senha">
      </div>

      <button class="fs-login-btn" onclick="fsSaveNewPassword()">Salvar</button>
      <div style="margin-top:10px;text-align:center;">
        <a href="#" class="fs-login-link" onclick="fsShowLogin();return false;">Voltar ao login</a>
      </div>
    </div>
  </div>

  <div id="fsUserAdminPage" class="fs-login-page fs-login-hidden">
    <div class="fs-login-card">
      <div class="fs-login-title">Gerenciar usu√°rios</div>
      <div class="fs-login-sub">Adicionar, atualizar ou desativar usu√°rios da plataforma.</div>

      <div id="fsUserList" style="margin-bottom:12px;font-size:12px;color:#4b5563;">
        <!-- lista de usu√°rios aqui -->
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:10px 0 14px 0;">

      <label for="fsAdminUserName" class="fs-login-label">Nome do usu√°rio</label>
      <div class="fs-login-input-wrap">
        <input id="fsAdminUserName" class="fs-login-input" placeholder="Ex.: Rayane, Mayara">
      </div>

      <label for="fsAdminNivel" class="fs-login-label">N√≠vel de acesso</label>
      <div class="fs-login-input-wrap">
        <select id="fsAdminNivel" class="fs-login-input">
          <option value="vendedor">Vendedor(a)</option>
          <option value="gerente">Ger√™ncia / Diretoria</option>
        </select>
      </div>

      <label for="fsAdminSenha" class="fs-login-label">Senha inicial</label>
      <div class="fs-login-input-wrap">
        <input id="fsAdminSenha" class="fs-login-input" placeholder="Ex.: 1234">
      </div>

      <button class="fs-login-btn" onclick="fsAdminSalvarUsuario()">Salvar / Atualizar usu√°rio</button>
      <button class="fs-login-btn" style="margin-top:8px;background:linear-gradient(90deg,#b91c1c,#ef4444);" onclick="fsAdminExcluirUsuario()">Desativar usu√°rio</button>

      <div style="margin-top:10px;text-align:center;">
        <a href="#" class="fs-login-link" onclick="fsShowLogin();return false;">Voltar ao login</a>
      </div>
    </div>
  </div>

  <div id="appView" style="display:none;">

  <div id="app" class="min-h-full"><!-- Loading State -->
      <div id="codigoPropostaFloat" class="hidden fixed top-4 right-4 z-40">
        <div class="bg-purple-600 text-white text-xs md:text-sm px-3 py-1 rounded-full shadow-lg border border-purple-300 opacity-90">
          C√≥digo da proposta:
          <span id="codigoPropostaFloatText" class="font-mono font-semibold"></span>
        </div>
      </div>

   <div id="loading" class="flex items-center justify-center min-h-full">
    <div class="text-center">
     <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
     <p class="text-gray-600 text-lg">Carregando modulo...</p>
    </div>
   </div><!-- Tela de Entrada (Welcome Screen) -->
   <div id="welcomeScreen" class="hidden min-h-full flex items-center justify-center p-4">
    <div class="max-w-2xl w-full"><!-- Card Principal -->
     <div class="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-105 transition-transform duration-300"><!-- Cabe√ßalho com Gradiente -->
      <div class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-700 p-8 relative overflow-hidden"><!-- Efeitos de fundo -->
       <div class="absolute inset-0 opacity-20">
        <div class="absolute top-0 left-0 w-64 h-64 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"></div>
       </div><!-- √çcone 3D de Gr√°ficos -->
       <div class="relative z-10 text-center mb-6">
        <div class="inline-block animate-bounce">
         <svg class="w-32 h-32 mx-auto drop-shadow-2xl" viewbox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><!-- Base do gr√°fico 3D --> <defs>
           <lineargradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
           </lineargradient>
           <lineargradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#34d399;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
           </lineargradient>
           <lineargradient id="grad3" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#a78bfa;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
           </lineargradient>
          </defs> <!-- Sombra --> <ellipse cx="100" cy="180" rx="80" ry="15" fill="rgba(0,0,0,0.2)" /> <!-- Barras 3D do gr√°fico --> <!-- Barra 1 (Azul) --> <path d="M 40 140 L 40 80 L 60 70 L 60 130 Z" fill="url(#grad1)" stroke="#1e40af" stroke-width="2" /> <path d="M 40 80 L 60 70 L 80 80 L 60 90 Z" fill="#93c5fd" stroke="#1e40af" stroke-width="2" /> <path d="M 60 130 L 60 70 L 80 80 L 80 140 Z" fill="#3b82f6" stroke="#1e40af" stroke-width="2" /> <!-- Barra 2 (Verde - mais alta) --> <path d="M 90 140 L 90 50 L 110 40 L 110 130 Z" fill="url(#grad2)" stroke="#065f46" stroke-width="2" /> <path d="M 90 50 L 110 40 L 130 50 L 110 60 Z" fill="#6ee7b7" stroke="#065f46" stroke-width="2" /> <path d="M 110 130 L 110 40 L 130 50 L 130 140 Z" fill="#10b981" stroke="#065f46" stroke-width="2" /> <!-- Barra 3 (Roxa) --> <path d="M 140 140 L 140 90 L 160 80 L 160 130 Z" fill="url(#grad3)" stroke="#5b21b6" stroke-width="2" /> <path d="M 140 90 L 160 80 L 180 90 L 160 100 Z" fill="#c4b5fd" stroke="#5b21b6" stroke-width="2" /> <path d="M 160 130 L 160 80 L 180 90 L 180 140 Z" fill="#8b5cf6" stroke="#5b21b6" stroke-width="2" /> <!-- Linha de tend√™ncia crescente --> <path d="M 30 120 Q 100 60 170 40" stroke="#fbbf24" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="5,5">
           <animate attributename="stroke-dashoffset" from="10" to="0" dur="1s" repeatcount="indefinite" />
          </path> <circle cx="170" cy="40" r="6" fill="#fbbf24">
           <animate attributename="r" values="6;8;6" dur="1s" repeatcount="indefinite" />
          </circle>
         </svg>
        </div>
        <h1 class="text-4xl font-extrabold text-white mt-6 mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Planos e Cota√ß√µes</h1>
        <p class="text-blue-100 text-lg font-medium">Sistema Profissional de Propostas Comerciais</p>
       </div>
      </div><!-- Corpo do Card -->
      <div class="p-8">
       <div class="mb-6"><label class="block text-gray-700 font-bold mb-3 text-lg" for="inputNomeVendedorInicial"> üë§ Qual √© o seu nome? </label> <input type="text" id="inputNomeVendedorInicial" class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Digite seu nome completo" autocomplete="off">
       </div><!-- Bot√£o de Entrada --> <button id="btnEntrarSistema" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-xl hover:from-blue-700 hover:to-indigo-700 shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-3"> <span class="text-2xl">üöÄ</span> <span>Entrar no Sistema</span> </button> <!-- Recursos do Sistema -->
             </div>
     </div><!-- Rodap√© -->
     <div class="text-center mt-6">
      <p class="text-sm text-gray-600">‚ú® Crie propostas incr√≠veis em minutos</p>
     </div>
    </div>
   </div><!-- Main Content (hidden initially) -->
   <div id="mainContent" class="hidden"><!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-700 text-white shadow-2xl relative overflow-hidden"><!-- Efeito de fundo animado -->
     <div class="absolute inset-0 opacity-10">
      <div class="absolute top-0 left-0 w-96 h-96 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 right-0 w-96 h-96 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"></div>
     </div>
     <div class="container mx-auto px-4 py-8 relative z-10">
      <div class="flex justify-between items-center flex-wrap gap-4">
       <div class="flex items-center gap-4"><!-- √çcone decorativo -->
        <div class="hidden md:flex items-center justify-center w-16 h-16 bg-white bg-opacity-20 rounded-2xl backdrop-blur-sm"><span class="text-4xl">üìä</span>
        </div>
        <div>
         <p id="bemVindoTexto" class="text-blue-100 text-base md:text-lg font-medium flex items-center gap-2 mb-1"><span class="inline-block w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Bem-vindo(a), <span id="nomeUsuarioHeader" class="font-bold">Usu√°rio</span>!</p>
         <h1 id="appTitle" class="text-3xl md:text-4xl font-extrabold tracking-tight" style="
                  text-shadow: 
                    1px 1px 0px rgba(0,0,0,0.2),
                    2px 2px 0px rgba(0,0,0,0.2),
                    3px 3px 0px rgba(0,0,0,0.2),
                    4px 4px 0px rgba(0,0,0,0.2),
                    5px 5px 0px rgba(0,0,0,0.2),
                    6px 6px 10px rgba(0,0,0,0.3);
                  transform: perspective(500px) rotateX(5deg);
                  display: inline-block;
                ">Planos e Cota√ß√µes</h1>
        </div>
       </div>
       <div class="flex items-center gap-3">
        <button
          id="btnNovaProposta"
          class="btn-primary bg-white text-blue-600 px-6 py-3 rounded-xl font-bold text-sm md:text-base hover:bg-blue-50 shadow-lg hover:shadow-xl flex items-center gap-2 transition-all"
        >
          <span class="text-xl">‚ûï</span>
          <span>Nova Proposta</span>
        </button>

        <button
          id="btnAbrirMenu"
          class="bg-white/80 text-gray-800 px-4 py-3 rounded-xl border border-white/60 shadow hover:bg-white flex items-center gap-2 text-sm md:text-base"
        >
          <span class="text-2xl">‚ò∞</span>
          <span class="hidden md:inline">Menu</span>
        </button>

        <button
          id="btnPainelGerente"
          class="hidden bg-indigo-600 text-white px-4 md:px-5 py-3 rounded-xl shadow-lg hover:bg-indigo-700 flex items-center gap-2 text-sm md:text-base font-semibold border border-indigo-300"
        >
          üìä <span>Painel do Gerente</span>
        </button>
       </div>
      </div>
     </div><!-- Linha decorativa inferior -->
     <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-30"></div>
    </header><!-- Modal do Menu -->
    <div id="modalMenu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto"><!-- Cabe√ßalho do Menu -->
      <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
       <div>
        <h2 class="text-2xl font-bold">üìã Menu Principal</h2>
        <p class="text-blue-100 text-sm mt-1">Ferramentas e Configura√ß√µes</p>
       </div><button id="btnFecharMenu" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors"> ‚úï </button>
      </div><!-- Conte√∫do do Menu -->
      <div class="p-6"><!-- Grid de Op√ß√µes -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"><!-- Taxas --> <button id="btnMenuTaxas" class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 rounded-xl p-6 hover:shadow-lg transition-all text-left group">
         <div class="text-4xl mb-3">
          üìä
         </div><h3 class="text-lg font-bold text-gray-800 mb-1">Taxas de Juros</h3><p class="text-sm text-gray-600">Consulte as taxas de carn√™ e cart√£o</p></button> <!-- Calculadora --> <button id="btnMenuCalculadora" class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-xl p-6 hover:shadow-lg transition-all text-left group">
         <div class="text-4xl mb-3">
          üßÆ
         </div><h3 class="text-lg font-bold text-gray-800 mb-1">Calculadora</h3><p class="text-sm text-gray-600">Calcule parcelas e valores</p></button> <!-- Relat√≥rios --> <button id="btnMenuRelatorios" class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-300 rounded-xl p-6 hover:shadow-lg transition-all text-left group">
         <div class="text-4xl mb-3">
          üìà
         </div><h3 class="text-lg font-bold text-gray-800 mb-1">Relat√≥rios</h3><p class="text-sm text-gray-600">Visualize estat√≠sticas e dados</p></button> <!-- Baixar App --> <button id="btnMenuBaixarApp" class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl p-6 hover:shadow-lg transition-all text-left group">
         <div class="text-4xl mb-3">
          üì±
         </div><h3 class="text-lg font-bold text-gray-800 mb-1">Baixar App</h3><p class="text-sm text-gray-600">Instale no seu dispositivo</p></button> <!-- Sair --> <button id="btnMenuSair" class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-300 rounded-xl p-6 hover:shadow-lg transition-all text-left group">
         <div class="text-4xl mb-3">
          üö™
         </div><h3 class="text-lg font-bold text-gray-800 mb-1">Sair</h3><p class="text-sm text-gray-600">Fazer logout do sistema</p></button>
       </div>
      </div>
     </div>
    </div><!-- Modal Taxas de Juros -->
    <div id="modalTaxas" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
       <div>
        <h2 class="text-2xl font-bold">üìä Tabela de Taxas de Juros</h2>
        <p class="text-orange-100 text-sm mt-1">Coeficientes para c√°lculo de parcelas</p>
       </div><button id="btnFecharTaxas" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors"> ‚úï </button>
      </div>
      <div class="p-6">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Tabela Carn√™ -->
        <div class="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
         <h3 class="text-xl font-bold text-orange-800 mb-4 flex items-center gap-2"><span>üìù</span> <span>Carn√™</span></h3>
         <div class="overflow-x-auto">
          <table class="w-full text-sm">
           <thead>
            <tr class="bg-orange-200">
             <th class="px-3 py-2 text-left font-bold text-orange-900">Parcelas</th>
             <th class="px-3 py-2 text-right font-bold text-orange-900">Coeficiente</th>
            </tr>
           </thead>
           <tbody>
            <tr class="bg-white border-b border-orange-100">
             <td class="px-3 py-2">1x</td>
             <td class="px-3 py-2 text-right font-mono">1.0690</td>
            </tr>
            <tr class="bg-orange-50 border-b border-orange-100">
             <td class="px-3 py-2">2x</td>
             <td class="px-3 py-2 text-right font-mono">0.5523</td>
            </tr>
            <tr class="bg-white border-b border-orange-100">
             <td class="px-3 py-2">3x</td>
             <td class="px-3 py-2 text-right font-mono">0.3804</td>
            </tr>
            <tr class="bg-orange-50 border-b border-orange-100">
             <td class="px-3 py-2">4x</td>
             <td class="px-3 py-2 text-right font-mono">0.2946</td>
            </tr>
            <tr class="bg-white border-b border-orange-100">
             <td class="px-3 py-2">5x</td>
             <td class="px-3 py-2 text-right font-mono">0.2432</td>
            </tr>
            <tr class="bg-orange-50 border-b border-orange-100">
             <td class="px-3 py-2">6x</td>
             <td class="px-3 py-2 text-right font-mono">0.2091</td>
            </tr>
            <tr class="bg-white border-b border-orange-100">
             <td class="px-3 py-2">7x</td>
             <td class="px-3 py-2 text-right font-mono">0.1849</td>
            </tr>
            <tr class="bg-orange-50 border-b border-orange-100">
             <td class="px-3 py-2">8x</td>
             <td class="px-3 py-2 text-right font-mono">0.1668</td>
            </tr>
            <tr class="bg-white border-b border-orange-100">
             <td class="px-3 py-2">9x</td>
             <td class="px-3 py-2 text-right font-mono">0.1528</td>
            </tr>
            <tr class="bg-orange-50 border-b border-orange-100">
             <td class="px-3 py-2">10x</td>
             <td class="px-3 py-2 text-right font-mono">0.1417</td>
            </tr>
            <tr class="bg-white border-b border-orange-100">
             <td class="px-3 py-2">11x</td>
             <td class="px-3 py-2 text-right font-mono">0.1327</td>
            </tr>
            <tr class="bg-orange-50">
             <td class="px-3 py-2">12x</td>
             <td class="px-3 py-2 text-right font-mono">0.1252</td>
            </tr>
           </tbody>
          </table>
         </div>
         <div class="mt-4 bg-orange-100 p-3 rounded-lg">
          <p class="text-xs text-orange-800 font-semibold">üí° F√≥rmula: Valor da Parcela = Vlr Total √ó Coeficiente</p>
         </div>
        </div><!-- Tabela Cart√£o -->
        <div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
         <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2"><span>üí≥</span> <span>Cart√£o</span></h3>
         <div class="overflow-x-auto">
          <table class="w-full text-sm">
           <thead>
            <tr class="bg-blue-200">
             <th class="px-3 py-2 text-left font-bold text-blue-900">Parcelas</th>
             <th class="px-3 py-2 text-right font-bold text-blue-900">Coeficiente</th>
            </tr>
           </thead>
           <tbody>
            <tr class="bg-white border-b border-blue-100">
             <td class="px-3 py-2">1x</td>
             <td class="px-3 py-2 text-right font-mono">1.0292</td>
            </tr>
            <tr class="bg-blue-50 border-b border-blue-100">
             <td class="px-3 py-2">2x</td>
             <td class="px-3 py-2 text-right font-mono">0.5220</td>
            </tr>
            <tr class="bg-white border-b border-blue-100">
             <td class="px-3 py-2">3x</td>
             <td class="px-3 py-2 text-right font-mono">0.3530</td>
            </tr>
            <tr class="bg-blue-50 border-b border-blue-100">
             <td class="px-3 py-2">4x</td>
             <td class="px-3 py-2 text-right font-mono">0.2685</td>
            </tr>
            <tr class="bg-white border-b border-blue-100">
             <td class="px-3 py-2">5x</td>
             <td class="px-3 py-2 text-right font-mono">0.2179</td>
            </tr>
            <tr class="bg-blue-50 border-b border-blue-100">
             <td class="px-3 py-2">6x</td>
             <td class="px-3 py-2 text-right font-mono">0.1841</td>
            </tr>
            <tr class="bg-white border-b border-blue-100">
             <td class="px-3 py-2">7x</td>
             <td class="px-3 py-2 text-right font-mono">0.1600</td>
            </tr>
            <tr class="bg-blue-50 border-b border-blue-100">
             <td class="px-3 py-2">8x</td>
             <td class="px-3 py-2 text-right font-mono">0.1420</td>
            </tr>
            <tr class="bg-white border-b border-blue-100">
             <td class="px-3 py-2">9x</td>
             <td class="px-3 py-2 text-right font-mono">0.1280</td>
            </tr>
            <tr class="bg-blue-50 border-b border-blue-100">
             <td class="px-3 py-2">10x</td>
             <td class="px-3 py-2 text-right font-mono">0.1168</td>
            </tr>
            <tr class="bg-white border-b border-blue-100">
             <td class="px-3 py-2">11x</td>
             <td class="px-3 py-2 text-right font-mono">0.1076</td>
            </tr>
            <tr class="bg-blue-50">
             <td class="px-3 py-2">12x</td>
             <td class="px-3 py-2 text-right font-mono">0.1000</td>
            </tr>
           </tbody>
          </table>
         </div>
         <div class="mt-4 bg-blue-100 p-3 rounded-lg">
          <p class="text-xs text-blue-800 font-semibold">üí° F√≥rmula: Valor da Parcela = Valor Total √ó Coeficiente</p>
         </div>
        </div>
       </div><!-- Exemplo Pr√°tico -->
       <div class="mt-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-300">
        <h3 class="text-lg font-bold text-green-800 mb-3">üìö Exemplo Pr√°tico</h3>
        <div class="space-y-2 text-sm text-gray-700">
         <p><strong>Produto:</strong> R$ 1.000,00</p>
         <p><strong>Carn√™ 6x:</strong> R$ 1.000,00 √ó 0.2091 = <span class="font-bold text-green-600">R$ 209,10 por parcela</span></p>
         <p><strong>Cart√£o 6x:</strong> R$ 1.000,00 √ó 0.1841 = <span class="font-bold text-blue-600">R$ 184,10 por parcela</span></p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Modal Calculadora -->
    <div id="modalCalculadora" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
       <div>
        <h2 class="text-2xl font-bold">üßÆ Calculadora de Parcelas</h2>
        <p class="text-green-100 text-sm mt-1">Calcule valores de forma r√°pida</p>
       </div><button id="btnFecharCalculadora" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors"> ‚úï </button>
      </div>
      <div class="p-6">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">üí∞ Valor do Produto (R$)</label> <input type="text" id="calcValor" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg" placeholder="R$ 0,00">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">üìã Modalidade</label> <select id="calcModalidade" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"> <option value="carne">üìù Carn√™</option> <option value="cartao">üí≥ Cart√£o</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">üî¢ N√∫mero de Parcelas</label> <select id="calcParcelas" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"> <option value="1">1x</option> <option value="2">2x</option> <option value="3">3x</option> <option value="4">4x</option> <option value="5">5x</option> <option value="6">6x</option> <option value="7">7x</option> <option value="8">8x</option> <option value="9">9x</option> <option value="10">10x</option> <option value="11">11x</option> <option value="12">12x</option> </select>
        </div><button id="btnCalcular" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:from-green-600 hover:to-emerald-600 shadow-lg transition-all"> üßÆ Calcular </button> <!-- Resultado -->
        <div id="calcResultado" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-300">
         <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">üìä Resultado</h3>
         <div class="space-y-3">
          <div class="bg-white p-4 rounded-lg">
           <p class="text-sm text-gray-600 mb-1">Valor da Parcela</p>
           <p id="calcValorParcela" class="text-3xl font-bold text-green-600">R$ 0,00</p>
          </div>
          <div class="bg-white p-4 rounded-lg">
           <p class="text-sm text-gray-600 mb-1">Valor Total</p>
           <p id="calcValorTotal" class="text-2xl font-bold text-blue-600">R$ 0,00</p>
          </div>
          <div class="bg-white p-4 rounded-lg">
           <p class="text-sm text-gray-600 mb-1">Coeficiente Utilizado</p>
           <p id="calcCoeficiente" class="text-xl font-mono text-gray-700">0.0000</p>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Modal Relat√≥rios -->
    <div id="modalRelatorios" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
       <div>
        <h2 class="text-2xl font-bold">üìà Relat√≥rios e Estat√≠sticas</h2>
        <p class="text-purple-100 text-sm mt-1">An√°lise de propostas e desempenho</p>
       </div><button id="btnFecharRelatorios" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors"> ‚úï </button>
      </div>
      <div class="p-6">
       <div id="relatoriosContent"><!-- Conte√∫do ser√° gerado dinamicamente -->
       </div>
      </div>
     </div>
    </div><!-- View Selector: Lista / Editor / Visualiza√ß√£o -->
    <div id="viewContainer" class="container mx-auto px-4 py-6"><!-- LISTA DE PROPOSTAS -->
     <div id="listaView" class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-gray-800">üéØ Minhas Propostas</h2>
       <div class="text-sm text-gray-500"><span id="contadorPropostas">0 propostas</span>
       </div>
      </div>
      <div id="painelGerenteVendedores" class="mb-4 hidden">
       <h3 class="text-sm font-semibold text-gray-700 mb-2">
        Painel do gerente ‚Äì vendedores em negocia√ß√£o
       </h3>
       <div id="gridCardsGerente" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
       </div>
      </div>
      <div id="gerenteSearchBox" class="mb-4">
        <div class="flex flex-wrap gap-3 items-center justify-between">
          <div class="text-sm font-medium text-gray-700">
            üîé Busca r√°pida (Gerente) ‚Äì informe o c√≥digo da proposta
          </div>
          <div class="flex gap-2">
            <input id="inputBuscaCodigo" type="text"
              class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              placeholder="Ex.: PC20251129001" />
            <button type="button" onclick="buscarPropostaPorCodigo()"
              class="px-4 py-2 rounded-lg bg-purple-600 text-white text-sm font-semibold shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
              Buscar
            </button>
          </div>
        </div>
        <p id="resultadoBuscaCodigo" class="mt-2 text-xs text-gray-500"></p>
      </div>
      <!-- Filtro de Datas -->
      <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-2 border-blue-200">
       <div class="flex flex-wrap gap-3 items-center justify-center"><label class="text-sm font-medium text-gray-700">üìÖ Filtrar por Data</label> <input type="date" id="inputDataFiltro" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"> <button id="btnFiltrarHoje" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold text-sm transition-colors"> üìÖ Hoje </button> <button id="btnLimparFiltro" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 font-semibold text-sm transition-colors"> üîÑ Todas </button>
       </div>
       <div id="infoFiltro" class="mt-3 text-sm text-blue-700 font-semibold text-center hidden"><!-- Informa√ß√£o do filtro ativo -->
       </div>
      </div>
      <div id="listaPropostas" class="space-y-4"><!-- Propostas ser√£o inseridas aqui -->
      </div>
      <div id="emptyState" class="text-center py-12">
       <div class="text-6xl mb-4">
        üìÑ
       </div>
       <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma proposta criada ainda</h3>
       <p class="text-gray-500 mb-6">Clique em "Nova Proposta" para come√ßar</p>
      </div>
     </div><!-- EDITOR DE PROPOSTA -->
     <div id="editorView" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">‚úèÔ∏è Propostas</h2><button id="btnVoltarLista" class="text-gray-600 hover:text-gray-800 font-semibold"> ‚Üê Voltar para Lista </button>
       </div><!-- Dados B√°sicos -->
       <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">üìù Dados B√°sicos</h3>
        <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
         <p class="text-sm text-blue-800 font-medium">üè™ Iguatu 3 - Ao lado do Bradesco</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputVendedorNome">Nome do Vendedor</label> <input type="text" id="inputVendedorNome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite o nome do vendedor">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputClienteNome">Nome do Cliente</label> <input type="text" id="inputClienteNome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite o nome do cliente">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputClienteContato">Contato do Cliente (com DDD)</label> <input type="text" id="inputClienteContato" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="(11) 98765-4321" required>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputDataProposta">üìÖ Data Atual</label> <input type="date" id="inputDataProposta" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-100" readonly>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputValidadeProposta">‚è∞ Validade da Proposta</label> <input type="date" id="inputValidadeProposta" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         </div>
        </div>
        <div class="mt-4"><label class="block text-sm font-medium text-gray-700 mb-2" for="inputTituloProposta">T√≠tulo da Proposta</label> <input type="text" id="inputTituloProposta" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
       </div><!-- Produtos / Planos -->
       <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">üõí Produtos / Planos</h3><button id="btnAdicionarProduto" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold text-sm"> + Adicionar Produto </button>
        </div>
        <div id="listaProdutos" class="space-y-4"><!-- Produtos ser√£o inseridas aqui -->
        </div>

       </div>


       <!-- Resumo Geral da Proposta -->

       <div id="resumoGeralContainer" class="mb-8 hidden">
        <div class="bg-white rounded-lg border border-green-300 p-4 shadow-sm">
         <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
          <div class="flex items-center gap-2">
           <button id="btnToggleResumoGeral" type="button"
            class="px-2 py-1 rounded-full border border-green-300 bg-green-50 text-xs text-green-700 hover:bg-green-100 transition">
            üîç
           </button>
           <h3 class="text-lg font-semibold text-gray-700">üí∞ Resumo Geral da Proposta</h3>
          </div>
          <div class="flex flex-wrap gap-3">
           <div class="flex items-center gap-2 mr-4">
            <input id="chkResumoCliente" type="checkbox" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
            <label for="chkResumoCliente" class="text-[11px] sm:text-xs text-gray-600">Incluir este resumo na imagem do cliente</label>
           </div>
           <div>
            <label for="resumoModalidade" class="block text-xs font-semibold text-gray-600 mb-1">Modalidade</label>
            <select id="resumoModalidade" class="px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
             <option value="carne">üìÑ Carn√™</option>
             <option value="cartao">üí≥ Cart√£o</option>
             <option value="avista">üíµ √Ä Vista</option>
            </select>
           </div>
           <div>
            <label for="resumoParcelas" class="block text-xs font-semibold text-gray-600 mb-1">N√∫mero de Parcelas</label>
            <select id="resumoParcelas" class="px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
             <option value="1">1x</option>
             <option value="2">2x</option>
             <option value="3">3x</option>
             <option value="4">4x</option>
             <option value="5" selected>5x</option>
             <option value="6">6x</option>
             <option value="7">7x</option>
             <option value="8">8x</option>
             <option value="9">9x</option>
             <option value="10">10x</option>
             <option value="11">11x</option>
             <option value="12">12x</option>
            </select>
           </div>
          </div>
         </div>
         
         <div id="resumoGeralBody" class="bg-green-50 rounded-lg p-4 border border-green-200 hidden">
          <h4 class="font-semibold text-center text-gray-700 mb-4">üßæ Resumo da Proposta</h4>
          
          <p class="text-xs text-gray-500 text-center mb-2">Resumo financeiro (parcelas)</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-4">
           <div class="bg-white rounded-lg border border-gray-200 p-3">
            <p class="text-xs text-gray-500 mb-1">Parcela Normal</p>
            <p id="resumoParcelaNormal" class="text-lg font-semibold text-gray-500 line-through">R$ 0,00</p>
           </div>
           <div class="bg-white rounded-lg border border-green-300 p-3">
            <p class="text-xs text-gray-500 mb-1">Sua Parcela</p>
            <p id="resumoSuaParcela" class="text-lg font-bold text-green-600">R$ 0,00</p>
           </div>
           <div class="bg-white rounded-lg border border-red-200 p-3 md:col-span-2">
            <p class="text-xs text-gray-500 mb-1">Economia por Parcela</p>
            <p id="resumoEconomiaParcela" class="text-lg font-bold text-red-500">R$ 0,00</p>
            <p id="resumoEconomiaParcelaPerc" class="text-xs text-gray-500 mt-1">(0,0% de desconto)</p>
           </div>
          </div>
          
          <p class="text-xs text-gray-500 text-center mt-2 mb-2">Resumo total</p>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
           <div class="bg-white rounded-lg border border-gray-200 p-3">
            <p class="text-xs text-gray-500 mb-1">Total Normal</p>
            <p id="resumoTotalNormal" class="text-sm font-semibold text-gray-500 line-through">R$ 0,00</p>
           </div>
           <div class="bg-white rounded-lg border border-green-300 p-3">
            <p class="text-xs text-gray-500 mb-1">Valor Total Parcelado</p>
            <p id="resumoTotalParcelado" class="text-sm font-bold text-green-600">R$ 0,00</p>
           </div>
           <div class="bg-white rounded-lg border border-red-200 p-3 md:col-span-2">
            <p class="text-xs text-gray-500 mb-1">Economia Total</p>
            <p id="resumoEconomiaTotal" class="text-sm font-bold text-red-500">R$ 0,00</p>
            <p id="resumoEconomiaTotalPerc" class="text-xs text-gray-500 mt-1">(0,0% de desconto)</p>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Bot√£o para Abrir Planos Exclusivos -->

       <div id="containerBotaoPlanoExclusivo" class="mb-8 hidden"><button id="btnAbrirPlanoExclusivo" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-pink-600 shadow-lg transition-all flex items-center justify-center gap-3"> <span class="text-2xl">üéÅ</span> <span>Plano Exclusivo Gerente</span> </button>
       </div><!-- Planos Exclusivos (Parcelamento Sem Juros) -->
       <div id="secaoPlanoExclusivo" class="mb-8 bg-purple-50 p-6 rounded-lg border border-purple-200 hidden">
        <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b border-purple-300 pb-2">üéÅ Planos Exclusivos (GERENTE)</h3>
        <div id="infoModalidadePlanoExclusivo" class="mb-3 p-2 bg-blue-100 rounded text-sm text-blue-800 text-center font-semibold"><!-- Modalidade ser√° exibida aqui -->
        </div>
        <div class="space-y-4">
         <!-- Valor da parcela em destaque -->
         <div class="max-w-md mx-auto">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="displayParcelaPlanoExclusivo">Valor da Parcela</label>
          <input
            type="text"
            id="displayParcelaPlanoExclusivo"
            class="w-full px-4 py-3 rounded-lg border border-green-300 bg-green-50 text-green-700 text-lg font-semibold text-center shadow-sm"
            readonly
            value="R$ 0,00"
          />
         </div>

         <!-- Pre√ßo de tabela e parcelamento -->
         <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-2xl mx-auto">
          <div>
           <label class="block text-sm font-medium text-gray-700 mb-1" for="inputValorPlanoExclusivo">
            Pre√ßo de Tabela com Benef√≠cios Zenir
           </label>
           <input
             type="text"
             id="inputValorPlanoExclusivo"
             class="w-full px-4 py-2 rounded-lg border border-green-200 bg-green-50 text-green-700 font-semibold focus:ring-2 focus:ring-green-500 focus:border-transparent"
             readonly
             placeholder="R$ 0,00"
           />
          </div>
          <div>
           <label class="block text-sm font-medium text-gray-700 mb-1" for="inputParcelasPlanoExclusivo">
            Parcelamento
           </label>
           <select
             id="inputParcelasPlanoExclusivo"
             class="w-full px-4 py-2 rounded-lg border border-purple-200 bg-white focus:ring-2 focus:ring-purple-500 focus:border-transparent"
             onchange="calcularParcelaPlanoExclusivo()"
           >
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="3">3x</option>
            <option value="4">4x</option>
            <option value="5">5x</option>
            <option value="6">6x</option>
            <option value="7">7x</option>
            <option value="8">8x</option>
            <option value="9">9x</option>
            <option value="10">10x</option>
            <option value="11">11x</option>
            <option value="12">12x</option>
           </select>
          </div>
         </div>
        </div>
        <div id="infoParcelamentoExclusivo" class="mt-3 p-3 bg-purple-100 rounded text-sm text-purple-800">
         <p class="font-semibold">üí° Calculado automaticamente com base nos produtos e servi√ßos</p>
        </div>
       </div><!-- Bot√£o para Abrir Observa√ß√µes Internas -->
       <div id="containerBotaoObservacoesInternas" class="mb-8 hidden"><button id="btnAbrirObservacoesInternas" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:from-yellow-600 hover:to-orange-600 shadow-lg transition-all flex items-center justify-center gap-3"> <span class="text-2xl">üîí</span> <span>Solicita√ß√£o N√≠vel Diretoria</span> </button>
       </div><!-- Observa√ß√µes Internas (apenas Diretoria) -->
       <div id="secaoObservacoesInternas" class="mb-8 bg-yellow-50 p-6 rounded-lg border border-yellow-200 hidden">
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputHistorico">Solicitante/Informa√ß√µes</label> <textarea id="inputHistorico" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Descreva as informa√ß√µes do solicitante..."></textarea>
         </div>
         <div id="campoParcelamentoCarne" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2" for="inputOpcoesParcelamentoCarne">üìù Carn√™ - Sem Juros</label> <textarea id="inputOpcoesParcelamentoCarne" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: 1x, 2x, 3x, 4x, 5x sem juros"></textarea>
         </div>
         <div id="campoParcelamentoCartao" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2" for="inputOpcoesParcelamentoCartao">üí≥ CartÔøΩÔøΩÔøΩÔøΩo - Sem Juros</label> <textarea id="inputOpcoesParcelamentoCartao" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: 1x, 2x, 3x, 4x, 5x, 6x sem juros"></textarea>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputSimulacao">Proposta da Ger√™ncia üíº</label> <textarea id="inputSimulacao" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2" for="inputOportunidades">Observa√ß√µes importantes</label> <textarea id="inputOportunidades" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
         </div>
         <div class="mt-4 flex items-center gap-2">
          <input id="chkMostrarParcelamentoSemJuros" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="chkMostrarParcelamentoSemJuros" class="text-sm text-gray-700">
           Mostrar bloco "Parcelamento Sem Juros" na proposta
          </label>
         </div>
        </div>
       </div><!-- Bot√µes de A√ß√£o -->
       <div class="flex gap-4"><button id="btnSalvarProposta" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700"> üíæ Salvar Proposta </button> <button id="btnVisualizarProposta" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700"> üëÅÔ∏è Visualizar Proposta </button>
       </div>
      </div>
     </div><!-- VISUALIZA√á√ÉO DA PROPOSTA -->
     <div id="visualizacaoView" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">üëÅÔ∏è Visualizacao da Proposta</h2><button id="btnVoltarEditor" class="text-gray-600 hover:text-gray-800 font-semibold"> ‚Üê Voltar ao Editor </button>
       </div><!-- Tabs: Vis√£o Cliente / Vis√£o Diretoria -->
       <div class="flex border-b mb-6"><button id="tabCliente" class="tab-button tab-active px-6 py-3 font-semibold text-gray-700"> üë§ Vis√£o Cliente </button> <button id="tabDiretoria" class="tab-button px-6 py-3 font-semibold text-gray-700"> üè¢ Vis√£o Diretoria </button>
       </div><!-- Conte√∫do das Tabs -->
       <div id="contentCliente" class="tab-content"><!-- Vis√£o Cliente ser√° renderizada aqui -->
       </div>
       <div id="contentDiretoria" class="tab-content hidden"><!-- Vis√£o Diretoria ser√° renderizada aqui -->
       </div><!-- Bot√µes de Acao -->
       <div class="mt-6 no-print"><button id="btnGerarImagemCliente" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600"> üëÅÔ∏è Visualizar e Enviar - Vis√£o Cliente </button> <button id="btnGerarImagemDiretoria" class="hidden w-full bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-600"> Visualizar e Enviar - Vis√£o Diretoria </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ===== AUTENTICA√á√ÉO GLOBAL FS SOLU√á√ïES =====
    const FS_AUTH_KEY = 'fsAuthGlobal';
    const FS_AUTH_TOKEN = 'ok-@fildO1060'; // token global para todas as plataformas FS

    const FS_AUTH_LOG_KEY = 'fsAuthTentativas';

    function fsRegistrarTentativa(tipo) {
      try {
        const agora = new Date().toISOString();
        const payload = {
          tipo,
          data: agora,
          userAgent: navigator.userAgent || ''
        };
        const atual = JSON.parse(localStorage.getItem(FS_AUTH_LOG_KEY) || '[]');
        atual.push(payload);
        // mant√©m s√≥ as √∫ltimas 50 tentativas
        localStorage.setItem(FS_AUTH_LOG_KEY, JSON.stringify(atual.slice(-50)));
      } catch (e) {
        console.warn('[FS] N√£o foi poss√≠vel registrar tentativa de acesso:', e);
      }
    }

    function fsVerificarAutenticacaoGlobal() {
      try {
        const token = localStorage.getItem(FS_AUTH_KEY);
        return token === FS_AUTH_TOKEN;
      } catch (e) {
        console.warn('[FS] N√£o foi poss√≠vel ler o localStorage:', e);
        return false;
      }
    }

    function fsGarantirAutenticacaoGlobal() {
      // Se j√° tiver token salvo (por outro m√≥dulo ou pelo Index), libera direto
      if (fsVerificarAutenticacaoGlobal()) {
        return true;
      }

      let tentativas = 0;
      while (tentativas < 3) {
        const senha = window.prompt('Digite a senha de acesso ao sistema:');
        if (senha === null) {
          fsRegistrarTentativa('cancelou_senha');
          alert('Acesso cancelado.');
          return false;
        }
        if (senha === '@fildO1060') {
          try {
            localStorage.setItem(FS_AUTH_KEY, FS_AUTH_TOKEN);
          } catch (e) {
            console.warn('[FS] N√£o foi poss√≠vel salvar o token de autentica√ß√£o:', e);
          }
          return true;
        }
        tentativas++;
        fsRegistrarTentativa('senha_incorreta');
        alert('Senha incorreta. Tente novamente.');
      }

      fsRegistrarTentativa('bloqueio_por_tentativas');
      alert('Muitas tentativas inv√°lidas. Acesso bloqueado.');
      return false;
    }

    // ========== CONFIG & STATE ==========
    const defaultConfig = {
      app_title: "Planos e Cota√ß√µes",
      primary_button_text: "Nova Proposta",
      background_color: "#eff6ff",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#2563eb",
      secondary_action_color: "#6366f1",
      font_family: "Inter",
      font_size: 16
    };


    // Endpoint online para envio ao gerente
    const FS_ONLINE_URL = 'https://script.google.com/macros/s/AKfycbwE-v6LHArYcoBcsqf0cWgzX1tm5-avttnwHxQ6vouWRRFpv-AvZYif_x8eqlEB5Rk5/exec';

    // Tabelas de taxas de juros
    const TAXAS_CARNE = [1.0690, 0.5523, 0.3804, 0.2946, 0.2432, 0.2091, 0.1849, 0.1668, 0.1528, 0.1417, 0.1327, 0.1252];
    const TAXAS_CARTAO = [1.0292, 0.5220, 0.3530, 0.2685, 0.2179, 0.1841, 0.1600, 0.1420, 0.1280, 0.1168, 0.1076, 0.1000];

    let currentProposalId = null;
    let currentProposalData = null;
    let produtos = [];
    let allProposals = [];
    let filtroDataInicio = null;
    let filtroDataFim = null;
    let nomeVendedorLogado = '';
    let propostaFoiSalva = false;
    let imagemClienteBaixada = false;

    // Filtros espec√≠ficos para vis√£o gerencial
    let filtroGerenteStatus = 'pendentes'; // 'pendentes', 'todos', 'autorizados', 'negados'
    let filtroGerenteVendedor = 'todos';

    // ===== Fun√ß√µes de apoio para gerente e c√≥digos de proposta =====
    function ehUsuarioGerente() {
      if (!nomeVendedorLogado) return false;
      const nome = (nomeVendedorLogado || '').toLowerCase().trim();

      // Somente estes nomes ter√£o acesso gerencial
      const nomesGerentes = [
        'fildo',
        'vit√≥ria',
        'vitoria',
        'neuma',
        'vicarri',
        'vicari'
      ];

      return nomesGerentes.some(p => nome.includes(p));
    }

    function abrirPainelGerente() {
      try {
        if (!FS_ONLINE_URL) {
          showToast('URL do painel gerencial n√£o configurada.', 'error');
          return;
        }
        window.open(FS_ONLINE_URL, '_blank');
      } catch (e) {
        console.error('[FS] Erro ao abrir painel do gerente:', e);
        showToast('‚ùå Erro ao abrir o painel do gerente.', 'error');
      }
    }


    
    function gerarCodigoPropostaUnico(dataProposta, listaExistente) {
      const prefix = 'FS';
      let maxSeq = 0;

      if (Array.isArray(listaExistente)) {
        listaExistente.forEach(p => {
          if (!p || !p.codigo_proposta) return;
          const match = String(p.codigo_proposta).trim().match(/^FS(\d+)$/i);
          if (match) {
            const n = parseInt(match[1], 10);
            if (!Number.isNaN(n) && n > maxSeq) {
              maxSeq = n;
            }
          }
        });
      }

      let seq = maxSeq + 1;
      if (!Number.isFinite(seq) || seq <= 0) seq = 1;

      let tentativas = 0;
      while (tentativas < 1000) {
        const codigo = `${prefix}${String(seq).padStart(2, '0')}`;
        if (!Array.isArray(listaExistente) || !listaExistente.some(p => p && p.codigo_proposta === codigo)) {
          return codigo;
        }
        seq++;
        tentativas++;
      }

      // fallback
      return `${prefix}${Date.now().toString().slice(-4)}`;
    }


function atualizarBadgeCodigo(codigo) {
      try {
        const cont = document.getElementById('codigoPropostaFloat');
        const span = document.getElementById('codigoPropostaFloatText');
        if (!cont || !span) return;

        if (!codigo) {
          cont.classList.add('hidden');
          span.textContent = '';
          return;
        }

        span.textContent = String(codigo);
        cont.classList.remove('hidden');
      } catch (e) {
        console.warn('[FS] Erro ao atualizar badge de c√≥digo:', e);
      }
    }

function configurarBuscaGerente() {
      const box = document.getElementById('gerenteSearchBox');
      const btnPainelHeader = document.getElementById('btnPainelGerente');
      const btnPainelMenu = document.getElementById('btnMenuPainelGerente');
      const btnPainelFloat = document.getElementById('btnPainelGerenteFlutuante');
      const ehGerente = ehUsuarioGerente();

      if (box) {
        if (ehGerente) box.classList.remove('hidden');
        else box.classList.add('hidden');
      }

      if (btnPainelHeader) {
        if (ehGerente) btnPainelHeader.classList.remove('hidden');
        else btnPainelHeader.classList.add('hidden');
      }

      if (btnPainelMenu) {
        if (ehGerente) btnPainelMenu.classList.remove('hidden');
        else btnPainelMenu.classList.add('hidden');
      }

      if (btnPainelFloat) {
        if (ehGerente) btnPainelFloat.classList.remove('hidden');
        else btnPainelFloat.classList.add('hidden');
      }

      // Se for gerente, exibir os filtros avan√ßados
      const filtrosGerente = document.getElementById('filtrosGerenteAvancados');
      if (filtrosGerente) {
        if (ehGerente) filtrosGerente.classList.remove('hidden');
        else filtrosGerente.classList.add('hidden');
      }
    }

    function definirFiltroGerenteStatus(novoStatus) {
      filtroGerenteStatus = novoStatus || 'pendentes';
      if (typeof renderListaPropostas === 'function') {
        renderListaPropostas(allProposals || []);
      }
    }

    function definirFiltroGerenteVendedor(nome) {
      filtroGerenteVendedor = nome || 'todos';
      if (typeof renderListaPropostas === 'function') {
        renderListaPropostas(allProposals || []);
      }
    }

function buscarPropostaPorCodigo() {
  try {
    const input = document.getElementById('inputBuscaCodigo');
    const feedback = document.getElementById('resultadoBuscaCodigo');

    if (!input || !feedback) return;

    const termo = (input.value || '').trim().toUpperCase();
    if (!termo) {
      feedback.textContent = 'Informe o c√≥digo da proposta para buscar.';
      feedback.classList.remove('text-red-500');
      feedback.classList.add('text-gray-500');
      return;
    }

    // 1) Tenta usar a fonte principal (online / Data SDK)
    let lista = [];
    if (Array.isArray(allProposals) && allProposals.length > 0) {
      lista = allProposals;
    } else {
      // 2) Fallback: usa o que estiver salvo neste dispositivo
      const STORAGE_KEY = 'fs_planos_cotacoes_propostas_offline_v1';
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) lista = parsed;
        } catch (e) {
          console.warn('[FS] Erro ao ler propostas offline para busca por c√≥digo:', e);
        }
      }
    }

    if (!Array.isArray(lista) || lista.length === 0) {
      feedback.textContent = 'Nenhuma proposta dispon√≠vel para busca neste painel.';
      feedback.classList.remove('text-gray-500');
      feedback.classList.add('text-red-500');
      return;
    }

    // Procura pelo c√≥digo da proposta
    const propostaAlvo = lista.find(p => p && String(p.codigo_proposta || '').toUpperCase() === termo);
    if (!propostaAlvo) {
      feedback.textContent = 'Nenhuma proposta encontrada com esse c√≥digo.';
      feedback.classList.remove('text-gray-500');
      feedback.classList.add('text-red-500');
      return;
    }

    // Mant√©m em mem√≥ria a mesma lista usada
    allProposals = lista;

    const idRef = propostaAlvo.__offlineId || propostaAlvo.__backendId;
    if (!idRef) {
      feedback.textContent = 'C√≥digo encontrado, mas n√£o foi poss√≠vel abrir a proposta (ID interno ausente).';
      feedback.classList.remove('text-gray-500');
      feedback.classList.add('text-red-500');
      return;
    }

    // Abre a proposta usando o fluxo normal de edi√ß√£o
    if (typeof editarProposta === 'function') {
      editarProposta(idRef);
    }

    if (typeof atualizarBadgeCodigo === 'function') {
      atualizarBadgeCodigo(propostaAlvo.codigo_proposta);
    }

    feedback.textContent = 'Proposta localizada e carregada para edi√ß√£o.';
    feedback.classList.remove('text-red-500');
    feedback.classList.add('text-green-600');
  } catch (e) {
    console.error('[FS] Erro ao buscar proposta por c√≥digo (gerente):', e);
    const feedback = document.getElementById('resultadoBuscaCodigo');
    if (feedback) {
      feedback.textContent = 'Erro ao buscar proposta. Tente novamente.';
      feedback.classList.remove('text-gray-500');
      feedback.classList.add('text-red-500');
    }
  }
}

// ========== DATA SDK SETUP ==========
    const dataHandler = {
      onDataChanged(data) {
        allProposals = data;
        renderListaPropostas(data);
        updateContador(data.length);
      }
    };

    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Erro ao inicializar Data SDK");
        document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro ao carregar o m√≥dulo.</p>';
        return;
      }

      // Inicializar Element SDK
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            applyConfigToUI(config);
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["primary_button_text", config.primary_button_text || defaultConfig.primary_button_text]
          ])
        });

        applyConfigToUI(window.elementSdk.config);
      }

      document.getElementById('loading').classList.add('hidden');
      
      // Verifica se j√° tem nome salvo no localStorage
      const nomeSalvo = localStorage.getItem('nomeVendedorLogado');
      
      if (nomeSalvo) {
        // Se j√° tem nome salvo, entra direto no sistema
        nomeVendedorLogado = nomeSalvo;
        document.getElementById('nomeUsuarioHeader').textContent = nomeSalvo;
        document.getElementById('mainContent').classList.remove('hidden');
        setupEventListeners();
        setDataAtual();
        configurarBuscaGerente();
        showToast(`üëã Bem-vindo de volta, ${nomeSalvo}!`, 'success');
      } else {
        // Se n√£o tem nome salvo, mostra a tela de boas-vindas
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // Configura o bot√£o de entrada
        document.getElementById('btnEntrarSistema').addEventListener('click', entrarNoSistema);
        
        // Permite entrar com Enter
        document.getElementById('inputNomeVendedorInicial').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            entrarNoSistema();
          }
        });
        
        // Foca no input
        setTimeout(() => {
          document.getElementById('inputNomeVendedorInicial').focus();
        }, 300);
      }
    }
    
    function entrarNoSistema() {
      const nomeInput = document.getElementById('inputNomeVendedorInicial');
      const nome = nomeInput.value.trim();
      
      if (!nome) {
        // Anima o input para indicar erro
        nomeInput.classList.add('border-red-500');
        nomeInput.placeholder = '‚ö†Ô∏è Por favor, digite seu nome';
        nomeInput.focus();
        
        setTimeout(() => {
          nomeInput.classList.remove('border-red-500');
          nomeInput.placeholder = 'Digite seu nome completo';
        }, 2000);
        return;
      }
      
      // Salva o nome do vendedor
      nomeVendedorLogado = nome;
      
      // Salva no localStorage para n√£o pedir novamente
      localStorage.setItem('nomeVendedorLogado', nome);
      
      // Atualiza o nome no header
      document.getElementById('nomeUsuarioHeader').textContent = nome;
      
      // Esconde a tela de boas-vindas
      document.getElementById('welcomeScreen').classList.add('hidden');
      
      // Mostra o conte√∫do principal
      document.getElementById('mainContent').classList.remove('hidden');
      
      // Configura os event listeners
      setupEventListeners();
      setDataAtual();
      configurarBuscaGerente();
      
      // Mostra mensagem de boas-vindas
      showToast(`üéâ Bem-vindo(a), ${nome}!`, 'success');
    }

    function applyConfigToUI(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;

      document.body.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      document.body.style.fontSize = `${baseSize}px`;
      document.body.style.background = `linear-gradient(to bottom right, ${bgColor}, ${secondaryColor}20)`;

      const appTitle = document.getElementById('appTitle');
      if (appTitle) {
        appTitle.textContent = config.app_title || defaultConfig.app_title;
        appTitle.style.fontSize = `${baseSize * 1.875}px`;
        appTitle.style.color = surfaceColor;
      }

      const btnNovaProposta = document.getElementById('btnNovaProposta');
      if (btnNovaProposta) {
        btnNovaProposta.textContent = `‚ûï ${config.primary_button_text || defaultConfig.primary_button_text}`;
        btnNovaProposta.style.backgroundColor = surfaceColor;
        btnNovaProposta.style.color = primaryColor;
        btnNovaProposta.style.fontSize = `${baseSize}px`;
      }

      const allSurfaces = document.querySelectorAll('.bg-white');
      allSurfaces.forEach(el => {
        el.style.backgroundColor = surfaceColor;
      });

      const allTexts = document.querySelectorAll('h1, h2, h3, p, label, span, button, input, textarea');
      allTexts.forEach(el => {
        if (!el.classList.contains('text-white') && !el.style.color) {
          el.style.color = textColor;
        }
      });
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      document.getElementById('btnNovaProposta').addEventListener('click', novaProposta);
      document.getElementById('btnVoltarLista').addEventListener('click', voltarParaLista);
      document.getElementById('btnAdicionarProduto').addEventListener('click', adicionarProduto);
      document.getElementById('btnSalvarProposta').addEventListener('click', salvarProposta);
      document.getElementById('btnVisualizarProposta').addEventListener('click', function () {
        if (!propostaFoiSalva) {
          showToast('üíæ Salve a proposta antes de visualizar.', 'error');
          return;
        }
        visualizarProposta();
      });
      document.getElementById('btnVoltarEditor').addEventListener('click', voltarParaEditor);
      document.getElementById('tabCliente').addEventListener('click', () => switchTab('cliente'));
      document.getElementById('tabDiretoria').addEventListener('click', () => switchTab('diretoria'));
      document.getElementById('btnGerarImagemCliente').addEventListener('click', () => gerarImagem('cliente'));
      document.getElementById('btnGerarImagemDiretoria').addEventListener('click', () => gerarImagem('diretoria'));
      document.getElementById('btnAbrirPlanoExclusivo').addEventListener('click', togglePlanoExclusivo);
      document.getElementById('btnAbrirObservacoesInternas').addEventListener('click', toggleObservacoesInternas);

      const btnToggleResumo = document.getElementById('btnToggleResumoGeral');
      if (btnToggleResumo) {
        btnToggleResumo.addEventListener('click', toggleResumoGeralProposta);
      }
      
      // Filtros de data
      document.getElementById('btnFiltrarHoje').addEventListener('click', filtrarHoje);
      document.getElementById('btnLimparFiltro').addEventListener('click', limparFiltro);
      document.getElementById('inputDataFiltro').addEventListener('change', aplicarFiltroData);
      
      // Menu
      document.getElementById('btnAbrirMenu').addEventListener('click', abrirMenu);
      document.getElementById('btnFecharMenu').addEventListener('click', fecharMenu);
      document.getElementById('btnMenuTaxas').addEventListener('click', abrirTaxas);
      document.getElementById('btnMenuCalculadora').addEventListener('click', abrirCalculadora);
      document.getElementById('btnMenuRelatorios').addEventListener('click', abrirRelatorios);
      document.getElementById('btnMenuBaixarApp').addEventListener('click', baixarApp);
      document.getElementById('btnMenuSair').addEventListener('click', sairSistema);
      
      // Modais
      document.getElementById('btnFecharTaxas').addEventListener('click', fecharTaxas);
      document.getElementById('btnFecharCalculadora').addEventListener('click', fecharCalculadora);
      document.getElementById('btnFecharRelatorios').addEventListener('click', fecharRelatorios);
      
      // Calculadora
      document.getElementById('btnCalcular').addEventListener('click', calcularParcelas);
      document.getElementById('calcValor').addEventListener('focus', limparCampoCalculadora);
      document.getElementById('calcValor').addEventListener('blur', formatarCampoCalculadora);

      // Persist√™ncia simples do formul√°rio para n√£o perder dados ao alternar entre modos/vis√µes
      if (typeof registrarPersistenciaFormularioLocal === 'function') {
        registrarPersistenciaFormularioLocal();
      }
    }

    function setDataAtual() {
      // Obt√©m a data e hora atual no fuso hor√°rio de Bras√≠lia (UTC-3)
      const agora = new Date();
      const brasiliaOffset = -3 * 60; // Bras√≠lia √© UTC-3 (em minutos)
      const localOffset = agora.getTimezoneOffset(); // Offset local em minutos
      const diffOffset = brasiliaOffset - localOffset;
      
      // Ajusta para o hor√°rio de Bras√≠lia
      const horarioBrasilia = new Date(agora.getTime() + diffOffset * 60 * 1000);
      
      // Formata a data no padr√£o YYYY-MM-DD
      const ano = horarioBrasilia.getFullYear();
      const mes = String(horarioBrasilia.getMonth() + 1).padStart(2, '0');
      const dia = String(horarioBrasilia.getDate()).padStart(2, '0');
      const dataFormatada = `${ano}-${mes}-${dia}`;
      
      document.getElementById('inputDataProposta').value = dataFormatada;
    }

    function togglePlanoExclusivo() {
      const secao = document.getElementById('secaoPlanoExclusivo');
      const botao = document.getElementById('btnAbrirPlanoExclusivo');
      
      if (secao.classList.contains('hidden')) {
        secao.classList.remove('hidden');
        botao.innerHTML = `
          <span class="text-2xl">‚ùå</span>
          <span>Remover Plano Exclusivo</span>
        `;
        botao.classList.remove('from-purple-500', 'to-pink-500', 'hover:from-purple-600', 'hover:to-pink-600');
        botao.classList.add('from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
      } else {
        secao.classList.add('hidden');
        botao.innerHTML = `
          <span class="text-2xl">üéÅ</span>
          <span>Plano Exclusivo Gerente</span>
        `;
        botao.classList.remove('from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
        botao.classList.add('from-purple-500', 'to-pink-500', 'hover:from-purple-600', 'hover:to-pink-600');
      }
    }

    function toggleObservacoesInternas() {
      const secao = document.getElementById('secaoObservacoesInternas');
      const botao = document.getElementById('btnAbrirObservacoesInternas');
      
      if (secao.classList.contains('hidden')) {
        secao.classList.remove('hidden');
        botao.innerHTML = `
          <span class="text-2xl">‚ùå</span>
          <span>Remover Observa√ß√µes Internas</span>
        `;
        botao.classList.remove('from-yellow-500', 'to-orange-500', 'hover:from-yellow-600', 'hover:to-orange-600');
        botao.classList.add('from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
      } else {
        secao.classList.add('hidden');
        botao.innerHTML = `
          <span class="text-2xl">üîí</span>
          <span>Solicita√ß√£o N√≠vel Diretoria</span>
        `;
        botao.classList.remove('from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
        botao.classList.add('from-yellow-500', 'to-orange-500', 'hover:from-yellow-600', 'hover:to-orange-600');
      }
    }

    // ========== NAVIGATION ==========
    function showView(viewName) {
      document.getElementById('listaView').classList.add('hidden');
      document.getElementById('editorView').classList.add('hidden');
      document.getElementById('visualizacaoView').classList.add('hidden');
      document.getElementById(viewName + 'View').classList.remove('hidden');
    }

    function novaProposta() {
      currentProposalId = null;
      currentProposalData = null;
      produtos = [];
      propostaFoiSalva = false;
      imagemClienteBaixada = false;
      limparFormulario();
      setDataAtual();
      
      // Preenche automaticamente o nome do vendedor
      if (nomeVendedorLogado) {
        document.getElementById('inputVendedorNome').value = nomeVendedorLogado;
      }
      
      showView('editor');
    }

    function voltarParaLista() {
      showView('lista');
    }

    function voltarParaEditor() {
      showView('editor');
    }

    // ========== PRODUTOS ==========
    function adicionarProduto() {
      // Fecha todos os produtos existentes
      produtos.forEach(p => {
        p.expanded = false;
      });
      
      // Adiciona novo produto j√° expandido
      const produto = {
        id: Date.now().toString(),
        produto_completo: '',
        codigo: '',
        nome: '',
        descricao: '',
        quantidade: 1,
        preco_normal: 0,
        preco_promo: 0,
        modalidade: 'avista',
        parcelas: 1,
        valor_parcela: 0,
        expanded: true,  // Novo produto j√° vem aberto
        tem_servicos: null,  // null = n√£o perguntou ainda, true = sim, false = n√£o
        valor_ge: 0,
        usa_pm: false,
        preco_com_ge: 0,
        preco_com_pm: 0
      };
      produtos.push(produto);
      renderProdutos();
    }



    function removerProduto(id) {
      produtos = produtos.filter(p => p.id !== id);
      renderProdutos();
      atualizarCamposParcelamento();
    }


    function atualizarResumoGeralProposta() {
      const containerResumo = document.getElementById('resumoGeralContainer');
      const bodyResumo = document.getElementById('resumoGeralBody');
      if (!containerResumo || !bodyResumo) return;

      // Se n√£o h√° produtos, esconde o resumo
      if (!Array.isArray(produtos) || produtos.length === 0) {
        containerResumo.classList.add('hidden');
        return;
      }

      // H√° produtos: mostra o container (o conte√∫do pode estar aberto ou fechado)
      containerResumo.classList.remove('hidden');

      const selectModalidade = document.getElementById('resumoModalidade');
      const selectParcelas = document.getElementById('resumoParcelas');

      const modalidade = (selectModalidade && selectModalidade.value) || 'carne';
      const parcelas = parseInt(selectParcelas && selectParcelas.value, 10) || 1;

      let totalNormal = 0;
      let totalPromo = 0;

      produtos.forEach(function (p) {
        // Clona o produto e for√ßa modalidade/parcelas escolhidas no resumo
        const clone = Object.assign({}, p, {
          modalidade: modalidade,
          parcelas: parcelas
        });

        totalNormal += calcularValorTotalNormal(clone) || 0;
        totalPromo += calcularValorTotal(clone) || 0;
      });

      if (totalNormal <= 0 || totalPromo <= 0) {
        containerResumo.classList.add('hidden');
        return;
      }

      // N√£o altera a visibilidade aqui; o bot√£o de toggle controla abrir/fechar

      // Calcula parcelas e economia
      let parcelaNormal = totalNormal;
      let parcelaPromo = totalPromo;

      if (modalidade !== 'avista' && parcelas > 0) {
        parcelaNormal = totalNormal / parcelas;
        parcelaPromo = totalPromo / parcelas;
      }

      let economiaParcela = parcelaNormal - parcelaPromo;
      let economiaTotal = totalNormal - totalPromo;

      // Se a economia ficar negativa, zera para evitar valores negativos
      if (economiaParcela < 0) economiaParcela = 0;
      if (economiaTotal < 0) economiaTotal = 0;

      const percParcela = parcelaNormal > 0 ? ((economiaParcela / parcelaNormal) * 100).toFixed(1) : '0.0';
      const percTotal = totalNormal > 0 ? ((economiaTotal / totalNormal) * 100).toFixed(1) : '0.0';

      const spanParcelaNormal = document.getElementById('resumoParcelaNormal');
      const spanSuaParcela = document.getElementById('resumoSuaParcela');
      const spanEconParcela = document.getElementById('resumoEconomiaParcela');
      const spanEconParcelaPerc = document.getElementById('resumoEconomiaParcelaPerc');
      const spanTotalNormal = document.getElementById('resumoTotalNormal');
      const spanTotalParcelado = document.getElementById('resumoTotalParcelado');
      const spanEconTotal = document.getElementById('resumoEconomiaTotal');
      const spanEconTotalPerc = document.getElementById('resumoEconomiaTotalPerc');

      if (spanParcelaNormal) spanParcelaNormal.textContent = formatarMoedaBR(parcelaNormal);
      if (spanSuaParcela) spanSuaParcela.textContent = formatarMoedaBR(parcelaPromo);
      if (spanEconParcela) spanEconParcela.textContent = formatarMoedaBR(economiaParcela);
      if (spanEconParcelaPerc) spanEconParcelaPerc.textContent = `(${percParcela}% de desconto)`;

      if (spanTotalNormal) spanTotalNormal.textContent = formatarMoedaBR(totalNormal);
      if (spanTotalParcelado) spanTotalParcelado.textContent = formatarMoedaBR(totalPromo);
      if (spanEconTotal) spanEconTotal.textContent = formatarMoedaBR(economiaTotal);
      if (spanEconTotalPerc) spanEconTotalPerc.textContent = `(${percTotal}% de desconto)`;
    }



    function toggleResumoGeralProposta() {
      const bodyResumo = document.getElementById('resumoGeralBody');
      const btn = document.getElementById('btnToggleResumoGeral');
      if (!bodyResumo || !btn) return;

      const estaOculto = bodyResumo.classList.contains('hidden');
      if (estaOculto) {
        bodyResumo.classList.remove('hidden');
        btn.textContent = 'üîΩ';
      } else {
        bodyResumo.classList.add('hidden');
        btn.textContent = 'üîç';
      }
    }


    function renderProdutos() {
      const container = document.getElementById('listaProdutos');
      if (produtos.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum produto adicionado. Clique em "Adicionar Produto".</p>';
        atualizarValorPlanoExclusivo();
        atualizarCamposParcelamento();
        atualizarResumoGeralProposta();
        return;
      }
      
      atualizarValorPlanoExclusivo();
      atualizarCamposParcelamento();
      atualizarResumoGeralProposta();

      container.innerHTML = produtos.map((p, index) => {
        const isExpanded = p.expanded === true;
        const desc = calcularDesconto(p);
        
        return `
        <div class="produto-item bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-md p-5 border-2 border-blue-200">
          <!-- Cabe√ßalho do Produto -->
          <div class="cursor-pointer" onclick="toggleProduto('${p.id}')">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${isExpanded ? 'üìÇ' : 'üìÅ'}</span>
              <div class="flex-1">
                <h4 class="font-bold text-gray-800">${p.produto_completo || `Produto #${index + 1}`}</h4>
                <p class="text-xs text-gray-500">${isExpanded ? 'Clique para recolher' : 'Clique para expandir'}</p>
              </div>
              <button onclick="event.stopPropagation(); removerProduto('${p.id}')" class="text-red-500 hover:text-red-700 text-2xl transition-colors" title="Remover produto">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- Campo de C√≥digo/Nome do Produto (vis√≠vel apenas quando expandido) -->
          <div class="mt-4 mb-4 ${isExpanded ? '' : 'hidden'}">
            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo / Nome do Produto</label>
            <div class="flex gap-2">
              <input id="inputCodigoNome-${p.id}" type="text" value="${p.produto_completo || ''}" onchange="updateProduto('${p.id}', 'produto_completo', this.value)" onclick="event.stopPropagation()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: COD123 - Nome do Produto">
              <button type="button" onclick="event.stopPropagation(); abrirZenirProduto('${p.id}')" class="px-3 py-2 rounded-lg border border-blue-500 text-blue-600 bg-white hover:bg-blue-50 flex items-center justify-center" title="Buscar no site da Zenir">
                üîç
              </button>
            </div>
          </div>

          <!-- Conte√∫do Expans√≠vel -->
          <div id="produto-content-${p.id}" class="${isExpanded ? '' : 'hidden'}">
<div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
  <input type="number"
         min="1"
         value="${p.quantidade || 1}"
         onchange="event.stopPropagation(); updateQuantidade('${p.id}', this.value)"
         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
         placeholder="1" />
</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Normal (R$)</label>
                <input type="text" value="${formatarMoeda(p.preco_normal)}" onfocus="limparMoeda(this)" onblur="aplicarMoeda(this, '${p.id}', 'preco_normal')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="R$ 0,00">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Promocional (R$)</label>
                <input type="text" id="input-preco-promo-${p.id}" value="${formatarMoeda(p.preco_promo)}" onfocus="limparMoeda(this)" onblur="aplicarMoeda(this, '${p.id}', 'preco_promo')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="R$ 0,00">
              </div>
            </div>

            <!-- Pergunta sobre Servi√ßos (s√≥ aparece em Carn√™ ou Cart√£o) -->
            <div id="pergunta-servicos-${p.id}" class="${(p.tem_servicos === null && (p.modalidade === 'carne' || p.modalidade === 'cartao')) ? '' : 'hidden'} mb-4 bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
              <p class="text-sm font-semibold text-gray-800 mb-3">üõ†Ô∏è Este or√ßamento tem servi√ßos (G.E${p.modalidade === 'carne' ? ' ou P.M' : ''})?</p>
              <div class="flex gap-3">
                <button onclick="event.stopPropagation(); responderServicos('${p.id}', true)" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold">
                  ‚úÖ Sim
                </button>
                <button onclick="event.stopPropagation(); responderServicos('${p.id}', false)" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold">
                  ‚ùå N√£o
                </button>
              </div>
            </div>

            <!-- √Årea de Servi√ßos (G.E e P.M) -->
            <div id="area-servicos-${p.id}" class="${p.tem_servicos === true ? '' : 'hidden'} mb-4 bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
              
              <!-- Valor G.E (Garantia Estendida) -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">üíé Benef√≠cios Zenir G.E +12</label>
                <input type="text" id="input-ge-${p.id}" value="${formatarMoeda(p.valor_ge || 0)}" onfocus="limparMoeda(this)" onblur="aplicarValorGE(this, '${p.id}')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="R$ 0,00">
              </div>

              <!-- Op√ß√£o P.M (Presta Mista) - Apenas para Carn√™ -->
              <div id="opcao-pm-${p.id}" class="${(p.modalidade === 'carne') ? '' : 'hidden'} mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="checkbox-pm-${p.id}" ${p.usa_pm ? 'checked' : ''} onchange="togglePM('${p.id}', this.checked)" class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                  <span class="text-sm font-medium text-gray-700">üìã P.M - Adiciona 6% na parcela</span>
                </label>
              </div>

              <!-- Resumo dos Valores com Servi√ßos -->
              <div class="bg-white p-3 rounded-lg border border-purple-300">
                <p class="text-sm font-semibold text-gray-700 mb-3">üíé Resumo de Valores:</p>
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm">Pre√ßo Promocional:</span>
                    <span class="font-bold text-green-600 text-lg">${formatarMoedaBR(p.preco_promo || 0)}</span>
                  </div>
                  <div class="flex justify-between text-purple-600 text-xs">
                    <span>+ G.E:</span>
                    <span class="font-semibold">${formatarMoedaBR(p.valor_ge || 0)}</span>
                  </div>
                  <div class="flex justify-between border-t pt-1 font-bold text-green-600 text-sm">
                    <span>Total com G.E:</span>
                    <span>${formatarMoedaBR(calcularPrecoComGE(p))}</span>
                  </div>
                  ${p.usa_pm && p.modalidade === 'carne' ? `
                    <div class="flex justify-between text-orange-600 mt-2 pt-2 border-t text-xs">
                      <span>+ P.M (6% na parcela):</span>
                      <span class="font-semibold">${formatarMoedaBR(calcularAdicionalPM(p))}</span>
                    </div>
                    <div class="flex justify-between font-bold text-blue-600 text-sm">
                      <span>Total com G.E + P.M:</span>
                      <span>${formatarMoedaBR(calcularPrecoComPM(p))}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Modalidade de Pagamento</label>
                <select onchange="updateModalidade('${p.id}', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="avista" ${(p.modalidade || 'avista') === 'avista' ? 'selected' : ''}>√Ä Vista</option>
                  <option value="carne" ${p.modalidade === 'carne' ? 'selected' : ''}>Carn√™</option>
                  <option value="cartao" ${p.modalidade === 'cartao' ? 'selected' : ''}>Cart√£o</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Parcelas</label>
                <select onchange="updateProduto('${p.id}', 'parcelas', parseInt(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" ${(p.modalidade || 'avista') === 'avista' ? 'disabled' : ''}>
                  <option value="1" ${p.parcelas === 1 ? 'selected' : ''}>1x</option>
                  <option value="2" ${p.parcelas === 2 ? 'selected' : ''}>2x</option>
                  <option value="3" ${p.parcelas === 3 ? 'selected' : ''}>3x</option>
                  <option value="4" ${p.parcelas === 4 ? 'selected' : ''}>4x</option>
                  <option value="5" ${p.parcelas === 5 ? 'selected' : ''}>5x</option>
                  <option value="6" ${p.parcelas === 6 ? 'selected' : ''}>6x</option>
                  <option value="7" ${p.parcelas === 7 ? 'selected' : ''}>7x</option>
                  <option value="8" ${p.parcelas === 8 ? 'selected' : ''}>8x</option>
                  <option value="9" ${p.parcelas === 9 ? 'selected' : ''}>9x</option>
                  <option value="10" ${p.parcelas === 10 ? 'selected' : ''}>10x</option>
                  <option value="11" ${p.parcelas === 11 ? 'selected' : ''}>11x</option>
                  <option value="12" ${p.parcelas === 12 ? 'selected' : ''}>12x</option>
                </select>
              </div>
            </div>

            <!-- Resumo Financeiro do Produto -->
            <div class="bg-white p-4 rounded-lg border border-blue-300">
              <h5 class="font-semibold text-gray-700 mb-3 text-center">üí∞ Resumo Financeiro</h5>
              ${(p.modalidade || 'avista') === 'avista' ? `
                <!-- Resumo √Ä Vista -->
                <div class="grid grid-cols-3 gap-4 text-center">
                  <div class="bg-blue-50 rounded-lg p-3">
                    <p class="text-xs text-gray-600 mb-1">üè∑Ô∏è Desconto</p>
                    <p class="font-bold text-blue-600 text-lg">${desc.percentual}%</p>
                  </div>
                  <div class="bg-green-50 rounded-lg p-3">
                    <p class="text-xs text-gray-600 mb-1">‚úÖ Economia</p>
                    <p class="font-bold text-green-600 text-lg">${formatarMoedaBR(desc.valor)}</p>
                  </div>
                  <div class="bg-purple-50 rounded-lg p-3">
                    <p class="text-xs text-gray-600 mb-1">üíµ Valor √Ä Vista</p>
                    <p class="font-bold text-purple-600 text-lg">${formatarMoedaBR(p.preco_promo)}</p>
                    <p class="text-xs text-gray-400 line-through mt-1">${formatarMoedaBR(p.preco_normal)}</p>
                  </div>
                </div>
              ` : `
                <!-- Resumo Parcelado (Carn√™ ou Cart√£o) -->
                <div class="space-y-3">
                  <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="bg-purple-50 rounded-lg p-3">
                      <p class="text-xs text-gray-600 mb-1">üí≥ Parcela no ${p.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o'}</p>
                      <p class="font-bold text-purple-600 text-lg">${formatarMoedaBR(calcularParcela(p))}</p>
                      <p class="text-xs text-gray-500 mt-1">${p.parcelas}x</p>
                    </div>
                    <div class="bg-indigo-50 rounded-lg p-3">
                      <p class="text-xs text-gray-600 mb-1">üíµ Valor Total</p>
                      <p class="font-bold text-indigo-600 text-lg">${formatarMoedaBR(calcularValorTotal(p))}</p>
                      <p class="text-xs text-gray-400 line-through mt-1">${formatarMoedaBR(calcularValorTotalNormal(p))}</p>
                    </div>
                  </div>
                  <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-300">
                    <p class="text-sm font-semibold text-gray-700 mb-2 text-center">üí∞ Economia Total no ${p.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o'}</p>
                    <div class="text-center">
                      <p class="text-2xl font-bold text-green-600">${formatarMoedaBR(calcularDescontoParcelado(p).valor)}</p>
                      <p class="text-xs text-gray-600 mt-1">(${calcularDescontoParcelado(p).percentual}% de desconto)</p>
                    </div>
                  </div>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
      }).join('');
    }


    function abrirZenirProduto(id) {
      try {
        const input = document.getElementById(`inputCodigoNome-${id}`);
        if (!input) return;
        
        const termo = (input.value || '').trim();
        
        // Se tiver c√≥digo/nome, j√° copia pro CTRL+C pra facilitar na busca
        if (termo) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(termo).catch(() => {});
          }
        }
        
        // Se o site aceitar busca por URL, j√° tentamos com o termo.
        // Se n√£o aceitar, pelo menos o site abre e o c√≥digo j√° est√° no CTRL+V.
        const baseUrl = 'https://www.zenirmoveis.com.br';
        const url = termo
          ? baseUrl + '/busca?ft=' + encodeURIComponent(termo)
          : baseUrl;
        
        window.open(url, '_blank');
      } catch (e) {
        console.error('Erro ao abrir site da Zenir:', e);
      }
    }

    function toggleProduto(id) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        const novoEstado = produto.expanded === false ? true : false;
        
        // Se est√° abrindo este produto, fecha todos os outros
        if (novoEstado === true) {
          produtos.forEach(p => {
            p.expanded = false;
          });
        }
        
        // Define o estado do produto clicado
        produto.expanded = novoEstado;
        renderProdutos();
      }
    }

    function updateProduto(id, campo, valor) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto[campo] = valor;
        renderProdutos();
      }
    }

function updateQuantidade(id, valor) {
  const produto = produtos.find(p => p.id === id);
  if (!produto) return;
  let qtd = parseInt(valor, 10);
  if (isNaN(qtd) || qtd < 1) {
    qtd = 1;
  }
  produto.quantidade = qtd;
  renderProdutos();
}

    function updateModalidade(id, valor) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.modalidade = valor;
        // Reseta o estado de servi√ßos para perguntar novamente
        produto.tem_servicos = null;
        // Se mudou para outra modalidade que n√£o carn√™, desativa P.M
        if (valor !== 'carne') {
          produto.usa_pm = false;
        }
        renderProdutos();
        atualizarCamposParcelamento();
      }
    }

    function responderServicos(id, temServicos) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.tem_servicos = temServicos;
        renderProdutos();
      }
    }


    function abrirServicosPlanoExclusivo() {
      if (!Array.isArray(produtos) || produtos.length === 0) {
        showToast('Adicione um produto antes de incluir servi√ßos.', 'warning');
        return;
      }

      // Prioriza produto em Carn√™ ou Cart√£o
      let alvo = produtos.find(p => p.modalidade === 'carne' || p.modalidade === 'cartao') || produtos[0];

      if (alvo.tem_servicos === true) {
        showToast('J√° existem servi√ßos vinculados a esta proposta.', 'info');
      }

      const blocoPergunta = document.getElementById(`pergunta-servicos-${alvo.id}`);
      if (blocoPergunta) {
        blocoPergunta.classList.remove('hidden');
        blocoPergunta.scrollIntoView({ behavior: 'smooth', block: 'center' });

        blocoPergunta.classList.add('ring-2', 'ring-yellow-400');
        setTimeout(() => {
          blocoPergunta.classList.remove('ring-2', 'ring-yellow-400');
        }, 1500);
      } else {
        showToast('Localize a pergunta de servi√ßos no bloco do produto.', 'info');
      }
    }

    function aplicarValorGE(input, id) {
      const valor = parseFloat(input.value.replace(',', '.')) || 0;
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.valor_ge = valor;
        produto.preco_com_ge = (parseFloat(produto.preco_promo) || 0) + valor;
        renderProdutos();
      }
      input.value = formatarMoeda(valor);
    }

    function togglePM(id, usaPM) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.usa_pm = usaPM;
        renderProdutos();
      }
    }

    function calcularPrecoComGE(produto) {
      return (parseFloat(produto.preco_promo) || 0) + (parseFloat(produto.valor_ge) || 0);
    }

    function calcularAdicionalPM(produto) {
      // P.M adiciona 6% no valor da parcela
      const precoBase = calcularPrecoComGE(produto);
      const parcelas = parseInt(produto.parcelas) || 1;
      const modalidade = produto.modalidade || 'avista';
      
      if (modalidade !== 'carne' || parcelas === 0) {
        return 0;
      }
      
      // Calcula a parcela base (sem P.M)
      let coeficiente = 0;
      if (parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARNE[parcelas - 1];
      }
      
      const parcelaBase = precoBase * coeficiente;
      
      // Adiciona 6% na parcela
      const parcelaComPM = parcelaBase * 1.06;
      
      // Retorna o adicional total (diferen√ßa entre total com PM e total sem PM)
      return (parcelaComPM * parcelas) - (parcelaBase * parcelas);
    }

    function calcularPrecoComPM(produto) {
      return calcularPrecoComGE(produto) + calcularAdicionalPM(produto);
    }

    function formatarMoeda(valor) {
      const numero = parseFloat(valor) || 0;
      return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function formatarMoedaBR(valor) {
      const numero = parseFloat(valor) || 0;
      return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function limparMoeda(input) {
      // Remove a formata√ß√£o e deixa apenas n√∫meros
      const valorAtual = input.value.replace(/[^\d,]/g, '').replace(',', '.');
      const numero = parseFloat(valorAtual) || 0;
      // Mostra apenas o n√∫mero sem formata√ß√£o para facilitar a digita√ß√£o
      input.value = numero > 0 ? numero.toString() : '';
      input.select(); // Seleciona todo o texto para facilitar a substitui√ß√£o
    }

    function aplicarMoeda(input, id, campo) {
      const valor = parseFloat(input.value.replace(',', '.')) || 0;
      updateProduto(id, campo, valor);
      input.value = formatarMoeda(valor);
    }

    // Fun√ß√µes para Plano Exclusivo
    let valorPlanoExclusivo = 0;

    function limparMoedaPlanoExclusivo(input) {
      const valorAtual = input.value.replace(/[^\d,]/g, '').replace(',', '.');
      const numero = parseFloat(valorAtual) || 0;
      input.value = numero > 0 ? numero.toString() : '';
      input.select();
    }

    function aplicarMoedaPlanoExclusivo(input) {
      const valor = parseFloat(input.value.replace(',', '.')) || 0;
      valorPlanoExclusivo = valor;
      input.value = formatarMoeda(valor);
      calcularParcelaPlanoExclusivo();
    }

    
    function calcularParcelaPlanoExclusivo(mostrarAlertas = true) {
      const selectParcelas = document.getElementById('inputParcelasPlanoExclusivo');
      const parcelas = parseInt(selectParcelas && selectParcelas.value, 10) || 1;
      
      // Verifica se tem produtos no carn√™ ou cart√£o
      const temCarne = produtos.some(p => p.modalidade === 'carne');
      const temCartao = produtos.some(p => p.modalidade === 'cartao');
      const temServicos = produtos.some(p => p.tem_servicos === true);
      
      let valorParcela = 0;
      let temJuros = false;
      let modalidadeTexto = '';
      
      if (temCarne) {
        modalidadeTexto = 'Carn√™';
        
        // Regra adicional: at√© 5x s√≥ √© permitido com G.E / P.M
        if (parcelas <= 5 && !temServicos && mostrarAlertas) {
          alert('Para usar o Plano Exclusivo at√© 5x √© necess√°rio incluir Garantia Estendida ou Prestamista em pelo menos um produto.');
          // Volta automaticamente para 6x (primeira op√ß√£o com juros)
          if (selectParcelas) {
            selectParcelas.value = '6';
          }
          return;
        }
        
        // CARN√ä: At√© 5x sem juros financeiros (j√° com 6% de P.M embutido no valor)
        if (parcelas <= 5) {
          valorParcela = (valorPlanoExclusivo || 0) / parcelas;
          temJuros = false;
        } else {
          // A partir da 6¬™ parcela aplica fator do carn√™
          const coeficiente = TAXAS_CARNE[parcelas - 1] || 0;
          valorParcela = (valorPlanoExclusivo || 0) * coeficiente;
          temJuros = true;
        }
      } else if (temCartao) {
        modalidadeTexto = 'Cart√£o';
        // CART√ÉO: At√© 6x sem juros, a partir da 7¬™ com juros
        if (parcelas <= 6) {
          valorParcela = (valorPlanoExclusivo || 0) / parcelas;
          temJuros = false;
        } else {
          const coeficiente = TAXAS_CARTAO[parcelas - 1] || 0;
          valorParcela = (valorPlanoExclusivo || 0) * coeficiente;
          temJuros = true;
        }
      } else {
        modalidadeTexto = '√Ä Vista';
        valorParcela = (valorPlanoExclusivo || 0) / parcelas;
        temJuros = false;
      }
      
      const displayParcela = document.getElementById('displayParcelaPlanoExclusivo');
      if (displayParcela) {
        displayParcela.value = formatarMoedaBR(valorParcela);
      }
      
      // Atualiza a mensagem de modalidade no topo
      const infoModalidadeDiv = document.getElementById('infoModalidadePlanoExclusivo');
      if (infoModalidadeDiv) {
        infoModalidadeDiv.innerHTML = `üìã Modalidade: <strong>${modalidadeTexto}</strong>`;
      }
      
      // Atualiza a mensagem informativa
      const infoDiv = document.getElementById('infoParcelamentoExclusivo');
      if (infoDiv) {
        if (temJuros) {
          const valorTotal = valorParcela * parcelas;
          infoDiv.innerHTML = `<p class="font-semibold">${modalidadeTexto}: ${parcelas}x COM JUROS = ${formatarMoedaBR(valorTotal)} (Total com juros)</p>`;
          infoDiv.className = 'mt-3 p-3 bg-orange-100 rounded text-sm text-orange-800';
        } else {
          if (modalidadeTexto === 'Carn√™' && parcelas <= 5) {
            // Texto ajustado: remove "SEM JUROS" e os asteriscos/emoji
            infoDiv.innerHTML = `<p class="font-semibold">Carn√™: At√© 5x - Condi√ß√£o especial!</p>`;
          } else if (modalidadeTexto === 'Cart√£o' && parcelas <= 6) {
            infoDiv.innerHTML = `<p class="font-semibold">Cart√£o: At√© 6x SEM JUROS - Condi√ß√£o especial!</p>`;
          } else {
            infoDiv.innerHTML = `<p class="font-semibold">Condi√ß√£o calculada automaticamente com base nos produtos e servi√ßos.</p>`;
          }
          infoDiv.className = 'mt-3 p-3 bg-purple-100 rounded text-sm text-purple-800';
        }
      }
    }

    function atualizarCamposParcelamento() {
      // Verifica quais modalidades existem nos produtos
      const temCarne = produtos.some(p => p.modalidade === 'carne');
      const temCartao = produtos.some(p => p.modalidade === 'cartao');
      
      const campoCarne = document.getElementById('campoParcelamentoCarne');
      const campoCartao = document.getElementById('campoParcelamentoCartao');
      
      // Mostra/oculta campos conforme modalidades presentes
      if (campoCarne) {
        if (temCarne) {
          campoCarne.classList.remove('hidden');
        } else {
          campoCarne.classList.add('hidden');
        }
      }
      
      if (campoCartao) {
        if (temCartao) {
          campoCartao.classList.remove('hidden');
        } else {
          campoCartao.classList.add('hidden');
        }
      }
    }

    
    function atualizarValorPlanoExclusivo() {
      // Verifica se tem produtos com carn√™ ou cart√£o
      const temCarneOuCartao = produtos.some(p => p.modalidade === 'carne' || p.modalidade === 'cartao');
      
      const containerBotao = document.getElementById('containerBotaoPlanoExclusivo');
      const containerBotaoObservacoes = document.getElementById('containerBotaoObservacoesInternas');
      
      // S√≥ mostra o BOT√ÉO se tiver carn√™ ou cart√£o
      if (!temCarneOuCartao) {
        if (containerBotao) {
          containerBotao.classList.add('hidden');
        }
        if (containerBotaoObservacoes) {
          containerBotaoObservacoes.classList.add('hidden');
        }
        return;
      } else {
        if (containerBotao) {
          containerBotao.classList.remove('hidden');
        }
        if (containerBotaoObservacoes) {
          containerBotaoObservacoes.classList.remove('hidden');
        }
      }
      
      // Calcula o valor total do plano exclusivo
      // Regra: sempre usa PRE√áO NORMAL + servi√ßos (G.E / P.M)
      let valorTotal = 0;
      
      produtos.forEach(p => {
        const modalidade = p.modalidade || 'avista';
        const precoNormal = parseFloat(p.preco_normal) || 0;
        const quantidade = parseInt(p.quantidade, 10) || 1;
        const valorGE = parseFloat(p.valor_ge) || 0;
        const temServicos = p.tem_servicos === true;
        const usaPM = p.usa_pm === true;
        
        // Considera apenas produtos que entram na negocia√ß√£o
        if (modalidade === 'avista' || modalidade === 'carne' || modalidade === 'cartao') {
          // Base: pre√ßo de tabela (normal) vezes quantidade
          let baseProduto = precoNormal * quantidade;
          
          // Soma garantia / servi√ßos quando marcado
          if (temServicos && valorGE > 0) {
            baseProduto += valorGE;
          }
          
          // P.M adiciona 6% sobre (produto + servi√ßos)
          if (temServicos && usaPM) {
            baseProduto *= 1.06;
          }
          
          valorTotal += baseProduto;
        }
      });
      
      valorPlanoExclusivo = valorTotal;
      
      const inputValor = document.getElementById('inputValorPlanoExclusivo');
      if (inputValor) {
        inputValor.value = formatarMoeda(valorPlanoExclusivo);
      }
      
      // Recalcula a parcela sempre que atualizar o valor
      calcularParcelaPlanoExclusivo(false);
    }

    function calcularDesconto(produto) {
      const normal = parseFloat(produto.preco_normal) || 0;
      const promo = parseFloat(produto.preco_promo) || 0;
      
      if (normal === 0 || promo === 0) {
        return { valor: 0, percentual: '0.0' };
      }
      
      const valor = normal - promo;
      
      // Se o valor for negativo ou zero, retorna zero
      if (valor <= 0) {
        return { valor: 0, percentual: '0.0' };
      }
      
      const percentual = ((valor / normal) * 100).toFixed(1);
      return { valor, percentual };
    }

    function calcularDescontoParcelado(produto) {
      const totalNormal = calcularValorTotalNormal(produto);
      const totalPromo = calcularValorTotal(produto);
      
      if (totalNormal === 0 || totalPromo === 0) {
        return { valor: 0, percentual: '0.0' };
      }
      
      const valor = totalNormal - totalPromo;
      
      // Se o valor for negativo ou zero, retorna zero
      if (valor <= 0) {
        return { valor: 0, percentual: '0.0' };
      }
      
      const percentual = ((valor / totalNormal) * 100).toFixed(1);
      return { valor, percentual };
    }

    function calcularParcela(produto) {
      // Usa o pre√ßo base correto dependendo se tem servi√ßos
      let precoBase = parseFloat(produto.preco_promo) || 0;
      const quantidade = parseInt(produto.quantidade) || 1;
      
      // Se tem servi√ßos, usa o pre√ßo com G.E ou com G.E + P.M
      if (produto.tem_servicos === true) {
        if (produto.usa_pm && produto.modalidade === 'carne') {
          // Calcula com G.E + P.M
          precoBase = calcularPrecoComGE(produto);
          const parcelas = parseInt(produto.parcelas) || 1;
          
          if (parcelas === 0) return 0;
          
          let coeficiente = 0;
          if (parcelas >= 1 && parcelas <= 12) {
            coeficiente = TAXAS_CARNE[parcelas - 1];
          }
          
          const parcelaBase = precoBase * coeficiente;
          // Adiciona 6% na parcela
          return parcelaBase * 1.06 * quantidade;
        } else {
          // Usa apenas com G.E
          precoBase = calcularPrecoComGE(produto);
        }
      }
      
      const parcelas = parseInt(produto.parcelas) || 1;
      const modalidade = produto.modalidade || 'avista';
      
      if (precoBase === 0 || parcelas === 0) {
        return 0;
      }
      
      // √Ä vista n√£o tem juros
      if (modalidade === 'avista') {
        return precoBase * quantidade;
      }
      
      // Aplica coeficiente conforme modalidade
      let coeficiente = 0;
      if (modalidade === 'carne' && parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARNE[parcelas - 1];
      } else if (modalidade === 'cartao' && parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARTAO[parcelas - 1];
      }
      
      // O coeficiente j√° representa o valor da parcela quando multiplicado pelo valor total
      return precoBase * coeficiente * quantidade;
    }
    
    function calcularValorTotal(produto) {
      const quantidade = parseInt(produto.quantidade) || 1;
      const promo = (parseFloat(produto.preco_promo) || 0) * quantidade;
      const parcelas = parseInt(produto.parcelas) || 1;
      const modalidade = produto.modalidade || 'avista';
      
      if (promo === 0) {
        return 0;
      }
      
      // √Ä vista nÔøΩÔøΩo tem juros
      if (modalidade === 'avista') {
        return promo;
      }
      
      // Valor total = valor da parcela * n√∫mero de parcelas
      const valorParcela = calcularParcela(produto);
      return valorParcela * parcelas;
    }

    function calcularValorTotalNormal(produto) {
      const quantidade = parseInt(produto.quantidade) || 1;
      const normal = (parseFloat(produto.preco_normal) || 0) * quantidade;
      const parcelas = parseInt(produto.parcelas) || 1;
      const modalidade = produto.modalidade || 'avista';
      
      if (normal === 0) {
        return 0;
      }
      
      // √Ä vista n√£o tem juros
      if (modalidade === 'avista') {
        return normal;
      }
      
      // Aplica coeficiente conforme modalidade usando pre√ßo normal
      let coeficiente = 0;
      if (modalidade === 'carne' && parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARNE[parcelas - 1];
      } else if (modalidade === 'cartao' && parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARTAO[parcelas - 1];
      }
      
      const valorParcela = normal * coeficiente;
      return valorParcela * parcelas;
    }

    // ========== SALVAR PROPOSTA ==========
    async function salvarProposta() {
      const btn = document.getElementById('btnSalvarProposta');
      
      // Validar contato do cliente com DDD
      const clienteContato = document.getElementById('inputClienteContato').value;
      
      if (!validarContato(clienteContato)) {
        showToast('‚ö†Ô∏è Contato do cliente deve incluir DDD. Ex: (11) 91234-5678', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'üíæ Salvando...';


      // ==== RESUMO DA MODALIDADE PARA HIST√ìRICO ====
      let modalidade_tipo = '';
      let modalidade_parcelas = 0;
      let modalidade_resumo = '';
      let modalidade_valor_parcela = 0;
      let modalidade_total = 0;

      try {
        // Calcula o total promocional dos produtos
        let produtosArrayResumo = [];
        try {
          if (Array.isArray(produtos)) {
            produtosArrayResumo = produtos;
          } else if (typeof produtos === 'string') {
            produtosArrayResumo = JSON.parse(produtos || '[]');
          }
        } catch (e) {
          produtosArrayResumo = [];
        }

        modalidade_total = produtosArrayResumo.reduce(function(sum, prod) {
          const v = (parseFloat(prod && prod.preco_promo) || 0) * (prod && prod.quantidade ? prod.quantidade : 1);
          return sum + v;
        }, 0);

        const elModalidade = document.getElementById('calcModalidade');
        const elParcelas = document.getElementById('calcParcelas');
        const elValorParcela = document.getElementById('calcValorParcela');

        modalidade_tipo = elModalidade && elModalidade.value ? elModalidade.value : '';

        if (elParcelas) {
          const txt = (elParcelas.value || elParcelas.textContent || elParcelas.innerText || '').replace(/[^0-9]/g, '');
          modalidade_parcelas = parseInt(txt, 10) || 0;
        }

        if (elValorParcela && (elValorParcela.textContent || elValorParcela.innerText)) {
          const txtParcela = (elValorParcela.textContent || elValorParcela.innerText)
            .replace(/[^0-9,.-]/g, '')
            .replace('.', '')
            .replace(',', '.');
          modalidade_valor_parcela = parseFloat(txtParcela) || 0;
        } else if (modalidade_parcelas > 0) {
          modalidade_valor_parcela = modalidade_total / modalidade_parcelas;
        }

        if (modalidade_tipo === 'carne') {
          modalidade_resumo = 'Carn√™ ‚Äì ' + modalidade_parcelas + 'x de ' + formatarMoeda(modalidade_valor_parcela);
        } else if (modalidade_tipo === 'cartao') {
          modalidade_resumo = 'Cart√£o ‚Äì ' + modalidade_parcelas + 'x de ' + formatarMoeda(modalidade_valor_parcela);
        } else if (modalidade_tipo === 'avista') {
          modalidade_resumo = '√Ä Vista ‚Äì ' + formatarMoeda(modalidade_total);
        } else {
          modalidade_resumo = 'Total: ' + formatarMoeda(modalidade_total);
        }
      } catch (e) {
        console.warn('[FS] Erro ao montar resumo da modalidade:', e);
      }

      const agora = new Date().toISOString();
      const proposta = {
        loja_nome: 'Iguatu 3 - Ao lado do Bradesco',
        vendedor_nome: document.getElementById('inputVendedorNome').value,
        vendedor_contato: '',
        titulo_proposta: document.getElementById('inputTituloProposta').value,
        data_proposta: document.getElementById('inputDataProposta').value,
        validade_proposta: document.getElementById('inputValidadeProposta').value,
        cliente_nome: document.getElementById('inputClienteNome').value,
        codigo_proposta: '',
        cliente_contato: clienteContato,
        produtos: JSON.stringify(produtos),
        plano_exclusivo_valor: valorPlanoExclusivo,
        plano_exclusivo_parcelas: parseInt(document.getElementById('inputParcelasPlanoExclusivo').value) || 1,
        historico_negociacao: document.getElementById('inputHistorico').value,
        opcoes_parcelamento_carne: document.getElementById('inputOpcoesParcelamentoCarne').value,
        opcoes_parcelamento_cartao: document.getElementById('inputOpcoesParcelamentoCartao').value,
        simulacao_perdas_ganhos: document.getElementById('inputSimulacao').value,
        oportunidades_melhoria: document.getElementById('inputOportunidades').value,
        mostrar_parcelamento_sem_juros: (document.getElementById('chkMostrarParcelamentoSemJuros')?.checked === true),

        // Campos de resumo da modalidade
        modalidade_tipo: modalidade_tipo,
        modalidade_parcelas: modalidade_parcelas,
        modalidade_valor_parcela: modalidade_valor_parcela,
        modalidade_total: modalidade_total,
        modalidade_resumo: modalidade_resumo,

        status: 'Em an√°lise',
        created_at: currentProposalId ? (allProposals.find(p => p.__backendId === currentProposalId)?.created_at || agora) : agora,
        updated_at: agora
      };


      let resultado = { isOk: false };
      const STORAGE_KEY = 'fs_planos_cotacoes_propostas_offline_v1';

      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        let lista = [];
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) lista = parsed;
          } catch (e) {
            console.warn('Erro ao ler propostas salvas offline:', e);
          }
        }

        // Gera ou reaproveita c√≥digo da proposta
        if (currentProposalId) {
          const existente = lista.find(p => p.__offlineId === currentProposalId);
          if (existente && existente.codigo_proposta) {
            proposta.codigo_proposta = existente.codigo_proposta;
          }
        }
        if (!proposta.codigo_proposta) {
          proposta.codigo_proposta = gerarCodigoPropostaUnico(proposta.data_proposta, lista);
        }

        // Atualiza ou inclui
        if (currentProposalId) {
          const idx = lista.findIndex(p => p.__offlineId === currentProposalId);
          proposta.__offlineId = currentProposalId;
          if (idx >= 0) {
            lista[idx] = proposta;
          } else {
            lista.push(proposta);
          }
        } else {
          const offlineId = 'OFF-' + Date.now();
          proposta.__offlineId = offlineId;
          currentProposalId = offlineId;
          lista.push(proposta);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
        allProposals = lista;

        if (typeof atualizarBadgeCodigo === 'function') {
          atualizarBadgeCodigo(proposta.codigo_proposta);
        }
        if (typeof renderListaPropostas === 'function') {
          renderListaPropostas(allProposals);
        }
        if (typeof updateContador === 'function') {
          updateContador(allProposals.length);
        }

        resultado.isOk = true;
      } catch (erro) {
        console.error('Erro ao salvar proposta offline:', erro);
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Salvar Proposta';

      if (resultado.isOk) {
        showToast('‚úÖ Proposta salva neste dispositivo!', 'success');
        setTimeout(() => voltarParaLista(), 1500);
      } else {
        showToast('‚ùå Erro ao salvar proposta. Tente novamente.', 'error');
      }
    }

    
    // ========== ESTADO DO FORMUL√ÅRIO (PERSIST√äNCIA LOCAL) ==========
    const FORM_STATE_KEY = 'fs_planos_cotacoes_form_state_v1';

    function salvarEstadoFormularioLocal() {
      try {
        const getVal = (id) => {
          const el = document.getElementById(id);
          return el && typeof el.value === 'string' ? el.value : '';
        };

        const state = {
          vendedor_nome: getVal('inputVendedorNome'),
          titulo_proposta: getVal('inputTituloProposta'),
          data_proposta: getVal('inputDataProposta'),
          validade_proposta: getVal('inputValidadeProposta'),
          cliente_nome: getVal('inputClienteNome'),
          cliente_contato: getVal('inputClienteContato'),
          historico_negociacao: getVal('inputHistorico'),
          opcoes_parcelamento_carne: getVal('inputOpcoesParcelamentoCarne'),
          opcoes_parcelamento_cartao: getVal('inputOpcoesParcelamentoCartao'),
          simulacao_perdas_ganhos: getVal('inputSimulacao'),
          oportunidades_melhoria: getVal('inputOportunidades')
        };

        localStorage.setItem(FORM_STATE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Erro ao salvar estado local do formul√°rio', e);
      }
    }

    function carregarEstadoFormularioLocal() {
      try {
        const raw = localStorage.getItem(FORM_STATE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        if (!state || typeof state !== 'object') return;

        const setValue = (id, val) => {
          const el = document.getElementById(id);
          if (el && typeof val === 'string' && val !== '') {
            el.value = val;
          }
        };

        setValue('inputVendedorNome', state.vendedor_nome);
        setValue('inputTituloProposta', state.titulo_proposta);
        setValue('inputDataProposta', state.data_proposta);
        setValue('inputValidadeProposta', state.validade_proposta);
        setValue('inputClienteNome', state.cliente_nome);
        setValue('inputClienteContato', state.cliente_contato);
        setValue('inputHistorico', state.historico_negociacao);
        setValue('inputOpcoesParcelamentoCarne', state.opcoes_parcelamento_carne);
        setValue('inputOpcoesParcelamentoCartao', state.opcoes_parcelamento_cartao);
        setValue('inputSimulacao', state.simulacao_perdas_ganhos);
        setValue('inputOportunidades', state.oportunidades_melhoria);
      } catch (e) {
        console.warn('Erro ao carregar estado local do formul√°rio', e);
      }
    }

    function registrarPersistenciaFormularioLocal() {
      const camposIds = [
        'inputVendedorNome',
        'inputTituloProposta',
        'inputDataProposta',
        'inputValidadeProposta',
        'inputClienteNome',
        'inputClienteContato',
        'inputHistorico',
        'inputOpcoesParcelamentoCarne',
        'inputOpcoesParcelamentoCartao',
        'inputSimulacao',
        'inputOportunidades'
      ];
      const handler = () => salvarEstadoFormularioLocal();

      camposIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', handler);
          el.addEventListener('change', handler);
        }
      });

      window.addEventListener('beforeunload', salvarEstadoFormularioLocal);
    }

// ========== VISUALIZAR PROPOSTA ==========
    function visualizarProposta() {
      // Exige que a proposta tenha sido salva antes de visualizar
      if (!propostaFoiSalva) {
        showToast('üíæ Primeiro clique em "Salvar Proposta" para visualizar.', 'error');
        return;
      }

      // Valida√ß√£o b√°sica
      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione pelo menos um produto antes de visualizar', 'error');
        return;
      }

      currentProposalData = {
        loja_nome: 'Iguatu 3 - Ao lado do Bradesco',
        vendedor_nome: document.getElementById('inputVendedorNome').value,
        vendedor_contato: '',
        titulo_proposta: document.getElementById('inputTituloProposta').value,
        data_proposta: document.getElementById('inputDataProposta').value,
        validade_proposta: document.getElementById('inputValidadeProposta').value,
        cliente_nome: document.getElementById('inputClienteNome').value,
        cliente_contato: document.getElementById('inputClienteContato').value,
        produtos: produtos,
        plano_exclusivo_valor: valorPlanoExclusivo,
        plano_exclusivo_parcelas: parseInt(document.getElementById('inputParcelasPlanoExclusivo').value) || 1,
        historico_negociacao: document.getElementById('inputHistorico').value,
        opcoes_parcelamento_carne: document.getElementById('inputOpcoesParcelamentoCarne').value,
        opcoes_parcelamento_cartao: document.getElementById('inputOpcoesParcelamentoCartao').value,
        simulacao_perdas_ganhos: document.getElementById('inputSimulacao').value,
        oportunidades_melhoria: document.getElementById('inputOportunidades').value
      };

      renderVisaoCliente(currentProposalData);
      renderVisaoDiretoria(currentProposalData);
      propostaFoiSalva = true;
      imagemClienteBaixada = false;
      showView('visualizacao');
      switchTab('cliente');
    }

    // ========== TABS ==========
    function switchTab(tab) {
      document.getElementById('tabCliente').classList.remove('tab-active');
      document.getElementById('tabDiretoria').classList.remove('tab-active');
      document.getElementById('contentCliente').classList.add('hidden');
      document.getElementById('contentDiretoria').classList.add('hidden');

      if (tab === 'cliente') {
        document.getElementById('tabCliente').classList.add('tab-active');
        document.getElementById('contentCliente').classList.remove('hidden');
        document.getElementById('btnGerarImagemCliente').classList.remove('hidden');
        document.getElementById('btnGerarImagemDiretoria').classList.add('hidden');
      } else {
        document.getElementById('tabDiretoria').classList.add('tab-active');
        document.getElementById('contentDiretoria').classList.remove('hidden');
        document.getElementById('btnGerarImagemCliente').classList.add('hidden');
        document.getElementById('btnGerarImagemDiretoria').classList.remove('hidden');
      }
    }

    // ========== RENDER VIS√ÉO CLIENTE ==========
    function renderVisaoCliente(data) {
      const totalNormal = data.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_normal) || 0) * (p.quantidade || 1), 0);
      const totalPromo = data.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_promo) || 0) * (p.quantidade || 1), 0);
      const economiaTotal = totalNormal - totalPromo;
      const descontoPercentual = totalNormal > 0 ? ((economiaTotal / totalNormal) * 100).toFixed(1) : 0;

      const html = `
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-8 rounded-lg border-2 border-blue-200">
          <!-- Cabe√ßalho -->
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-6 pb-4 border-b-2 border-blue-300">
            <div>
              <p class="text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-1">
                <span>üìä</span><span>Simula√ß√µes</span>
              </p>
              <div class="text-base sm:text-lg font-bold text-gray-800">Zenir M√≥veis &amp; Eletros</div>
              <div class="text-xs sm:text-sm text-gray-600 mt-1">Iguatu 3 - Ao lado do Bradesco üìç</div>
              <div class="text-sm sm:text-base font-bold text-blue-600 mt-2">
                ${data.titulo_proposta || 'Proposta comercial'}
              </div>
            </div>
            <div class="text-[11px] sm:text-xs text-gray-700 sm:text-right leading-snug">
              <p>Vendedor(a): <strong>${data.vendedor_nome || 'Vendedor(a)'}</strong></p>
              <p>Proposta para: <strong>${data.cliente_nome || 'Cliente'}</strong></p>
              <p>C√≥digo da proposta: <strong>${data.codigo_proposta || '---'}</strong></p>
              <p>Data da simula√ß√£o: <strong>${formatarData(data.data_proposta)}</strong></p>
              ${data.validade_proposta ? `
              <p>Proposta v√°lida at√©:
                <strong class="text-red-600">${formatarData(data.validade_proposta)}</strong>
              </p>` : ''}
              ${data.cliente_contato ? `<p>Contato cliente: <strong>${data.cliente_contato}</strong></p>` : ''}
            </div>
          </div>

<!-- Produtos -->
          <div class="mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
              <span class="bg-blue-500 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2 text-sm">üõí</span>
              Produtos Inclusos
            </h3>
            <div class="space-y-4">
              ${data.produtos.map(p => {
                const desc = calcularDesconto(p);
                const modalidade = p.modalidade || 'avista';
                
                // Verifica se tem benef√≠cios (G.E ou P.M)
                const temBeneficios = p.tem_servicos === true && ((p.valor_ge && p.valor_ge > 0) || p.usa_pm);
                
                // Calcula valores considerando servi√ßos
                let precoFinalCliente = (parseFloat(p.preco_promo) || 0) * (p.quantidade || 1);
                let precoNormalCliente = (parseFloat(p.preco_normal) || 0) * (p.quantidade || 1);
                
                if (temBeneficios && modalidade === 'avista') {
                  // √Ä vista com G.E: soma o G.E ao pre√ßo
                  precoFinalCliente = calcularPrecoComGE(p) * (p.quantidade || 1);
                  precoNormalCliente = ((parseFloat(p.preco_normal) || 0) + (parseFloat(p.valor_ge) || 0)) * (p.quantidade || 1);
                }
                
                // Calcula economia espec√≠fica por modalidade (sempre comparando o que aparece para o cliente)
                let economiaModalidade = 0;
                let baseNormalParaDesconto = 0;

                if (modalidade === 'avista') {
                  // Compara o valor normal x valor final √† vista
                  economiaModalidade = precoNormalCliente - precoFinalCliente;
                  baseNormalParaDesconto = precoNormalCliente;
                } else {
                  // Para carn√™ / cart√£o, compara o total das parcelas normais x total das parcelas com benef√≠cios
                  const parcelas = p.parcelas || 1;
                  const valorParcelaNormal = calcularParcela({ ...p, preco_promo: p.preco_normal });
                  const valorParcelaFinal = calcularParcela(p);
                  const totalNormalProduto = valorParcelaNormal * parcelas;
                  const totalFinalProduto = valorParcelaFinal * parcelas;

                  economiaModalidade = totalNormalProduto - totalFinalProduto;
                  baseNormalParaDesconto = totalNormalProduto;
                }

                // Se a economia for negativa ou zero, zera
                if (economiaModalidade <= 0) {
                  economiaModalidade = 0;
                }

                // Calcula desconto percentual correto
                const descontoPercentualProduto = (baseNormalParaDesconto > 0 && economiaModalidade > 0)
                  ? ((economiaModalidade / baseNormalParaDesconto) * 100).toFixed(1)
                  : '0.0';
                
                // Calcula parcelamento sem juros baseado no pre√ßo √† vista promocional
                const precoAvistaPromo = (parseFloat(p.preco_promo) || 0) * (p.quantidade || 1);
                const parcelaCarne2x = precoAvistaPromo / 2;
                const parcelaCartao3x = precoAvistaPromo / 3;
                
                return `
                  <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex-1">
                        <h4 class="text-sm font-bold text-gray-800">${p.produto_completo || 'Produto'}</h4>
                        <p class="text-xs text-gray-600">${p.descricao || ""}</p>\
                        <p class="text-xs text-gray-500 mt-1">Qtd: ${p.quantidade || 1}</p>
                        ${temBeneficios ? `<p class="text-xs text-purple-600 font-semibold mt-1 bg-purple-50 px-2 py-1 rounded inline-block">‚ú® Com benef√≠cios Zenir</p>` : ''}
                      </div>
                    </div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t">
                      <div>
                        ${modalidade === 'avista' 
                          ? `<p class="text-xs text-gray-500 line-through">De ${formatarMoedaBR(precoNormalCliente)}</p>
                             <p class="text-lg font-bold text-green-600">${formatarMoedaBR(precoFinalCliente)}</p>
                             <p class="text-xs text-blue-600 font-semibold mt-1">√Ä Vista</p>
                             <p class="text-xs text-green-600 font-bold mt-1">üí∞ Economia: ${formatarMoedaBR(economiaModalidade)}</p>` 
                          : `<p class="text-xs text-gray-500 line-through">De ${p.parcelas}x ${formatarMoedaBR(calcularParcela({...p, preco_promo: p.preco_normal}))}</p>
                             <p class="text-base font-bold text-green-600">${p.parcelas}x de ${formatarMoedaBR(calcularParcela(p))}</p>
                             <p class="text-xs text-gray-600 mt-1">no ${modalidade === 'carne' ? 'Carn√™' : 'Cart√£o'}</p>`
                        }
                      </div>
                      <div class="text-right">
                        <div class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-semibold">
                          ${descontoPercentualProduto}% OFF
                        </div>
                        <p class="text-xs text-green-600 mt-1">Economize ${formatarMoedaBR(economiaModalidade)}</p>
                      </div>
                    </div>
                    

                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Resumo Financeiro -->
          ${(() => {
            // Calcula totais baseados na modalidade de cada produto
            let totalNormalGeral = 0;
            let totalPromoGeral = 0;
            let temAvista = false;
            let temParcelado = false;
            let parcelaNormalTotal = 0;
            let parcelaPromoTotal = 0;
            let numParcelas = 0;
            
            data.produtos.forEach(p => {
              const modalidade = p.modalidade || 'avista';
              const temBeneficios = p.tem_servicos === true && ((p.valor_ge && p.valor_ge > 0) || p.usa_pm);
              
              if (modalidade === 'avista') {
                temAvista = true;
                if (temBeneficios) {
                  // √Ä vista com G.E
                  totalNormalGeral += ((parseFloat(p.preco_normal) || 0) + (parseFloat(p.valor_ge) || 0)) * (p.quantidade || 1);
                  totalPromoGeral += calcularPrecoComGE(p);
                } else {
                  // ÔøΩÔøΩ vista sem servi√ßos
                  totalNormalGeral += (parseFloat(p.preco_normal) || 0) * (p.quantidade || 1);
                  totalPromoGeral += (parseFloat(p.preco_promo) || 0) * (p.quantidade || 1);
                }
              } else {
                temParcelado = true;
                totalNormalGeral += calcularValorTotalNormal(p);
                totalPromoGeral += calcularValorTotal(p);
                // Soma as parcelas
                parcelaNormalTotal += calcularParcela({...p, preco_promo: p.preco_normal});
                parcelaPromoTotal += calcularParcela(p);
                numParcelas = p.parcelas; // Assume que todos t√™m o mesmo n√∫mero de parcelas
              }
            });
            
            let economiaGeral = totalNormalGeral - totalPromoGeral;
            // Se a economia for negativa ou zero, zera
            if (economiaGeral <= 0) {
              economiaGeral = 0;
            }
            const descontoPercentualGeral = (totalNormalGeral > 0 && economiaGeral > 0) ? ((economiaGeral / totalNormalGeral) * 100).toFixed(1) : 0;
            
            let economiaParcela = parcelaNormalTotal - parcelaPromoTotal;
            // Se a economia for negativa ou zero, zera
            if (economiaParcela <= 0) {
              economiaParcela = 0;
            }
            const descontoPercentualParcela = (parcelaNormalTotal > 0 && economiaParcela > 0) ? ((economiaParcela / parcelaNormalTotal) * 100).toFixed(1) : 0;
            
            // Define o t√≠tulo baseado nas modalidades
            let tituloValorPromo = 'Valor Total';
            if (temAvista && !temParcelado) {
              tituloValorPromo = 'Valor √† Vista';
            } else if (temParcelado && !temAvista) {
              tituloValorPromo = 'Valor Total Parcelado';
            }
            
            return `
              <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border-2 border-green-300 mb-6">
                <h3 class="text-base font-bold text-gray-800 mb-3 text-center">üí∞ Resumo da Proposta</h3>
                
                ${temParcelado ? `
                  <!-- Destaque para Parcelas -->
                  <div class="bg-white p-4 rounded-lg shadow-lg mb-3 border-2 border-green-400">
                    <div class="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <p class="text-xs text-gray-600 mb-1">Parcela Normal</p>
                        <p class="text-base font-bold text-gray-500 line-through">${numParcelas}x ${formatarMoedaBR(parcelaNormalTotal)}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-600 mb-1">Sua Parcela</p>
                        <p class="text-2xl font-bold text-green-600">${numParcelas}x ${formatarMoedaBR(parcelaPromoTotal)}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-600 mb-1">Economia por Parcela</p>
                        <p class="text-xl font-bold text-red-600">${formatarMoedaBR(economiaParcela)}</p>
                        <p class="text-xs text-gray-600 font-semibold">(${descontoPercentualParcela}% de desconto)</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Valores Totais (menor) - Oculta se n√£o houver economia -->
                  ${economiaGeral > 0 ? `
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-500 text-center mb-2">Valores Totais</p>
                    <div class="grid grid-cols-3 gap-3 text-center">
                      <div>
                        <p class="text-xs text-gray-500">Total Normal</p>
                        <p class="text-sm font-semibold text-gray-400 line-through">${formatarMoedaBR(totalNormalGeral)}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">${tituloValorPromo}</p>
                        <p class="text-sm font-semibold text-green-600">${formatarMoedaBR(totalPromoGeral)}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Economia Total</p>
                        <p class="text-sm font-semibold text-red-600">${formatarMoedaBR(economiaGeral)} (${descontoPercentualGeral}%)</p>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                ` : `
                  <!-- Resumo √Ä Vista (mant√©m formato original) -->
                  <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                      <p class="text-sm text-gray-600">Valor Normal</p>
                      <p class="text-xl font-bold text-gray-500 line-through">${formatarMoedaBR(totalNormalGeral)}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600">${tituloValorPromo}</p>
                      <p class="text-2xl font-bold text-green-600">${formatarMoedaBR(totalPromoGeral)}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600">Voc√™ Economiza</p>
                      <p class="text-2xl font-bold text-red-600">${formatarMoedaBR(economiaGeral)}</p>
                      <p class="text-xs text-gray-600">(${descontoPercentualGeral}% de desconto)</p>
                    </div>
                  </div>
                `}
              </div>
            `;
          })()}




                    <!-- Plano Exclusivo -->
          ${(() => {
            // Verifica se tem produtos com carn√™ ou cart√£o E se tem parcelas selecionadas
            const temCarneOuCartao = data.produtos.some(p => p.modalidade === 'carne' || p.modalidade === 'cartao');
            const parcelas = data.plano_exclusivo_parcelas || 1;
            const valorBase = data.plano_exclusivo_valor || 0;

            if (!temCarneOuCartao || parcelas <= 1 || valorBase <= 0) {
              return '';
            };
            const temCarne = data.produtos.some(p => p.modalidade === 'carne');
            const temCartao = data.produtos.some(p => p.modalidade === 'cartao');
            
            let valorParcela = 0;
            let temJuros = false;
            let modalidade = '';
            
            if (temCarne) {
              modalidade = 'Carn√™';
              if (parcelas <= 5) {
                valorParcela = valorBase / parcelas;
                temJuros = false;
              } else {
                const coeficiente = TAXAS_CARNE[parcelas - 1] || 0;
                valorParcela = valorBase * coeficiente;
                temJuros = true;
              }
            } else if (temCartao) {
              modalidade = 'Cart√£o';
              if (parcelas <= 6) {
                valorParcela = valorBase / parcelas;
                temJuros = false;
              } else {
                const coeficiente = TAXAS_CARTAO[parcelas - 1] || 0;
                valorParcela = valorBase * coeficiente;
                temJuros = true;
              }
            } else {
              modalidade = '√Ä Vista';
              valorParcela = valorBase / parcelas;
              temJuros = false;
            }
            
            const valorTotal = temJuros ? (valorParcela * parcelas) : valorBase;
            
            return `
            <div class="mb-8 bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border-2 border-purple-300">
              <h3 class="text-xl font-bold text-purple-700 mb-4 flex items-center">
                <span class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">üéÅ</span>
                Plano Exclusivo para Voc√™ - Com Benef√≠cios Zenir
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                <!-- Parcelamentos em destaque -->
                <div class="bg-white p-4 rounded-lg shadow-sm md:col-span-2">
                  <p class="text-sm text-gray-600 mb-1">Parcelamentos</p>
                  <p class="text-2xl font-bold ${temJuros ? 'text-orange-500' : 'text-green-600'}">${parcelas}x de ${formatarMoedaBR(valorParcela)}</p>
                  ${temJuros ? `<p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(valorTotal)}</p>` : ''}
                </div>
                <!-- Pre√ßo de tabela mais discreto abaixo -->
                <div class="bg-white p-3 rounded-lg shadow-sm md:col-span-2">
                  <p class="text-xs text-gray-500 mb-1">Pre√ßo de Tabela com Benef√≠cios Zenir</p>
                  <p class="text-lg font-semibold text-purple-600">${formatarMoedaBR(valorBase)}</p>
                </div>
              </div>
              </div>
              <div class="mt-4 text-center">
                ${temJuros 
                  ? `<p class="text-sm text-orange-700 font-semibold">‚ö†Ô∏è ${modalidade}: A partir da ${temCarne ? '6¬™' : '7¬™'} parcela com juros</p>`
                  : `<p class="text-sm text-purple-700 font-semibold">‚ú® Planos Exclusivos Autoriza√ß√£o Gerente</p>`
                }
              </div>
            </div>
            `;
          })()}

          <!-- Op√ß√µes de Parcelamento Sem Juros (controladas pelo vendedor) -->
          ${(() => {
            const mostrarSemJuros = data.mostrar_parcelamento_sem_juros === true;

            if (!mostrarSemJuros) {
              return ''; // N√£o mostra a se√ß√£o se n√£o for selecionado na proposta
            }

            const totalAvistaPromo = data.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_promo) || 0) * (p.quantidade || 1), 0);
            const totalCarne2x = totalAvistaPromo / 2;
            const totalCartao3x = totalAvistaPromo / 3;

            return `
              <div class="mb-6 bg-gradient-to-r from-cyan-50 to-blue-50 p-3 rounded-lg border-2 border-cyan-300">
                <h3 class="text-xs font-bold text-cyan-700 mb-2 flex items-center justify-center">
                  <span class="bg-cyan-500 text-white rounded-full w-5 h-5 flex items-center justify-center mr-2 text-xs">üí≥</span>
                  Facilite seu Pagamento - Parcelamento Sem Juros
                </h3>
                <p class="text-center text-xs text-gray-600 mb-2">Baseado no pre√ßo √† vista promocional de cada produto</p>
                
                <!-- Resumo Total -->
                <div class="bg-gradient-to-br from-purple-100 to-pink-100 p-2 rounded-lg border-2 border-purple-400 mb-3 shadow-lg">
                  <h4 class="text-center font-bold text-purple-800 mb-2 text-xs">üìä Resumo Total - Parcelamento Sem Juros</h4>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div class="bg-white p-2 rounded-lg shadow-md text-center">
                      <p class="text-xs text-gray-600 mb-1">üí∞ Total √† Vista</p>
                      <p class="text-sm font-bold text-green-600">${formatarMoedaBR(totalAvistaPromo)}</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-2 rounded-lg shadow-md border-2 border-orange-300 text-center">
                      <div class="flex items-center justify-center gap-1 mb-1">
                        <span class="text-xs">üìù</span>
                        <p class="text-xs font-semibold text-orange-700">Carn√™</p>
                      </div>
                      <p class="text-sm font-bold text-orange-600">2x ${formatarMoedaBR(totalCarne2x)}</p>
                      <p class="text-xs text-gray-600 mt-1">Sem juros</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-2 rounded-lg shadow-md border-2 border-blue-300 text-center">
                      <div class="flex items-center justify-center gap-1 mb-1">
                        <span class="text-xs">üí≥</span>
                        <p class="text-xs font-semibold text-blue-700">Cart√£o</p>
                      </div>
                      <p class="text-sm font-bold text-blue-600">3x ${formatarMoedaBR(totalCartao3x)}</p>
                      <p class="text-xs text-gray-600 mt-1">Sem juros</p>
                    </div>
                  </div>
                </div>
                
                <!-- Tabela de Produtos -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                  <table class="w-full">
                    <thead>
                      <tr class="bg-gradient-to-r from-cyan-600 to-blue-600 text-white">
                        <th class="px-4 py-3 text-left font-bold">Produto</th>
                        <th class="px-4 py-3 text-center font-bold">üí∞ √Ä Vista</th>
                        <th class="px-4 py-3 text-center font-bold">üìù Carn√™ 2x</th>
                        <th class="px-4 py-3 text-center font-bold">üí≥ Cart√£o 3x</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.produtos.map((p, index) => {
                        const precoAvistaPromo = parseFloat(p.preco_promo) || 0;
                        const parcelaCarne2x = precoAvistaPromo / 2;
                        const parcelaCartao3x = precoAvistaPromo / 3;
                        const bgColor = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                        
                        return `
                          <tr class="${bgColor} border-b border-gray-200 hover:bg-cyan-50 transition-colors">
                            <td class="px-3 py-2">
                              <p class="text-xs font-bold text-gray-800">${p.produto_completo || 'Produto'}</p>
                            </td>
                            <td class="px-3 py-2 text-center">
                              <p class="text-sm font-bold text-green-600">${formatarMoedaBR(precoAvistaPromo)}</p>
                            </td>
                            <td class="px-3 py-2 text-center">
                              <p class="text-sm font-bold text-orange-600">2x ${formatarMoedaBR(parcelaCarne2x)}</p>
                              <p class="text-xs text-gray-500 mt-1">Sem juros</p>
                            </td>
                            <td class="px-3 py-2 text-center">
                              <p class="text-sm font-bold text-blue-600">3x ${formatarMoedaBR(parcelaCartao3x)}</p>
                              <p class="text-xs text-gray-500 mt-1">Sem juros</p>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
                
                <div class="mt-4 bg-cyan-100 p-3 rounded-lg text-center">
                  <p class="text-sm font-semibold text-cyan-800">‚ú® Condi√ß√µes especiais para facilitar sua compra!</p>
                </div>
              </div>
            `;
          })()}

          <!-- Rodap√© -->
          <div class="mt-6 pt-4 border-t border-blue-200 text-left text-[11px] sm:text-xs text-gray-700">
            <p class="font-semibold text-gray-800 mb-1">Condi√ß√µes especiais:</p>
            <p>üõÖ Estoque limitado</p>
            <p>üöö Entregas e üß∞ montagens (m√≥veis) gr√°tis</p>
            <p class="mt-2">
              Para n√£o perder esse valor üíô<br>
              √â s√≥ me sinalizar.
            </p>
            <p class="mt-2 text-[11px] font-semibold">
              Vendedor: ${data.vendedor_nome || 'Vendedor'}
            </p>
          </div>
        </div>
      `;

      document.getElementById('contentCliente').innerHTML = html;
    }

    // ========== RENDER VIS√ÉO DIRETORIA ==========
    function renderVisaoDiretoria(data) {
      // Calcula totais SEM considerar servi√ßos (G.E e P.M)
      const totalNormal = data.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_normal) || 0) * (p.quantidade || 1), 0);
      const totalPromo = data.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_promo) || 0) * (p.quantidade || 1), 0);
      const economiaTotal = totalNormal - totalPromo;

      // Verifica quais modalidades existem nos produtos
      const temCarne = data.produtos.some(p => p.modalidade === 'carne');
      const temCartao = data.produtos.some(p => p.modalidade === 'cartao');

      // Totais de parcelamento (considerando quantidade)
      let totalValorParcelado = 0;
      let totalValorParcela = 0;
      try {
        data.produtos.forEach(p => {
          const precoPromo = parseFloat(p.preco_promo) || 0;
          const qtd = p.quantidade || 1;
          const modalidade = p.modalidade || 'avista';
          const parcelas = parseInt(p.num_parcelas) || 0;
          let valorTotal = 0;
          let valorParcela = 0;

          if (modalidade === 'avista') {
            valorTotal = precoPromo * qtd;
            valorParcela = 0;
          } else {
            let coeficiente = 0;
            if (typeof TAXAS_CARNE !== 'undefined' && modalidade === 'carne' && parcelas >= 1 && parcelas <= 12) {
              coeficiente = TAXAS_CARNE[parcelas - 1];
            } else if (typeof TAXAS_CARTAO !== 'undefined' && modalidade === 'cartao' && parcelas >= 1 && parcelas <= 12) {
              coeficiente = TAXAS_CARTAO[parcelas - 1];
            }
            valorParcela = precoPromo * coeficiente;
            valorTotal = valorParcela * parcelas * qtd;
          }

          totalValorParcelado += valorTotal;
          totalValorParcela += valorParcela;
        });
      } catch (e) {
        console && console.warn && console.warn('Falha ao calcular totais de parcelamento (diretoria):', e);
      }

      const html = `
        <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
          <!-- Cabe√ßalho Interno -->
          <div class="mb-3 pb-2 border-b-2 border-yellow-400">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-base font-bold text-gray-800">üîí VISAO DIRETORIA</h2>
                <p class="text-xs text-gray-600 mt-1">Analise Completa da Proposta</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-600">Loja: <strong>${data.loja_nome || 'N/A'}</strong></p>
                <p class="text-xs text-gray-600">Vendedor: <strong>${data.vendedor_nome || 'N/A'}</strong></p>
                <p class="text-xs text-gray-600">Data: <strong>${formatarData(data.data_proposta)}</strong></p>
                ${data.validade_proposta ? `<p class="text-xs text-gray-600">Validade: <strong class="text-orange-600">‚è∞ ${formatarData(data.validade_proposta)}</strong></p>` : ''}
                ${data.cliente_nome ? `<p class="text-xs text-gray-600">Cliente: <strong>${data.cliente_nome}</strong></p>` : ''}
                ${data.cliente_contato ? `<p class="text-xs text-gray-600">Contato Cliente: <strong>${data.cliente_contato}</strong></p>` : ''}
              </div>
            </div>
          </div>

          <!-- Tabela Completa de Produtos (SEM SERVI√áOS) -->
          <div class="mb-4">
            <h3 class="text-sm font-bold text-gray-800 mb-2">üìä Tabela Completa de Produtos</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-xs border-collapse fs-tabela-diretoria">
                <thead>
                  <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-2 py-1 text-left">C√≥d / Produto</th>
                    <th class="border border-gray-300 px-2 py-1 text-center">Modalidade</th>
                    <th class="border border-gray-300 px-2 py-1 text-center">Qtd</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Pre√ßo Normal</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Pre√ßo Promo</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Desc R$</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Desc %</th>
                    <th class="border border-gray-300 px-2 py-1 text-center">Parcelas</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Valor Total</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Vlr Parcela</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.produtos.map(p => {
                    // Quantidade do item
                    const quantidade = parseInt(p.quantidade) || 1;

                    // Modalidade em texto
                    const modalidadeTexto = p.modalidade === 'carne'
                      ? 'Carn√™'
                      : (p.modalidade === 'cartao' ? 'Cart√£o' : '√Ä Vista');

                    // Valores TOTAIS (j√° considerando quantidade e juros)
                    const precoNormalTotal = calcularValorTotalNormal(p) || 0;
                    const precoPromoTotal  = calcularValorTotal(p) || 0;
                    const parcelas = parseInt(p.parcelas) || 1;
                    const modalidade = p.modalidade || 'avista';

                    // Desconto total em R$ e %
                    let descontoValor = precoNormalTotal - precoPromoTotal;
                    if (descontoValor < 0) descontoValor = 0;
                    const descontoPercentual = precoNormalTotal > 0
                      ? ((descontoValor / precoNormalTotal) * 100).toFixed(1)
                      : '0.0';

                    // Valor total e valor da parcela (total / parcelas)
                    let valorTotal = precoPromoTotal;
                    let valorParcela = 0;
                    if (modalidade !== 'avista' && parcelas > 0) {
                      valorParcela = valorTotal / parcelas;
                    }

                    return `
                      <tr class="bg-white">
                        <td class="border border-gray-300 px-2 py-1">${p.produto_completo || 'N/A'}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center font-semibold">${modalidadeTexto}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">${quantidade}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">${formatarMoedaBR(precoNormalTotal)}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right font-semibold text-green-600">${formatarMoedaBR(precoPromoTotal)}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right text-red-600">${formatarMoedaBR(descontoValor)}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right text-red-600">${descontoPercentual}%</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">${modalidade === 'avista' ? '-' : parcelas + 'x'}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right font-semibold text-purple-600">${formatarMoedaBR(valorTotal)}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">${modalidade === 'avista' ? '-' : formatarMoedaBR(valorParcela)}</td>
                      </tr>
                    `;
                  }).join('')}
                  <!-- Linha de espa√ßamento -->
                  <tr class="bg-white">
                    <td colspan="10" class="border-0 py-1"></td>
                  </tr>
                  <!-- Linha de TOTAL -->
                  <tr class="bg-gray-100 font-bold">
                    <td colspan="3" class="border border-gray-300 px-2 py-1">TOTAL</td>
                    <td class="border border-gray-300 px-2 py-1 text-right">${formatarMoedaBR(totalNormal)}</td>
                    <td class="border border-gray-300 px-2 py-1 text-right text-green-600">${formatarMoedaBR(totalPromo)}</td>
                    <td class="border border-gray-300 px-2 py-1 text-right text-red-600">${formatarMoedaBR(economiaTotal)}</td>
                    <td class="border border-gray-300 px-2 py-1 text-right text-red-600">${(() => {
                      // Calcula a m√©dia de desconto percentual
                      let somaDescontos = 0;
                      let countProdutos = 0;
                      data.produtos.forEach(p => {
                        const desc = calcularDesconto(p);
                        const percentual = parseFloat(desc.percentual) || 0;
                        if (percentual > 0) {
                          somaDescontos += percentual;
                          countProdutos++;
                        }
                      });
                      const mediaDesconto = countProdutos > 0 ? (somaDescontos / countProdutos).toFixed(1) : '0.0';
                      return mediaDesconto + '%';
                    })()}</td>
                    <td class="border border-gray-300 px-2 py-1 text-center">-</td>
                    <td class="border border-gray-300 px-2 py-1 text-right font-semibold text-purple-600">${formatarMoedaBR(totalValorParcelado)}</td>
                    <td class="border border-gray-300 px-2 py-1 text-right">${totalValorParcela > 0 ? formatarMoedaBR(totalValorParcela) : '-'}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- An√°lise Interna -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
            ${data.historico_negociacao ? `
              <div class="bg-gradient-to-br from-yellow-100 to-orange-100 p-3 rounded-lg border-2 border-orange-400 shadow-lg">
                <h4 class="text-xs font-semibold text-orange-800 mb-2 flex items-center">
                  <span class="text-base mr-1">üìã</span>
                  Solicitante / Informa√ß√µes
                </h4>
                <p class="text-xs text-gray-800 font-semibold whitespace-pre-line leading-relaxed">${data.historico_negociacao}</p>
              </div>
            ` : ''}
            ${temCarne && data.opcoes_parcelamento_carne ? `
              <div class="bg-white p-2 rounded-lg border border-gray-300">
                <h4 class="text-xs font-semibold text-gray-700 mb-1">üìù Carn√™ - Sem Juros</h4>
                <p class="text-lg text-gray-800 font-bold whitespace-pre-line">${data.opcoes_parcelamento_carne}</p>
              </div>
            ` : ''}
            ${temCartao && data.opcoes_parcelamento_cartao ? `
              <div class="bg-white p-2 rounded-lg border border-gray-300">
                <h4 class="text-xs font-semibold text-gray-700 mb-1">üí≥ Cart√£o - Sem Juros</h4>
                <p class="text-lg text-gray-800 font-bold whitespace-pre-line">${data.opcoes_parcelamento_cartao}</p>
              </div>
            ` : ''}
            ${data.simulacao_perdas_ganhos ? `
              <div class="bg-white p-2 rounded-lg border border-gray-300">
                <h4 class="text-xs font-semibold text-gray-700 mb-1">üíº Proposta da Ger√™ncia</h4>
                <p class="text-xs text-gray-800 font-semibold whitespace-pre-line">${data.simulacao_perdas_ganhos}</p>
              </div>
            ` : ''}
            ${data.oportunidades_melhoria ? `
              <div class="bg-white p-2 rounded-lg border border-gray-300">
                <h4 class="text-xs font-semibold text-gray-700 mb-1">üìù Observa√ß√µes importantes</h4>
                <p class="text-xs text-gray-600 whitespace-pre-line">${data.oportunidades_melhoria}</p>
              </div>
            ` : ''}
          </div>

          <!-- Rodap√© Interno -->
          <div class="mt-4 pt-2 border-t-2 border-yellow-400 text-center text-xs text-gray-600">
            <p>üéØ Demonstrativo das Solicita√ß√µes de Clientes</p>
          </div>
        </div>
      `;

      document.getElementById('contentDiretoria').innerHTML = html;
    }

    // ========== FILTROS DE DATA ==========
    function filtrarHoje() {
      // Obt√©m a data atual no fuso hor√°rio de Bras√≠lia
      const agora = new Date();
      const brasiliaOffset = -3 * 60;
      const localOffset = agora.getTimezoneOffset();
      const diffOffset = brasiliaOffset - localOffset;
      const horarioBrasilia = new Date(agora.getTime() + diffOffset * 60 * 1000);
      
      const ano = horarioBrasilia.getFullYear();
      const mes = String(horarioBrasilia.getMonth() + 1).padStart(2, '0');
      const dia = String(horarioBrasilia.getDate()).padStart(2, '0');
      const hoje = `${ano}-${mes}-${dia}`;
      
      document.getElementById('inputDataFiltro').value = hoje;
      filtroDataInicio = hoje;
      filtroDataFim = hoje;
      aplicarFiltros();
      mostrarInfoFiltro('üìÖ Mostrando propostas de Hoje');
    }

    function aplicarFiltroData() {
      const dataSelecionada = document.getElementById('inputDataFiltro').value;
      
      if (dataSelecionada) {
        filtroDataInicio = dataSelecionada;
        filtroDataFim = dataSelecionada;
        aplicarFiltros();
        
        // Obt√©m a data atual no fuso hor√°rio de BrasÔøΩÔøΩlia
        const agora = new Date();
        const brasiliaOffset = -3 * 60;
        const localOffset = agora.getTimezoneOffset();
        const diffOffset = brasiliaOffset - localOffset;
        const horarioBrasilia = new Date(agora.getTime() + diffOffset * 60 * 1000);
        
        const ano = horarioBrasilia.getFullYear();
        const mes = String(horarioBrasilia.getMonth() + 1).padStart(2, '0');
        const dia = String(horarioBrasilia.getDate()).padStart(2, '0');
        const hoje = `${ano}-${mes}-${dia}`;
        
        const textoData = dataSelecionada === hoje ? 'Hoje' : formatarData(dataSelecionada);
        
        mostrarInfoFiltro(`üìÖ Mostrando propostas de ${textoData}`);
      } else {
        limparFiltro();
      }
    }

    function limparFiltro() {
      filtroDataInicio = null;
      filtroDataFim = null;
      document.getElementById('inputDataFiltro').value = '';
      aplicarFiltros();
      esconderInfoFiltro();
    }

    function aplicarFiltros() {
      renderListaPropostas(allProposals);
    }

    function mostrarInfoFiltro(texto) {
      const infoDiv = document.getElementById('infoFiltro');
      infoDiv.textContent = texto;
      infoDiv.classList.remove('hidden');
    }

    function esconderInfoFiltro() {
      const infoDiv = document.getElementById('infoFiltro');
      infoDiv.classList.add('hidden');
    }

    function filtrarPropostasPorData(propostas) {
      if (!filtroDataInicio && !filtroDataFim) {
        return propostas;
      }

      return propostas.filter(p => {
        const dataProposta = p.data_proposta;
        
        if (!dataProposta) return false;

        if (filtroDataInicio && filtroDataFim) {
          return dataProposta >= filtroDataInicio && dataProposta <= filtroDataFim;
        } else if (filtroDataInicio) {
          return dataProposta >= filtroDataInicio;
        } else if (filtroDataFim) {
          return dataProposta <= filtroDataFim;
        }

        return true;
      });
    }

    // ========== LISTA DE PROPOSTAS ==========
    
    function renderListaPropostas(propostas) {
      const container = document.getElementById('listaPropostas');
      const emptyState = document.getElementById('emptyState');

      if (!Array.isArray(propostas)) propostas = [];

      const ehGerente = ehUsuarioGerente();
      const nomeLogado = (nomeVendedorLogado || '').toLowerCase().trim();

      // 1) Filtro por tipo de usu√°rio (vendedor x gerente)
      let listaBase = propostas.slice();

      if (!ehGerente && nomeLogado) {
        // Vendedor v√™ apenas as pr√≥prias propostas
        listaBase = listaBase.filter(p => (p.vendedor_nome || '').toLowerCase().trim() === nomeLogado);
      }

      if (ehGerente) {
        // Filtro de vendedor escolhido no painel do gerente
        if (filtroGerenteVendedor && filtroGerenteVendedor !== 'todos') {
          const alvo = filtroGerenteVendedor.toLowerCase().trim();
          listaBase = listaBase.filter(p => (p.vendedor_nome || '').toLowerCase().trim() === alvo);
        }

        // Filtro de status
        listaBase = listaBase.filter(p => {
          const st = (p.status || 'Em an√°lise').toLowerCase();
          if (filtroGerenteStatus === 'pendentes') {
            return st === 'em an√°lise' || st === 'em analise';
          }
          if (filtroGerenteStatus === 'autorizados') {
            return st === 'autorizado';
          }
          if (filtroGerenteStatus === 'negados') {
            return st === 'negado';
          }
          // 'todos'
          return true;
        });
      }

      // 2) Painel visual do gerente + combo (se existir)
      if (ehGerente) {
        try {
          // Monta resumo por vendedor
          const resumoPorVendedor = {};
          propostas.forEach(p => {
            const nomeVend = (p.vendedor_nome || '').trim();
            if (!nomeVend) return;
            if (!resumoPorVendedor[nomeVend]) {
              resumoPorVendedor[nomeVend] = { total: 0, pendentes: 0 };
            }
            resumoPorVendedor[nomeVend].total++;
            const st = (p.status || 'Em an√°lise').toLowerCase();
            if (st === 'em an√°lise' || st === 'em analise') {
              resumoPorVendedor[nomeVend].pendentes++;
            }
          });

          const painel = document.getElementById('painelGerenteVendedores');
          const grid = document.getElementById('gridCardsGerente');

          if (painel && grid) {
            if (typeof ehUsuarioGerente === 'function' && !ehUsuarioGerente()) {
              painel.classList.add('hidden');
              grid.innerHTML = '';
              return;
            }
            const nomes = Object.keys(resumoPorVendedor).sort((a, b) =>
              a.localeCompare(b, 'pt-BR', { sensitivity: 'base' })
            );

            if (nomes.length === 0) {
              painel.classList.add('hidden');
              grid.innerHTML = '';
            } else {
              painel.classList.remove('hidden');

              const totalPendentes = nomes.reduce(
                (acc, n) => acc + (resumoPorVendedor[n].pendentes || 0),
                0
              );
              const totalGeral = nomes.reduce(
                (acc, n) => acc + (resumoPorVendedor[n].total || 0),
                0
              );

              const cards = [];

              // Card geral "Todos"
              cards.push(`
                <button
                  class="group border rounded-xl p-4 text-left bg-white hover:bg-blue-50 hover:border-blue-400 transition-all flex items-start justify-between gap-3"
                  data-vendedor-card=""
                >
                  <div>
                    <div class="text-xs font-semibold text-gray-500 uppercase mb-1">Todos</div>
                    <div class="text-base font-bold text-gray-800">Todos os vendedores</div>
                    <div class="text-xs text-gray-500 mt-1">
                      ${totalGeral} propostas ¬∑ ${totalPendentes} em an√°lise
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-1">
                    ${
                      totalPendentes > 0
                        ? '<span class="inline-flex items-center gap-1 text-xs font-semibold text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full animate-pulse">üü° Pendentes</span>'
                        : '<span class="inline-flex items-center gap-1 text-xs font-semibold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full">‚úÖ Sem pend√™ncias</span>'
                    }
                  </div>
                </button>
              `);

              // Cards por vendedor
              nomes.forEach(nome => {
                const info = resumoPorVendedor[nome];
                const temPendentes = info.pendentes > 0;

                cards.push(`
                  <button
                    class="group border rounded-xl p-4 text-left ${temPendentes ? 'bg-yellow-50 border-yellow-400' : 'bg-white border-gray-200'} hover:bg-blue-50 hover:border-blue-400 transition-all flex items-start justify-between gap-3"
                    data-vendedor-card="${nome}"
                  >
                    <div>
                      <div class="text-xs font-semibold text-gray-500 uppercase mb-1">Vendedor</div>
                      <div class="text-base font-bold text-gray-800">${nome}</div>
                      <div class="text-xs text-gray-500 mt-1">
                        ${info.total} propostas ¬∑ ${info.pendentes} em an√°lise
                      </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                      ${
                        temPendentes
                          ? '<span class="inline-flex items-center gap-1 text-xs font-semibold text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full animate-pulse">üü° Em an√°lise</span>'
                          : '<span class="inline-flex items-center gap-1 text-xs font-semibold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full">‚úÖ Ok</span>'
                      }
                    </div>
                  </button>
                `);
              });

              grid.innerHTML = cards.join('');

              // Liga o clique nos cards
              Array.from(grid.querySelectorAll('[data-vendedor-card]')).forEach(card => {
                card.addEventListener('click', () => {
                  const nome = card.getAttribute('data-vendedor-card') || 'todos';
                  definirFiltroGerenteVendedor(nome);
                  definirFiltroGerenteStatus('pendentes');
                  const listaView = document.getElementById('listaView');
                  if (listaView) {
                    try {
                      listaView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } catch (e) {
                      listaView.scrollIntoView();
                    }
                  }
                });
              });
            }
          }

          // Mant√©m combo de vendedores se o select existir
          const selectVend = document.getElementById('selectFiltroVendedorGerente');
          if (selectVend) {
            const nomesCombo = Array.from(
              new Set(propostas.map(p => (p.vendedor_nome || '').trim()).filter(Boolean))
            ).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));

            selectVend.innerHTML = '<option value="todos">Todos os vendedores</option>' +
              nomesCombo.map(n => `<option value="${n}">${n}</option>`).join('');

            if (filtroGerenteVendedor && filtroGerenteVendedor !== 'todos') {
              const opt = Array.from(selectVend.options).find(o => o.value.toLowerCase() === filtroGerenteVendedor.toLowerCase());
              if (opt) selectVend.value = opt.value;
            } else {
              selectVend.value = 'todos';
            }
          }
        } catch (e) {
          console.warn('[FS] Erro ao atualizar painel/combos do gerente:', e);
        }
      }


// 3) Aplica filtro de data em cima da lista j√° filtrada
      const propostasFiltradas = filtrarPropostasPorData(listaBase);

      // Atualiza contador com propostas filtradas
      updateContador(propostasFiltradas.length);


      // Destaca bot√£o do Painel do Gerente quando houver propostas em an√°lise
      try {
        const btnPainel = document.getElementById('btnPainelGerente');
        if (btnPainel && ehGerente) {
          const temPendentes = listaBase.some(p => {
            const st = (p.status || 'Em an√°lise').toLowerCase();
            return st === 'em an√°lise' || st === 'em analise';
          });
          if (temPendentes) {
            btnPainel.classList.add('animate-pulse', 'ring-4', 'ring-yellow-300', 'ring-offset-2');
          } else {
            btnPainel.classList.remove('animate-pulse', 'ring-4', 'ring-yellow-300', 'ring-offset-2');
          }
        }
      } catch (e) {
        console.warn('[FS] Erro ao atualizar destaque do Painel do Gerente:', e);
      }

      if (propostasFiltradas.length === 0) {
        container.innerHTML = '';
        if (filtroDataInicio || filtroDataFim) {
          emptyState.innerHTML = `
            <div class="text-center py-12">
              <div class="text-6xl mb-4">üò¢</div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma Negocia√ß√£o Aqui</h3>
            </div>
          `;
        } else {
          emptyState.innerHTML = `
            <div class="text-center py-12">
              <div class="text-6xl mb-4">üìÑ</div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma proposta criada ainda</h3>
              <p class="text-gray-500 mb-6">Clique em "Nova Proposta" para come√ßar</p>
            </div>
          `;
        }
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.innerHTML = propostasFiltradas.map(p => {
        const produtosArray = JSON.parse(p.produtos || '[]');
        const totalPromo = produtosArray.reduce((sum, prod) => sum + (parseFloat(prod.preco_promo) || 0) * (prod.quantidade || 1), 0);
        
        return `
          <div class="bg-white p-5 rounded-lg shadow hover:shadow-lg transition-shadow border border-gray-200">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-800 mb-1">${p.codigo_proposta || p.titulo_proposta || 'Sem c√≥digo'}</h3>
                <div class="flex gap-4 text-xs text-gray-500 mb-3">
                  <span>üè™ ${p.loja_nome || 'N/A'}</span>
                  <span>üë§ ${p.vendedor_nome || 'N/A'}</span>
                  <span>üìÖ ${formatarData(p.data_proposta)}</span>
                  ${p.cliente_nome ? `<span>üéØ ${p.cliente_nome}</span>` : ''}
                </div>
                <div class="flex gap-2 flex-wrap">
                  <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">
                    ${produtosArray.length} produto(s)
                  </span>
                   <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-semibold cursor-pointer"
                    onclick="abrirAlterarStatusProposta('${p.__offlineId || p.__backendId}')">
                    ${
                      (function () {
                        let status = p.status || 'Em an√°lise';
                        if (status === 'Em anÔøΩÔøΩlise') status = 'Em an√°lise';
                        return status;
                      })()
                    }
                  </span>
                  ${p.data_envio_cliente ? `
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs" title="Enviado ao cliente em ${formatarDataHora(p.data_envio_cliente)}">
                      üì± Cliente: ${formatarDataHora(p.data_envio_cliente)}
                    </span>
                  ` : ''}
                  ${p.data_envio_diretoria ? `
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs" title="Enviado √† diretoria em ${formatarDataHora(p.data_envio_diretoria)}">
                      üè¢ Diretoria: ${formatarDataHora(p.data_envio_diretoria)}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="editarProposta('${p.__offlineId || p.__backendId}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm font-semibold">
                  ‚úèÔ∏è Editar
                </button>
                <button onclick="visualizarPropostaDaLista('${p.__offlineId || p.__backendId}')" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 text-sm font-semibold">
                  üëÅÔ∏è Visualizar
                </button>
                <button onclick="enviarPropostaParaGerente('${p.__offlineId || p.__backendId}')" class="bg-emerald-500 text-white px-4 py-2 rounded hover:bg-emerald-600 text-sm font-semibold">
                  üì§ Enviar p/ gerente
                </button>
                <button onclick="excluirProposta('${p.__offlineId || p.__backendId}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm font-semibold">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

function updateContador(count) {
      const contador = document.getElementById('contadorPropostas');
      contador.textContent = count === 1 ? '1 proposta' : `${count} propostas`;
    }

    async function editarProposta(id) {
      const proposta = allProposals.find(p => (p.__offlineId && p.__offlineId === id) || (p.__backendId && p.__backendId === id));

      if (!proposta) return;

      currentProposalId = id;
      produtos = JSON.parse(proposta.produtos || '[]');
      propostaFoiSalva = true;

      document.getElementById('inputVendedorNome').value = proposta.vendedor_nome || '';
      document.getElementById('inputTituloProposta').value = proposta.titulo_proposta || '';
      document.getElementById('inputDataProposta').value = proposta.data_proposta || '';
      document.getElementById('inputValidadeProposta').value = proposta.validade_proposta || '';
      document.getElementById('inputClienteNome').value = proposta.cliente_nome || '';
      document.getElementById('inputClienteContato').value = proposta.cliente_contato || '';
      valorPlanoExclusivo = parseFloat(proposta.plano_exclusivo_valor) || 0;
      document.getElementById('inputValorPlanoExclusivo').value = formatarMoeda(valorPlanoExclusivo);
      document.getElementById('inputParcelasPlanoExclusivo').value = proposta.plano_exclusivo_parcelas || 1;
      calcularParcelaPlanoExclusivo(false);
      document.getElementById('inputHistorico').value = proposta.historico_negociacao || '';
      document.getElementById('inputOpcoesParcelamentoCarne').value = proposta.opcoes_parcelamento_carne || '';
      document.getElementById('inputOpcoesParcelamentoCartao').value = proposta.opcoes_parcelamento_cartao || '';
      document.getElementById('inputSimulacao').value = proposta.simulacao_perdas_ganhos || '';
      document.getElementById('inputOportunidades').value = proposta.oportunidades_melhoria || '';
      const chkSemJuros = document.getElementById('chkMostrarParcelamentoSemJuros');
      if (chkSemJuros) {
        chkSemJuros.checked = proposta.mostrar_parcelamento_sem_juros === true;
      }

      renderProdutos();
      atualizarCamposParcelamento();
      if (typeof atualizarBadgeCodigo === 'function') {
        atualizarBadgeCodigo(proposta.codigo_proposta);
      }
      showView('editor');
    }

    async function visualizarPropostaDaLista(id) {
      await editarProposta(id);
      visualizarProposta();
    }


    async function excluirProposta(id) {
      const proposta = allProposals.find(p => (p.__offlineId && p.__offlineId === id) || (p.__backendId && p.__backendId === id));
      if (!proposta) return;

      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclus√£o</h3>
          <p class="text-gray-600 mb-6">Tem certeza que deseja excluir esta proposta? Esta a√ß√£o n√£o pode ser desfeita.</p>
          <div class="flex gap-3">
            <button id="btnCancelarExclusao" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 font-semibold">
              Cancelar
            </button>
            <button id="btnConfirmarExclusao" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 font-semibold">
              Excluir
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);

      document.getElementById('btnCancelarExclusao').addEventListener('click', () => {
        document.body.removeChild(confirmDiv);
      });

      document.getElementById('btnConfirmarExclusao').addEventListener('click', async () => {
        const btnConfirmar = document.getElementById('btnConfirmarExclusao');
        btnConfirmar.disabled = true;
        btnConfirmar.textContent = 'Excluindo...';

        let result = { isOk: false };

        try {
          if (window.dataSdk && typeof window.dataSdk.delete === 'function' && proposta.__backendId) {
            // Modo online (Canva / Data SDK)
            result = await window.dataSdk.delete(proposta);
          } else {
            // Modo offline (GitHub / navegador) - remove do localStorage
            const STORAGE_KEY = 'fs_planos_cotacoes_propostas_offline_v1';
            const raw = localStorage.getItem(STORAGE_KEY);
            let lista = [];
            if (raw) {
              try {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) lista = parsed;
              } catch (e) {
                console.warn('Erro ao ler propostas salvas offline para exclus√£o:', e);
              }
            }

            const idOffline = proposta.__offlineId || id;

            const novaLista = lista.filter(p => {
              if (p.__offlineId && p.__offlineId === idOffline) return false;
              if (p.__backendId && p.__backendId === proposta.__backendId) return false;
              return true;
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(novaLista));
            allProposals = novaLista;

            if (typeof renderListaPropostas === 'function') {
              renderListaPropostas(allProposals);
            }
            if (typeof updateContador === 'function') {
              updateContador(allProposals.length);
            }

            result.isOk = true;
          }
        } catch (erro) {
          console.error('Erro ao excluir proposta:', erro);
        }

        document.body.removeChild(confirmDiv);

        if (result.isOk) {
          showToast('‚úÖ Proposta exclu√≠da com sucesso!', 'success');
        } else {
          showToast('‚ùå Erro ao excluir proposta.', 'error');
        }
      });
    }


    // ========== STATUS DAS PROPOSTAS (DASHBOARD) ==========
    function atualizarStatusProposta(id, novoStatus) {
      try {
        const STORAGE_KEY = 'fs_planos_cotacoes_propostas_offline_v1';
        const raw = localStorage.getItem(STORAGE_KEY);
        let lista = [];
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) lista = parsed;
          } catch (e) {
            console.warn('Erro ao ler propostas salvas offline para atualizar status:', e);
          }
        }

        const idAlvo = id;
        let alterou = false;

        lista = lista.map(function (p) {
          const matchOffline = p.__offlineId && p.__offlineId === idAlvo;
          const matchBackend = p.__backendId && p.__backendId === idAlvo;
          if (matchOffline || matchBackend) {
            alterou = true;
            return Object.assign({}, p, { status: novoStatus });
          }
          return p;
        });

        if (!alterou) {
          console.warn('Nenhuma proposta encontrada para atualizar status (id =', idAlvo, ')');
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
        allProposals = lista;

        if (typeof renderListaPropostas === 'function') {
          renderListaPropostas(allProposals);
        }
        if (typeof updateContador === 'function') {
          updateContador(allProposals.length);
        }

        showToast('‚úÖ Status atualizado para "' + novoStatus + '"', 'success');
      } catch (erro) {
        console.error('Erro ao atualizar status da proposta:', erro);
        showToast('‚ùå Erro ao atualizar status da proposta.', 'error');
      }
  

    // Enviar proposta para o gerente (online)
    async function enviarPropostaParaGerente(id) {
      try {
        if (!FS_ONLINE_URL) {
          showToast('URL do painel gerencial n√£o configurada.', 'error');
          return;
        }

        const STORAGE_KEY = 'fs_planos_cotacoes_propostas_offline_v1';
        const raw = localStorage.getItem(STORAGE_KEY);
        let lista = [];
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) lista = parsed;
          } catch (e) {
            console.warn('Erro ao ler propostas salvas offline para envio ao gerente:', e);
          }
        }

        const proposta = lista.find(function (p) {
          return (p.__offlineId && p.__offlineId === id) || (p.__backendId && p.__backendId === id);
        });

        if (!proposta) {
          showToast('Proposta n√£o encontrada para envio.', 'error');
          return;
        }

        const agora = new Date().toISOString();
        proposta.data_envio_diretoria = agora;

        // Atualiza lista local com a data de envio
        lista = lista.map(function (p) {
          const matchOffline = p.__offlineId && p.__offlineId === id;
          const matchBackend = p.__backendId && p.__backendId === id;
          if (matchOffline || matchBackend) {
            return Object.assign({}, p, { data_envio_diretoria: agora });
          }
          return p;
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
        allProposals = lista;
        if (typeof renderListaPropostas === 'function') {
          renderListaPropostas(allProposals);
        }
        if (typeof updateContador === 'function') {
          updateContador(allProposals.length);
        }

        // Envia para o Apps Script
        const payload = {
          acao: 'enviar_para_gerente',
          proposta: proposta
        };

        const resp = await fetch(FS_ONLINE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          console.error('Erro HTTP ao enviar proposta ao gerente:', resp.status);
          showToast('‚ö†Ô∏è Erro ao enviar para o gerente. Verifique a internet.', 'error');
          return;
        }

        showToast('üì§ Proposta enviada para o gerente!', 'success');
      } catch (erro) {
        console.error('Falha ao enviar proposta para o gerente:', erro);
        showToast('‚ö†Ô∏è N√£o foi poss√≠vel enviar para o gerente.', 'error');
      }
    }

  }

    function abrirAlterarStatusProposta(id) {
      const proposta = allProposals.find(function (p) {
        return (p.__offlineId && p.__offlineId === id) || (p.__backendId && p.__backendId === id);
      });
      if (!proposta) return;

      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-5">
          <h3 class="text-lg font-bold text-gray-800 mb-1">Atualizar status</h3>
          <p class="text-xs text-gray-500 mb-4">
            Proposta: <span class="font-semibold">${proposta.titulo_proposta || 'Sem t√≠tulo'}</span><br/>
            Cliente: <span class="font-semibold">${proposta.cliente_nome || 'Sem cliente'}</span>
          </p>
          <div class="flex flex-col gap-2">
            <button data-status="Em an√°lise" class="w-full px-3 py-2 rounded-full bg-yellow-100 text-yellow-800 text-sm font-semibold flex items-center justify-center gap-2">
              <span>üü°</span> <span>Em an√°lise</span>
            </button>
            <button data-status="Autorizado" class="w-full px-3 py-2 rounded-full bg-green-100 text-green-800 text-sm font-semibold flex items-center justify-center gap-2">
              <span>üü¢</span> <span>Autorizado</span>
            </button>
            <button data-status="Negado" class="w-full px-3 py-2 rounded-full bg-red-100 text-red-800 text-sm font-semibold flex items-center justify-center gap-2">
              <span>üî¥</span> <span>Negado</span>
            </button>
          </div>
          <button id="btnFecharStatusModal" class="mt-4 w-full px-3 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-semibold hover:bg-gray-200">
            Fechar
          </button>
        </div>
      `;
      document.body.appendChild(overlay);

      const fechar = function () {
        if (overlay && overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      };

      overlay.querySelector('#btnFecharStatusModal').addEventListener('click', fechar);

      const botoes = overlay.querySelectorAll('button[data-status]');
      botoes.forEach(function (btn) {
        btn.addEventListener('click', function () {
          const novoStatus = btn.getAttribute('data-status');
          atualizarStatusProposta(id, novoStatus);
          fechar();
        });
      });
    }


    // ========== GERAR IMAGEM ==========
    function gerarImagem(tipo) {
      if (tipo === 'cliente') {
        imagemClienteBaixada = false;
      }
      const content = tipo === 'cliente' ? document.getElementById('contentCliente') : document.getElementById('contentDiretoria');
      const contentHTML = content.innerHTML;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl w-full h-full max-w-6xl max-h-[95%] flex flex-col">
          <!-- Cabe√ßalho do Modal -->
          <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 rounded-t-lg flex justify-between items-center flex-shrink-0">
            <div>
              <h3 class="text-xl font-bold">üìÑ Preview da Proposta - ${tipo === 'cliente' ? 'Vis√£o Cliente' : 'Vis√£o Diretoria'}</h3>
              <p class="text-sm text-blue-100 mt-1">Visualize antes de enviar via WhatsApp</p>
            </div>
            <button id="btnFecharModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <!-- √Årea de Preview (Formato A4) -->
          <div class="flex-1 overflow-auto bg-gray-100 p-6">
            <div id="previewContent" class="bg-white mx-auto shadow-2xl" style="width: 260mm; min-height: 297mm; padding: 20mm;">
              ${contentHTML}
            </div>
          </div>

          <!-- Rodap√© com A√ß√µes -->
          <div class="bg-gray-50 p-4 rounded-b-lg border-t flex-shrink-0">
            <div class="flex gap-3">
              <button id="btnEnviarWhatsApp" class="flex-1 ${tipo === 'cliente' ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-600 hover:bg-blue-700'} text-white px-6 py-4 rounded-lg font-bold text-lg transition-colors flex items-center justify-center gap-2">
                <span class="text-2xl">${tipo === 'cliente' ? 'üì±' : 'üì•'}</span>
                <span>${tipo === 'cliente' ? 'Enviar via WhatsApp' : 'Baixar como Imagem'}</span>
              </button>
              ${tipo === 'cliente' ? `
              <button id="btnBaixarPDF" class="flex-1 bg-blue-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                <span class="text-2xl">üì•</span>
                <span>Baixar como Imagem</span>
              </button>
              ` : ''}
              <button id="btnCancelarModal" class="bg-gray-300 text-gray-700 px-6 py-4 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                Cancelar
              </button>
            </div>
            <div class="mt-3 text-center">
              <p class="text-xs text-gray-500">üí° ${tipo === 'cliente' ? 'A proposta ser√° formatada em tamanho A4 para melhor visualiza√ß√£o' : 'Baixe a imagem e envie manualmente para a diretoria'}</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Utiliza querySelector dentro do pr√≥prio modal para evitar conflitos
      const btnFechar = modal.querySelector('#btnFecharModal');
      if (btnFechar) {
        btnFechar.addEventListener('click', () => {
          document.body.removeChild(modal);
        });
      }

      const btnCancelar = modal.querySelector('#btnCancelarModal');
      if (btnCancelar) {
        btnCancelar.addEventListener('click', () => {
          document.body.removeChild(modal);
        });
      }

      // Bot√£o principal (Enviar / Baixar)
      const btnAcaoPrincipal = modal.querySelector('#btnEnviarWhatsApp');
      if (btnAcaoPrincipal) {
        btnAcaoPrincipal.addEventListener('click', async () => {
          if (tipo === 'cliente') {
            await enviarWhatsApp(tipo);
          } else {
            await baixarComoImagem(tipo);
          }
        });
      }

      // Baixar como imagem (somente se existir o bot√£o - vis√£o cliente)
      const btnBaixar = modal.querySelector('#btnBaixarPDF');
      if (btnBaixar) {
        btnBaixar.addEventListener('click', async () => {
          await baixarComoImagem(tipo);
        });
      }

      // Fechar ao clicar fora (no fundo escuro)
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    async function enviarWhatsApp(tipo) {
      if (!currentProposalData) {
        showToast('‚ùå Dados da proposta n√£o encontrados', 'error');
        return;
      }

      if (tipo === 'cliente') {
        // Modo simplificado: n√£o bloqueia envio se a proposta n√£o estiver marcada como salva
        // ou se a imagem ainda n√£o tiver sido baixada manualmente.
        // A captura e o download da imagem ser√£o feitos automaticamente abaixo.
      }

      const clienteContato = currentProposalData.cliente_contato || '';
      const clienteNome = currentProposalData.cliente_nome || 'Cliente';
      const tituloProposta = currentProposalData.titulo_proposta || 'Proposta Comercial';
      const vendedorNome = currentProposalData.vendedor_nome || 'Vendedor';
      const lojaNome = currentProposalData.loja_nome || 'Loja';
      
      // Para diretoria, n√£o precisa de n√∫mero do cliente
      let numeroLimpo = '';
      if (tipo === 'cliente') {
        // Remove caracteres n√£o num√©ricos do contato
        numeroLimpo = clienteContato.replace(/\D/g, '');
        
        if (!numeroLimpo || numeroLimpo.length < 10) {
          showToast('ÔøΩÔøΩÔ∏è N√∫mero de WhatsApp do cliente inv√°lido ou n√£o informado', 'error');
          return;
        }
      }

      // Mostra mensagem de processamento
      showToast('üì∏ Gerando imagem da proposta...', 'success');

      // Captura a imagem
      const previewContent = document.getElementById('previewContent');
      
      try {
        const canvas = await html2canvas(previewContent, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: true,
          backgroundColor: '#ffffff',
          windowWidth: previewContent.scrollWidth,
          windowHeight: previewContent.scrollHeight,
          onclone: (clonedDoc) => {
            const clonedContent = clonedDoc.getElementById('previewContent');
            if (clonedContent) {
              clonedContent.style.display = 'block';
              clonedContent.style.width = '210mm';
            }
          }
        });

        // Converte para blob
        canvas.toBlob(async (blob) => {
          if (!blob) {
            showToast('‚ùå Erro ao criar arquivo de imagem', 'error');
            return;
          }

          // Cria um link tempor√°rio para download
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const timestamp = new Date().getTime();
          const nomeArquivo = tipo === 'cliente' 
            ? `proposta_cliente_${clienteNome.replace(/\s+/g, '_')}_${timestamp}.png`
            : `proposta_diretoria_${vendedorNome.replace(/\s+/g, '_')}_${timestamp}.png`;
          
          link.href = url;
          link.download = nomeArquivo;
          link.style.display = 'none';
          document.body.appendChild(link);
          
          // Aguarda um momento e for√ßa o download
          setTimeout(() => {
            try {
              link.click();
              showToast('‚úÖ Download iniciado! Verifique seus downloads', 'success');
            } catch (e) {
              showToast('‚ùå Erro ao iniciar download', 'error');
            }
            
            setTimeout(() => {
              try {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
              } catch (e) {
                // Ignora erros de limpeza
              }
            }, 1000);
          }, 100);

          // Calcula valores para a mensagem
          const totalNormal = currentProposalData.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_normal) || 0), 0);
          const totalPromo = currentProposalData.produtos.reduce((sum, p) => sum + (parseFloat(p.preco_promo) || 0), 0);
          const economia = totalNormal - totalPromo;
          
          // Verifica se tem produtos parcelados
          const temParcelado = currentProposalData.produtos.some(p => p.modalidade !== 'avista');
          
          let mensagem = '';
          
          if (tipo === 'cliente') {
            // Mensagem para CLIENTE (com nome do cliente)
            // Usa o nome do vendedor logado se n√£o tiver nome na proposta
            const nomeVendedorFinal = vendedorNome || nomeVendedorLogado || 'Vendedor';
            
            mensagem = `üëã Ol√°, *${clienteNome}*!\n\n`;
            mensagem += `Obrigado por escolher a *Zenir* üíô\n`;
            mensagem += `√â um prazer lhe atender!\n\n`;
            mensagem += `Preparei uma oferta especial e personalizada pra voc√™.\n`;
            mensagem += `üëá As informa√ß√µes detalhadas est√£o na imagem abaixo.\n\n`;
            mensagem += `Qualquer d√∫vida, estou √† disposi√ß√£o!\n\n`;
            mensagem += `*${nomeVendedorFinal}* ‚Äì Iguatu 3 - Ao lado do Bradesco üìç`;
          } else {
            // Mensagem para DIRETORIA (SEM nome do cliente, foco comercial)
            mensagem = `üè¢ *SOLICITA√á√ÉO DIRETORIA*\n\n`;
            mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            mensagem += `üë§ *Vendedor:* ${vendedorNome}\n`;
            mensagem += `üè™ *Loja:* ${lojaNome}\n`;
            mensagem += `üìÖ *Data:* ${formatarData(currentProposalData.data_proposta)}\n`;
            if (currentProposalData.validade_proposta) {
              mensagem += `‚è∞ *Validade:* ${formatarData(currentProposalData.validade_proposta)}\n`;
            }
            mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            mensagem += `üìã *${tituloProposta}*\n\n`;
            
            // Informa√ß√µes da negocia√ß√£o
            if (currentProposalData.historico_negociacao) {
              mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅÔøΩÔøΩÔøΩ‚îÅ‚îÅ\n`;
              mensagem += `üìù *SOLICITANTE/INFORMA√á√ïES*\n`;
              mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
              mensagem += `${currentProposalData.historico_negociacao}\n\n`;
            }
            
            // Proposta da ger√™ncia
            if (currentProposalData.simulacao_perdas_ganhos) {
              mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
              mensagem += `üíº *PROPOSTA DA GER√äNCIA*\n`;
              mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
              mensagem += `${currentProposalData.simulacao_perdas_ganhos}\n\n`;
            }
            
            // Parcelamentos sem juros
            const temCarne = currentProposalData.produtos.some(p => p.modalidade === 'carne');
            const temCartao = currentProposalData.produtos.some(p => p.modalidade === 'cartao');
            
            if (temCarne && currentProposalData.opcoes_parcelamento_carne) {
              mensagem += `üìù *Carn√™ - Sem Juros:*\n${currentProposalData.opcoes_parcelamento_carne}\n\n`;
            }
            
            if (temCartao && currentProposalData.opcoes_parcelamento_cartao) {
              mensagem += `üí≥ *Cart√£o - Sem Juros:*\n${currentProposalData.opcoes_parcelamento_cartao}\n\n`;
            }
            
            // Observa√ß√µes
            if (currentProposalData.oportunidades_melhoria) {
              mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
              mensagem += `üìå *OBSERVA√á√ïES*\n`;
              mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
              mensagem += `${currentProposalData.oportunidades_melhoria}\n\n`;
            }
            
            // Resumo comercial
            mensagem += `‚îÅÔøΩÔøΩ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅÔøΩÔøΩ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            mensagem += `üí∞ *RESUMO COMERCIAL*\n`;
            mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅÔøΩÔøΩ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            mensagem += `üì¶ *Produtos:* ${currentProposalData.produtos.length}\n`;
            mensagem += `üíµ *Valor Total:* ${formatarMoedaBR(totalPromo)}\n`;
            if (economia > 0) {
              const percentualDesconto = ((economia / totalNormal) * 100).toFixed(0);
              mensagem += `üìâ *Desconto:* ${formatarMoedaBR(economia)} (${percentualDesconto}%)\n`;
            }
            mensagem += `\nüì∏ *Detalhes completos na imagem anexa*\n\n`;
            mensagem += `_Aguardo an√°lise e aprova√ß√£o_`;
          }

          // Codifica a mensagem para URL
          const mensagemCodificada = encodeURIComponent(mensagem);
          
          // Registra o envio na proposta
          if (currentProposalId) {
            const proposta = allProposals.find(p => p.__backendId === currentProposalId);
            if (proposta) {
              const dataEnvio = new Date().toISOString();
              const campoEnvio = tipo === 'cliente' ? 'data_envio_cliente' : 'data_envio_diretoria';
              proposta[campoEnvio] = dataEnvio;
              proposta.updated_at = dataEnvio;
              await window.dataSdk.update(proposta);
            }
          }
          
          // Abre o WhatsApp Web
          let urlWhatsApp = '';
          if (tipo === 'cliente') {
            urlWhatsApp = `https://wa.me/55${numeroLimpo}?text=${mensagemCodificada}`;
          } else {
            // Para diretoria, abre WhatsApp sem n√∫mero espec√≠fico (usu√°rio escolhe o contato)
            urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
          }
          
          window.open(urlWhatsApp, '_blank', 'noopener,noreferrer');
          
          const dataHoraEnvio = formatarDataHora(new Date());
          showToast(`‚úÖ Imagem baixada! Agora anexe no WhatsApp. Registrado em ${dataHoraEnvio}`, 'success');
        }, 'image/png');

      } catch (error) {
        console.error('Erro ao gerar imagem:', error);
        showToast('‚ùå Erro ao gerar imagem. Tente novamente.', 'error');
      }
    }

    async function baixarComoImagem(tipo) {
      showToast('üì∏ Gerando imagem da proposta...', 'success');

      const previewContent = document.getElementById('previewContent');
      
      try {
        const canvas = await html2canvas(previewContent, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: true,
          backgroundColor: '#ffffff',
          // usa toda a largura real do conte√∫do
          windowWidth: previewContent.scrollWidth,
          windowHeight: previewContent.scrollHeight,
          onclone: (clonedDoc) => {
            const clonedContent = clonedDoc.getElementById('previewContent');
            if (clonedContent) {
              clonedContent.style.display = 'block';

              // Para a vis√£o da diretoria, diminu√≠mos um pouco a escala
              // para garantir que TODA a tabela caiba na imagem,
              // mesmo sendo mais larga que a tela do celular.
              if (tipo === 'diretoria') {
                clonedContent.style.transform = 'scale(0.7)';
                clonedContent.style.transformOrigin = 'top left';
              }
            }
          }
        });

        // Converte para blob e faz download
        canvas.toBlob((blob) => {
          if (!blob) {
            showToast('‚ùå Erro ao criar arquivo de imagem', 'error');
            return;
          }

          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const clienteNome = currentProposalData?.cliente_nome || 'Cliente';
          const vendedorNome = currentProposalData?.vendedor_nome || 'Vendedor';
          const timestamp = new Date().getTime();
          const nomeArquivo = tipo === 'cliente'
            ? `proposta_cliente_${clienteNome.replace(/\s+/g, '_')}_${timestamp}.png`
            : `proposta_diretoria_${vendedorNome.replace(/\s+/g, '_')}_${timestamp}.png`;
          
          link.href = url;
          link.download = nomeArquivo;
          link.style.display = 'none';
          document.body.appendChild(link);
          
          setTimeout(() => {
            try {
              link.click();
              if (tipo === 'cliente') {
                imagemClienteBaixada = true;
              }
              showToast('‚úÖ Download iniciado! Verifique seus downloads', 'success');
            } catch (e) {
              showToast('‚ùå Erro ao iniciar download', 'error');
            }
            
            setTimeout(() => {
              try {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
              } catch (e) {
                // Ignora erros de limpeza
              }
            }, 1000);
          }, 100);
        }, 'image/png');

      } catch (error) {
        console.error('Erro ao gerar imagem:', error);
        showToast('‚ùå Erro ao gerar imagem. Tente novamente.', 'error');
      }
    }

    // ========== UTILS ==========
    function validarContato(contato) {
      // Verifica se o contato tem DDD (formato com par√™nteses ou n√∫meros)
      // Aceita formatos: (11) 98765-4321, 11987654321, (11)987654321, etc.
      const regex = /\(?\d{2}\)?[\s-]?\d{4,5}[\s-]?\d{4}/;
      return regex.test(contato);
    }

    function limparFormulario() {
      document.getElementById('inputVendedorNome').value = '';
      document.getElementById('inputTituloProposta').value = '';
      document.getElementById('inputClienteNome').value = '';
      document.getElementById('inputClienteContato').value = '';
      document.getElementById('inputValidadeProposta').value = '';
      valorPlanoExclusivo = 0;
      document.getElementById('inputValorPlanoExclusivo').value = '';
      document.getElementById('inputParcelasPlanoExclusivo').value = '1';
      document.getElementById('displayParcelaPlanoExclusivo').value = 'R$ 0,00';
      document.getElementById('inputHistorico').value = '';
      document.getElementById('inputOpcoesParcelamentoCarne').value = '';
      document.getElementById('inputOpcoesParcelamentoCartao').value = '';
      document.getElementById('inputSimulacao').value = '';
      document.getElementById('inputOportunidades').value = '';
      renderProdutos();
      atualizarCamposParcelamento();
    }

    function formatarData(dataStr) {
      if (!dataStr) return 'N/A';
      const [ano, mes, dia] = dataStr.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    function formatarDataHora(data) {
      if (!data) return 'N/A';
      const d = typeof data === 'string' ? new Date(data) : data;
      const dia = String(d.getDate()).padStart(2, '0');
      const mes = String(d.getMonth() + 1).padStart(2, '0');
      const ano = d.getFullYear();
      const hora = String(d.getHours()).padStart(2, '0');
      const minuto = String(d.getMinutes()).padStart(2, '0');
      return `${dia}/${mes}/${ano} √†s ${hora}:${minuto}`;
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 3000);
    }

    // ========== FUN√á√ïES DO MENU ==========
    function abrirMenu() {
      document.getElementById('modalMenu').classList.remove('hidden');
    }

    function fecharMenu() {
      document.getElementById('modalMenu').classList.add('hidden');
    }

    function abrirTaxas() {
      fecharMenu();
      document.getElementById('modalTaxas').classList.remove('hidden');
    }

    function fecharTaxas() {
      document.getElementById('modalTaxas').classList.add('hidden');
    }

    function abrirCalculadora() {
      fecharMenu();
      document.getElementById('modalCalculadora').classList.remove('hidden');
      document.getElementById('calcResultado').classList.add('hidden');
    }

    function fecharCalculadora() {
      document.getElementById('modalCalculadora').classList.add('hidden');
    }

    function abrirRelatorios() {
      fecharMenu();
      gerarRelatorios();
      document.getElementById('modalRelatorios').classList.remove('hidden');
    }

    function fecharRelatorios() {
      document.getElementById('modalRelatorios').classList.add('hidden');
    }

    function baixarApp() {
      fecharMenu();
      
      // Cria modal de instru√ß√µes
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6">
          <div class="text-center mb-6">
            <div class="text-6xl mb-4">üì±</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Instalar Aplicativo</h2>
            <p class="text-gray-600">Adicione este app √† sua tela inicial para acesso r√°pido</p>
          </div>

          <div class="space-y-6">
            <!-- Android Chrome -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border-2 border-green-300">
              <h3 class="font-bold text-green-800 mb-3 flex items-center gap-2">
                <span class="text-2xl">ü§ñ</span>
                <span>Android (Chrome)</span>
              </h3>
              <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                <li>Toque no menu <strong>‚ãÆ</strong> (tr√™s pontos) no canto superior direito</li>
                <li>Selecione <strong>"Adicionar √† tela inicial"</strong></li>
                <li>Confirme tocando em <strong>"Adicionar"</strong></li>
                <li>O √≠cone aparecer√° na sua tela inicial! üéâ</li>
              </ol>
            </div>

            <!-- iOS Safari -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border-2 border-blue-300">
              <h3 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                <span class="text-2xl">üçé</span>
                <span>iPhone/iPad (Safari)</span>
              </h3>
              <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                <li>Toque no bot√£o <strong>Compartilhar</strong> (quadrado com seta para cima)</li>
                <li>Role para baixo e toque em <strong>"Adicionar √† Tela de In√≠cio"</strong></li>
                <li>Toque em <strong>"Adicionar"</strong> no canto superior direito</li>
                <li>Pronto! O app est√° instalado! üéâ</li>
              </ol>
            </div>

            <!-- Desktop -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border-2 border-purple-300">
              <h3 class="font-bold text-purple-800 mb-3 flex items-center gap-2">
                <span class="text-2xl">üíª</span>
                <span>Desktop (Chrome/Edge)</span>
              </h3>
              <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                <li>Clique no √≠cone <strong>‚äï</strong> (mais) na barra de endere√ßo</li>
                <li>Ou v√° em Menu ‚Üí <strong>"Instalar Planos e Cota√ß√µes"</strong></li>
                <li>Confirme a instala√ß√£o</li>
                <li>O app abrir√° em uma janela pr√≥pria! üéâ</li>
              </ol>
            </div>
          </div>

          <div class="mt-6 text-center">
            <button id="btnFecharInstrucoes" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">
              Entendi!
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('btnFecharInstrucoes').addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    function sairSistema() {
      fecharMenu();
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
          <div class="text-center mb-6">
            <div class="text-6xl mb-4">üö™</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Sair do Sistema</h2>
            <p class="text-gray-600">Tem certeza que deseja sair?</p>
          </div>
          <div class="flex gap-3">
            <button id="btnCancelarSair" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
              Cancelar
            </button>
            <button id="btnConfirmarSair" class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors">
              Sair
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('btnCancelarSair').addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      document.getElementById('btnConfirmarSair').addEventListener('click', () => {
        document.body.removeChild(modal);
        
        // Limpa dados do localStorage
        localStorage.removeItem('nomeVendedorLogado');
        
        // Limpa dados e volta para tela de login
        nomeVendedorLogado = '';
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        document.getElementById('inputNomeVendedorInicial').value = '';
        document.getElementById('inputNomeVendedorInicial').focus();
        
        showToast('üëã At√© logo!', 'success');
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // ========== CALCULADORA ==========
    function limparCampoCalculadora() {
      const input = document.getElementById('calcValor');
      const valorAtual = input.value.replace(/[^\d,]/g, '').replace(',', '.');
      const numero = parseFloat(valorAtual) || 0;
      input.value = numero > 0 ? numero.toString() : '';
      input.select();
    }

    function formatarCampoCalculadora() {
      const input = document.getElementById('calcValor');
      const valor = parseFloat(input.value.replace(',', '.')) || 0;
      input.value = formatarMoeda(valor);
    }

    function calcularParcelas() {
      const valorInput = document.getElementById('calcValor').value;
      const valor = parseFloat(valorInput.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
      const modalidade = document.getElementById('calcModalidade').value;
      const parcelas = parseInt(document.getElementById('calcParcelas').value);

      if (valor === 0) {
        showToast('‚ö†Ô∏è Digite um valor v√°lido', 'error');
        return;
      }

      let coeficiente = 0;
      if (modalidade === 'carne' && parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARNE[parcelas - 1];
      } else if (modalidade === 'cartao' && parcelas >= 1 && parcelas <= 12) {
        coeficiente = TAXAS_CARTAO[parcelas - 1];
      }

      const valorParcela = valor * coeficiente;
      const valorTotal = valorParcela * parcelas;

      document.getElementById('calcValorParcela').textContent = formatarMoedaBR(valorParcela);
      document.getElementById('calcValorTotal').textContent = formatarMoedaBR(valorTotal);
      document.getElementById('calcCoeficiente').textContent = coeficiente.toFixed(4);
      document.getElementById('calcResultado').classList.remove('hidden');
    }

    // ========== RELAT√ìRIOS ==========
    function gerarRelatorios() {
      const container = document.getElementById('relatoriosContent');
      
      // Estat√≠sticas gerais
      const totalPropostas = allProposals.length;
      const totalValor = allProposals.reduce((sum, p) => {
        const produtos = JSON.parse(p.produtos || '[]');
        return sum + produtos.reduce((s, prod) => s + (parseFloat(prod.preco_promo) || 0), 0);
      }, 0);

      // Propostas por vendedor
      const porVendedor = {};
      allProposals.forEach(p => {
        const vendedor = p.vendedor_nome || 'Sem vendedor';
        if (!porVendedor[vendedor]) {
          porVendedor[vendedor] = { count: 0, valor: 0 };
        }
        porVendedor[vendedor].count++;
        const produtos = JSON.parse(p.produtos || '[]');
        porVendedor[vendedor].valor += produtos.reduce((s, prod) => s + (parseFloat(prod.preco_promo) || 0), 0);
      });

      // Propostas por m√™s
      const porMes = {};
      allProposals.forEach(p => {
        if (p.data_proposta) {
          const [ano, mes] = p.data_proposta.split('-');
          const chave = `${mes}/${ano}`;
          if (!porMes[chave]) {
            porMes[chave] = { count: 0, valor: 0 };
          }
          porMes[chave].count++;
          const produtos = JSON.parse(p.produtos || '[]');
          porMes[chave].valor += produtos.reduce((s, prod) => s + (parseFloat(prod.preco_promo) || 0), 0);
        }
      });

      const html = `
        <!-- Cards de Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-300">
            <div class="text-4xl mb-2">üìä</div>
            <p class="text-sm text-gray-600 mb-1">Total de Propostas</p>
            <p class="text-3xl font-bold text-blue-600">${totalPropostas}</p>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border-2 border-green-300">
            <div class="text-4xl mb-2">üí∞</div>
            <p class="text-sm text-gray-600 mb-1">Valor Total</p>
            <p class="text-3xl font-bold text-green-600">${formatarMoedaBR(totalValor)}</p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border-2 border-purple-300">
            <div class="text-4xl mb-2">üìà</div>
            <p class="text-sm text-gray-600 mb-1">Ticket M√©dio</p>
            <p class="text-3xl font-bold text-purple-600">${formatarMoedaBR(totalPropostas > 0 ? totalValor / totalPropostas : 0)}</p>
          </div>
        </div>

        <!-- Por Vendedor -->
        <div class="bg-white rounded-xl p-6 border-2 border-gray-200 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>üë•</span>
            <span>Propostas por Vendedor</span>
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-100">
                  <th class="px-4 py-3 text-left font-bold text-gray-700">Vendedor</th>
                  <th class="px-4 py-3 text-center font-bold text-gray-700">Propostas</th>
                  <th class="px-4 py-3 text-right font-bold text-gray-700">Valor Total</th>
                  <th class="px-4 py-3 text-right font-bold text-gray-700">Ticket M√©dio</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(porVendedor).map(([vendedor, dados], index) => `
                  <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="px-4 py-3 font-semibold text-gray-800">${vendedor}</td>
                    <td class="px-4 py-3 text-center text-blue-600 font-bold">${dados.count}</td>
                    <td class="px-4 py-3 text-right text-green-600 font-bold">${formatarMoedaBR(dados.valor)}</td>
                    <td class="px-4 py-3 text-right text-purple-600 font-bold">${formatarMoedaBR(dados.valor / dados.count)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Por M√™s -->
        <div class="bg-white rounded-xl p-6 border-2 border-gray-200">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>üìÖ</span>
            <span>Propostas por M√™s</span>
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-100">
                  <th class="px-4 py-3 text-left font-bold text-gray-700">M√™s/Ano</th>
                  <th class="px-4 py-3 text-center font-bold text-gray-700">Propostas</th>
                  <th class="px-4 py-3 text-right font-bold text-gray-700">Valor Total</th>
                  <th class="px-4 py-3 text-right font-bold text-gray-700">Ticket M√©dio</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(porMes).sort((a, b) => {
                  const [mesA, anoA] = a[0].split('/');
                  const [mesB, anoB] = b[0].split('/');
                  return (anoB + mesB).localeCompare(anoA + mesA);
                }).map(([mes, dados], index) => `
                  <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="px-4 py-3 font-semibold text-gray-800">${mes}</td>
                    <td class="px-4 py-3 text-center text-blue-600 font-bold">${dados.count}</td>
                    <td class="px-4 py-3 text-right text-green-600 font-bold">${formatarMoedaBR(dados.valor)}</td>
                    <td class="px-4 py-3 text-right text-purple-600 font-bold">${formatarMoedaBR(dados.valor / dados.count)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        ${totalPropostas === 0 ? `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üìä</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhum dado dispon√≠vel</h3>
            <p class="text-gray-500">Crie propostas para visualizar relat√≥rios</p>
          </div>
        ` : ''}
      `;

          container.innerHTML = html;
    }

    // ======================================================================
    // üîå BLOCO FS ‚Äì WHATSAPP COM IMAGEM (CLIENTE / DIRETORIA)
    // N√ÉO APAGA NADA DO QUE J√Å EXISTE. APENAS FOI COLADO NO FINAL.
    // ======================================================================

    let visaoPreviewAtual = null;

    // Envolve as fun√ß√µes existentes de visualiza√ß√£o para saber qual vis√£o est√° ativa
    if (typeof visualizarPropostaCliente === 'function') {
      const _visualizarPropostaClienteOriginal = visualizarPropostaCliente;
      visualizarPropostaCliente = function () {
        visaoPreviewAtual = 'cliente';
        _visualizarPropostaClienteOriginal();
      };
    }

    if (typeof visualizarPropostaDiretoria === 'function') {
      const _visualizarPropostaDiretoriaOriginal = visualizarPropostaDiretoria;
      visualizarPropostaDiretoria = function () {
        visaoPreviewAtual = 'diretoria';
        _visualizarPropostaDiretoriaOriginal();
      };
    }

    // Assim que a tela carregar, cria os bot√µes de WhatsApp ao lado dos bot√µes principais
    document.addEventListener('DOMContentLoaded', function () {
      try {
        const containerBotoes = document.querySelector('.flex.flex-wrap.gap-4');
        if (!containerBotoes) return;

       // Assim que a tela carregar, cria os bot√µes de WhatsApp ao lado dos bot√µes principais
document.addEventListener('DOMContentLoaded', function () {
  try {
    const containerBotoes = document.querySelector('.flex.flex-wrap.gap-4');
    if (!containerBotoes) return;

    // Bot√£o para Cliente
    const btnWhatsCliente = document.createElement('button');
    btnWhatsCliente.className =
      'flex-1 min-w-max bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2';
    btnWhatsCliente.innerHTML = '<span>üì§</span><span>Enviar Whats ‚Äì Cliente</span>';
    btnWhatsCliente.addEventListener('click', function () {
      enviarWhatsappComImagem('cliente');
    });

    // Bot√£o para Diretoria
    const btnWhatsDiretoria = document.createElement('button');
    btnWhatsDiretoria.className =
      'flex-1 min-w-max bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2';
    btnWhatsDiretoria.innerHTML = '<span>üè¢</span><span>Enviar Whats ‚Äì Diretoria</span>';
    btnWhatsDiretoria.addEventListener('click', function () {
      enviarWhatsappComImagem('diretoria');
    });

    // Adiciona ao container
    containerBotoes.appendChild(btnWhatsCliente);
    containerBotoes.appendChild(btnWhatsDiretoria);

    // üëá ESCONDE OS BOT√ïES DO CABE√áALHO
    btnWhatsCliente.style.display = 'none';
    btnWhatsDiretoria.style.display = 'none';

  } catch (e) {
    console.error('Erro ao criar bot√µes de WhatsApp:', e);
  }
});


        containerBotoes.appendChild(btnWhatsCliente);
        containerBotoes.appendChild(btnWhatsDiretoria);
      } catch (e) {
        console.error('Erro ao criar bot√µes de WhatsApp:', e);
      }
    });

    // Fun√ß√£o principal: gera imagem + abre WhatsApp
    async function enviarWhatsappComImagem(tipo) {
      try {
        if (!window.html2canvas) {
          showToast('‚ùå html2canvas n√£o encontrado na p√°gina.', 'error');
          return;
        }

        // Garante que existe pelo menos 1 produto
        if (!Array.isArray(produtos) || produtos.length === 0) {
          showToast('Adicione pelo menos 1 produto antes de enviar.', 'error');
          return;
        }

        // Abre o preview correto (usa as fun√ß√µes que j√° existem)
        if (tipo === 'cliente') {
          if (typeof visualizarPropostaCliente === 'function') {
            visualizarPropostaCliente();
          } else {
            showToast('Fun√ß√£o visualizarPropostaCliente n√£o encontrada.', 'error');
            return;
          }
        } else {
          if (typeof visualizarPropostaDiretoria === 'function') {
            visualizarPropostaDiretoria();
          } else {
            showToast('Fun√ß√£o visualizarPropostaDiretoria n√£o encontrada.', 'error');
            return;
          }
        }

        // D√° um tempinho pro HTML montar o preview
        await delayFS(500);

        const previewContent = document.getElementById('previewContent');
        if (!previewContent) {
          showToast('Preview da proposta n√£o encontrado.', 'error');
          return;
        }

        // Gera imagem em alta qualidade do preview
        const canvas = await html2canvas(previewContent, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff'
        });

        const dataUrl = canvas.toDataURL('image/png');

        // Nome do arquivo usando cliente + tipo de vis√£o
        const nomeCliente = (document.getElementById('inputClienteNome')?.value || 'cliente').trim() || 'cliente';
        const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
        const nomeArquivo = `proposta-${tipo}-${nomeCliente.replace(/\s+/g, '-').toLowerCase()}-${timestamp}.png`;

        // For√ßa o download da imagem
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = nomeArquivo;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('üì∏ Imagem da proposta gerada e baixada!', 'success');

        // Fecha o preview, se existir fun√ß√£o
        if (typeof fecharPreview === 'function') {
          fecharPreview();
        }

        // Pega o telefone do cliente (ou pergunta, se n√£o tiver)
        let numero = (document.getElementById('inputClienteTelefone')?.value || '').replace(/\D/g, '');
        if (!numero) {
          numero = prompt('Informe o n√∫mero do cliente (somente n√∫meros, com DDD):', '');
          if (!numero) {
            showToast('N√∫mero do cliente n√£o informado.', 'error');
            return;
          }
        }

        // Mensagem padr√£o para o WhatsApp
        const lojaNome = document.getElementById('inputLoja')?.value || 'Zenir';
        const tituloProposta = document.getElementById('inputTituloProposta')?.value || 'Proposta Especial';
        const saudacao = tipo === 'cliente'
          ? `Ol√°, ${nomeCliente}! Tudo bem?`
          : `Ol√°, boa tarde!`;

        let mensagem = `${saudacao}\n\n`;
        mensagem += `Envio em anexo a imagem da *${tipo === 'cliente' ? 'Proposta Comercial' : 'Cota√ß√£o para an√°lise da Diretoria'}*.\n`;
        mensagem += `üè™ Loja: ${lojaNome}\n`;
        mensagem += `üìã T√≠tulo: ${tituloProposta}\n\n`;
        mensagem += `üì∏ *Aten√ß√£o*: a proposta est√° detalhada na imagem que acabei de enviar.\n`;
        mensagem += `Qualquer d√∫vida, fico √† disposi√ß√£o!\n`;

        const mensagemCodificada = encodeURIComponent(mensagem);
        const numeroBrasil = numero.startsWith('55') ? numero : `55${numero}`;

        const urlWhats = `https://wa.me/${numeroBrasil}?text=${mensagemCodificada}`;
        window.open(urlWhats, '_blank');
      } catch (erro) {
        console.error('Erro ao gerar imagem / enviar WhatsApp:', erro);
        showToast('Erro ao gerar imagem ou enviar WhatsApp.', 'error');
      }
    }

    // Pequeno helper de delay
    function delayFS(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ======================================================================
    // üîö FIM DO BLOCO FS ‚Äì WHATSAPP COM IMAGEM
    // ======================================================================

    
    // ======================================================================
    // üîÅ OVERRIDE INITIALIZEAPP ‚Äì MODO OFFLINE / GITHUB PAGES
    // ======================================================================
    async function initializeApp() {
      try {
        document.getElementById('loading').classList.add('hidden');

        // Verifica se j√° tem nome salvo no localStorage
        const nomeSalvo = localStorage.getItem('nomeVendedorLogado');

        if (nomeSalvo) {
          // Se j√° tem nome salvo, entra direto no sistema
          nomeVendedorLogado = nomeSalvo;
          document.getElementById('nomeUsuarioHeader').textContent = nomeSalvo;
          document.getElementById('mainContent').classList.remove('hidden');
          setupEventListeners();
          setDataAtual();

          // Carrega propostas salvas offline, se existirem
          try {
            const rawPropostas = localStorage.getItem('fs_planos_cotacoes_propostas_offline_v1');
            if (rawPropostas) {
              const lista = JSON.parse(rawPropostas);
              if (Array.isArray(lista)) {
                allProposals = lista;

                if (typeof renderListaPropostas === 'function') {
                  renderListaPropostas(allProposals);
                }
                if (typeof updateContador === 'function') {
                  updateContador(allProposals.length);
                }
              }
            }
          } catch (erro) {
            console.warn('Erro ao carregar propostas salvas offline:', erro);
          }

          showToast(`üëã Bem-vindo de volta, ${nomeSalvo}!`, 'success');
        } else {
          // Se n√£o tem nome salvo, mostra a tela de boas-vindas
          document.getElementById('welcomeScreen').classList.remove('hidden');

          // Configura o bot√£o de entrada
          const btnEntrar = document.getElementById('btnEntrarSistema');
          if (btnEntrar) {
            btnEntrar.addEventListener('click', entrarNoSistema);
          }

          // Permite entrar com Enter
          const inputNome = document.getElementById('inputNomeVendedorInicial');
          if (inputNome) {
            inputNome.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                entrarNoSistema();
              }
            });

            // Foca no input
            setTimeout(() => {
              inputNome.focus();
            }, 300);
          }
        }
      } catch (e) {
        console.error('Erro ao inicializar app em modo offline:', e);
        try {
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('welcomeScreen').classList.remove('hidden');
        } catch (_) {}
      }
    }



    // Marca proposta como N√ÉO salva sempre que algum campo do editor for alterado
    document.addEventListener('input', function (e) {
      const editor = document.getElementById('editorView');
      if (!editor) return;
      if (editor.contains(e.target)) {
        propostaFoiSalva = false;
      }
    });

    // Atualiza o resumo geral quando alterar modalidade ou n√∫mero de parcelas
    document.addEventListener('change', function (e) {
      const target = e.target;
      if (!target) return;
      if (target.id === 'resumoModalidade' || target.id === 'resumoParcelas') {
        atualizarResumoGeralProposta();
      }
    });


    // Bot√£o flutuante para voltar ao in√≠cio
    document.addEventListener('DOMContentLoaded', function () {
      const btnVoltar = document.getElementById('btnVoltarInicio');
      if (!btnVoltar) return;

      btnVoltar.addEventListener('click', function () {
        try {
          if (window.history && window.history.length > 1) {
            window.history.back();
          } else {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        } catch (e) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    });


// ========== INIT ==========
    if (fsGarantirAutenticacaoGlobal()) {
      initializeApp();

      // Atalhos do painel do gerente (listeners extras)
      document.addEventListener('DOMContentLoaded', function () {
        const btnFloat = document.getElementById('btnPainelGerenteFlutuante');
        if (btnFloat) {
          btnFloat.addEventListener('click', abrirPainelGerente);
        }
      });
    } else {
      // Bloqueia visualmente se n√£o autenticou
      document.body.innerHTML = `
        <div style="
          min-height:100vh;
          display:flex;
          align-items:center;
          justify-content:center;
          background:#0f172a;
          color:#e5e7eb;
          font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
          text-align:center;
          padding:24px;
        ">
          <div>
            <h1 style="font-size:20px;margin-bottom:8px;">Acesso n√£o autorizado</h1>
            <p style="font-size:14px;opacity:.8;">
              Atualize a p√°gina e tente novamente com a senha correta.
            </p>
          </div>
        </div>
      `;
    }
</script>
  

  <button id="btnVoltarInicio" class="fixed right-3 bottom-3 z-40 px-4 py-2 rounded-full bg-gray-900 text-white text-xs md:text-sm shadow-lg flex items-center gap-2">
    <span>‚üµ</span>
    <span>Voltar</span>
  </button>


  
  </div>

<script>
  const FS_MASTER = "@fildO1060";

  const FS_BASE_USERS = {
    "fildo":   { senha: "@fildO1060", nivel: ["gerente","diretoria"], fixo: true,  nome: "Fildo" },
    "patricia":{ senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Patr√≠cia" },
    "darlan":  { senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Darlan" },
    "eduardo": { senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Eduardo" },
    "flavio":  { senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Fl√°vio" },
    "iane":    { senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Iane" },
    "larissa": { senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Larissa" },
    "anderson":{ senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Anderson" },
    "vitoria": { senha: "1234",       nivel: ["gerente"],            fixo: false, nome: "Vit√≥ria" },
    "neuma":   { senha: "1234",       nivel: ["gerente"],            fixo: false, nome: "Neuma" },
    "vicari":  { senha: "1234",       nivel: ["gerente"],            fixo: false, nome: "Vicari" },
    "rayane":  { senha: "1234",       nivel: ["vendedor"],           fixo: false, nome: "Rayane" }
  };

  let FS_USER_STORE = {}; // customiza√ß√µes gravadas no dispositivo
  let FS_USUARIOS = {};
  let fsAuthReady = false;

  const originalShowToast = window.showToast || function(){};
  window.showToast = function(msg, tipo){
    if (!fsAuthReady) {
      return;
    }
    try { originalShowToast(msg, tipo); } catch(e) {}
  };

  function fsNorm(nome){
    if(!nome) return "";
    return nome.trim().toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,"");
  }

  function fsRefreshUsers(){
    try{
      FS_USER_STORE = JSON.parse(localStorage.getItem("fsUserStore") || "{}");
    }catch(e){
      FS_USER_STORE = {};
    }
    FS_USUARIOS = {};
    // base
    Object.keys(FS_BASE_USERS).forEach(function(k){
      FS_USUARIOS[k] = Object.assign({}, FS_BASE_USERS[k]);
    });
    // custom (podem sobrescrever base)
    Object.keys(FS_USER_STORE).forEach(function(k){
      var info = FS_USER_STORE[k];
      if(!info) return;
      if(info.ativo === false){
        delete FS_USUARIOS[k];
        return;
      }
      FS_USUARIOS[k] = {
        senha: info.senha,
        nivel: info.nivel || ["vendedor"],
        fixo: !!info.fixo,
        nome: info.nome || info.rawName || k
      };
    });
  }

  fsRefreshUsers();

  function fsTogglePass(){
    var input = document.getElementById("fsPass");
    if(!input) return;
    if(input.type === "password"){
      input.type = "text";
    } else {
      input.type = "password";
    }
  }

  function fsShowLogin(){
    document.getElementById("fsLoginPage").classList.remove("fs-login-hidden");
    document.getElementById("fsMasterPage").classList.add("fs-login-hidden");
    document.getElementById("fsNewPassPage").classList.add("fs-login-hidden");
    document.getElementById("fsUserAdminPage").classList.add("fs-login-hidden");
  }

  function fsShowMaster(){
    document.getElementById("fsLoginPage").classList.add("fs-login-hidden");
    document.getElementById("fsMasterPage").classList.remove("fs-login-hidden");
    document.getElementById("fsNewPassPage").classList.add("fs-login-hidden");
    document.getElementById("fsUserAdminPage").classList.add("fs-login-hidden");
  }

  function fsShowNewPass(){
    document.getElementById("fsLoginPage").classList.add("fs-login-hidden");
    document.getElementById("fsMasterPage").classList.add("fs-login-hidden");
    document.getElementById("fsNewPassPage").classList.remove("fs-login-hidden");
    document.getElementById("fsUserAdminPage").classList.add("fs-login-hidden");
  }

  function fsShowUserAdmin(){
    document.getElementById("fsLoginPage").classList.add("fs-login-hidden");
    document.getElementById("fsMasterPage").classList.add("fs-login-hidden");
    document.getElementById("fsNewPassPage").classList.add("fs-login-hidden");
    document.getElementById("fsUserAdminPage").classList.remove("fs-login-hidden");
    fsAdminRenderLista();
  }

  function fsLogin(){
    fsRefreshUsers();
    var rawName = document.getElementById("fsUser").value;
    var u = fsNorm(rawName);
    var pass = document.getElementById("fsPass").value;
    var savedUser = localStorage.getItem("fsAuthUser") || "";
    var remembered = localStorage.getItem("fsRemember") === "1";

    if(!FS_USUARIOS[u]){
      alert("Usu√°rio n√£o encontrado. Use apenas o primeiro nome, ex.: fildo, patricia.");
      return;
    }

    if(!pass && remembered && fsNorm(savedUser) === u){
      fsEntrar(rawName || savedUser);
      return;
    }

    if(pass === FS_USUARIOS[u].senha){
      if(pass === "1234"){
        document.getElementById("fsNewPassUser").value = rawName;
        localStorage.setItem("fsResetUser", u);
        fsShowNewPass();
        return;
      }
      fsEntrar(rawName);
    } else {
      alert("Senha incorreta.");
    }
  }

  function fsEntrar(rawName){
    try{
      var login = document.getElementById("fsLoginPage");
      var master = document.getElementById("fsMasterPage");
      var nova = document.getElementById("fsNewPassPage");
      var admin = document.getElementById("fsUserAdminPage");
      var appWrap = document.getElementById("appView");
      if(login) login.style.display = "none";
      if(master) master.style.display = "none";
      if(nova) nova.style.display = "none";
      if(admin) admin.style.display = "none";
      if(appWrap){
        appWrap.style.display = "block";
      }

      try {
        window.nomeVendedorLogado = rawName || "";
        localStorage.setItem("nomeVendedorLogado", window.nomeVendedorLogado);
        localStorage.setItem("fsAuthUser", rawName || "");
        localStorage.setItem("fsRemember", "1");

        var headerSpan = document.getElementById("nomeUsuarioHeader");
        if(headerSpan){
          headerSpan.textContent = window.nomeVendedorLogado;
        }

        var main = document.getElementById("mainContent");
        var welcome = document.getElementById("welcomeScreen");
        if(welcome){ welcome.classList.add("hidden"); }
        if(main){ main.classList.remove("hidden"); }

        if(typeof setupEventListeners === "function") setupEventListeners();
        if(typeof setDataAtual === "function") setDataAtual();
        if(typeof configurarBuscaGerente === "function") configurarBuscaGerente();

      } catch(e) {
        console && console.warn && console.warn("Falha ao integrar login com app:", e);
      }

      fsAuthReady = true;
      try {
        originalShowToast("üëã Bem-vindo(a), " + (rawName || "") + "!", "success");
      } catch(e) {}
    }catch(e){
      console && console.warn && console.warn("Erro login FS:", e);
    }
  }

  function fsValidarMasterParaReset(){
    var m = document.getElementById("fsMaster").value;
    if(m === FS_MASTER){
      fsShowNewPass();
    } else {
      alert("Senha mestre incorreta.");
    }
  }

  function fsValidarMasterParaAdmin(){
    var m = document.getElementById("fsMaster").value;
    if(m === FS_MASTER){
      fsShowUserAdmin();
    } else {
      alert("Senha mestre incorreta.");
    }
  }

  function fsSaveNewPassword(){
    fsRefreshUsers();
    var userName = document.getElementById("fsNewPassUser").value;
    var u = fsNorm(userName || localStorage.getItem("fsResetUser") || "");
    var newPass = document.getElementById("fsNewPass").value;

    if(!FS_USUARIOS[u]){
      alert("Usu√°rio inv√°lido.");
      return;
    }
    if(!newPass || newPass.length < 4){
      alert("A nova senha deve ter pelo menos 4 caracteres.");
      return;
    }

    // Atualiza em FS_USER_STORE para ficar gravado no aparelho
    var baseInfo = FS_USUARIOS[u] || {};
    FS_USER_STORE[u] = {
      nome: baseInfo.nome || userName,
      rawName: userName,
      senha: newPass,
      nivel: baseInfo.nivel || ["vendedor"],
      ativo: true
    };
    localStorage.setItem("fsUserStore", JSON.stringify(FS_USER_STORE));

    alert("Senha redefinida com sucesso! Use essa senha no pr√≥ximo acesso.");
    localStorage.setItem("fsRemember","1");
    localStorage.setItem("fsAuthUser", userName);
    fsRefreshUsers();
    fsEntrar(userName);
  }

  function fsAdminRenderLista(){
    fsRefreshUsers();
    var container = document.getElementById("fsUserList");
    if(!container) return;
    var html = '<div style="margin-bottom:4px;font-weight:600;">Usu√°rios cadastrados neste dispositivo:</div>';
    var keys = Object.keys(FS_USUARIOS).sort();
    if(keys.length === 0){
      html += "<div>Nenhum usu√°rio.</div>";
    } else {
      keys.forEach(function(k){
        var info = FS_USUARIOS[k];
        var label = info.nome || k;
        var niveis = info.nivel || [];
        var badgeClass = niveis.indexOf("gerente") >= 0 || niveis.indexOf("diretoria") >= 0
          ? "fs-user-badge fs-user-badge-gerente"
          : "fs-user-badge fs-user-badge-vendedor";
        var nivelTexto = (niveis.indexOf("gerente") >= 0 || niveis.indexOf("diretoria") >= 0)
          ? "Ger√™ncia"
          : "Vendedor(a)";
        html += '<div class="fs-user-chip">' + label +
                '<span class="' + badgeClass + '">' + nivelTexto + '</span>' +
                (FS_BASE_USERS[k] && FS_BASE_USERS[k].fixo ? ' <span style="font-size:10px;color:#9ca3af;">(base)</span>' : '') +
                '</div>';
      });
    }
    container.innerHTML = html;
  }

  function fsAdminSalvarUsuario(){
    fsRefreshUsers();
    var nome = document.getElementById("fsAdminUserName").value;
    var nivel = document.getElementById("fsAdminNivel").value;
    var senha = document.getElementById("fsAdminSenha").value || "1234";
    var u = fsNorm(nome);

    if(!nome){
      alert("Informe o nome do usu√°rio.");
      return;
    }
    if(u === "fildo"){
      alert("O usu√°rio 'Fildo' √© fixo e j√° est√° cadastrado.");
      return;
    }
    var niveis = nivel === "gerente" ? ["gerente"] : ["vendedor"];

    FS_USER_STORE[u] = {
      nome: nome,
      rawName: nome,
      senha: senha,
      nivel: niveis,
      ativo: true
    };
    localStorage.setItem("fsUserStore", JSON.stringify(FS_USER_STORE));
    fsAdminRenderLista();
    alert("Usu√°rio salvo/atualizado com sucesso.");
  }

  function fsAdminExcluirUsuario(){
    fsRefreshUsers();
    var nome = document.getElementById("fsAdminUserName").value;
    var u = fsNorm(nome);

    if(!nome){
      alert("Informe o nome do usu√°rio que deseja desativar.");
      return;
    }
    if(u === "fildo"){
      alert("O usu√°rio 'Fildo' n√£o pode ser removido.");
      return;
    }

    if(!FS_USUARIOS[u]){
      alert("Usu√°rio n√£o encontrado.");
      return;
    }

    if(!confirm("Deseja realmente desativar o usu√°rio '" + nome + "' neste dispositivo?")){
      return;
    }

    FS_USER_STORE[u] = {
      nome: nome,
      rawName: nome,
      senha: FS_USUARIOS[u].senha,
      nivel: FS_USUARIOS[u].nivel || ["vendedor"],
      ativo: false
    };
    localStorage.setItem("fsUserStore", JSON.stringify(FS_USER_STORE));
    fsAdminRenderLista();
    alert("Usu√°rio desativado neste dispositivo.");
  }

  document.addEventListener("DOMContentLoaded", function(){
    try{
      fsRefreshUsers();
      var saved = localStorage.getItem("fsAuthUser") || "";
      var remembered = localStorage.getItem("fsRemember") === "1";
      var input = document.getElementById("fsUser");
      if(saved && input){
        input.value = saved;
      }
      var app = document.getElementById("appView");
      if(app){
        app.style.display = "none";
      }
      var main = document.getElementById("mainContent");
      var welcome = document.getElementById("welcomeScreen");

      // Modelo 1: manter logado at√© clicar em Sair
      if (saved && remembered && typeof FS_USUARIOS !== "undefined" && typeof fsNorm === "function" && FS_USUARIOS[fsNorm(saved)]) {
        fsEntrar(saved);
      } else {
        if(main) main.classList.add("hidden");
        if(welcome) welcome.classList.add("hidden");
        fsShowLogin();
      }
    }catch(e){
      console && console.warn && console.warn("Init FS falhou:", e);
    }
  });
</script>

</body>
</html>
