<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planos e Cota√ß√µes - Sistema Comercial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @media print {
      body * {
        visibility: hidden;
      }
      #previewContent, #previewContent * {
        visibility: visible;
      }
      #previewContent {
        position: absolute;
        left: 0;
        top: 0;
        width: 210mm;
      }
    }

    .produto-item {
      transition: all 0.3s ease;
    }

    .produto-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
    }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .preview-container {
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-full"><!-- ========== TELA DE BOAS-VINDAS ========== -->
  <div id="welcomeScreen" class="flex items-center justify-center min-h-full p-4">
   <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full animate-slide-in">
    <div class="text-center mb-8">
     <div class="text-6xl mb-4">
      üìä
     </div>
     <h1 class="text-3xl font-bold text-gray-800 mb-2">Planos e Cota√ß√µes</h1>
     <p class="text-gray-600">Sistema Comercial Profissional</p>
    </div>
    <form id="formLogin" class="space-y-6">
     <div><label for="inputNomeVendedorInicial" class="block text-sm font-semibold text-gray-700 mb-2"> üë§ Seu Nome </label> <input type="text" id="inputNomeVendedorInicial" placeholder="Digite seu nome completo" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
     </div><button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 shadow-lg"> Entrar no Sistema üöÄ </button>
    </form>
    <div class="mt-6 text-center text-sm text-gray-500">
     <p>‚ú® Crie propostas profissionais em minutos</p>
    </div>
   </div>
  </div><!-- ========== CONTE√öDO PRINCIPAL ========== -->
  <div id="mainContent" class="hidden min-h-full"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="text-3xl">
        üìä
       </div>
       <div>
        <h1 class="text-2xl font-bold">Planos e Cota√ß√µes</h1>
        <p class="text-sm text-blue-100">Bem-vindo(a), <span id="headerVendedorNome" class="font-semibold">Vendedor</span>!</p>
       </div>
      </div><button onclick="abrirMenu()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2"> <span>ÔøΩÔøΩÔøΩÔøΩ</span> <span class="hidden sm:inline">Menu</span> </button>
     </div>
    </div>
   </header><!-- Container Principal -->
   <main class="max-w-7xl mx-auto px-4 py-6"><!-- Conte√∫do das Abas -->
    <div id="conteudoNovaProposta" class="space-y-6"><!-- Se√ß√£o: Informa√ß√µes B√°sicas -->
     <section class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><span>üìã</span> <span>Dados B√°sicos</span></h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
       <div><label for="inputLoja" class="block text-sm font-semibold text-gray-700 mb-2"> üè™ Loja </label> <input type="text" id="inputLoja" placeholder="Ex: Iguatu 3 - Ao lado do Bradesco" value="Iguatu 3 - Ao lado do Bradesco" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
       <div><label for="inputVendedorNome" class="block text-sm font-semibold text-gray-700 mb-2"> üë§ Nome do Vendedor </label> <input type="text" id="inputVendedorNome" placeholder="Nome do vendedor" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
       <div><label for="inputClienteNome" class="block text-sm font-semibold text-gray-700 mb-2"> üë• Nome do Cliente * </label> <input type="text" id="inputClienteNome" placeholder="Digite o nome do cliente" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
       <div><label for="inputClienteContato" class="block text-sm font-semibold text-gray-700 mb-2"> üìû Contato do Cliente (com DDD) </label> <input type="text" id="inputClienteContato" placeholder="(11) 98765-4321" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
       <div><label for="inputDataAtual" class="block text-sm font-semibold text-gray-700 mb-2"> üìÖ Data Atual </label> <input type="date" id="inputDataAtual" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
       <div><label for="inputValidadeProposta" class="block text-sm font-semibold text-gray-700 mb-2"> ‚è∞ Validade da Proposta </label> <input type="date" id="inputValidadeProposta" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
       <div class="md:col-span-2"><label for="inputTituloProposta" class="block text-sm font-semibold text-gray-700 mb-2"> üìÑ T√≠tulo da Proposta </label> <input type="text" id="inputTituloProposta" placeholder="Ex: Proposta Especial Black Friday" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all">
       </div>
      </div>
     </section><!-- Se√ß√£o: Produtos -->
     <section class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span>üõí</span> <span>Produtos / Planos</span></h2><button onclick="adicionarProduto()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2"> <span>‚ûï</span> <span>Adicionar Produto</span> </button>
      </div>
      <div id="listaProdutos" class="space-y-4"><!-- Produtos ser√£o renderizados aqui -->
      </div>
     </section><!-- Se√ß√£o: Resumo Financeiro (aparece apenas quando h√° produtos) -->
     <section id="secaoResumoFinanceiro" class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-2xl shadow-md p-5 border border-emerald-200 hidden">
      <h2 class="text-lg font-bold text-emerald-800 mb-4 flex items-center gap-2"><span>üìä</span> <span>Resumo Financeiro</span></h2>
      <div id="resumoFinanceiroContent"><!-- Conte√∫do ser√° gerado dinamicamente -->
      </div><!-- Campo de Sugest√£o de Parcelamento -->
      <div class="mt-4"><label for="inputSugestaoParcelamento" class="block text-sm font-semibold text-gray-700 mb-2"> üí° Sugest√£o de Parcelamento para o Cliente </label> <textarea id="inputSugestaoParcelamento" rows="3" placeholder="Ex: Sugerimos 5x no carn√™ com garantia estendida, totalizando R$ 780,65 por m√™s..." class="w-full px-4 py-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 transition-all resize-none"></textarea>
      </div>
     </section><!-- Bot√£o Abrir Plano Exclusivo -->
     <div class="flex justify-center"><button onclick="togglePlanoExclusivo()" id="btnTogglePlanoExclusivo" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg"> <span>üíé</span> <span>Abrir Plano Exclusivo</span> </button>
     </div><!-- Se√ß√£o: Plano Exclusivo -->
     <section id="secaoPlanoExclusivo" class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-lg p-6 border-2 border-purple-200 hidden">
      <h2 class="text-2xl font-bold text-purple-800 mb-6 flex items-center gap-2"><span>üíé</span> <span>Plano Exclusivo - Comparativo Consolidado</span></h2><!-- Seletor de Modalidade -->
      <div id="seletorModalidadePlano" class="mb-6">
       <h3 class="text-lg font-bold text-gray-800 mb-3">Selecione a Modalidade de Pagamento:</h3>
       <div class="grid grid-cols-2 md:grid-cols-4 gap-3"><button onclick="selecionarModalidadePlano('avista')" id="btnModalidadeAvista" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"> <span>üí∞</span> <span>√Ä Vista</span> </button> <button onclick="selecionarModalidadePlano('carne')" id="btnModalidadeCarne" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"> <span>üìù</span> <span>Carn√™</span> </button> <button onclick="selecionarModalidadePlano('cartao')" id="btnModalidadeCartao" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"> <span>üí≥</span> <span>Cart√£o</span> </button> <button onclick="abrirExclusivoGerente()" id="btnExclusivoGerente" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-yellow-400 to-orange-400 text-white hover:from-yellow-500 hover:to-orange-500 shadow-md"> <span>‚≠ê</span> <span class="hidden sm:inline">Exclusivo Gerente</span> <span class="sm:hidden">Exclusivo</span> </button>
       </div>
      </div>
      <div id="planoExclusivoContent"><!-- Conte√∫do ser√° gerado dinamicamente -->
      </div>
     </section><!-- Bot√£o Abrir Informa√ß√µes Adicionais -->
     <div class="flex justify-center"><button onclick="toggleInformacoesAdicionais()" id="btnToggleInformacoesAdicionais" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg"> <span>üìã</span> <span>Abrir Informa√ß√µes Adicionais</span> </button>
     </div><!-- Se√ß√£o: Informa√ß√µes Adicionais -->
     <section id="secaoInformacoesAdicionais" class="bg-white rounded-2xl shadow-lg p-6 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><span>üìã</span> <span>Informa√ß√µes Adicionais - Proposta para Diretoria</span></h2>
      <div class="space-y-6"><!-- Hist√≥rico de Negocia√ß√£o -->
       <div><label for="inputHistorico" class="block text-sm font-semibold text-gray-700 mb-2"> üìù Hist√≥rico de Negocia√ß√£o / Contexto do Cliente </label> <textarea id="inputHistorico" rows="3" placeholder="Ex: Cliente pesquisou concorrentes, j√° conhece a marca, veio por indica√ß√£o..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all resize-none"></textarea>
       </div><!-- Seletor de Modalidade para Proposta -->
       <div>
        <h3 class="text-lg font-bold text-gray-800 mb-3">üí∞ Proposta do Cliente - Selecione a Modalidade:</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3"><button type="button" onclick="selecionarModalidadeProposta('avista')" id="btnPropostaAvista" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"> <span>üí∞</span> <span>√Ä Vista</span> </button> <button type="button" onclick="selecionarModalidadeProposta('carne')" id="btnPropostaCarne" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"> <span>üìù</span> <span>Carn√™</span> </button> <button type="button" onclick="selecionarModalidadeProposta('cartao')" id="btnPropostaCartao" class="px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"> <span>ÔøΩÔøΩÔøΩÔøΩ</span> <span>Cart√£o</span> </button>
        </div>
       </div><!-- Campos da Proposta (aparecem apÔøΩÔøΩs selecionar modalidade) -->
       <div id="camposPropostaCliente" class="hidden"><!-- Conte√∫do ser√° gerado dinamicamente -->
       </div><!-- Simula√ß√£o de Perdas e Ganhos -->
       <div><label for="inputSimulacao" class="block text-sm font-semibold text-gray-700 mb-2"> üìà Simula√ß√£o de Perdas e Ganhos / An√°lise Financeira </label> <textarea id="inputSimulacao" rows="3" placeholder="Descreva a an√°lise de perdas e ganhos, margem de lucro, impacto no faturamento..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all resize-none"></textarea>
       </div><!-- Oportunidades e Observa√ß√µes -->
       <div><label for="inputOportunidades" class="block text-sm font-semibold text-gray-700 mb-2"> üí° Oportunidades de Melhoria / Observa√ß√µes Importantes </label> <textarea id="inputOportunidades" rows="3" placeholder="Possibilidade de venda adicional, fideliza√ß√£o do cliente, observa√ß√µes relevantes..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all resize-none"></textarea>
       </div>
      </div>
     </section><!-- Bot√µes de A√ß√£o -->
     <div class="flex flex-wrap gap-4"><button onclick="salvarProposta()" class="flex-1 min-w-max bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"> <span>üíæ</span> <span>Salvar Proposta</span> </button> <button onclick="visualizarPropostaCliente()" class="flex-1 min-w-max bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"> <span>üì±</span> <span>Visualizar para Cliente</span> </button> <button onclick="visualizarPropostaDiretoria()" class="flex-1 min-w-max bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"> <span>üìä</span> <span>Visualizar para Diretoria</span> </button>
     </div>
    </div>
   </main>
  </div>
  <script>
    const COEFICIENTES_CARNE = {
      1: 1.0690, 2: 0.5523, 3: 0.3804, 4: 0.2946, 5: 0.2432, 6: 0.2091,
      7: 0.1849, 8: 0.1668, 9: 0.1528, 10: 0.1417, 11: 0.1327, 12: 0.1252
    };

    const COEFICIENTES_CARTAO = {
      1: 1.0292, 2: 0.5220, 3: 0.3530, 4: 0.2685, 5: 0.2179, 6: 0.1841,
      7: 0.1600, 8: 0.1420, 9: 0.1280, 10: 0.1168, 11: 0.1076, 12: 0.1000
    };

    const TAXA_PM = 0.06;
    const MAX_PRODUTOS = 10;

    let nomeVendedorLogado = '';
    let produtos = [];
    let valorPlanoExclusivo = 0;
    let allProposals = [];
    let currentProposalData = null;
    let currentProposalId = null;
    let modalidadePlanoSelecionada = null;
    let exclusivoGerenteAberto = false;
    let modalidadeExclusivoSelecionada = null;
    let planoExclusivoVisivel = false;
    let informacoesAdicionaisVisivel = false;
    let resumoFinanceiroVisivel = false;
    let modalidadePropostaCliente = null;
    let propostaClienteData = {
      modalidade: null,
      parcelas: null,
      tipoPreco: null,
      observacoes: ''
    };

    function toggleInformacoesAdicionais() {
      informacoesAdicionaisVisivel = !informacoesAdicionaisVisivel;
      const secao = document.getElementById('secaoInformacoesAdicionais');
      const btn = document.getElementById('btnToggleInformacoesAdicionais');
      
      if (informacoesAdicionaisVisivel) {
        secao.classList.remove('hidden');
        btn.innerHTML = '<span>ÔøΩÔøΩÔøΩ</span><span>Fechar Informa√ß√µes Adicionais</span>';
        btn.className = 'bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
        showToast('üìã Informa√ß√µes Adicionais abertas!', 'success');
      } else {
        secao.classList.add('hidden');
        btn.innerHTML = '<span>üìã</span><span>Abrir Informa√ß√µes Adicionais</span>';
        btn.className = 'bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
        showToast('ÔøΩÔøΩÔøΩ Informa√ß√µes Adicionais fechadas', 'success');
      }
    }

    function initializeApp() {
      const vendedorSalvo = localStorage.getItem('nomeVendedorLogado');
      if (vendedorSalvo) {
        nomeVendedorLogado = vendedorSalvo;
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        document.getElementById('headerVendedorNome').textContent = nomeVendedorLogado;
        document.getElementById('inputVendedorNome').value = nomeVendedorLogado;
      }

      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('inputDataAtual').value = hoje;

      carregarPropostas();

      document.getElementById('formLogin').addEventListener('submit', (e) => {
        e.preventDefault();
        const nome = document.getElementById('inputNomeVendedorInicial').value.trim();
        if (nome) {
          nomeVendedorLogado = nome;
          localStorage.setItem('nomeVendedorLogado', nome);
          document.getElementById('welcomeScreen').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          document.getElementById('headerVendedorNome').textContent = nomeVendedorLogado;
          document.getElementById('inputVendedorNome').value = nomeVendedorLogado;
          const hoje = new Date().toISOString().split('T')[0];
          document.getElementById('inputDataAtual').value = hoje;
          showToast('‚úÖ Bem-vindo, ' + nome + '!', 'success');
        }
      });

      renderProdutos();
      renderPlanoExclusivo();
      renderResumoFinanceiro();
    }

    function carregarPropostas() {
      const propostas = localStorage.getItem('propostas');
      if (propostas) {
        allProposals = JSON.parse(propostas);
      }
    }

    function salvarPropostasLocalStorage() {
      localStorage.setItem('propostas', JSON.stringify(allProposals));
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 3000);
    }

    function selecionarModalidadeProposta(modalidade) {
      modalidadePropostaCliente = modalidade;
      propostaClienteData.modalidade = modalidade;
      
      document.getElementById('btnPropostaAvista').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('btnPropostaCarne').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('btnPropostaCartao').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      
      if (modalidade === 'avista') {
        document.getElementById('btnPropostaAvista').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg';
      } else if (modalidade === 'carne') {
        document.getElementById('btnPropostaCarne').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg';
      } else if (modalidade === 'cartao') {
        document.getElementById('btnPropostaCartao').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg';
      }
      
      renderCamposPropostaCliente();
      const nomeModalidade = modalidade === 'avista' ? '√Ä Vista' : modalidade === 'carne' ? 'Carn√™' : 'Cart√£o';
      showToast(`‚úÖ Modalidade ${nomeModalidade} selecionada!`, 'success');
    }

    function renderCamposPropostaCliente() {
      const container = document.getElementById('camposPropostaCliente');
      
      if (!modalidadePropostaCliente) {
        container.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      
      if (modalidadePropostaCliente === 'avista') {
        container.innerHTML = `
          <div class="p-6 bg-green-50 rounded-xl border-2 border-green-300">
            <h4 class="text-lg font-bold text-green-800 mb-4 flex items-center gap-2">
              <span>üí∞</span>
              <span>Proposta √Ä Vista</span>
            </h4>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üíµ Tipo de Pre√ßo
                </label>
                <select
                  id="selectTipoPrecoAvista"
                  onchange="propostaClienteData.tipoPreco = this.value"
                  class="w-full px-4 py-3 border-2 border-green-300 rounded-xl focus:border-green-500 transition-all"
                >
                  <option value="">Selecione...</option>
                  <option value="normal">Pre√ßo Normal (Tabela)</option>
                  <option value="promocional">Pre√ßo Promocional</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üìù Observa√ß√µes
                </label>
                <textarea
                  id="textareaObservacoesAvista"
                  rows="3"
                  onchange="propostaClienteData.observacoes = this.value"
                  placeholder="Ex: Cliente quer desconto adicional, condi√ß√µes especiais..."
                  class="w-full px-4 py-3 border-2 border-green-300 rounded-xl focus:border-green-500 transition-all resize-none"
                ></textarea>
              </div>
            </div>
          </div>
        `;
      } else if (modalidadePropostaCliente === 'carne') {
        container.innerHTML = `
          <div class="p-6 bg-blue-50 rounded-xl border-2 border-blue-300">
            <h4 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
              <span>üìù</span>
              <span>Proposta Carn√™</span>
            </h4>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üìä N√∫mero de Parcelas
                </label>
                <input
                  type="number"
                  id="inputParcelasCarne"
                  min="1"
                  max="12"
                  placeholder="Ex: 5"
                  onchange="propostaClienteData.parcelas = parseInt(this.value)"
                  class="w-full px-4 py-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 transition-all"
                />
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üíµ Tipo de PreÔøΩÔøΩo
                </label>
                <select
                  id="selectTipoPrecoCarne"
                  onchange="propostaClienteData.tipoPreco = this.value"
                  class="w-full px-4 py-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 transition-all"
                >
                  <option value="">Selecione...</option>
                  <option value="normal">Pre√ßo Normal (Tabela)</option>
                  <option value="promocional">Pre√ßo Promocional</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  ÔøΩÔøΩÔøΩ Observa√ß√µes
                </label>
                <textarea
                  id="textareaObservacoesCarne"
                  rows="3"
                  onchange="propostaClienteData.observacoes = this.value"
                  placeholder="Ex: Cliente quer 5x sem juros, condi√ß√µes especiais..."
                  class="w-full px-4 py-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 transition-all resize-none"
                ></textarea>
              </div>
            </div>
          </div>
        `;
      } else if (modalidadePropostaCliente === 'cartao') {
        container.innerHTML = `
          <div class="p-6 bg-purple-50 rounded-xl border-2 border-purple-300">
            <h4 class="text-lg font-bold text-purple-800 mb-4 flex items-center gap-2">
              <span>üí≥</span>
              <span>Proposta Cart√£o</span>
            </h4>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üìä N√∫mero de Parcelas
                </label>
                <input
                  type="number"
                  id="inputParcelasCartao"
                  min="1"
                  max="12"
                  placeholder="Ex: 6"
                  onchange="propostaClienteData.parcelas = parseInt(this.value)"
                  class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 transition-all"
                />
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üíµ Tipo de Pre√ßo
                </label>
                <select
                  id="selectTipoPrecoCartao"
                  onchange="propostaClienteData.tipoPreco = this.value"
                  class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 transition-all"
                >
                  <option value="">Selecione...</option>
                  <option value="normal">Pre√ßo Normal (Tabela)</option>
                  <option value="promocional">Pre√ßo Promocional</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üìù Observa√ß√µes
                </label>
                <textarea
                  id="textareaObservacoesCartao"
                  rows="3"
                  onchange="propostaClienteData.observacoes = this.value"
                  placeholder="Ex: Cliente quer 6x sem juros, condi√ß√µes especiais..."
                  class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 transition-all resize-none"
                ></textarea>
              </div>
            </div>
          </div>
        `;
      }
    }

    function togglePlanoExclusivo() {
      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione produtos primeiro!', 'error');
        return;
      }
      
      planoExclusivoVisivel = !planoExclusivoVisivel;
      atualizarVisibilidadeSecaoPlano();
      
      const btn = document.getElementById('btnTogglePlanoExclusivo');
      if (planoExclusivoVisivel) {
        btn.innerHTML = '<span>‚ùå</span><span>Fechar Plano Exclusivo</span>';
        btn.className = 'bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
        showToast('üíé Plano Exclusivo aberto!', 'success');
      } else {
        btn.innerHTML = '<span>üíé</span><span>Abrir Plano Exclusivo</span>';
        btn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
        showToast('‚ùå Plano Exclusivo fechado', 'success');
      }
    }



    function renderResumoFinanceiro() {
      const container = document.getElementById('resumoFinanceiroContent');
      const secao = document.getElementById('secaoResumoFinanceiro');

      if (produtos.length === 0) {
        secao.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      
      secao.classList.remove('hidden');

      let totalNormalGeral = 0;
      let totalPromoGeral = 0;

      const linhasProdutos = produtos.map((produto, index) => {
        let parcelaNormal = 0;
        let parcelaPromo = 0;
        let valorNormal = 0;
        let valorPromo = 0;

        if (produto.modalidade === 'avista') {
          parcelaNormal = produto.preco_normal || 0;
          parcelaPromo = produto.preco_promo || 0;
          valorNormal = produto.preco_normal || 0;
          valorPromo = produto.preco_promo || 0;
        } else {
          const parcelaProdutoNormal = calcularParcelaNormal(produto);
          const parcelaProdutoPromo = calcularParcela(produto);
          const valorGarantia = produto.valor_garantia || 0;
          const parcelasGarantia = produto.parcelas_garantia || produto.parcelas;
          
          let parcelaGarantiaCalc = 0;
          if (produto.tem_garantia && valorGarantia > 0) {
            const coef = produto.modalidade === 'carne' ? COEFICIENTES_CARNE[parcelasGarantia] : COEFICIENTES_CARTAO[parcelasGarantia];
            parcelaGarantiaCalc = valorGarantia * coef;
          }
          
          parcelaNormal = parcelaProdutoNormal + parcelaGarantiaCalc;
          parcelaPromo = parcelaProdutoPromo + parcelaGarantiaCalc;
          
          if (produto.tem_presta_mista && produto.modalidade === 'carne') {
            parcelaNormal = parcelaNormal * 1.06;
            parcelaPromo = parcelaPromo * 1.06;
          }
          
          valorNormal = parcelaNormal * produto.parcelas;
          valorPromo = parcelaPromo * produto.parcelas;
        }

        totalNormalGeral += valorNormal;
        totalPromoGeral += valorPromo;

        const economiaParcela = parcelaNormal - parcelaPromo;
        const percentual = parcelaNormal > 0 ? ((economiaParcela / parcelaNormal) * 100).toFixed(1) : 0;

        const modalidadeTexto = produto.modalidade === 'avista' ? '√Ä Vista' : 
                                produto.modalidade === 'carne' ? `Carn√™ ${produto.parcelas}x` : 
                                `Cart√£o ${produto.parcelas}x`;

        return `
          <tr class="border-b border-emerald-200 hover:bg-emerald-50 transition-colors">
            <td class="p-2 text-xs font-semibold text-gray-800">${produto.codigo_nome || `Produto #${index + 1}`}</td>
            <td class="p-2 text-xs text-center text-gray-700">${modalidadeTexto}</td>
            <td class="p-2 text-xs text-right font-bold text-red-600">${formatarMoedaBR(parcelaNormal)}</td>
            <td class="p-2 text-xs text-right font-bold text-green-600">${formatarMoedaBR(parcelaPromo)}</td>
            <td class="p-2 text-xs text-right font-bold text-blue-600">${formatarMoedaBR(economiaParcela)}</td>
            <td class="p-2 text-xs text-center font-bold text-orange-600">${percentual}%</td>
          </tr>
        `;
      }).join('');

      const economiaTotal = totalNormalGeral - totalPromoGeral;
      const percentualTotal = totalNormalGeral > 0 ? ((economiaTotal / totalNormalGeral) * 100).toFixed(1) : 0;

      container.innerHTML = `
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gradient-to-r from-emerald-100 to-green-100">
                  <th class="p-2 text-left text-xs font-bold text-gray-800 border-b-2 border-emerald-300">Produto</th>
                  <th class="p-2 text-center text-xs font-bold text-gray-800 border-b-2 border-emerald-300">Modalidade</th>
                  <th class="p-2 text-right text-xs font-bold text-gray-800 border-b-2 border-emerald-300">Parcela Normal</th>
                  <th class="p-2 text-right text-xs font-bold text-gray-800 border-b-2 border-emerald-300">Parcela Promo</th>
                  <th class="p-2 text-right text-xs font-bold text-gray-800 border-b-2 border-emerald-300">Economia/Parcela</th>
                  <th class="p-2 text-center text-xs font-bold text-gray-800 border-b-2 border-emerald-300">%</th>
                </tr>
              </thead>
              <tbody>
                ${linhasProdutos}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cards de Resumo -->
        ${(() => {
          // Calcular parcelas consolidadas
          let totalParcelaNormal = 0;
          let totalParcelaPromo = 0;
          let maxParcelas = 0;
          let temParcelado = false;

          produtos.forEach(produto => {
            if (produto.modalidade !== 'avista') {
              temParcelado = true;
              const parcelaProdutoNormal = calcularParcelaNormal(produto);
              const parcelaProdutoPromo = calcularParcela(produto);
              const valorGarantia = produto.valor_garantia || 0;
              const parcelasGarantia = produto.parcelas_garantia || produto.parcelas;
              
              let parcelaGarantiaCalc = 0;
              if (produto.tem_garantia && valorGarantia > 0) {
                const coef = produto.modalidade === 'carne' ? COEFICIENTES_CARNE[parcelasGarantia] : COEFICIENTES_CARTAO[parcelasGarantia];
                parcelaGarantiaCalc = valorGarantia * coef;
              }
              
              let parcelaNormal = parcelaProdutoNormal + parcelaGarantiaCalc;
              let parcelaPromo = parcelaProdutoPromo + parcelaGarantiaCalc;
              
              if (produto.tem_presta_mista && produto.modalidade === 'carne') {
                parcelaNormal = parcelaNormal * 1.06;
                parcelaPromo = parcelaPromo * 1.06;
              }
              
              totalParcelaNormal += parcelaNormal;
              totalParcelaPromo += parcelaPromo;
              
              if (produto.parcelas > maxParcelas) {
                maxParcelas = produto.parcelas;
              }
            }
          });

          if (temParcelado) {
            const economiaParcela = totalParcelaNormal - totalParcelaPromo;
            const percentualParcela = totalParcelaNormal > 0 ? ((economiaParcela / totalParcelaNormal) * 100).toFixed(1) : 0;

            return `
              <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
                <div class="bg-gradient-to-br from-red-50 to-pink-50 rounded-lg p-3 border border-red-300 text-center">
                  <p class="text-xs text-gray-600 mb-1">üíµ Parcela Normal</p>
                  <p class="text-lg font-bold text-red-600">${maxParcelas}x ${formatarMoedaBR(totalParcelaNormal)}</p>
                  <p class="text-xs text-gray-400 mt-1">Total: ${formatarMoedaBR(totalNormalGeral)}</p>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border-2 border-green-400 text-center">
                  <p class="text-xs text-gray-700 font-semibold mb-1">‚úÖ Parcela Promo</p>
                  <p class="text-xl font-bold text-green-600">${maxParcelas}x ${formatarMoedaBR(totalParcelaPromo)}</p>
                  <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(totalPromoGeral)}</p>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-400 text-center">
                  <p class="text-xs text-gray-600 mb-1">üéâ Economia/Parcela</p>
                  <p class="text-xl font-bold text-blue-600">${formatarMoedaBR(economiaParcela)}</p>
                  <p class="text-sm text-orange-600 font-bold mt-1">${percentualParcela}%</p>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-400 text-center">
                  <p class="text-xs text-gray-600 mb-1">üí∞ Economia Total</p>
                  <p class="text-xl font-bold text-purple-600">${formatarMoedaBR(economiaTotal)}</p>
                  <p class="text-sm text-orange-600 font-bold mt-1">${percentualTotal}%</p>
                </div>
              </div>
            `;
          } else {
            // Apenas produtos √† vista
            return `
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
                <div class="bg-gradient-to-br from-red-50 to-pink-50 rounded-lg p-3 border border-red-300 text-center">
                  <p class="text-xs text-gray-600 mb-1">üíµ Valor Total Normal</p>
                  <p class="text-lg font-bold text-red-600">${formatarMoedaBR(totalNormalGeral)}</p>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border-2 border-green-400 text-center">
                  <p class="text-xs text-gray-700 font-semibold mb-1">‚úÖ Valor Total Promo</p>
                  <p class="text-xl font-bold text-green-600">${formatarMoedaBR(totalPromoGeral)}</p>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-400 text-center">
                  <p class="text-xs text-gray-600 mb-1">üéâ Economia Total</p>
                  <p class="text-xl font-bold text-blue-600">${formatarMoedaBR(economiaTotal)}</p>
                  <p class="text-sm text-orange-600 font-bold mt-1">${percentualTotal}%</p>
                </div>
              </div>
            `;
          }
        })()}
      `;
    }

    function adicionarProduto() {
      if (produtos.length >= MAX_PRODUTOS) {
        showToast(`‚ö†Ô∏è M√°ximo de ${MAX_PRODUTOS} produtos atingido`, 'error');
        return;
      }

      produtos.push({
        id: Date.now().toString(),
        codigo_nome: '',
        preco_normal: 0,
        preco_promo: 0,
        modalidade: 'avista',
        parcelas: 1,
        tem_garantia: false,
        valor_garantia: 0,
        parcelas_garantia: 1,
        tem_presta_mista: false,
        expandido: true
      });

      renderProdutos();
      showToast('‚úÖ Produto adicionado!', 'success');
    }

    function toggleGarantia(id) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.tem_garantia = !produto.tem_garantia;
        if (!produto.tem_garantia) {
          produto.valor_garantia = 0;
        }
        produto.parcelas_garantia = produto.parcelas;
        renderProdutos();
        atualizarBotaoExclusivo();
        showToast(produto.tem_garantia ? '‚úÖ Garantia ativada!' : '‚ùå Garantia desativada', 'success');
      }
    }

    function togglePrestaMista(id) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.tem_presta_mista = !produto.tem_presta_mista;
        renderProdutos();
        showToast(produto.tem_presta_mista ? '‚úÖ Presta Mista ativada (+6%)!' : '‚ùå Presta Mista desativada', 'success');
      }
    }

    function formatarCampoGarantia(inputId, produtoId) {
      const input = document.getElementById(inputId);
      const valor = parseFloat(input.value.replace(',', '.')) || 0;
      input.value = formatarMoeda(valor);
      
      const produto = produtos.find(p => p.id === produtoId);
      if (produto) {
        produto.valor_garantia = valor;
        renderProdutos();
        atualizarBotaoExclusivo();
      }
    }

    function removerProduto(id) {
      produtos = produtos.filter(p => p.id !== id);
      renderProdutos();
      
      if (produtos.length === 0) {
        planoExclusivoVisivel = false;
        atualizarVisibilidadeSecaoPlano();
        const btn = document.getElementById('btnTogglePlanoExclusivo');
        if (btn) {
          btn.innerHTML = '<span>üíé</span><span>Abrir Plano Exclusivo</span>';
          btn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
        }
      }
      
      showToast('üóëÔ∏è Produto removido', 'success');
    }

    function toggleProduto(id) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto.expandido = !produto.expandido;
        renderProdutos();
      }
    }

    function atualizarProduto(id, campo, valor) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        produto[campo] = valor;
        atualizarCamposParcelamento();
      }
    }

    function atualizarTituloProduto(id, valor) {
      const produto = produtos.find(p => p.id === id);
      if (produto) {
        const index = produtos.indexOf(produto);
        const headerElement = document.querySelector(`[onclick="toggleProduto('${id}')"] h3`);
        if (headerElement) {
          headerElement.textContent = valor ? valor : `Produto #${index + 1}`;
        }
      }
    }

    function atualizarCamposParcelamento() {
      produtos.forEach(produto => {
        const modalidadeSelect = document.getElementById(`modalidade_${produto.id}`);
        const parcelasSelect = document.getElementById(`parcelas_${produto.id}`);

        if (modalidadeSelect && parcelasSelect) {
          if (produto.modalidade === 'avista') {
            parcelasSelect.disabled = true;
            parcelasSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
          } else {
            parcelasSelect.disabled = false;
            parcelasSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
          }
        }
      });
      
      renderProdutos();
      atualizarBotaoExclusivo();
    }

    function calcularParcela(produto) {
      if (produto.modalidade === 'avista') return produto.preco_promo;

      const parcelas = parseInt(produto.parcelas) || 1;
      const valorPresente = produto.preco_promo;
      
      const coeficiente = produto.modalidade === 'carne' 
        ? COEFICIENTES_CARNE[parcelas] 
        : COEFICIENTES_CARTAO[parcelas];

      let valorParcela = valorPresente * coeficiente;

      if (produto.modalidade === 'carne' && produto.tem_servico && produto.tipo_servico === 'pm') {
        valorParcela = valorParcela * (1 + TAXA_PM);
      }

      return valorParcela;
    }

    function calcularValorTotal(produto) {
      if (produto.modalidade === 'avista') return produto.preco_promo;
      const valorParcela = calcularParcela(produto);
      return valorParcela * parseInt(produto.parcelas);
    }

    function calcularParcelaNormal(produto) {
      if (produto.modalidade === 'avista') return produto.preco_normal;

      const parcelas = parseInt(produto.parcelas) || 1;
      const valorPresente = produto.preco_normal;
      
      const coeficiente = produto.modalidade === 'carne' 
        ? COEFICIENTES_CARNE[parcelas] 
        : COEFICIENTES_CARTAO[parcelas];

      let valorParcela = valorPresente * coeficiente;

      if (produto.modalidade === 'carne' && produto.tem_servico && produto.tipo_servico === 'pm') {
        valorParcela = valorParcela * (1 + TAXA_PM);
      }

      return valorParcela;
    }

    function calcularParcelaGE(produto) {
      const valorGE = produto.valor_ge || 0;
      if (valorGE === 0) return 0;

      const parcelas = parseInt(produto.parcelas_ge || produto.parcelas) || 1;
      
      const coeficiente = produto.modalidade === 'carne' 
        ? COEFICIENTES_CARNE[parcelas] 
        : COEFICIENTES_CARTAO[parcelas];

      const valorParcela = valorGE * coeficiente;
      return valorParcela;
    }

    function renderProdutos() {
      const container = document.getElementById('listaProdutos');

      if (produtos.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
            <div class="text-6xl mb-4">üì¶</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhum produto adicionado</h3>
            <p class="text-gray-500 mb-4">Clique em "Adicionar Produto" para come√ßar</p>
          </div>
        `;
        
        // Esconder resumo financeiro quando n√£o h√° produtos
        const secaoResumo = document.getElementById('secaoResumoFinanceiro');
        if (secaoResumo) {
          secaoResumo.classList.add('hidden');
        }
        const containerResumo = document.getElementById('resumoFinanceiroContent');
        if (containerResumo) {
          containerResumo.innerHTML = '';
        }
        
        return;
      }

      renderPlanoExclusivo();
      renderResumoFinanceiro();
      
      container.innerHTML = produtos.map((produto, index) => {
        const desconto = produto.preco_normal - produto.preco_promo;
        const percentualProduto = produto.preco_normal > 0 ? ((desconto / produto.preco_normal) * 100).toFixed(1) : 0;
        const valorParcela = calcularParcela(produto);
        const valorTotal = calcularValorTotal(produto);
        const temServico = produto.tem_servico || false;
        const tipoServico = produto.tipo_servico || 'ge';

        return `
        <div class="produto-item bg-white rounded-xl border-2 border-gray-300 overflow-hidden">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white p-4 cursor-pointer hover:from-blue-600 hover:to-indigo-600 transition-all" onclick="toggleProduto('${produto.id}')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl">üìÇ</span>
                <div>
                  <h3 class="text-lg font-bold">${produto.codigo_nome ? produto.codigo_nome : `Produto #${index + 1}`}</h3>
                  <p class="text-sm text-blue-100">${produto.expandido ? 'Clique para recolher' : 'Clique para expandir'}</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                ${!produto.expandido ? `
                  <div class="text-right">
                    ${(() => {
                      if (produto.modalidade === 'avista') {
                        return `
                          <p class="text-sm font-semibold text-blue-100">üí∞ √Ä Vista</p>
                          <p class="text-lg font-bold">${formatarMoedaBR(produto.preco_promo)}</p>
                        `;
                      } else {
                        const parcelaProdutoPromo = calcularParcela(produto);
                        const valorGarantia = produto.valor_garantia || 0;
                        const parcelasGarantia = produto.parcelas_garantia || produto.parcelas;
                        
                        let parcelaGarantiaCalculada = 0;
                        if (produto.tem_garantia && valorGarantia > 0) {
                          const coeficiente = produto.modalidade === 'carne' 
                            ? COEFICIENTES_CARNE[parcelasGarantia] 
                            : COEFICIENTES_CARTAO[parcelasGarantia];
                          parcelaGarantiaCalculada = valorGarantia * coeficiente;
                        }
                        
                        let parcelaFinalPromo = parcelaProdutoPromo;
                        
                        if (produto.tem_garantia && valorGarantia > 0) {
                          parcelaFinalPromo += parcelaGarantiaCalculada;
                        }
                        
                        if (produto.tem_presta_mista && produto.modalidade === 'carne') {
                          parcelaFinalPromo = parcelaFinalPromo * 1.06;
                        }
                        
                        const modalidadeNome = produto.modalidade === 'carne' ? 'üìù Carn√™' : 'üí≥ Cart√£o';
                        
                        return `
                          <p class="text-sm font-semibold text-blue-100">${modalidadeNome}</p>
                          <p class="text-lg font-bold">${formatarMoedaBR(parcelaFinalPromo)} <span class="text-sm">x${produto.parcelas}</span></p>
                        `;
                      }
                    })()}
                  </div>
                ` : ''}
                <button
                  onclick="event.stopPropagation(); removerProduto('${produto.id}')"
                  class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-semibold transition-all flex items-center gap-1"
                >
                  <span>üóëÔ∏è</span>
                </button>
              </div>
            </div>
          </div>

          ${produto.expandido ? `
            <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üè∑Ô∏è C√≥digo / Nome do Produto
                  </label>
                  <input
                    type="text"
                    id="codigo_nome_${produto.id}"
                    value="${produto.codigo_nome || ''}"
                    onchange="atualizarProduto('${produto.id}', 'codigo_nome', this.value); atualizarTituloProduto('${produto.id}', this.value)"
                    placeholder="Ex: COD123 - Nome do Produto"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üíµ Pre√ßo Normal (R$)
                  </label>
                  <input
                    type="text"
                    id="preco_normal_${produto.id}"
                    value="${formatarMoeda(produto.preco_normal)}"
                    onfocus="limparCampo('preco_normal_${produto.id}')"
                    onblur="formatarCampo('preco_normal_${produto.id}')"
                    placeholder="R$ 0,00"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üè∑Ô∏è Pre√ßo Promocional (R$)
                  </label>
                  <input
                    type="text"
                    id="preco_promo_${produto.id}"
                    value="${formatarMoeda(produto.preco_promo)}"
                    onfocus="limparCampo('preco_promo_${produto.id}')"
                    onblur="formatarCampo('preco_promo_${produto.id}')"
                    placeholder="R$ 0,00"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üí≥ Modalidade de Pagamento
                  </label>
                  <select
                    id="modalidade_${produto.id}"
                    onchange="atualizarProduto('${produto.id}', 'modalidade', this.value); atualizarCamposParcelamento();"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all"
                  >
                    <option value="avista" ${produto.modalidade === 'avista' ? 'selected' : ''}>üí∞ √Ä Vista</option>
                    <option value="carne" ${produto.modalidade === 'carne' ? 'selected' : ''}>üìù Carn√™</option>
                    <option value="cartao" ${produto.modalidade === 'cartao' ? 'selected' : ''}>üí≥ Cart√£o</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üìä N√∫mero de Parcelas
                  </label>
                  <select
                    id="parcelas_${produto.id}"
                    onchange="atualizarProduto('${produto.id}', 'parcelas', parseInt(this.value)); atualizarCamposParcelamento();"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 transition-all ${produto.modalidade === 'avista' ? 'bg-gray-100 cursor-not-allowed' : ''}"
                    ${produto.modalidade === 'avista' ? 'disabled' : ''}
                  >
                    ${[1,2,3,4,5,6,7,8,9,10,11,12].map(n => `<option value="${n}" ${produto.parcelas === n ? 'selected' : ''}>${n}x</option>`).join('')}
                  </select>
                </div>
              </div>

              <!-- OpÔøΩÔøΩ√µes de Garantia (apenas para Carn√™ e Cart√£o) -->
              ${produto.modalidade !== 'avista' ? `
                <div class="mt-4 flex flex-wrap gap-3">
                  <button
                    type="button"
                    onclick="toggleGarantia('${produto.id}')"
                    class="px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 ${produto.tem_garantia ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                  >
                    <span>${produto.tem_garantia ? '‚úÖ' : '‚¨ú'}</span>
                    <span>Garantia Estendida</span>
                  </button>
                  
                  ${produto.modalidade === 'carne' ? `
                    <button
                      type="button"
                      onclick="togglePrestaMista('${produto.id}')"
                      class="px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 ${produto.tem_presta_mista ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                    >
                      <span>${produto.tem_presta_mista ? '‚úÖ' : '‚¨ú'}</span>
                      <span>Presta Mista (+6%)</span>
                    </button>
                  ` : ''}
                </div>

                <!-- Campos de Garantia Estendida -->
                ${produto.tem_garantia ? `
                  <div class="mt-4 p-4 bg-green-50 rounded-xl border-2 border-green-300">
                    <h5 class="text-sm font-bold text-green-800 mb-3 flex items-center gap-2">
                      <span>üõ°Ô∏è</span>
                      <span>Configura√ß√£o da Garantia Estendida</span>
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2">
                          üí∞ Valor da Garantia (R$)
                        </label>
                        <input
                          type="text"
                          id="valor_garantia_${produto.id}"
                          value="${formatarMoeda(produto.valor_garantia || 0)}"
                          onfocus="limparCampo('valor_garantia_${produto.id}')"
                          onblur="formatarCampoGarantia('valor_garantia_${produto.id}', '${produto.id}')"
                          placeholder="R$ 0,00"
                          class="w-full px-3 py-2 border-2 border-green-300 rounded-lg focus:border-green-500 transition-all"
                        />
                      </div>

                    </div>
                  </div>
                ` : ''}
              ` : ''}

              <!-- Resumo do Produto -->
              ${produto.preco_promo > 0 ? `
              <div class="mt-6 bg-white rounded-xl p-5 border-2 border-gray-200 shadow-sm">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <span>üí∞</span>
                  <span>Resumo Financeiro</span>
                </h4>
                
                ${produto.modalidade === 'avista' ? `
                  <!-- √Ä VISTA -->
                  <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                      <span class="text-sm text-gray-700">üíµ Pre√ßo Normal √† Vista</span>
                      <span class="text-lg font-bold text-red-600 line-through">${formatarMoedaBR(produto.preco_normal)}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border-2 border-green-400">
                      <span class="text-sm font-semibold text-gray-700">‚úÖ Pre√ßo Promocional √† Vista</span>
                      <span class="text-2xl font-bold text-green-600">${formatarMoedaBR(produto.preco_promo)}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <span class="text-sm text-gray-700">üéâ Economia Total</span>
                      <span class="text-lg font-bold text-blue-600">${formatarMoedaBR(desconto)} (${percentualProduto}% de desconto)</span>
                    </div>
                  </div>
                ` : `
                  <!-- PARCELADO (Carn√™ ou Cart√£o) -->
                  ${(() => {
                    const parcelaProdutoPromo = calcularParcela(produto);
                    const parcelaProdutoNormal = calcularParcelaNormal(produto);
                    const valorGarantia = produto.valor_garantia || 0;
                    const parcelasGarantia = produto.parcelas_garantia || produto.parcelas;
                    
                    let parcelaGarantiaCalculada = 0;
                    if (produto.tem_garantia && valorGarantia > 0) {
                      const coeficiente = produto.modalidade === 'carne' 
                        ? COEFICIENTES_CARNE[parcelasGarantia] 
                        : COEFICIENTES_CARTAO[parcelasGarantia];
                      parcelaGarantiaCalculada = valorGarantia * coeficiente;
                    }
                    
                    let parcelaFinalPromo = parcelaProdutoPromo;
                    let parcelaFinalNormal = parcelaProdutoNormal;
                    let totalFinalPromo = parcelaProdutoPromo * produto.parcelas;
                    let totalFinalNormal = parcelaProdutoNormal * produto.parcelas;
                    
                    if (produto.tem_garantia && valorGarantia > 0) {
                      parcelaFinalPromo += parcelaGarantiaCalculada;
                      parcelaFinalNormal += parcelaGarantiaCalculada;
                      totalFinalPromo += parcelaGarantiaCalculada * parcelasGarantia;
                      totalFinalNormal += parcelaGarantiaCalculada * parcelasGarantia;
                    }
                    
                    if (produto.tem_presta_mista && produto.modalidade === 'carne') {
                      parcelaFinalPromo = parcelaFinalPromo * 1.06;
                      parcelaFinalNormal = parcelaFinalNormal * 1.06;
                      totalFinalPromo = totalFinalPromo * 1.06;
                      totalFinalNormal = totalFinalNormal * 1.06;
                    }
                    
                    const temBeneficios = (produto.tem_garantia && valorGarantia > 0) || (produto.tem_presta_mista && produto.modalidade === 'carne');
                    
                    return `
                  <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                      <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                        <p class="text-xs text-gray-600 mb-1">‚ùå Parcela no Pre√ßo Normal</p>
                        <p class="text-sm font-bold text-red-600 line-through">${formatarMoedaBR(parcelaFinalNormal)}</p>
                        <p class="text-xs text-gray-500">${produto.parcelas}x</p>
                      </div>
                      <div class="p-3 bg-green-50 rounded-lg border-2 border-green-400">
                        <p class="text-xs text-gray-700 mb-1 font-semibold">‚úÖ Parcela no Pre√ßo Promocional${temBeneficios ? ' + Benef√≠cios' : ''}</p>
                        <p class="text-xl font-bold text-green-600">${formatarMoedaBR(parcelaFinalPromo)}</p>
                        <p class="text-xs text-gray-600 font-semibold">${produto.parcelas}x</p>
                      </div>
                    </div>
                    
                    ${produto.tem_garantia && produto.valor_garantia > 0 || produto.tem_presta_mista ? `
                      <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-300">
                        <p class="text-xs text-gray-700 mb-2 font-semibold">üìã Benef√≠cios Inclusos:</p>
                        ${produto.tem_garantia && produto.valor_garantia > 0 ? `<p class="text-xs text-green-600">‚úÖ Garantia Estendida</p>` : ''}
                        ${produto.tem_presta_mista && produto.modalidade === 'carne' ? `<p class="text-xs text-blue-600">‚úÖ Presta Mista (+6%)</p>` : ''}
                      </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-3">
                      <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-xs text-gray-600 mb-1">üíµ Total no Pre√ßo Normal</p>
                        <p class="text-sm font-bold text-gray-700 line-through">${formatarMoedaBR(totalFinalNormal)}</p>
                      </div>
                      <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">üíµ Total no Pre√ßo Promocional${temBeneficios ? ' + Benef√≠cios' : ''}</p>
                        <p class="text-lg font-bold text-purple-600">${formatarMoedaBR(totalFinalPromo)}</p>
                      </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-400">
                      <span class="text-sm font-semibold text-gray-700">üéâ Economia Total no ${produto.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o'}</span>
                      <span class="text-xl font-bold text-green-600">${formatarMoedaBR(totalFinalNormal - totalFinalPromo)} (${percentualProduto}% de desconto)</span>
                    </div>
                  </div>
                    `;
                  })()}
                `}
              </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;
      }).join('');
    }

    function verificarBloqueioExclusivo() {
      if (produtos.length === 0) {
        return true;
      }
      
      const produtosSemBeneficios = produtos.filter(p => {
        if (p.modalidade === 'avista') {
          return false;
        }
        
        // Para Carn√™: precisa ter Garantia OU Presta Mista
        if (p.modalidade === 'carne') {
          return !p.tem_garantia && !p.tem_presta_mista;
        }
        
        // Para Cart√£o: precisa ter Garantia (Presta Mista n√£o existe no Cart√£o)
        if (p.modalidade === 'cartao') {
          return !p.tem_garantia;
        }
        
        return false;
      });
      
      return produtosSemBeneficios.length > 0;
    }

    function atualizarVisibilidadeSecaoPlano() {
      const secao = document.getElementById('secaoPlanoExclusivo');
      if (!secao) return;
      
      if (planoExclusivoVisivel && produtos.length > 0) {
        secao.classList.remove('hidden');
      } else {
        secao.classList.add('hidden');
      }
    }

    function atualizarBotaoExclusivo() {
      const btn = document.getElementById('btnExclusivoGerente');
      if (!btn) return;
      
      const bloqueado = verificarBloqueioExclusivo();
      
      if (bloqueado) {
        btn.className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-400 text-gray-200 cursor-not-allowed opacity-60';
        btn.disabled = true;
      } else {
        btn.className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gradient-to-r from-yellow-400 to-orange-400 text-white hover:from-yellow-500 hover:to-orange-500 shadow-md';
        btn.disabled = false;
      }
    }

    function abrirExclusivoGerente() {
      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione produtos primeiro!', 'error');
        return;
      }
      
      if (verificarBloqueioExclusivo()) {
        showToast('üö´ BLOQUEADO! Ative GARANTIA ESTENDIDA e/ou PRESTA MISTA em todos os produtos parcelados antes de abrir o Exclusivo Gerente.', 'error');
        return;
      }
      
      exclusivoGerenteAberto = true;
      modalidadePlanoSelecionada = 'exclusivo';
      renderPlanoExclusivo();
      showToast('‚≠ê Exclusivo Gerente aberto! Selecione a modalidade.', 'success');
    }
    
    function selecionarModalidadeExclusivo(modalidade) {
      modalidadeExclusivoSelecionada = modalidade;
      renderPlanoExclusivo();
      const nomeModalidade = modalidade === 'carne' ? 'Carn√™ 5x' : 'Cart√£o 6x';
      showToast(`‚úÖ ${nomeModalidade} selecionado!`, 'success');
    }
    
    function fecharExclusivoGerente() {
      exclusivoGerenteAberto = false;
      modalidadePlanoSelecionada = null;
      modalidadeExclusivoSelecionada = null;
      renderPlanoExclusivo();
      showToast('‚ùå Exclusivo Gerente fechado', 'success');
    }

    function selecionarModalidadePlano(modalidade) {
      modalidadePlanoSelecionada = modalidade;
      exclusivoGerenteAberto = false;
      modalidadeExclusivoSelecionada = null;
      
      document.getElementById('btnModalidadeAvista').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('btnModalidadeCarne').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('btnModalidadeCartao').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      
      if (modalidade === 'avista') {
        document.getElementById('btnModalidadeAvista').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg';
      } else if (modalidade === 'carne') {
        document.getElementById('btnModalidadeCarne').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg';
      } else if (modalidade === 'cartao') {
        document.getElementById('btnModalidadeCartao').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg';
      }
      
      renderPlanoExclusivo();
      const nomeModalidade = modalidade === 'avista' ? '√Ä Vista' : modalidade === 'carne' ? 'Carn√™' : 'Cart√£o';
      showToast(`‚úÖ Modalidade ${nomeModalidade} selecionada!`, 'success');
    }

    function renderPlanoExclusivo() {
      const container = document.getElementById('planoExclusivoContent');

      if (produtos.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 bg-white rounded-xl border-2 border-dashed border-purple-300">
            <div class="text-4xl mb-3">üìä</div>
            <p class="text-gray-600">Adicione produtos para visualizar o Plano Exclusivo</p>
          </div>
        `;
        return;
      }

      if (!modalidadePlanoSelecionada) {
        container.innerHTML = `
          <div class="text-center py-8 bg-white rounded-xl border-2 border-dashed border-purple-300">
            <div class="text-4xl mb-3">üëÜ</div>
            <p class="text-gray-600 font-semibold">Selecione uma modalidade de pagamento acima</p>
          </div>
        `;
        return;
      }

      // MODO √Ä VISTA
      if (modalidadePlanoSelecionada === 'avista') {
        let totalNormal = 0;
        let totalPromo = 0;
        
        produtos.forEach(produto => {
          totalNormal += produto.preco_normal || 0;
          totalPromo += produto.preco_promo || 0;
        });
        
        const economia = totalNormal - totalPromo;
        const percentual = totalNormal > 0 ? ((economia / totalNormal) * 100).toFixed(1) : 0;
        
        container.innerHTML = `
          <div class="bg-white rounded-xl p-6 shadow-md border-2 border-green-300">
            <h3 class="text-2xl font-bold text-green-700 mb-6 flex items-center gap-2">
              <span>üí∞</span>
              <span>Plano Consolidado - √Ä Vista</span>
            </h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- PREÔøΩÔøΩÔøΩÔøΩO TABELA -->
              <div class="bg-red-50 rounded-xl p-6 border-2 border-red-300">
                <h4 class="text-lg font-bold text-red-700 mb-4 flex items-center gap-2">
                  <span>‚ùå</span>
                  <span>Pre√ßo de Tabela</span>
                </h4>
                <div class="text-center">
                  <p class="text-sm text-gray-600 mb-2">Total de ${produtos.length} produto(s)</p>
                  <p class="text-4xl font-bold text-red-600 line-through">${formatarMoedaBR(totalNormal)}</p>
                </div>
              </div>
              
              <!-- PRE√áO PROMOCIONAL -->
              <div class="bg-green-50 rounded-xl p-6 border-2 border-green-400">
                <h4 class="text-lg font-bold text-green-700 mb-4 flex items-center gap-2">
                  <span>‚úÖ</span>
                  <span>Pre√ßo Promocional</span>
                </h4>
                <div class="text-center">
                  <p class="text-sm text-gray-600 mb-2">Total de ${produtos.length} produto(s)</p>
                  <p class="text-5xl font-bold text-green-600">${formatarMoedaBR(totalPromo)}</p>
                </div>
              </div>
            </div>
            
            <!-- ECONOMIA -->
            <div class="mt-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-300">
              <div class="text-center">
                <p class="text-lg text-gray-700 mb-2">üéâ <strong>Economia Total</strong></p>
                <p class="text-4xl font-bold text-blue-600">${formatarMoedaBR(economia)}</p>
                <p class="text-xl text-blue-500 font-semibold mt-2">${percentual}% de desconto</p>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      // MODO EXCLUSIVO GERENTE
      if (modalidadePlanoSelecionada === 'exclusivo' && exclusivoGerenteAberto) {
        
        if (!modalidadeExclusivoSelecionada) {
          container.innerHTML = `
            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 shadow-md border-2 border-yellow-400">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-orange-800 flex items-center gap-2">
                  <span>‚≠ê</span>
                  <span>Exclusivo Gerente - Selecione a Modalidade</span>
                </h3>
                <button
                  onclick="fecharExclusivoGerente()"
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                >
                  ‚ùå Fechar
                </button>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button
                  onclick="selecionarModalidadeExclusivo('carne')"
                  class="p-8 bg-white hover:bg-blue-50 rounded-xl border-2 border-blue-300 hover:border-blue-500 transition-all"
                >
                  <div class="flex items-center justify-center gap-3">
                    <span class="text-5xl">üìù</span>
                    <h4 class="text-2xl font-bold text-blue-700">Carn√™ 5x</h4>
                  </div>
                </button>
                
                <button
                  onclick="selecionarModalidadeExclusivo('cartao')"
                  class="p-8 bg-white hover:bg-purple-50 rounded-xl border-2 border-purple-300 hover:border-purple-500 transition-all"
                >
                  <div class="flex items-center justify-center gap-3">
                    <span class="text-5xl">üí≥</span>
                    <h4 class="text-2xl font-bold text-purple-700">Cart√£o 6x</h4>
                  </div>
                </button>
              </div>
            </div>
          `;
          return;
        }
        
        if (modalidadeExclusivoSelecionada === 'carne') {
          const opcoesCarneConsolidadas = [];
          
          for (let parcelas = 1; parcelas <= 5; parcelas++) {
            let totalCarneComJuros = 0;
            let totalCarneSemJuros = 0;
            
            produtos.forEach(produto => {
              const precoNormal = produto.preco_normal || 0;
              const valorGarantia = produto.valor_garantia || 0;
              
              const coefCarne = COEFICIENTES_CARNE[parcelas];
              const parcelaProdutoComJuros = precoNormal * coefCarne;
              const parcelaGarantiaComJuros = valorGarantia * coefCarne;
              let parcelaComJuros = parcelaProdutoComJuros + parcelaGarantiaComJuros;
              parcelaComJuros = parcelaComJuros * 1.06;
              totalCarneComJuros += parcelaComJuros * parcelas;
              
              const totalSemJuros = (precoNormal + valorGarantia) * 1.06;
              totalCarneSemJuros += totalSemJuros;
            });
            
            const parcelaCarneComJuros = totalCarneComJuros / parcelas;
            const parcelaCarneSemJuros = totalCarneSemJuros / parcelas;
            const economiaCarneTotal = totalCarneComJuros - totalCarneSemJuros;
            const percentualEconomiaCarne = totalCarneComJuros > 0 ? ((economiaCarneTotal / totalCarneComJuros) * 100).toFixed(1) : 0;
            
            opcoesCarneConsolidadas.push({
              parcelas,
              parcelaComJuros: parcelaCarneComJuros,
              parcelaSemJuros: parcelaCarneSemJuros,
              totalComJuros: totalCarneComJuros,
              totalSemJuros: totalCarneSemJuros,
              economia: economiaCarneTotal,
              percentual: percentualEconomiaCarne
            });
          }
          
          container.innerHTML = `
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 shadow-md border-2 border-blue-400">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-blue-800 flex items-center gap-2">
                  <span>üìù</span>
                  <span>Exclusivo Gerente - CarnÔøΩÔøΩ</span>
                </h3>
                <div class="flex gap-2">
                  <button
                    onclick="modalidadeExclusivoSelecionada = null; renderPlanoExclusivo();"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                  >
                    ‚¨ÖÔ∏è Voltar
                  </button>
                  <button
                    onclick="fecharExclusivoGerente()"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                  >
                    ‚ùå Fechar
                  </button>
                </div>
              </div>
              
              <p class="text-sm text-gray-700 mb-6 font-semibold">
                ÔøΩÔøΩÔøΩ Total de ${produtos.length} produto(s) consolidados | 
                üí° Compara√ß√£o: SEM BENEFICIO vs COM BENEFICIOS ZENIR (1x a 5x)
              </p>
              
              <div class="overflow-x-auto mb-4">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-gradient-to-r from-blue-100 to-indigo-100">
                      <th class="border-2 border-blue-300 p-3 text-left font-bold text-gray-800">Parcelas</th>
                      <th class="border-2 border-red-300 p-3 text-center font-bold text-red-700 bg-red-50">‚ùå SEM BENEFICIO<br><span class="text-xs font-normal">Parcela | Total</span></th>
                      <th class="border-2 border-green-300 p-3 text-center font-bold text-green-700 bg-green-50">‚úÖ COM BENEFICIOS ZENIR<br><span class="text-xs font-normal">Parcela | Total</span></th>
                      <th class="border-2 border-blue-300 p-3 text-center font-bold text-blue-700 bg-blue-50">üí∞ Economia<br><span class="text-xs font-normal">Valor | %</span></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${opcoesCarneConsolidadas.map(op => `
                      <tr class="hover:bg-blue-50 transition-colors">
                        <td class="border-2 border-gray-300 p-3 font-bold text-gray-800">
                          ${op.parcelas}x
                        </td>
                        <td class="border-2 border-red-200 p-3 text-center bg-red-50">
                          <p class="text-lg font-bold text-red-600">${formatarMoedaBR(op.parcelaComJuros)}</p>
                          <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(op.totalComJuros)}</p>
                        </td>
                        <td class="border-2 border-green-200 p-3 text-center bg-green-50">
                          <p class="text-lg font-bold text-green-600">${formatarMoedaBR(op.parcelaSemJuros)}</p>
                          <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(op.totalSemJuros)}</p>
                        </td>
                        <td class="border-2 border-blue-200 p-3 text-center bg-blue-50">
                          <p class="text-lg font-bold text-blue-600">${formatarMoedaBR(op.economia)}</p>
                          <p class="text-xs text-blue-500 font-semibold mt-1">${op.percentual}% OFF</p>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
          return;
        }
        
        if (modalidadeExclusivoSelecionada === 'cartao') {
          const opcoesCartaoConsolidadas = [];
          
          for (let parcelas = 1; parcelas <= 6; parcelas++) {
            let totalCartaoComJuros = 0;
            let totalCartaoSemJuros = 0;
            
            produtos.forEach(produto => {
              const precoNormal = produto.preco_normal || 0;
              const valorGarantia = produto.valor_garantia || 0;
              
              const coefCartao = COEFICIENTES_CARTAO[parcelas];
              const parcelaProdutoComJuros = precoNormal * coefCartao;
              const parcelaGarantiaComJuros = valorGarantia * coefCartao;
              const parcelaComJuros = parcelaProdutoComJuros + parcelaGarantiaComJuros;
              totalCartaoComJuros += parcelaComJuros * parcelas;
              
              const totalSemJuros = precoNormal + valorGarantia;
              totalCartaoSemJuros += totalSemJuros;
            });
            
            const parcelaCartaoComJuros = totalCartaoComJuros / parcelas;
            const parcelaCartaoSemJuros = totalCartaoSemJuros / parcelas;
            const economiaCartaoTotal = totalCartaoComJuros - totalCartaoSemJuros;
            const percentualEconomiaCartao = totalCartaoComJuros > 0 ? ((economiaCartaoTotal / totalCartaoComJuros) * 100).toFixed(1) : 0;
            
            opcoesCartaoConsolidadas.push({
              parcelas,
              parcelaComJuros: parcelaCartaoComJuros,
              parcelaSemJuros: parcelaCartaoSemJuros,
              totalComJuros: totalCartaoComJuros,
              totalSemJuros: totalCartaoSemJuros,
              economia: economiaCartaoTotal,
              percentual: percentualEconomiaCartao
            });
          }
          
          container.innerHTML = `
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 shadow-md border-2 border-purple-400">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-purple-800 flex items-center gap-2">
                  <span>ÔøΩÔøΩÔøΩ</span>
                  <span>Exclusivo Gerente - Cart√£o</span>
                </h3>
                <div class="flex gap-2">
                  <button
                    onclick="modalidadeExclusivoSelecionada = null; renderPlanoExclusivo();"
                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                  >
                    ‚¨ÖÔ∏è Voltar
                  </button>
                  <button
                    onclick="fecharExclusivoGerente()"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                  >
                    ‚ùå Fechar
                  </button>
                </div>
              </div>
              
              <p class="text-sm text-gray-700 mb-6 font-semibold">
                ÔøΩÔøΩÔøΩÔøΩ Total de ${produtos.length} produto(s) consolidados | 
                üí° Compara√ß√£o: SEM BENEFICIO vs COM BENEFICIO (+12) (1x a 6x)
              </p>
              
              <div class="overflow-x-auto mb-4">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-gradient-to-r from-purple-100 to-pink-100">
                      <th class="border-2 border-purple-300 p-3 text-left font-bold text-gray-800">Parcelas</th>
                      <th class="border-2 border-red-300 p-3 text-center font-bold text-red-700 bg-red-50">‚ùå SEM BENEFICIO<br><span class="text-xs font-normal">Parcela | Total</span></th>
                      <th class="border-2 border-green-300 p-3 text-center font-bold text-green-700 bg-green-50">‚úÖ COM BENEFICIOS ZENIR<br><span class="text-xs font-normal">Parcela | Total</span></th>
                      <th class="border-2 border-blue-300 p-3 text-center font-bold text-blue-700 bg-blue-50">ÔøΩÔøΩÔøΩÔøΩ Economia<br><span class="text-xs font-normal">Valor | %</span></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${opcoesCartaoConsolidadas.map(op => `
                      <tr class="hover:bg-purple-50 transition-colors">
                        <td class="border-2 border-gray-300 p-3 font-bold text-gray-800">
                          ${op.parcelas}x
                        </td>
                        <td class="border-2 border-red-200 p-3 text-center bg-red-50">
                          <p class="text-lg font-bold text-red-600">${formatarMoedaBR(op.parcelaComJuros)}</p>
                          <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(op.totalComJuros)}</p>
                        </td>
                        <td class="border-2 border-green-200 p-3 text-center bg-green-50">
                          <p class="text-lg font-bold text-green-600">${formatarMoedaBR(op.parcelaSemJuros)}</p>
                          <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(op.totalSemJuros)}</p>
                        </td>
                        <td class="border-2 border-blue-200 p-3 text-center bg-blue-50">
                          <p class="text-lg font-bold text-blue-600">${formatarMoedaBR(op.economia)}</p>
                          <p class="text-xs text-blue-500 font-semibold mt-1">${op.percentual}% OFF</p>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
          return;
        }
      }
      
      // MODO CARN√ä OU CART√ÉO
      const modalidade = modalidadePlanoSelecionada;
      const maxParcelas = modalidade === 'carne' ? 5 : 6;
      const coeficientes = modalidade === 'carne' ? COEFICIENTES_CARNE : COEFICIENTES_CARTAO;
      const modalidadeNome = modalidade === 'carne' ? 'Carn√™' : 'Cart√£o';
      const modalidadeIcon = modalidade === 'carne' ? 'üìù' : 'üí≥';
      
      const opcoesConsolidadas = [];
      
      for (let i = 1; i <= 12; i++) {
        let totalParcelaNormal = 0;
        let totalParcelaPromo = 0;
        let totalGeralNormal = 0;
        let totalGeralPromo = 0;
        
        produtos.forEach(produto => {
          const precoNormal = produto.preco_normal || 0;
          const precoPromo = produto.preco_promo || 0;
          const valorGarantia = produto.valor_garantia || 0;
          const coef = coeficientes[i];
          
          let parcelaProdutoNormal = precoNormal * coef;
          
          let parcelaGarantiaNormal = 0;
          if (valorGarantia > 0) {
            parcelaGarantiaNormal = valorGarantia * coef;
          }
          
          let parcelaNormal = parcelaProdutoNormal + parcelaGarantiaNormal;
          
          totalParcelaNormal += parcelaNormal;
          totalGeralNormal += parcelaNormal * i;
          
          let parcelaProdutoPromo = precoPromo * coef;
          
          let parcelaGarantiaPromo = 0;
          if (valorGarantia > 0) {
            parcelaGarantiaPromo = valorGarantia * coef;
          }
          
          let parcelaPromo = parcelaProdutoPromo + parcelaGarantiaPromo;
          
          totalParcelaPromo += parcelaPromo;
          totalGeralPromo += parcelaPromo * i;
        });
        
        const economia = totalGeralNormal - totalGeralPromo;
        const percentualEconomia = totalGeralNormal > 0 ? ((economia / totalGeralNormal) * 100).toFixed(1) : 0;
        
        opcoesConsolidadas.push({
          parcelas: i,
          parcelaNormal: totalParcelaNormal,
          parcelaPromo: totalParcelaPromo,
          totalNormal: totalGeralNormal,
          totalPromo: totalGeralPromo,
          economia: economia,
          percentualEconomia: percentualEconomia
        });
      }
      
      container.innerHTML = `
        <div class="bg-white rounded-xl p-6 shadow-md border-2 border-purple-300">
          <h3 class="text-2xl font-bold text-purple-800 mb-4 flex items-center gap-2">
            <span>${modalidadeIcon}</span>
            <span>Plano Consolidado - ${modalidadeNome}</span>
          </h3>
          
          <p class="text-xs text-gray-600 mb-4 font-semibold">üì¶ Total de ${produtos.length} produto(s) consolidados</p>
          
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gradient-to-r from-purple-100 to-pink-100">
                  <th class="border-2 border-purple-300 p-3 text-left font-bold text-gray-800">Parcelas</th>
                  <th class="border-2 border-red-300 p-3 text-center font-bold text-red-700 bg-red-50">‚ùå Pre√ßo Tabela<br><span class="text-xs font-normal">Parcela | Total</span></th>
                  <th class="border-2 border-green-300 p-3 text-center font-bold text-green-700 bg-green-50">‚úÖ Pre√ßo Promocional<br><span class="text-xs font-normal">Parcela | Total</span></th>
                  <th class="border-2 border-blue-300 p-3 text-center font-bold text-blue-700 bg-blue-50">ÔøΩÔøΩÔøΩÔøΩ Economia<br><span class="text-xs font-normal">Valor | %</span></th>
                </tr>
              </thead>
              <tbody>
                ${opcoesConsolidadas.map(op => `
                  <tr class="hover:bg-purple-50 transition-colors">
                    <td class="border-2 border-gray-300 p-3 font-bold text-gray-800">
                      ${op.parcelas}x
                    </td>
                    <td class="border-2 border-red-200 p-3 text-center bg-red-50">
                      <p class="text-lg font-bold text-red-600">${formatarMoedaBR(op.parcelaNormal)}</p>
                      <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(op.totalNormal)}</p>
                    </td>
                    <td class="border-2 border-green-200 p-3 text-center bg-green-50">
                      <p class="text-lg font-bold text-green-600">${formatarMoedaBR(op.parcelaPromo)}</p>
                      <p class="text-xs text-gray-500 mt-1">Total: ${formatarMoedaBR(op.totalPromo)}</p>
                    </td>
                    <td class="border-2 border-blue-200 p-3 text-center bg-blue-50">
                      <p class="text-lg font-bold text-blue-600">${formatarMoedaBR(op.economia)}</p>
                      <p class="text-xs text-blue-500 font-semibold mt-1">${op.percentualEconomia}% OFF</p>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
    }

    function formatarMoeda(valor) {
      if (!valor || valor === 0) return '';
      return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatarMoedaBR(valor) {
      if (!valor || valor === 0) return 'R$ 0,00';
      return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function limparCampo(inputId) {
      const input = document.getElementById(inputId);
      const valorAtual = input.value.replace(/[^\d,]/g, '').replace(',', '.');
      const numero = parseFloat(valorAtual) || 0;
      input.value = numero > 0 ? numero.toString() : '';
      input.select();
    }

    function formatarCampo(inputId) {
      const input = document.getElementById(inputId);
      const valor = parseFloat(input.value.replace(',', '.')) || 0;
      input.value = formatarMoeda(valor);
      
      if (inputId.startsWith('preco_normal_')) {
        const produtoId = inputId.replace('preco_normal_', '');
        atualizarProduto(produtoId, 'preco_normal', valor);
        renderProdutos();
      } else if (inputId.startsWith('preco_promo_')) {
        const produtoId = inputId.replace('preco_promo_', '');
        atualizarProduto(produtoId, 'preco_promo', valor);
        atualizarCamposParcelamento();
        renderProdutos();
      } else if (inputId.startsWith('valor_ge_')) {
        const produtoId = inputId.replace('valor_ge_', '');
        atualizarProduto(produtoId, 'valor_ge', valor);
        renderProdutos();
      }
    }

    function abrirMenu() {
      const menuHTML = `
        <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharMenu()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                  <span>‚ò∞</span>
                  <span>Menu</span>
                </h2>
                <button onclick="fecharMenu()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-2xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div class="p-6 space-y-3">
              <button
                onclick="limparFormulario(); fecharMenu();"
                class="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-6 py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-3 shadow-lg"
              >
                <span class="text-2xl">üóëÔ∏è</span>
                <span>Limpar Formul√°rio</span>
              </button>
              
              <button
                onclick="fecharMenu()"
                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-3"
              >
                <span class="text-2xl">‚ùå</span>
                <span>Fechar Menu</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', menuHTML);
    }

    function fecharMenu() {
      const menu = document.getElementById('menuModal');
      if (menu) {
        menu.remove();
      }
    }

    function salvarProposta() {
      const vendedorNome = document.getElementById('inputVendedorNome').value.trim();
      const clienteNome = document.getElementById('inputClienteNome').value.trim();

      if (!vendedorNome) {
        showToast('‚ö†Ô∏è Preencha o nome do vendedor', 'error');
        return;
      }

      if (!clienteNome) {
        showToast('‚ö†Ô∏è Preencha o nome do cliente', 'error');
        return;
      }

      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione pelo menos um produto', 'error');
        return;
      }

      showToast('‚úÖ Proposta salva com sucesso!', 'success');
    }

    function visualizarPropostaCliente() {
      const vendedorNome = document.getElementById('inputVendedorNome').value.trim();
      const clienteNome = document.getElementById('inputClienteNome').value.trim();
      const loja = document.getElementById('inputLoja').value.trim();
      const clienteContato = document.getElementById('inputClienteContato').value.trim();
      const dataAtual = document.getElementById('inputDataAtual').value;
      const validadeProposta = document.getElementById('inputValidadeProposta').value;
      const tituloProposta = document.getElementById('inputTituloProposta').value.trim();

      if (!vendedorNome || !clienteNome) {
        showToast('‚ö†Ô∏è Preencha os campos obrigatÔøΩÔøΩrios', 'error');
        return;
      }

      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione pelo menos um produto', 'error');
        return;
      }

      const dataAtualFormatada = dataAtual ? new Date(dataAtual + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';
      const validadeFormatada = validadeProposta ? new Date(validadeProposta + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';

      let totalParcelaNormal = 0;
      let totalParcelaPromo = 0;
      let totalGeralNormal = 0;
      let totalGeralPromo = 0;
      let maxParcelas = 1;

      let produtosHTML = produtos.map((produto, index) => {
        const desconto = produto.preco_normal - produto.preco_promo;
        const percentual = produto.preco_normal > 0 ? ((desconto / produto.preco_normal) * 100).toFixed(1) : 0;
        
        if (produto.modalidade === 'avista') {
          totalGeralNormal += produto.preco_normal;
          totalGeralPromo += produto.preco_promo;
          
          return `
            <div class="bg-white rounded-xl border-2 border-green-300 p-6 mb-4 shadow-md">
              <h4 class="text-xl font-bold text-gray-800 mb-4">${produto.codigo_nome || `Produto #${index + 1}`}</h4>
              
              <div class="text-center mb-4">
                <p class="text-sm text-gray-600 mb-2">De <span class="line-through text-red-600 font-bold">${formatarMoedaBR(produto.preco_normal)}</span></p>
                <p class="text-4xl font-bold text-green-600 mb-2">${formatarMoedaBR(produto.preco_promo)}</p>
                <p class="text-lg font-semibold text-blue-600">√Ä Vista</p>
              </div>
              
              <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 border-2 border-yellow-300">
                <p class="text-2xl font-bold text-orange-600 text-center">${percentual}% OFF</p>
                <p class="text-center text-gray-700 font-semibold mt-1">Economize ${formatarMoedaBR(desconto)}</p>
              </div>
            </div>
          `;
        } else {
          const parcelaProdutoNormal = calcularParcelaNormal(produto);
          const parcelaProdutoPromo = calcularParcela(produto);
          const valorGarantia = produto.valor_garantia || 0;
          const parcelasGarantia = produto.parcelas_garantia || produto.parcelas;
          
          let parcelaGarantiaCalc = 0;
          if (produto.tem_garantia && valorGarantia > 0) {
            const coef = produto.modalidade === 'carne' ? COEFICIENTES_CARNE[parcelasGarantia] : COEFICIENTES_CARTAO[parcelasGarantia];
            parcelaGarantiaCalc = valorGarantia * coef;
          }
          
          let parcelaNormal = parcelaProdutoNormal + parcelaGarantiaCalc;
          let parcelaPromo = parcelaProdutoPromo + parcelaGarantiaCalc;
          
          if (produto.tem_presta_mista && produto.modalidade === 'carne') {
            parcelaNormal = parcelaNormal * 1.06;
            parcelaPromo = parcelaPromo * 1.06;
          }
          
          const totalNormal = parcelaNormal * produto.parcelas;
          const totalPromo = parcelaPromo * produto.parcelas;
          const economiaTotal = totalNormal - totalPromo;
          const percentualEconomia = totalNormal > 0 ? ((economiaTotal / totalNormal) * 100).toFixed(1) : 0;
          
          totalParcelaNormal += parcelaNormal;
          totalParcelaPromo += parcelaPromo;
          totalGeralNormal += totalNormal;
          totalGeralPromo += totalPromo;
          
          if (produto.parcelas > maxParcelas) {
            maxParcelas = produto.parcelas;
          }
          
          const modalidadeNome = produto.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o';
          
          return `
            <div class="bg-white rounded-xl border-2 border-blue-300 p-6 mb-4 shadow-md">
              <h4 class="text-xl font-bold text-gray-800 mb-4">${produto.codigo_nome || `Produto #${index + 1}`}</h4>
              
              <div class="text-center mb-4">
                <p class="text-sm text-gray-600 mb-2">De <span class="line-through text-red-600 font-bold">${produto.parcelas}x ${formatarMoedaBR(parcelaNormal)}</span></p>
                <p class="text-4xl font-bold text-green-600 mb-2">${produto.parcelas}x de ${formatarMoedaBR(parcelaPromo)}</p>
                <p class="text-lg font-semibold text-blue-600">no ${modalidadeNome}</p>
              </div>
              
              <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 border-2 border-yellow-300">
                <p class="text-2xl font-bold text-orange-600 text-center">${percentualEconomia}% OFF</p>
                <p class="text-center text-gray-700 font-semibold mt-1">Economize ${formatarMoedaBR(economiaTotal)}</p>
              </div>
            </div>
          `;
        }
      }).join('');
      
      const economiaTotal = totalGeralNormal - totalGeralPromo;
      const percentualEconomiaTotal = totalGeralNormal > 0 ? ((economiaTotal / totalGeralNormal) * 100).toFixed(1) : 0;
      const economiaPorParcela = totalParcelaNormal - totalParcelaPromo;
      const percentualEconomiaParcela = totalParcelaNormal > 0 ? ((economiaPorParcela / totalParcelaNormal) * 100).toFixed(1) : 0;
      
      let resumoHTML = '';
      if (totalParcelaNormal > 0) {
        resumoHTML = `
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-300 mt-6">
            <h3 class="text-2xl font-bold text-purple-800 mb-6 text-center">üí∞ Resumo da Proposta</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-white rounded-lg p-4 border-2 border-red-200 text-center">
                <p class="text-sm text-gray-600 mb-2">Parcela Normal</p>
                <p class="text-2xl font-bold text-red-600">${maxParcelas}x ${formatarMoedaBR(totalParcelaNormal)}</p>
              </div>
              
              <div class="bg-white rounded-lg p-4 border-2 border-green-400 text-center">
                <p class="text-sm text-gray-700 font-semibold mb-2">Sua Parcela</p>
                <p class="text-3xl font-bold text-green-600">${maxParcelas}x ${formatarMoedaBR(totalParcelaPromo)}</p>
              </div>
              
              <div class="bg-white rounded-lg p-4 border-2 border-blue-300 text-center">
                <p class="text-sm text-gray-600 mb-2">Economia por Parcela</p>
                <p class="text-2xl font-bold text-blue-600">${formatarMoedaBR(economiaPorParcela)}</p>
                <p class="text-sm text-blue-500 font-semibold">(${percentualEconomiaParcela}% de desconto)</p>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 border-2 border-purple-300">
              <h4 class="text-lg font-bold text-gray-800 mb-4 text-center">Valores Totais</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                  <p class="text-sm text-gray-600 mb-1">Total Normal</p>
                  <p class="text-xl font-bold text-red-600 line-through">${formatarMoedaBR(totalGeralNormal)}</p>
                </div>
                
                <div class="text-center">
                  <p class="text-sm text-gray-700 font-semibold mb-1">Valor Total</p>
                  <p class="text-2xl font-bold text-green-600">${formatarMoedaBR(totalGeralPromo)}</p>
                </div>
                
                <div class="text-center">
                  <p class="text-sm text-gray-600 mb-1">Economia Total</p>
                  <p class="text-xl font-bold text-blue-600">${formatarMoedaBR(economiaTotal)} (${percentualEconomiaTotal}%)</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        resumoHTML = `
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-300 mt-6">
            <h3 class="text-2xl font-bold text-green-800 mb-6 text-center">üí∞ Resumo da Proposta</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-white rounded-lg p-4 border-2 border-red-200 text-center">
                <p class="text-sm text-gray-600 mb-2">Total Normal</p>
                <p class="text-2xl font-bold text-red-600 line-through">${formatarMoedaBR(totalGeralNormal)}</p>
              </div>
              
              <div class="bg-white rounded-lg p-4 border-2 border-green-400 text-center">
                <p class="text-sm text-gray-700 font-semibold mb-2">Valor Total</p>
                <p class="text-3xl font-bold text-green-600">${formatarMoedaBR(totalGeralPromo)}</p>
              </div>
              
              <div class="bg-white rounded-lg p-4 border-2 border-blue-300 text-center">
                <p class="text-sm text-gray-600 mb-2">Economia Total</p>
                <p class="text-2xl font-bold text-blue-600">${formatarMoedaBR(economiaTotal)}</p>
                <p class="text-sm text-blue-500 font-semibold">(${percentualEconomiaTotal}%)</p>
              </div>
            </div>
          </div>
        `;
      }

      const historicoInfo = document.getElementById('inputHistorico').value.trim();
      const simulacaoInfo = document.getElementById('inputSimulacao').value.trim();
      const oportunidadesInfo = document.getElementById('inputOportunidades').value.trim();
      const sugestaoParcelamento = document.getElementById('inputSugestaoParcelamento').value.trim();

      let sugestaoHTML = '';
      if (sugestaoParcelamento) {
        sugestaoHTML = `
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-300 mb-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
              <span>üí°</span>
              <span>Nossa Sugest√£o para Voc√™</span>
            </h3>
            <p class="text-base text-gray-700 bg-white p-4 rounded-lg leading-relaxed">${sugestaoParcelamento}</p>
          </div>
        `;
      }

      let infoAdicionaisHTML = '';
      if (historicoInfo || simulacaoInfo || oportunidadesInfo || propostaClienteData.modalidade) {
        infoAdicionaisHTML = `
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-300 mb-6">
            <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center gap-2">
              <span>üìã</span>
              <span>Informa√ß√µes Adicionais - Proposta para Diretoria</span>
            </h3>
            
            ${historicoInfo ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üìù Hist√≥rico de Negocia√ß√£o:</h4>
                <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${historicoInfo}</p>
              </div>
            ` : ''}
            
            ${propostaClienteData.modalidade ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üí∞ Proposta do Cliente:</h4>
                <div class="bg-white p-3 rounded-lg">
                  <p class="text-sm text-gray-600"><strong>Modalidade:</strong> ${
                    propostaClienteData.modalidade === 'avista' ? '√Ä Vista' :
                    propostaClienteData.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o'
                  }</p>
                  ${propostaClienteData.parcelas ? `<p class="text-sm text-gray-600"><strong>Parcelas:</strong> ${propostaClienteData.parcelas}x</p>` : ''}
                  ${propostaClienteData.tipoPreco ? `<p class="text-sm text-gray-600"><strong>Tipo de Pre√ßo:</strong> ${propostaClienteData.tipoPreco === 'normal' ? 'Pre√ßo Normal' : 'Pre√ßo Promocional'}</p>` : ''}
                  ${propostaClienteData.observacoes ? `<p class="text-sm text-gray-600 mt-2"><strong>Observa√ß√µes:</strong> ${propostaClienteData.observacoes}</p>` : ''}
                </div>
              </div>
            ` : ''}
            
            ${simulacaoInfo ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üìà Simula√ß√£o de Perdas e Ganhos:</h4>
                <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${simulacaoInfo}</p>
              </div>
            ` : ''}
            
            ${oportunidadesInfo ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üí° Oportunidades:</h4>
                <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${oportunidadesInfo}</p>
              </div>
            ` : ''}
          </div>
        `;
      }

      const previewHTML = `
        <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharPreview()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                  <span>üëÅÔ∏è</span>
                  <span>Visualiza√ß√£o da Proposta</span>
                </h2>
                <button onclick="fecharPreview()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-2xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div id="previewContent" class="p-6">
              <!-- Cabe√ßalho -->
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border-2 border-blue-300">
                <h3 class="text-2xl font-bold text-blue-800 mb-4">${tituloProposta || 'Proposta Comercial'}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p class="text-gray-600">ÔøΩÔøΩÔøΩÔøΩ <strong>Loja:</strong> ${loja}</p>
                    <p class="text-gray-600">üë§ <strong>Vendedor:</strong> ${vendedorNome}</p>
                    <p class="text-gray-600">üë• <strong>Cliente:</strong> ${clienteNome}</p>
                  </div>
                  <div>
                    ${clienteContato ? `<p class="text-gray-600">üìû <strong>Contato:</strong> ${clienteContato}</p>` : ''}
                    <p class="text-gray-600">ÔøΩÔøΩÔøΩÔøΩ <strong>Data:</strong> ${dataAtualFormatada}</p>
                    <p class="text-gray-600">‚è∞ <strong>Validade:</strong> ${validadeFormatada}</p>
                  </div>
                </div>
              </div>

              <!-- Produtos -->
              <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <span>üõí</span>
                  <span>Produtos / Planos</span>
                </h3>
                ${produtosHTML}
              </div>

              <!-- Sugest√£o de Parcelamento -->
              ${sugestaoHTML}

              <!-- Informa√ß√µes Adicionais -->
              ${infoAdicionaisHTML}
            </div>

            <div class="p-6 bg-gray-50 rounded-b-2xl flex gap-3">
              <button
                onclick="imprimirProposta()"
                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
              >
                <span>üñ®Ô∏è</span>
                <span>Imprimir</span>
              </button>
              <button
                onclick="fecharPreview()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
              >
                <span>‚ùå</span>
                <span>Fechar</span>
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', previewHTML);
    }

    function visualizarPropostaDiretoria() {
      const vendedorNome = document.getElementById('inputVendedorNome').value.trim();
      const clienteNome = document.getElementById('inputClienteNome').value.trim();
      const loja = document.getElementById('inputLoja').value.trim();
      const clienteContato = document.getElementById('inputClienteContato').value.trim();
      const dataAtual = document.getElementById('inputDataAtual').value;
      const validadeProposta = document.getElementById('inputValidadeProposta').value;
      const tituloProposta = document.getElementById('inputTituloProposta').value.trim();

      if (!vendedorNome || !clienteNome) {
        showToast('‚ö†Ô∏è Preencha os campos obrigat√≥rios', 'error');
        return;
      }

      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione pelo menos um produto', 'error');
        return;
      }

      const dataAtualFormatada = dataAtual ? new Date(dataAtual + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';
      const validadeFormatada = validadeProposta ? new Date(validadeProposta + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada';

      let totalNormalGeral = 0;
      let totalPromoGeral = 0;

      let produtosHTML = produtos.map((produto, index) => {
        const desconto = produto.preco_normal - produto.preco_promo;
        const percentual = produto.preco_normal > 0 ? ((desconto / produto.preco_normal) * 100).toFixed(1) : 0;
        
        if (produto.modalidade === 'avista') {
          totalNormalGeral += produto.preco_normal;
          totalPromoGeral += produto.preco_promo;
          
          return `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
              <td class="p-3 text-sm">${produto.codigo_nome || `Produto #${index + 1}`}</td>
              <td class="p-3 text-sm text-center">√Ä Vista</td>
              <td class="p-3 text-sm text-right font-bold text-red-600 line-through">${formatarMoedaBR(produto.preco_normal)}</td>
              <td class="p-3 text-sm text-right font-bold text-green-600">${formatarMoedaBR(produto.preco_promo)}</td>
              <td class="p-3 text-sm text-right font-bold text-blue-600">${formatarMoedaBR(desconto)}</td>
              <td class="p-3 text-sm text-center font-bold text-orange-600">${percentual}%</td>
            </tr>
          `;
        } else {
          const parcelaProdutoNormal = calcularParcelaNormal(produto);
          const parcelaProdutoPromo = calcularParcela(produto);
          const valorGarantia = produto.valor_garantia || 0;
          const parcelasGarantia = produto.parcelas_garantia || produto.parcelas;
          
          let parcelaGarantiaCalc = 0;
          if (produto.tem_garantia && valorGarantia > 0) {
            const coef = produto.modalidade === 'carne' ? COEFICIENTES_CARNE[parcelasGarantia] : COEFICIENTES_CARTAO[parcelasGarantia];
            parcelaGarantiaCalc = valorGarantia * coef;
          }
          
          let parcelaNormal = parcelaProdutoNormal + parcelaGarantiaCalc;
          let parcelaPromo = parcelaProdutoPromo + parcelaGarantiaCalc;
          
          if (produto.tem_presta_mista && produto.modalidade === 'carne') {
            parcelaNormal = parcelaNormal * 1.06;
            parcelaPromo = parcelaPromo * 1.06;
          }
          
          const totalNormal = parcelaNormal * produto.parcelas;
          const totalPromo = parcelaPromo * produto.parcelas;
          const economiaTotal = totalNormal - totalPromo;
          const percentualEconomia = totalNormal > 0 ? ((economiaTotal / totalNormal) * 100).toFixed(1) : 0;
          
          totalNormalGeral += totalNormal;
          totalPromoGeral += totalPromo;
          
          const modalidadeNome = produto.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o';
          
          return `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
              <td class="p-3 text-sm">${produto.codigo_nome || `Produto #${index + 1}`}</td>
              <td class="p-3 text-sm text-center">${modalidadeNome} ${produto.parcelas}x</td>
              <td class="p-3 text-sm text-right font-bold text-red-600 line-through">${formatarMoedaBR(totalNormal)}</td>
              <td class="p-3 text-sm text-right font-bold text-green-600">${formatarMoedaBR(totalPromo)}</td>
              <td class="p-3 text-sm text-right font-bold text-blue-600">${formatarMoedaBR(economiaTotal)}</td>
              <td class="p-3 text-sm text-center font-bold text-orange-600">${percentualEconomia}%</td>
            </tr>
          `;
        }
      }).join('');

      const economiaTotal = totalNormalGeral - totalPromoGeral;
      const percentualEconomiaTotal = totalNormalGeral > 0 ? ((economiaTotal / totalNormalGeral) * 100).toFixed(1) : 0;

      const historicoInfo = document.getElementById('inputHistorico').value.trim();
      const simulacaoInfo = document.getElementById('inputSimulacao').value.trim();
      const oportunidadesInfo = document.getElementById('inputOportunidades').value.trim();
      const sugestaoParcelamento = document.getElementById('inputSugestaoParcelamento').value.trim();

      let sugestaoHTML2 = '';
      if (sugestaoParcelamento) {
        sugestaoHTML2 = `
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-300 mb-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
              <span>üí°</span>
              <span>Sugest√£o de Parcelamento para o Cliente</span>
            </h3>
            <p class="text-base text-gray-700 bg-white p-4 rounded-lg leading-relaxed">${sugestaoParcelamento}</p>
          </div>
        `;
      }

      let infoAdicionaisHTML = '';
      if (historicoInfo || simulacaoInfo || oportunidadesInfo || propostaClienteData.modalidade) {
        infoAdicionaisHTML = `
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-300 mb-6">
            <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center gap-2">
              <span>üìã</span>
              <span>Informa√ß√µes Adicionais</span>
            </h3>
            
            ${historicoInfo ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üìù Hist√≥rico de Negocia√ß√£o:</h4>
                <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${historicoInfo}</p>
              </div>
            ` : ''}
            
            ${propostaClienteData.modalidade ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üí∞ Proposta do Cliente:</h4>
                <div class="bg-white p-3 rounded-lg">
                  <p class="text-sm text-gray-600"><strong>Modalidade:</strong> ${
                    propostaClienteData.modalidade === 'avista' ? '√Ä Vista' :
                    propostaClienteData.modalidade === 'carne' ? 'Carn√™' : 'Cart√£o'
                  }</p>
                  ${propostaClienteData.parcelas ? `<p class="text-sm text-gray-600"><strong>Parcelas:</strong> ${propostaClienteData.parcelas}x</p>` : ''}
                  ${propostaClienteData.tipoPreco ? `<p class="text-sm text-gray-600"><strong>Tipo de Pre√ßo:</strong> ${propostaClienteData.tipoPreco === 'normal' ? 'Pre√ßo Normal' : 'Pre√ßo Promocional'}</p>` : ''}
                  ${propostaClienteData.observacoes ? `<p class="text-sm text-gray-600 mt-2"><strong>Observa√ß√µes:</strong> ${propostaClienteData.observacoes}</p>` : ''}
                </div>
              </div>
            ` : ''}
            
            ${simulacaoInfo ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üìà Simula√ß√£o de Perdas e Ganhos:</h4>
                <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${simulacaoInfo}</p>
              </div>
            ` : ''}
            
            ${oportunidadesInfo ? `
              <div class="mb-4">
                <h4 class="text-sm font-bold text-gray-700 mb-2">üí° Oportunidades:</h4>
                <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${oportunidadesInfo}</p>
              </div>
            ` : ''}
          </div>
        `;
      }

      const previewHTML = `
        <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharPreview()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                  <span>üìä</span>
                  <span>Proposta para Diretoria</span>
                </h2>
                <button onclick="fecharPreview()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-2xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div id="previewContent" class="p-6">
              <!-- Cabe√ßalho -->
              <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 mb-6 border-2 border-purple-300">
                <h3 class="text-2xl font-bold text-purple-800 mb-4">${tituloProposta || 'Proposta Comercial'}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p class="text-gray-600">üè™ <strong>Loja:</strong> ${loja}</p>
                    <p class="text-gray-600">üë§ <strong>Vendedor:</strong> ${vendedorNome}</p>
                    <p class="text-gray-600">üë• <strong>Cliente:</strong> ${clienteNome}</p>
                  </div>
                  <div>
                    ${clienteContato ? `<p class="text-gray-600">üìû <strong>Contato:</strong> ${clienteContato}</p>` : ''}
                    <p class="text-gray-600">üìÖ <strong>Data:</strong> ${dataAtualFormatada}</p>
                    <p class="text-gray-600">‚è∞ <strong>Validade:</strong> ${validadeFormatada}</p>
                  </div>
                </div>
              </div>

              <!-- Tabela de Produtos -->
              <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <span>üì¶</span>
                  <span>Resumo dos Produtos</span>
                </h3>
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse bg-white rounded-xl overflow-hidden shadow-md">
                    <thead>
                      <tr class="bg-gradient-to-r from-purple-100 to-pink-100">
                        <th class="p-3 text-left text-sm font-bold text-gray-800">Produto</th>
                        <th class="p-3 text-center text-sm font-bold text-gray-800">Modalidade</th>
                        <th class="p-3 text-right text-sm font-bold text-gray-800">Valor Normal</th>
                        <th class="p-3 text-right text-sm font-bold text-gray-800">Valor Proposto</th>
                        <th class="p-3 text-right text-sm font-bold text-gray-800">Desconto (R$)</th>
                        <th class="p-3 text-center text-sm font-bold text-gray-800">Desconto (%)</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${produtosHTML}
                      <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 font-bold border-t-2 border-blue-300">
                        <td class="p-4 text-sm" colspan="2">TOTAL GERAL</td>
                        <td class="p-4 text-sm text-right text-red-600 line-through">${formatarMoedaBR(totalNormalGeral)}</td>
                        <td class="p-4 text-sm text-right text-green-600 text-lg">${formatarMoedaBR(totalPromoGeral)}</td>
                        <td class="p-4 text-sm text-right text-blue-600 text-lg">${formatarMoedaBR(economiaTotal)}</td>
                        <td class="p-4 text-sm text-center text-orange-600 text-lg">${percentualEconomiaTotal}%</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Sugest√£o de Parcelamento -->
              ${sugestaoHTML2}

              <!-- Informa√ß√µes Adicionais -->
              ${infoAdicionaisHTML}
            </div>

            <div class="p-6 bg-gray-50 rounded-b-2xl flex gap-3">
              <button
                onclick="imprimirProposta()"
                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
              >
                <span>üñ®Ô∏è</span>
                <span>Imprimir</span>
              </button>
              <button
                onclick="fecharPreview()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
              >
                <span>‚ùå</span>
                <span>Fechar</span>
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', previewHTML);
    }

    function fecharPreview() {
      const preview = document.getElementById('previewModal');
      if (preview) {
        preview.remove();
      }
    }

    function imprimirProposta() {
      window.print();
    }

    function limparFormulario() {
      document.getElementById('inputLoja').value = 'Iguatu 3 - Ao lado do Bradesco';
      document.getElementById('inputVendedorNome').value = nomeVendedorLogado;
      document.getElementById('inputTituloProposta').value = '';
      document.getElementById('inputClienteNome').value = '';
      document.getElementById('inputClienteContato').value = '';
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('inputDataAtual').value = hoje;
      document.getElementById('inputValidadeProposta').value = '';
      valorPlanoExclusivo = 0;
      document.getElementById('inputHistorico').value = '';
      document.getElementById('inputSimulacao').value = '';
      document.getElementById('inputOportunidades').value = '';
      produtos = [];
      currentProposalId = null;
      planoExclusivoVisivel = false;
      informacoesAdicionaisVisivel = false;
      resumoFinanceiroVisivel = false;
      modalidadePropostaCliente = null;
      propostaClienteData = {
        modalidade: null,
        parcelas: null,
        tipoPreco: null,
        observacoes: ''
      };
      
      const btnInfoAdicionais = document.getElementById('btnToggleInformacoesAdicionais');
      if (btnInfoAdicionais) {
        btnInfoAdicionais.innerHTML = '<span>üìã</span><span>Abrir Informa√ß√µes Adicionais</span>';
        btnInfoAdicionais.className = 'bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
      }
      
      const secaoInfoAdicionais = document.getElementById('secaoInformacoesAdicionais');
      if (secaoInfoAdicionais) {
        secaoInfoAdicionais.classList.add('hidden');
      }

      document.getElementById('inputSugestaoParcelamento').value = '';
      
      document.getElementById('btnPropostaAvista').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('btnPropostaCarne').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('btnPropostaCartao').className = 'px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('camposPropostaCliente').classList.add('hidden');
      
      const btn = document.getElementById('btnTogglePlanoExclusivo');
      if (btn) {
        btn.innerHTML = '<span></span><span>Abrir Plano Exclusivo</span>';
        btn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-bold text-lg transition-all flex items-center gap-2 shadow-lg';
      }
      
      renderProdutos();
      atualizarCamposParcelamento();
      atualizarVisibilidadeSecaoPlano();
      showToast(' Formul√°rio limpo!', 'success');
    }
    
      const previewHTML = `
        <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4" onclick="fecharPreview()">
          <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 md:p-6 rounded-t-2xl sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 class="text-base md:text-2xl font-bold flex items-center gap-2">
                  <span>üìä</span>
                  <span>Proposta para Diretoria</span>
                </h2>
                <button onclick="fecharPreview()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                  <span class="text-xl">‚úï</span>
                </button>
              </div>
            </div>
            
            <div class="p-4 md:p-6 text-xs md:text-sm">
              <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 md:p-5 mb-5 border border-purple-200">
                <h3 class="text-base md:text-lg font-bold text-purple-800 mb-3">
                  ${tituloProposta || 'Proposta Comercial'}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <p class="text-gray-700">üè™ <strong>Loja:</strong> ${loja}</p>
                    <p class="text-gray-700">üë§ <strong>Vendedor:</strong> ${vendedorNome}</p>
                    <p class="text-gray-700">üë• <strong>Cliente:</strong> ${clienteNome}</p>
                  </div>
                  <div>
                    ${clienteContato ? `<p class="text-gray-700">üìû <strong>Contato:</strong> ${clienteContato}</p>` : ''}
                    <p class="text-gray-700">üìÖ <strong>Data:</strong> ${dataAtualFormatada}</p>
                    <p class="text-gray-700">‚è∞ <strong>Validade:</strong> ${validadeFormatada}</p>
                  </div>
                </div>
              </div>

              <div class="mb-5">
                <h3 class="text-sm md:text-base font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <span>üì¶</span>
                  <span>Resumo dos produtos</span>
                </h3>
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse bg-white rounded-xl overflow-hidden shadow-md">
                    <thead>
                      <tr class="bg-gradient-to-r from-purple-100 to-pink-100 text-[11px] md:text-xs">
                        <th class="p-2 text-left font-bold text-gray-700">Produto</th>
                        <th class="p-2 text-center font-bold text-gray-700">Modalidade</th>
                        <th class="p-2 text-right font-bold text-gray-700">Valor normal</th>
                        <th class="p-2 text-right font-bold text-gray-700">Valor proposto</th>
                        <th class="p-2 text-right font-bold text-gray-700">Desconto (R$)</th>
                        <th class="p-2 text-center font-bold text-gray-700">Desconto (%)</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${linhasProdutos}
                      <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 font-bold text-xs md:text-sm border-t-2 border-blue-200">
                        <td class="p-3" colspan="2">TOTAL GERAL</td>
                        <td class="p-3 text-right text-red-600 line-through">${formatarMoedaBR(totalNormalGeral)}</td>
                        <td class="p-3 text-right text-green-600 text-base md:text-lg">${formatarMoedaBR(totalPromoGeral)}</td>
                        <td class="p-3 text-right text-blue-600 text-base md:text-lg">${formatarMoedaBR(economiaTotal)}</td>
                        <td class="p-3 text-center text-orange-600 text-base md:text-lg">${percTotal}%</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              ${sugestaoHTML2}
              ${infoAdicionaisHTML}
            </div>

            <div class="p-4 md:p-6 bg-gray-50 rounded-b-2xl flex gap-3">
              <button
                onclick="imprimirProposta()"
                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2"
              >
                üñ®Ô∏è Imprimir
              </button>
              <button
                onclick="fecharPreview()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-3 rounded-xl font-bold text-xs md:text-sm flex items-center justify-center gap-2"
              >
                ‚ùå Fechar
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', previewHTML);
    }

    function fecharPreview() {
      const preview = document.getElementById('previewModal');
      if (preview) preview.remove();
    }

    function imprimirProposta() {
      window.print();
    }
  </script>
</body>
</html>
