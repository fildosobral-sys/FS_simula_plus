<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FS Planos & Cotações – V14 Online</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f7fa;
    margin: 0;
    padding: 0;
  }

  .hidden { display: none; }
  .fs-btn {
    padding: 10px 16px;
    border-radius: 6px;
    background: #004aad;
    color: white;
    border: none;
    font-weight: bold;
  }
  .fs-btn:hover { background: #00347a; }

  .input-text {
    width: 100%;
    padding: 10px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    margin-bottom: 10px;
  }

  .senha-box {
    position: relative;
  }
  .senha-olho {
    position: absolute;
    right: 12px;
    top: 11px;
    font-size: 13px;
    color: #004aad;
  }
</style>

<script>
// =============================
// CONFIGURAÇÕES FS V14 ONLINE
// =============================
const FSAPIURL = "https://script.google.com/macros/s/AKfycbwE-v6LHArYcoBcsqf0cWgzX1tm5-avttnwHxQ6vouWRRFpv-AvZYif_x8eqlEB5Rk5/exec";
const FS_GERENCIAL_SENHA = "@fildO1060";

// =============================
// LOGIN – USUÁRIO E GERENTE
// =============================
function toggleSenha(inputId, btnId) {
  const inp = document.getElementById(inputId);
  const btn = document.getElementById(btnId);

  if (inp.type === "password") {
    inp.type = "text";
    btn.innerText = "Ocultar";
  } else {
    inp.type = "password";
    btn.innerText = "Mostrar";
  }
}

// Carrega usuário automático (se lembrar)
window.onload = function() {
  const lembrar = localStorage.getItem("fs_user_lembrar");
  if (lembrar === "sim") {
    const user = localStorage.getItem("fs_user_nome");

    if (user) {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      document.getElementById("nomeUsuarioTopo").innerText = user;
    }
  }
};
</script>

</head>
<body>

<!-- ============ LOGIN ============ -->
<div id="loginScreen">
  <h2 style="text-align:center; margin-top:20px;">Acesso à Plataforma</h2>

  <input id="loginUser" class="input-text" placeholder="Usuário" />

  <div class="senha-box">
    <input id="loginSenha" type="password" class="input-text" placeholder="Senha" />
    <span id="btnMostrarLogin" class="senha-olho" onclick="toggleSenha('loginSenha','btnMostrarLogin')">Mostrar</span>
  </div>

  <label>
    <input type="checkbox" id="lembrarUser" /> Lembrar neste dispositivo
  </label>

  <br><br>
  <button class="fs-btn" onclick="entrarSistema()">Entrar</button>

  <p style="text-align:center; margin-top:10px; color:#555;">
    Esqueceu a senha? <a href="#" onclick="abrirResetSenha()">Clique aqui</a>
  </p>
</div>
<!-- ============ RESET DE SENHA ============ -->
<div id="resetSenhaScreen" class="hidden" style="padding:20px;">
  <h2>Redefinir senha do usuário</h2>

  <input id="resetUser" class="input-text" placeholder="Usuário" />

  <div class="senha-box">
    <input id="resetSenhaGerente" type="password" class="input-text" placeholder="Senha Gerencial" />
    <span id="btnMostrarResetG" class="senha-olho" onclick="toggleSenha('resetSenhaGerente','btnMostrarResetG')">Mostrar</span>
  </div>

  <div class="senha-box">
    <input id="resetSenhaNova" type="password" class="input-text" placeholder="Nova senha do usuário" />
    <span id="btnMostrarReset1" class="senha-olho" onclick="toggleSenha('resetSenhaNova','btnMostrarReset1')">Mostrar</span>
  </div>

  <button class="fs-btn" onclick="confirmarResetSenha()">Salvar nova senha</button>
  <button class="fs-btn" style="background:#777; margin-top:10px;" onclick="voltarLogin()">Voltar</button>
</div>


<script>
// ==========================================
// LOGIN DO USUÁRIO
// ==========================================
function entrarSistema() {
  const user = document.getElementById("loginUser").value.trim();
  const senha = document.getElementById("loginSenha").value.trim();
  const lembrar = document.getElementById("lembrarUser").checked;

  if (!user || !senha) {
    alert("Preencha usuário e senha");
    return;
  }

  const uSenha = localStorage.getItem("fs_user_senha_" + user);

  if (!uSenha) {
    alert("Usuário não cadastrado pelo gerente.");
    return;
  }

  if (senha !== uSenha) {
    alert("Senha incorreta");
    return;
  }

  if (lembrar) {
    localStorage.setItem("fs_user_lembrar", "sim");
    localStorage.setItem("fs_user_nome", user);
  } else {
    localStorage.setItem("fs_user_lembrar", "nao");
    localStorage.setItem("fs_user_nome", user);
  }

  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("mainContent").classList.remove("hidden");
  document.getElementById("nomeUsuarioTopo").innerText = user;
}


// =============================
// RESET SENHA
// =============================
function abrirResetSenha() {
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("resetSenhaScreen").classList.remove("hidden");
}

function voltarLogin() {
  document.getElementById("resetSenhaScreen").classList.add("hidden");
  document.getElementById("loginScreen").classList.remove("hidden");
}

function confirmarResetSenha() {
  const usuario = document.getElementById("resetUser").value.trim();
  const gerente = document.getElementById("resetSenhaGerente").value.trim();
  const novaSenha = document.getElementById("resetSenhaNova").value.trim();

  if (!usuario || !gerente || !novaSenha) {
    alert("Preencha todos os campos.");
    return;
  }

  if (gerente !== FS_GERENCIAL_SENHA) {
    alert("Senha gerencial incorreta.");
    return;
  }

  localStorage.setItem("fs_user_senha_" + usuario, novaSenha);

  alert("Senha alterada com sucesso!");
  voltarLogin();
}
</script>



<!-- ========================================== -->
<!-- ============ LAYOUT PRINCIPAL ============ -->
<!-- ========================================== -->

<div id="mainContent" class="hidden" style="padding:10px;">

  <h2 style="text-align:center;">
    FS Planos & Cotações – <span id="nomeUsuarioTopo"></span>
  </h2>

  <!-- Menu superior -->
  <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
    <button class="fs-btn" onclick="abrirNovaProposta()">Nova Proposta</button>
    <button class="fs-btn" onclick="abrirPainelGerente()">Painel do Gerente</button>
  </div>

  <hr style="margin:20px 0;">
  <!-- ===================================================== -->
<!-- ========== TELA DE NOVA PROPOSTA / FORMULÁRIO ======= -->
<!-- ===================================================== -->

<div id="novaPropostaScreen" class="hidden" style="padding:15px;">
  <h2>Nova Proposta</h2>

  <label>Vendedor:</label>
  <input id="inputVendedorNome" class="input-text" placeholder="Nome do vendedor" />

  <label>Título / Resumo da Proposta:</label>
  <input id="inputTituloProposta" class="input-text" placeholder="Resumo da Proposta" />

  <label>Data da Proposta:</label>
  <input id="inputDataProposta" type="date" class="input-text" />

  <label>Validade da Proposta:</label>
  <input id="inputValidadeProposta" type="date" class="input-text" />

  <label>Cliente:</label>
  <input id="inputClienteNome" class="input-text" placeholder="Nome do cliente" />

  <label>Contato do Cliente:</label>
  <input id="inputClienteContato" class="input-text" placeholder="Telefone, WhatsApp..." />

  <h3 style="margin-top:20px;">Produtos da Proposta</h3>

  <div id="listaProdutosContainer"></div>

  <button class="fs-btn" onclick="adicionarProduto()">Adicionar Produto</button>

  <div style="margin-top:25px;">
    <button class="fs-btn" onclick="salvarPropostaServidor()">Salvar Proposta</button>
    <button class="fs-btn" style="background:#777;" onclick="voltarMenuPrincipal()">Voltar</button>
  </div>

  <p id="statusSalvarProposta" style="margin-top:15px; font-weight:bold; text-align:center;"></p>
</div>


<script>
// =====================================================
// GERAR CÓDIGO FS_25_XXX  (reinicia a cada ano)
// =====================================================
function gerarCodigoFS(listaExistente) {
  try {
    const ano = new Date().getFullYear().toString().slice(-2);
    let seq = 1;

    if (!Array.isArray(listaExistente)) listaExistente = [];

    while (seq < 1000) {
      const codigo = `FS_${ano}_${String(seq).padStart(3, '0')}`;
      const existe = listaExistente.some(p => p.codigo === codigo || p.codigo_proposta === codigo);
      if (!existe) return codigo;
      seq++;
    }

    return `FS_${ano}_${Date.now().toString().slice(-3)}`;
  } catch (e) {
    return "FS_ERR_" + Date.now();
  }
}


// =====================================================
// ADICIONAR PRODUTO NA LISTA
// =====================================================
let produtos = [];

function adicionarProduto() {
  const descricao = prompt("Descrição do produto:");
  if (!descricao) return;

  const valor = prompt("Valor do produto:");
  if (!valor) return;

  produtos.push({
    descricao: descricao,
    valor: parseFloat(valor)
  });

  renderListaProdutos();
}

function renderListaProdutos() {
  const div = document.getElementById("listaProdutosContainer");
  div.innerHTML = "";

  produtos.forEach((p, i) => {
    const linha = document.createElement("div");
    linha.style.padding = "8px";
    linha.style.border = "1px solid #ccc";
    linha.style.marginBottom = "6px";
    linha.style.borderRadius = "6px";
    linha.innerHTML = `
      <strong>${p.descricao}</strong><br>
      Valor: R$ ${p.valor.toFixed(2)}
      <button style="float:right; background:#c00; color:white; border:none; padding:4px 8px; border-radius:5px;" onclick="removerProduto(${i})">X</button>
    `;
    div.appendChild(linha);
  });
}

function removerProduto(i) {
  produtos.splice(i, 1);
  renderListaProdutos();
}


// =====================================================
// ABRIR / FECHAR TELAS
// =====================================================
function abrirNovaProposta() {
  document.getElementById("novaPropostaScreen").classList.remove("hidden");
}

function voltarMenuPrincipal() {
  document.getElementById("novaPropostaScreen").classList.add("hidden");
}
</script>
<!-- ===================================================== -->
<!-- =============== PAINEL DO GERENTE =================== -->
<!-- ===================================================== -->

<div id="painelGerenteScreen" class="hidden" style="padding:15px; border-top:1px solid #ccc; margin-top:15px;">
  <h2>Painel do Gerente</h2>

  <p>Código atual carregado: <strong><span id="badgeCodigoAtual">nenhum</span></strong></p>

  <div style="margin-top:10px; border:1px solid #ddd; padding:10px; border-radius:6px;">
    <h3>Busca rápida por código</h3>
    <input id="inputBuscaCodigo" class="input-text" placeholder="Ex.: FS_25_001" />
    <button class="fs-btn" onclick="buscarPropostaPorCodigo()">Buscar</button>
    <p id="resultadoBuscaCodigo" style="margin-top:8px; font-weight:bold;"></p>
  </div>

  <div id="infoPropostaGerente" style="margin-top:15px; padding:10px; border:1px solid #eee; border-radius:6px; background:#fafafa;">
    <em>Nenhuma proposta carregada.</em>
  </div>

  <div style="margin-top:15px;">
    <button class="fs-btn" style="background:#777;" onclick="fecharPainelGerente()">Fechar Painel</button>
  </div>
</div>

<script>
// =====================================================
// ABRIR / FECHAR PAINEL DO GERENTE
// =====================================================
function abrirPainelGerente() {
  document.getElementById("painelGerenteScreen").classList.remove("hidden");
  document.getElementById("novaPropostaScreen").classList.add("hidden");
}

function fecharPainelGerente() {
  document.getElementById("painelGerenteScreen").classList.add("hidden");
}


// =====================================================
// ATUALIZAR BADGE DO CÓDIGO ATUAL
// =====================================================
function atualizarBadgeCodigo(cod) {
  const span = document.getElementById("badgeCodigoAtual");
  if (span) {
    span.innerText = cod || "nenhum";
  }
}


// =====================================================
// BUSCAR PROPOSTA POR CÓDIGO (100% ONLINE – FSAPIURL)
// =====================================================
async function buscarPropostaPorCodigo() {
  try {
    const input = document.getElementById("inputBuscaCodigo");
    const info = document.getElementById("infoPropostaGerente");
    const feedback = document.getElementById("resultadoBuscaCodigo");

    if (!input || !info || !feedback) return;

    const termoBruto = (input.value || "").trim();
    if (!termoBruto) {
      feedback.innerText = "Informe o código da proposta.";
      feedback.style.color = "#c00";
      return;
    }

    if (!FSAPIURL) {
      feedback.innerText = "FSAPIURL não configurado.";
      feedback.style.color = "#c00";
      return;
    }

    const codigo = termoBruto.toUpperCase();

    feedback.innerText = "Buscando proposta no painel online...";
    feedback.style.color = "#555";

    const url = FSAPIURL + "?acao=buscar_por_codigo&codigo=" + encodeURIComponent(codigo);
    const resp = await fetch(url);

    if (!resp.ok) {
      feedback.innerText = "Erro ao buscar. Verifique a internet.";
      feedback.style.color = "#c00";
      console.error("HTTP", resp.status);
      return;
    }

    let data;
    try {
      data = await resp.json();
    } catch (e) {
      feedback.innerText = "Resposta inválida do servidor.";
      feedback.style.color = "#c00";
      console.error("JSON erro", e);
      return;
    }

    if (!data || data.status !== "ok" || !data.proposta) {
      feedback.innerText = data && data.mensagem ? data.mensagem : "Proposta não encontrada.";
      feedback.style.color = "#c00";
      info.innerHTML = "<em>Nenhuma proposta carregada.</em>";
      return;
    }

    const proposta = data.proposta;
    let jsonCompleto = proposta;

    if (proposta.json_completo) {
      try {
        jsonCompleto = typeof proposta.json_completo === "string"
          ? JSON.parse(proposta.json_completo)
          : proposta.json_completo;
      } catch (e) {
        console.warn("Erro ao interpretar json_completo, usando objeto base:", e);
        jsonCompleto = proposta;
      }
    }

    // Atualiza o resumo textual no painel do gerente
    const vendedor = jsonCompleto.vendedor || jsonCompleto.vendedor_nome || proposta.vendedor || "";
    const cliente  = jsonCompleto.cliente || jsonCompleto.cliente_nome || proposta.cliente || "";
    const loja     = jsonCompleto.loja || jsonCompleto.loja_nome || proposta.loja || "";
    const dataSim  = jsonCompleto.data_simulacao || jsonCompleto.data_proposta || proposta.data_simulacao || "";
    const validade = jsonCompleto.validade || jsonCompleto.validade_proposta || proposta.validade || "";
    const resumo   = jsonCompleto.resumo || proposta.resumo || jsonCompleto.titulo_proposta || "";

    let total = 0;
    let itensHtml = "";

    try {
      let listaProdutos = jsonCompleto.produtos;
      if (typeof listaProdutos === "string") {
        listaProdutos = JSON.parse(listaProdutos || "[]");
      }
      if (Array.isArray(listaProdutos)) {
        itensHtml = "<ul>";
        listaProdutos.forEach(p => {
          const v = Number(p.valor || p.preco || 0);
          total += v;
          itensHtml += `<li>${p.descricao || p.nome || "Item"} – R$ ${v.toFixed(2)}</li>`;
        });
        itensHtml += "</ul>";
      }
    } catch (e) {
      console.warn("Erro ao montar lista de produtos:", e);
    }

    info.innerHTML = `
      <p><strong>Código:</strong> ${codigo}</p>
      <p><strong>Vendedor:</strong> ${vendedor}</p>
      <p><strong>Cliente:</strong> ${cliente}</p>
      <p><strong>Loja:</strong> ${loja}</p>
      <p><strong>Data:</strong> ${dataSim}</p>
      <p><strong>Validade:</strong> ${validade}</p>
      <p><strong>Resumo:</strong> ${resumo}</p>
      <p><strong>Total aproximado:</strong> R$ ${total.toFixed(2)}</p>
      <p><strong>Itens:</strong></p>
      ${itensHtml || "<em>Sem itens detalhados.</em>"}
    `;

    // Também joga os dados no formulário de edição, se você quiser editar
    try {
      const inpVend = document.getElementById("inputVendedorNome");
      const inpTit  = document.getElementById("inputTituloProposta");
      const inpData = document.getElementById("inputDataProposta");
      const inpVal  = document.getElementById("inputValidadeProposta");
      const inpCli  = document.getElementById("inputClienteNome");
      const inpCont = document.getElementById("inputClienteContato");

      if (inpVend) inpVend.value = vendedor;
      if (inpTit)  inpTit.value  = resumo;
      if (inpData) inpData.value = dataSim;
      if (inpVal)  inpVal.value  = validade;
      if (inpCli)  inpCli.value  = cliente;
      if (inpCont) inpCont.value = jsonCompleto.cliente_contato || "";

      // Produtos -> preenche na tela para reedição
      if (jsonCompleto.produtos) {
        let listaProdutos = jsonCompleto.produtos;
        if (typeof listaProdutos === "string") {
          listaProdutos = JSON.parse(listaProdutos || "[]");
        }
        if (Array.isArray(listaProdutos)) {
          window.produtos = listaProdutos.map(p => ({
            descricao: p.descricao || p.nome || "",
            valor: Number(p.valor || p.preco || 0)
          }));
          renderListaProdutos();
        }
      }
    } catch (e) {
      console.warn("Erro ao aplicar a proposta no formulário de edição:", e);
    }

    atualizarBadgeCodigo(codigo);
    feedback.innerText = "Proposta localizada e carregada.";
    feedback.style.color = "green";
  } catch (e) {
    console.error("Erro geral na busca por código:", e);
    const feedback = document.getElementById("resultadoBuscaCodigo");
    if (feedback) {
      feedback.innerText = "Erro ao buscar proposta. Tente novamente.";
      feedback.style.color = "#c00";
    }
  }
}
       </script>
       <!-- ===================================================== -->
<!-- ========== SALVAR PROPOSTA NO SERVIDOR (ONLINE) ===== -->
<!-- ===================================================== -->

<script>
async function salvarPropostaServidor() {
  const statusEl = document.getElementById("statusSalvarProposta");

  try {
    const vendedor = (document.getElementById("inputVendedorNome").value || "").trim();
    const titulo   = (document.getElementById("inputTituloProposta").value || "").trim();
    const dataProp = (document.getElementById("inputDataProposta").value || "").trim();
    const validade = (document.getElementById("inputValidadeProposta").value || "").trim();
    const cliente  = (document.getElementById("inputClienteNome").value || "").trim();
    const contato  = (document.getElementById("inputClienteContato").value || "").trim();

    if (!vendedor || !titulo || !dataProp || !cliente) {
      alert("Preencha pelo menos vendedor, título, data e cliente.");
      return;
    }

    if (!Array.isArray(produtos) || produtos.length === 0) {
      const conf = confirm("Nenhum produto adicionado. Deseja salvar mesmo assim?");
      if (!conf) return;
    }

    if (!FSAPIURL) {
      alert("FSAPIURL não configurado.");
      return;
    }

    statusEl.innerText = "Enviando proposta para o painel online...";
    statusEl.style.color = "#555";

    // Aqui você poderia no futuro buscar uma lista já existente para garantir código único,
    // mas por enquanto vamos gerar localmente:
    const codigo = gerarCodigoFS([]);

    const jsonCompleto = {
      codigo: codigo,
      vendedor: vendedor,
      cliente: cliente,
      loja: "", // se quiser, pode preencher depois
      data_simulacao: dataProp,
      validade: validade,
      titulo_proposta: titulo,
      cliente_contato: contato,
      produtos: produtos
    };

    const payload = {
      acao: "salvar_proposta",
      codigo: codigo,
      vendedor: vendedor,
      cliente: cliente,
      data_simulacao: dataProp,
      validade: validade,
      resumo: titulo,
      json_completo: JSON.stringify(jsonCompleto)
    };

    const resp = await fetch(FSAPIURL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      console.error("HTTP erro ao salvar proposta:", resp.status);
      statusEl.innerText = "Erro ao salvar. Verifique a internet.";
      statusEl.style.color = "#c00";
      return;
    }

    let data;
    try {
      data = await resp.json();
    } catch (e) {
      console.error("Erro ao ler resposta JSON do servidor:", e);
      statusEl.innerText = "Proposta salva? Não foi possível confirmar a resposta.";
      statusEl.style.color = "#c00";
      return;
    }

    if (!data || data.status !== "ok") {
      statusEl.innerText = data && data.mensagem
        ? data.mensagem
        : "Não foi possível confirmar o salvamento da proposta.";
      statusEl.style.color = "#c00";
      return;
    }

    // Sucesso!
    statusEl.innerText = `Proposta salva com sucesso! Código: ${codigo}`;
    statusEl.style.color = "green";

    atualizarBadgeCodigo(codigo);

    // Se quiser, limpa os produtos e volta para o menu
    // produtos = [];
    // renderListaProdutos();

  } catch (e) {
    console.error("Erro geral ao salvar proposta:", e);
    if (statusEl) {
      statusEl.innerText = "Erro ao salvar proposta. Tente novamente.";
      statusEl.style.color = "#c00";
    }
  }
}
</script>
<!-- ===================================================== -->
<!-- =============== RODAPÉ E FECHAMENTO ================= -->
<!-- ===================================================== -->

<hr style="margin-top:30px;">

<p style="text-align:center; padding:15px; color:#777;">
  FS Planos & Cotações – Sistema V14 (Online)
  <br>
  Desenvolvido por Fildo Sobral
</p>

</div> <!-- fecha #mainContent -->

</body>
</html>
