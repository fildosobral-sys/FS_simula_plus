<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planos e Cota√ß√µes</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    html {
      height: 100%;
    }
    .produto-item {
      transition: all 0.2s ease;
    }
    .produto-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-primary {
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .tab-button {
      transition: all 0.2s ease;
    }
    .tab-active {
      border-bottom: 3px solid #2563eb;
      color: #2563eb;
      font-weight: 600;
    }
    @media print {
      .no-print {
        display: none !important;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100">
  <div id="app" class="min-h-full"><!-- Loading State -->
   <div id="loading" class="flex items-center justify-center min-h-full">
    <div class="text-center">
     <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
     <p class="text-gray-600 text-lg">Carregando m√≥dulo...</p>
    </div>
   </div><!-- Tela de Entrada (Welcome Screen) -->
   <div id="welcomeScreen" class="hidden min-h-full flex items-center justify-center p-4">
    <div class="max-w-2xl w-full">
     <div class="bg-white rounded-3xl shadow-2xl overflow-hidden transform hover:scale-105 transition-transform duration-300">
      <div class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-700 p-8 relative overflow-hidden">
       <div class="absolute inset-0 opacity-20">
        <div class="absolute top-0 left-0 w-64 h-64 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"></div>
       </div>
       <div class="relative z-10 text-center mb-6">
        <div class="inline-block animate-bounce"><span class="text-8xl">üìä</span>
        </div>
        <h1 class="text-4xl font-extrabold text-white mt-6 mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Planos e Cota√ß√µes</h1>
        <p class="text-blue-100 text-lg font-medium">Sistema Profissional de Propostas Comerciais</p>
       </div>
      </div>
      <div class="p-8">
       <div class="mb-6"><label class="block text-gray-700 font-bold mb-3 text-lg" for="inputNomeVendedorInicial"> üë§ Qual √© o seu nome? </label> <input type="text" id="inputNomeVendedorInicial" class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Digite seu nome completo" autocomplete="off">
       </div><button id="btnEntrarSistema" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-xl hover:from-blue-700 hover:to-indigo-700 shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-3"> <span class="text-2xl">üöÄ</span> <span>Entrar no Sistema</span> </button>
      </div>
     </div>
     <div class="text-center mt-6">
      <p class="text-sm text-gray-600">‚ú® Crie propostas incr√≠veis em minutos</p>
     </div>
    </div>
   </div><!-- Main Content (hidden initially) -->
   <div id="mainContent" class="hidden pb-16"><!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-700 text-white shadow-2xl relative overflow-hidden">
     <div class="absolute inset-0 opacity-10">
      <div class="absolute top-0 left-0 w-96 h-96 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 right-0 w-96 h-96 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"></div>
     </div>
     <div class="container mx-auto px-4 py-8 relative z-10">
      <div class="flex justify-between items-center flex-wrap gap-4">
       <div class="flex items-center gap-4">
        <div class="hidden md:flex items-center justify-center w-16 h-16 bg-white bg-opacity-20 rounded-2xl backdrop-blur-sm"><span class="text-4xl">üìä</span>
        </div>
        <div>
         <h1 class="text-4xl font-extrabold tracking-tight mb-1">Planos e Cota√ß√µes</h1>
         <p class="text-blue-100 text-lg font-medium flex items-center gap-2">Bem-vindo(a), <span id="nomeUsuarioHeader" class="font-bold">Usu√°rio</span>!</p>
        </div>
       </div>
       <div class="flex items-center gap-3"><button id="btnNovaProposta" class="btn-primary bg-white text-blue-600 px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-50 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center gap-3"> <span class="text-2xl">‚ûï</span> <span>Nova Proposta</span> </button> <button id="btnAbrirMenu" class="bg-white bg-opacity-20 backdrop-blur-sm text-white px-6 py-4 rounded-xl font-bold text-lg hover:bg-opacity-30 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200 flex items-center gap-2"> <span class="text-2xl">‚ò∞</span> <span class="hidden md:inline">Menu</span> </button>
       </div>
      </div>
     </div>
     <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-30"></div>
    </header><!-- View Container -->
    <div id="viewContainer" class="container mx-auto px-4 py-6"><!-- LISTA DE PROPOSTAS -->
     <div id="listaView" class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
       <div>
        <h2 class="text-2xl font-bold text-gray-800">üéØ Minhas Propostas</h2>
        <div class="text-sm text-gray-500 mt-1"><span id="contadorPropostas">0 propostas</span>
        </div>
       </div>
      </div><!-- Filtros de Data -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-4 mb-6">
       <h3 class="text-lg font-bold text-blue-800 mb-3">üìÖ Filtrar por Data</h3>
       <div class="flex gap-3 flex-wrap"><input type="date" id="filtroData" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"> <button onclick="filtrarPorData('hoje')" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-all"> üìÖ Hoje </button> <button onclick="filtrarPorData('todas')" class="bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-all"> üîÑ Todas </button>
       </div>
       <div id="statusFiltro" class="mt-3 text-sm text-gray-600 hidden"><span class="font-semibold">Pesquisando...</span>
       </div>
      </div>
      <div id="listaPropostas" class="space-y-4"><!-- Propostas ser√£o inseridas aqui -->
      </div>
      <div id="emptyState" class="text-center py-12">
       <div class="text-6xl mb-4">
        üìÑ
       </div>
       <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma proposta criada ainda</h3>
       <p class="text-gray-500 mb-6">Clique em "Nova Proposta" para come√ßar</p>
      </div>
     </div>
    </div><!-- Rodap√© Fixo -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-gray-800 to-gray-900 text-white py-3 text-center shadow-lg z-40">
     <p class="text-sm font-medium">Desenvolvido por üöÄ <span class="font-bold">Fildosobral</span> | Vers√£o 1.5.0</p>
    </footer>
   </div>
  </div>
  <script>
    // ========== CONFIG & STATE ==========
    const defaultConfig = {
      app_title: "Planos e Cota√ß√µes",
      primary_button_text: "Nova Proposta"
    };

    // TAXAS DE JUROS (12 parcelas)
    const TAXAS_CARNE = [1.0690, 0.5523, 0.3804, 0.2946, 0.2432, 0.2091, 0.1849, 0.1668, 0.1528, 0.1417, 0.1327, 0.1252];
    const TAXAS_CARTAO = [1.0292, 0.5220, 0.3530, 0.2685, 0.2179, 0.1841, 0.1600, 0.1420, 0.1280, 0.1168, 0.1076, 0.1000];

    let allProposals = [];
    let nomeVendedorLogado = '';
    let propostaAtual = null;

    // ========== DATA SDK SETUP ==========
    const dataHandler = {
      onDataChanged(data) {
        allProposals = data;
        renderListaPropostas(data);
        updateContador(data.length);
      }
    };

    async function initializeApp() {
      try {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Erro ao inicializar Data SDK");
          document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro ao carregar o m√≥dulo.</p>';
          return;
        }

        document.getElementById('loading').classList.add('hidden');
        
        const nomeSalvo = localStorage.getItem('nomeVendedorLogado');
        
        if (nomeSalvo) {
          nomeVendedorLogado = nomeSalvo;
          document.getElementById('nomeUsuarioHeader').textContent = nomeSalvo;
          document.getElementById('mainContent').classList.remove('hidden');
          showToast(`üëã Bem-vindo de volta, ${nomeSalvo}!`, 'success');
        } else {
          document.getElementById('welcomeScreen').classList.remove('hidden');
          
          document.getElementById('btnEntrarSistema').addEventListener('click', entrarNoSistema);
          
          document.getElementById('inputNomeVendedorInicial').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              entrarNoSistema();
            }
          });
          
          setTimeout(() => {
            document.getElementById('inputNomeVendedorInicial').focus();
          }, 300);
        }

        // Event Listeners
        document.getElementById('btnNovaProposta').addEventListener('click', () => {
          mostrarFormularioProposta();
        });

        document.getElementById('btnAbrirMenu').addEventListener('click', () => {
          mostrarMenu();
        });
      } catch (error) {
        console.error("Erro na inicializa√ß√£o:", error);
        document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro ao carregar o m√≥dulo.</p>';
      }
    }
    
    function entrarNoSistema() {
      const nomeInput = document.getElementById('inputNomeVendedorInicial');
      const nome = nomeInput.value.trim();
      
      if (!nome) {
        nomeInput.classList.add('border-red-500');
        nomeInput.placeholder = '‚ö†Ô∏è Por favor, digite seu nome';
        nomeInput.focus();
        
        setTimeout(() => {
          nomeInput.classList.remove('border-red-500');
          nomeInput.placeholder = 'Digite seu nome completo';
        }, 2000);
        return;
      }
      
      nomeVendedorLogado = nome;
      localStorage.setItem('nomeVendedorLogado', nome);
      document.getElementById('nomeUsuarioHeader').textContent = nome;
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      showToast(`üéâ Bem-vindo(a), ${nome}!`, 'success');
    }

    function renderListaPropostas(data) {
      const container = document.getElementById('listaPropostas');
      const emptyState = document.getElementById('emptyState');
      
      if (data.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      container.innerHTML = data.map(proposta => {
        const totalProdutos = proposta.produtos ? proposta.produtos.length : 0;
        
        // Calcula valor total
        let valorTotal = 0;
        if (proposta.produtos) {
          proposta.produtos.forEach(prod => {
            const precoNormal = parseFloat(prod.preco_normal) || 0;
            const precoPromocional = parseFloat(prod.preco_promocional) || 0;
            const valorAvista = precoPromocional > 0 ? precoPromocional : precoNormal;
            valorTotal += valorAvista;
          });
        }
        
        // Formata data de cria√ß√£o
        const dataCriacao = proposta.criado_em ? new Date(proposta.criado_em) : new Date();
        const dataFormatada = dataCriacao.toLocaleDateString('pt-BR');
        const horaFormatada = dataCriacao.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        return `
        <div class="bg-white border-2 border-blue-300 rounded-xl p-5 hover:shadow-xl transition-all">
          <!-- Cabe√ßalho com Loja -->
          <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg p-3 mb-4">
            <p class="font-bold text-sm">üè™ Iguatu 3 - Ao lado do Bradesco</p>
          </div>

          <!-- Informa√ß√µes Principais -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-blue-50 rounded-lg p-3">
              <p class="text-xs text-gray-600 mb-1">üë§ Vendedor</p>
              <p class="font-bold text-gray-800">${proposta.vendedor}</p>
            </div>
            
            <div class="bg-green-50 rounded-lg p-3">
              <p class="text-xs text-gray-600 mb-1">üìÖ Data</p>
              <p class="font-bold text-gray-800">${proposta.data || dataFormatada}</p>
            </div>
            
            <div class="bg-purple-50 rounded-lg p-3">
              <p class="text-xs text-gray-600 mb-1">üéØ Cliente</p>
              <p class="font-bold text-gray-800">${proposta.cliente_nome}</p>
            </div>
          </div>

          <!-- Resumo -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center flex-wrap gap-3">
              <div>
                <p class="text-sm text-gray-600">üì¶ Produtos</p>
                <p class="text-2xl font-bold text-green-600">${totalProdutos} produto(s)</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">üí∞ Valor Total</p>
                <p class="text-2xl font-bold text-blue-600">R$ ${valorTotal.toFixed(2)}</p>
              </div>
            </div>
          </div>

          <!-- Status e Data de Cria√ß√£o -->
          <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
            <div class="bg-yellow-100 border border-yellow-400 rounded-lg px-4 py-2">
              <p class="text-sm font-bold text-yellow-800">Em an√°lise</p>
            </div>
            <div class="text-sm text-gray-600">
              <p>üì± Cliente: ${dataFormatada} √†s ${horaFormatada}</p>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="flex gap-2 flex-wrap">
            <button onclick="visualizarProposta('${proposta.__backendId}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm">
              üëÅÔ∏è Ver
            </button>
            <button onclick="editarProposta('${proposta.__backendId}')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-all text-sm">
              ‚úèÔ∏è Editar
            </button>
            <button onclick="confirmarExclusao('${proposta.__backendId}')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-all text-sm">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `;
      }).join('');
    }

    function updateContador(count) {
      document.getElementById('contadorPropostas').textContent = count + ' proposta' + (count !== 1 ? 's' : '');
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // ========== MENU ==========
    function mostrarMenu() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="bg-gradient-to-r from-gray-700 to-gray-900 text-white p-6 rounded-t-2xl flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üìã Menu Principal</h2>
              <p class="text-gray-300 text-sm mt-1">Ferramentas e Configura√ß√µes</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6 space-y-3">
            <button onclick="mostrarTaxasJuros(); this.closest('.fixed').remove();" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üìä</span>
              <div class="flex-1">
                <div class="font-bold">Taxas de Juros</div>
                <div class="text-xs text-blue-600">Consulte as taxas de carn√™ e cart√£o</div>
              </div>
            </button>
            
            <button onclick="mostrarCalculadora(); this.closest('.fixed').remove();" class="w-full bg-green-50 hover:bg-green-100 text-green-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üßÆ</span>
              <div class="flex-1">
                <div class="font-bold">Calculadora</div>
                <div class="text-xs text-green-600">Calcule parcelas e valores</div>
              </div>
            </button>
            
            <button onclick="mostrarRelatorios(); this.closest('.fixed').remove();" class="w-full bg-purple-50 hover:bg-purple-100 text-purple-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üìà</span>
              <div class="flex-1">
                <div class="font-bold">Relat√≥rios</div>
                <div class="text-xs text-purple-600">Visualize estat√≠sticas e dados</div>
              </div>
            </button>
            
            <button onclick="mostrarBaixarApp(); this.closest('.fixed').remove();" class="w-full bg-orange-50 hover:bg-orange-100 text-orange-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üì±</span>
              <div class="flex-1">
                <div class="font-bold">Baixar App</div>
                <div class="text-xs text-orange-600">Instale no seu dispositivo</div>
              </div>
            </button>
            
            <button onclick="sairSistema(); this.closest('.fixed').remove();" class="w-full bg-red-50 hover:bg-red-100 text-red-800 px-6 py-4 rounded-lg font-semibold text-left flex items-center gap-3 transition-all">
              <span class="text-2xl">üö™</span>
              <div class="flex-1">
                <div class="font-bold">Sair</div>
                <div class="text-xs text-red-600">Fazer logout do sistema</div>
              </div>
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function mostrarTaxasJuros() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto';
      
      let tabelaCarne = '';
      let tabelaCartao = '';
      
      for (let i = 0; i < 12; i++) {
        tabelaCarne += `
          <tr class="border-b hover:bg-blue-50">
            <td class="px-4 py-3 text-center font-semibold">${i + 1}x</td>
            <td class="px-4 py-3 text-center">${TAXAS_CARNE[i].toFixed(4)}</td>
          </tr>
        `;
        
        tabelaCartao += `
          <tr class="border-b hover:bg-green-50">
            <td class="px-4 py-3 text-center font-semibold">${i + 1}x</td>
            <td class="px-4 py-3 text-center">${TAXAS_CARTAO[i].toFixed(4)}</td>
          </tr>
        `;
      }
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
          <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
            <div>
              <h2 class="text-2xl font-bold">üìä Taxas de Juros</h2>
              <p class="text-blue-100 text-sm mt-1">Tabela de taxas para carn√™ e cart√£o</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              
              <!-- Tabela Carn√™ -->
              <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4">
                <h3 class="text-xl font-bold text-blue-800 mb-4 text-center">üé´ Carn√™</h3>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-blue-600 text-white">
                      <tr>
                        <th class="px-4 py-3 text-center">Parcelas</th>
                        <th class="px-4 py-3 text-center">Taxa</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white">
                      ${tabelaCarne}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Tabela Cart√£o -->
              <div class="bg-green-50 border-2 border-green-300 rounded-xl p-4">
                <h3 class="text-xl font-bold text-green-800 mb-4 text-center">üí≥ Cart√£o</h3>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-green-600 text-white">
                      <tr>
                        <th class="px-4 py-3 text-center">Parcelas</th>
                        <th class="px-4 py-3 text-center">Taxa</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white">
                      ${tabelaCartao}
                    </tbody>
                  </table>
                </div>
              </div>

            </div>

            <div class="mt-6 text-center">
              <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-gray-700 transition-all">
                Fechar
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function mostrarCalculadora() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl">
          <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-t-2xl flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üßÆ Calculadora de Parcelas</h2>
              <p class="text-green-100 text-sm mt-1">Calcule valores de parcelas</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6">
            <div class="space-y-4">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">üí∞ Valor do Produto (R$)</label>
                <input type="number" id="calcValor" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0.00" step="0.01">
              </div>

              <div>
                <label class="block text-gray-700 font-semibold mb-2">üì¶ Tipo de Pagamento</label>
                <select id="calcTipo" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="carne">üé´ Carn√™</option>
                  <option value="cartao">üí≥ Cart√£o</option>
                </select>
              </div>

              <div>
                <label class="block text-gray-700 font-semibold mb-2">üî¢ N√∫mero de Parcelas</label>
                <select id="calcParcelas" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  ${Array.from({length: 12}, (_, i) => `<option value="${i + 1}">${i + 1}x</option>`).join('')}
                </select>
              </div>

              <button onclick="calcularParcela()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 shadow-lg transition-all">
                Calcular
              </button>

              <div id="resultadoCalc" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-6 mt-4">
                <h3 class="text-xl font-bold text-blue-800 mb-3 text-center">üìä Resultado</h3>
                <div class="space-y-2 text-center">
                  <p class="text-lg"><strong>Valor da Parcela:</strong> <span id="valorParcela" class="text-green-600 font-bold text-2xl"></span></p>
                  <p class="text-lg"><strong>Valor Total:</strong> <span id="valorTotal" class="text-blue-600 font-bold text-xl"></span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function calcularParcela() {
      const valor = parseFloat(document.getElementById('calcValor').value);
      const tipo = document.getElementById('calcTipo').value;
      const parcelas = parseInt(document.getElementById('calcParcelas').value);

      if (!valor || valor <= 0) {
        showToast('‚ö†Ô∏è Digite um valor v√°lido', 'error');
        return;
      }

      const taxas = tipo === 'carne' ? TAXAS_CARNE : TAXAS_CARTAO;
      const taxa = taxas[parcelas - 1];
      const valorParcela = valor * taxa;
      const valorTotal = valorParcela * parcelas;

      document.getElementById('valorParcela').textContent = `R$ ${valorParcela.toFixed(2)}`;
      document.getElementById('valorTotal').textContent = `R$ ${valorTotal.toFixed(2)}`;
      document.getElementById('resultadoCalc').classList.remove('hidden');
    }

    function mostrarRelatorios() {
      const totalPropostas = allProposals.length;
      let totalProdutos = 0;
      
      allProposals.forEach(prop => {
        if (prop.produtos) {
          totalProdutos += prop.produtos.length;
        }
      });

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl">
          <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üìà Relat√≥rios</h2>
              <p class="text-purple-100 text-sm mt-1">Estat√≠sticas do sistema</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              
              <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 text-center">
                <div class="text-5xl mb-3">üìÑ</div>
                <div class="text-4xl font-bold mb-2">${totalPropostas}</div>
                <div class="text-blue-100">Propostas Criadas</div>
              </div>

              <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 text-center">
                <div class="text-5xl mb-3">üì¶</div>
                <div class="text-4xl font-bold mb-2">${totalProdutos}</div>
                <div class="text-green-100">Produtos Cadastrados</div>
              </div>

              <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 text-center">
                <div class="text-5xl mb-3">üë§</div>
                <div class="text-2xl font-bold mb-2">${nomeVendedorLogado}</div>
                <div class="text-purple-100">Vendedor Ativo</div>
              </div>

              <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl p-6 text-center">
                <div class="text-5xl mb-3">üöÄ</div>
                <div class="text-2xl font-bold mb-2">v1.5.0</div>
                <div class="text-orange-100">Vers√£o do Sistema</div>
              </div>

            </div>

            <div class="mt-6 text-center">
              <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-gray-700 transition-all">
                Fechar
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function mostrarBaixarApp() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-2xl flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üì± Baixar App</h2>
              <p class="text-orange-100 text-sm mt-1">Instale no seu dispositivo</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6 text-center">
            <div class="text-6xl mb-4">üì≤</div>
            <h3 class="text-xl font-bold text-gray-800 mb-3">Como Instalar</h3>
            
            <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 mb-4 text-left">
              <p class="font-semibold text-blue-800 mb-2">üì± No Celular:</p>
              <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                <li>Abra este site no navegador</li>
                <li>Toque no menu (‚ãÆ) do navegador</li>
                <li>Selecione "Adicionar √† tela inicial"</li>
                <li>Confirme a instala√ß√£o</li>
              </ol>
            </div>

            <div class="bg-green-50 border-2 border-green-300 rounded-xl p-4 mb-4 text-left">
              <p class="font-semibold text-green-800 mb-2">üíª No Computador:</p>
              <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                <li>Abra no Chrome ou Edge</li>
                <li>Clique no √≠cone de instala√ß√£o (‚ûï) na barra de endere√ßo</li>
                <li>Clique em "Instalar"</li>
              </ol>
            </div>

            <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-700 transition-all">
              Fechar
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }
    
    function sairSistema() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="bg-gradient-to-r from-red-600 to-rose-600 text-white p-6 rounded-t-2xl text-center">
            <div class="text-5xl mb-3">üö™</div>
            <h2 class="text-2xl font-bold">Sair do Sistema</h2>
          </div>
          
          <div class="p-6">
            <p class="text-gray-700 mb-4 text-center">
              Tem certeza que deseja sair?
            </p>
            <p class="text-sm text-gray-500 mb-6 text-center">
              Voc√™ ser√° redirecionado para a tela de login.
            </p>
            
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 transition-all">
                Cancelar
              </button>
              <button onclick="confirmarSaida()" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all">
                Sair
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function confirmarSaida() {
      localStorage.removeItem('nomeVendedorLogado');
      location.reload();
    }

    // ========== FORMUL√ÅRIO DE PROPOSTA COMPLETO ==========
    function mostrarFormularioProposta(propostaParaEditar = null) {
      const isEdicao = !!propostaParaEditar;
      
      // Oculta a lista e mostra o formul√°rio
      document.getElementById('listaView').classList.add('hidden');
      
      const formContainer = document.createElement('div');
      formContainer.id = 'formPropostaContainer';
      formContainer.className = 'bg-white rounded-xl shadow-lg p-6';
      
      formContainer.innerHTML = `
        <div class="mb-6">
          <button onclick="voltarParaLista()" class="text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-2 transition-all">
            <span>‚Üê</span>
            <span>Voltar para Lista</span>
          </button>
        </div>

        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-xl mb-6">
          <h2 class="text-3xl font-bold">‚úèÔ∏è Propostas</h2>
        </div>

        <form id="formNovaProposta" class="space-y-6">
          
          <!-- Dados B√°sicos -->
          <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4">üìã Dados B√°sicos</h3>
            
            <div class="bg-blue-100 border border-blue-300 rounded-lg p-3 mb-4">
              <p class="text-blue-800 font-semibold text-sm">üè™ Iguatu 3 - Ao lado do Bradesco</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Nome do Cliente</label>
                <input type="text" id="inputCliente" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Digite o nome do cliente" value="${isEdicao ? propostaParaEditar.cliente_nome : ''}">
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Contato do Cliente (com DDD)</label>
                <input type="tel" id="inputContato" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="(11) 98765-4321" value="${isEdicao ? propostaParaEditar.cliente_contato : ''}">
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">üìÖ Data Atual</label>
                <input type="text" id="inputDataAtual" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="23/11/2025" value="${isEdicao ? propostaParaEditar.data : ''}">
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">‚è∞ Validade da Proposta</label>
                <input type="text" id="inputValidade" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="dd/mm/aaaa" value="${isEdicao ? propostaParaEditar.validade : ''}">
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">T√≠tulo da Proposta</label>
                <input type="text" id="inputTitulo" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${isEdicao ? propostaParaEditar.titulo : 'Proposta Comercial'}">
              </div>
            </div>
          </div>

          <!-- Produtos -->
          <div class="bg-green-50 border-2 border-green-300 rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-green-800">üõí Produtos / Planos</h3>
              <button type="button" onclick="adicionarProduto()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-all">
                + Adicionar Produto
              </button>
            </div>

            <div id="listaProdutos" class="space-y-4">
              <!-- Produtos ser√£o inseridos aqui -->
            </div>

            <div id="emptyProdutos" class="text-center py-6 text-gray-500">
              <p>Nenhum produto adicionado. Clique em "Adicionar Produto".</p>
            </div>
          </div>

          <!-- Bot√£o para Mostrar Planos Exclusivos -->
          <div class="text-center">
            <button type="button" id="btnMostrarPlanoExclusivo" onclick="togglePlanoExclusivo()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-pink-700 shadow-lg transition-all flex items-center justify-center gap-3 mx-auto">
              <span class="text-2xl">üéÅ</span>
              <span>Adicionar Plano Exclusivo</span>
            </button>
          </div>

          <!-- Planos Exclusivos (Oculto por padr√£o) -->
          <div id="secaoPlanoExclusivo" class="bg-purple-50 border-2 border-purple-300 rounded-xl p-6 hidden">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-purple-800">üéÅ Planos Exclusivos (Solicita√ß√£o de Cliente)</h3>
              <button type="button" onclick="togglePlanoExclusivo()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all text-sm">
                ‚úï Remover
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Modalidade</label>
                <select id="inputModalidadePlano" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" onchange="atualizarPrecoTabelaPlano(); calcularPlanoExclusivo()">
                  <option value="">Selecione...</option>
                  <option value="avista">√Ä Vista</option>
                  <option value="carne">üé´ Carn√™</option>
                  <option value="cartao">üí≥ Cart√£o</option>
                </select>
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Pre√ßo de Tabela (Normal)</label>
                <input type="text" id="inputPrecoTabelaPlano" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 font-bold text-gray-700" placeholder="R$ 0,00" readonly value="">
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Valor da Garantia (G.E)</label>
                <div class="relative">
                  <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-600 font-semibold">R$</span>
                  <input type="text" id="inputGarantiaPlano" class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="0,00" value="${isEdicao && propostaParaEditar.garantia_plano ? formatarMoeda(propostaParaEditar.garantia_plano) : ''}" oninput="formatarCampoMoedaPlano(this); calcularPlanoExclusivo()">
                </div>
              </div>
              
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Parcelamento</label>
                <select id="inputParcelamentoPlano" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" onchange="calcularPlanoExclusivo()">
                  ${Array.from({length: 12}, (_, i) => {
                    const selected = isEdicao && propostaParaEditar.parcelas_plano === (i + 1) ? 'selected' : '';
                    return `<option value="${i + 1}" ${selected}>${i + 1}x</option>`;
                  }).join('')}
                </select>
              </div>
              
              <div class="md:col-span-2">
                <label class="block text-gray-700 font-semibold mb-2">Valor da Parcela</label>
                <input type="text" id="inputValorParcelaPlano" readonly class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gradient-to-r from-purple-100 to-pink-100 font-bold text-purple-700 text-center text-3xl" value="R$ 0,00">
              </div>
            </div>

            <div id="avisoPlanoExclusivo" class="mt-4 bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4">
              <p class="text-yellow-800 font-semibold text-center text-sm">‚ú® Selecione a modalidade e preencha os valores</p>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="flex gap-4">
            <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 shadow-lg transition-all flex items-center justify-center gap-2">
              <span>üíæ</span>
              <span>Salvar Proposta</span>
            </button>
            
            <button type="button" onclick="visualizarPropostaPreview()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-indigo-700 shadow-lg transition-all flex items-center justify-center gap-2">
              <span>üëÅÔ∏è</span>
              <span>Visualizar Proposta</span>
            </button>
          </div>
        </form>
      `;

      document.getElementById('viewContainer').appendChild(formContainer);

      // Define data atual se n√£o for edi√ß√£o
      if (!isEdicao) {
        const hoje = new Date();
        const dataFormatada = hoje.toLocaleDateString('pt-BR');
        document.getElementById('inputDataAtual').value = dataFormatada;
      }

      // Carrega produtos se for edi√ß√£o
      if (isEdicao && propostaParaEditar.produtos) {
        propostaParaEditar.produtos.forEach(produto => {
          adicionarProduto(produto);
        });
        
        // Ap√≥s carregar produtos, verifica modalidade e mostra se√ß√µes apropriadas
        setTimeout(() => {
          propostaParaEditar.produtos.forEach(produto => {
            if (produto.modalidade === 'carne') {
              toggleSecaoServicos(produto.id);
              
              if (produto.tem_garantia && produto.valor_garantia > 0) {
                const checkGarantia = document.querySelector(`#checkGarantia_${produto.id}`);
                if (checkGarantia) {
                  checkGarantia.checked = true;
                  toggleCampoGarantia(produto.id);
                }
              }
              
              if (produto.tem_prestamista && produto.valor_prestamista > 0) {
                const checkPrestamista = document.querySelector(`#checkPrestamista_${produto.id}`);
                if (checkPrestamista) {
                  checkPrestamista.checked = true;
                  toggleCampoPrestamista(produto.id);
                }
              }
            }
          });
        }, 100);
      }

      // Mostra e calcula plano exclusivo se for edi√ß√£o
      if (isEdicao && propostaParaEditar.modalidade_plano) {
        setTimeout(() => {
          togglePlanoExclusivo();
          document.getElementById('inputModalidadePlano').value = propostaParaEditar.modalidade_plano;
          atualizarPrecoTabelaPlano();
          calcularPlanoExclusivo();
        }, 100);
      }

      // Event listener do formul√°rio
      document.getElementById('formNovaProposta').addEventListener('submit', async (e) => {
        e.preventDefault();
        await salvarProposta(isEdicao, propostaParaEditar);
      });
    }

    function voltarParaLista() {
      const formContainer = document.getElementById('formPropostaContainer');
      if (formContainer) {
        formContainer.remove();
      }
      document.getElementById('listaView').classList.remove('hidden');
    }

    function togglePlanoExclusivo() {
      const secao = document.getElementById('secaoPlanoExclusivo');
      const botao = document.getElementById('btnMostrarPlanoExclusivo');
      
      if (secao.classList.contains('hidden')) {
        secao.classList.remove('hidden');
        botao.classList.add('hidden');
      } else {
        secao.classList.add('hidden');
        botao.classList.remove('hidden');
        // Limpa os campos ao remover
        document.getElementById('inputModalidadePlano').value = '';
        document.getElementById('inputPrecoTabelaPlano').value = '';
        document.getElementById('inputGarantiaPlano').value = '';
        document.getElementById('inputValorParcelaPlano').value = 'R$ 0,00';
        document.getElementById('inputParcelamentoPlano').value = '1';
      }
    }

    // Atualiza o pre√ßo de tabela baseado nos produtos adicionados
    function atualizarPrecoTabelaPlano() {
      const modalidade = document.getElementById('inputModalidadePlano').value;
      
      if (!modalidade) {
        document.getElementById('inputPrecoTabelaPlano').value = '';
        return;
      }

      // Pega todos os produtos e soma os pre√ßos normais
      const produtosDiv = document.querySelectorAll('.produto-item');
      let totalPrecoNormal = 0;

      produtosDiv.forEach(produtoDiv => {
        const precoNormal = converterMoedaParaNumero(produtoDiv.querySelector('[data-field="preco_normal"]').value);
        totalPrecoNormal += precoNormal;
      });

      if (totalPrecoNormal > 0) {
        document.getElementById('inputPrecoTabelaPlano').value = 'R$ ' + totalPrecoNormal.toFixed(2).replace('.', ',');
      } else {
        document.getElementById('inputPrecoTabelaPlano').value = 'R$ 0,00';
      }

      calcularPlanoExclusivo();
    }

    function formatarCampoMoedaPlano(input) {
      let valor = input.value.replace(/\D/g, '');
      
      if (valor === '') {
        input.value = '';
        return;
      }
      
      valor = parseInt(valor);
      const valorFormatado = (valor / 100).toFixed(2).replace('.', ',');
      
      const partes = valorFormatado.split(',');
      partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      input.value = partes.join(',');
    }

    function calcularPlanoExclusivo() {
      const modalidade = document.getElementById('inputModalidadePlano').value;
      const precoTabelaTexto = document.getElementById('inputPrecoTabelaPlano').value;
      const garantia = converterMoedaParaNumero(document.getElementById('inputGarantiaPlano').value);
      const parcelas = parseInt(document.getElementById('inputParcelamentoPlano').value);
      const avisoDiv = document.getElementById('avisoPlanoExclusivo');

      if (!modalidade) {
        document.getElementById('inputValorParcelaPlano').value = 'R$ 0,00';
        avisoDiv.innerHTML = '<p class="text-yellow-800 font-semibold text-center text-sm">‚ú® Selecione a modalidade e preencha os valores</p>';
        avisoDiv.className = 'mt-4 bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4';
        return;
      }

      // Extrai o valor num√©rico do pre√ßo de tabela
      const precoTabela = converterMoedaParaNumero(precoTabelaTexto.replace('R$', '').trim());

      if (precoTabela <= 0) {
        document.getElementById('inputValorParcelaPlano').value = 'R$ 0,00';
        avisoDiv.innerHTML = '<p class="text-red-800 font-semibold text-center text-sm">‚ö†Ô∏è Adicione produtos primeiro para calcular o plano exclusivo</p>';
        avisoDiv.className = 'mt-4 bg-red-100 border-2 border-red-400 rounded-lg p-4';
        return;
      }

      let valorParcela = 0;
      let mensagemAviso = '';

      // ========== REGRAS PARA CARN√ä ==========
      if (modalidade === 'carne') {
        const totalBase = precoTabela + garantia;

        if (parcelas <= 5) {
          // At√© 5x SEM JUROS no carn√™
          // F√≥rmula: (Produto + Garantia) / Parcelas * 1.06 (P.M)
          valorParcela = (totalBase / parcelas) * 1.06;
          mensagemAviso = `‚ú® <strong>Carn√™:</strong> At√© 5x SEM JUROS + Garantia + P.M (6%)`;
        } else {
          // A partir da 6¬™ parcela, usa taxa de juros do carn√™
          const taxa = TAXAS_CARNE[parcelas - 1];
          valorParcela = totalBase * taxa * 1.06; // Aplica taxa + P.M
          mensagemAviso = `üìä <strong>Carn√™:</strong> ${parcelas}x COM JUROS (taxa ${taxa.toFixed(4)}) + Garantia + P.M (6%)`;
        }

        avisoDiv.className = 'mt-4 bg-blue-100 border-2 border-blue-400 rounded-lg p-4';
      }
      // ========== REGRAS PARA CART√ÉO ==========
      else if (modalidade === 'cartao') {
        const totalBase = precoTabela + garantia;

        if (parcelas <= 6) {
          // At√© 6x SEM JUROS no cart√£o
          // F√≥rmula: (Produto + Garantia) / Parcelas
          valorParcela = totalBase / parcelas;
          mensagemAviso = `‚ú® <strong>Cart√£o:</strong> At√© 6x SEM JUROS + Garantia`;
        } else {
          // A partir da 7¬™ parcela, usa taxa de juros do cart√£o
          const taxa = TAXAS_CARTAO[parcelas - 1];
          valorParcela = totalBase * taxa;
          mensagemAviso = `üìä <strong>Cart√£o:</strong> ${parcelas}x COM JUROS (taxa ${taxa.toFixed(4)}) + Garantia`;
        }

        avisoDiv.className = 'mt-4 bg-green-100 border-2 border-green-400 rounded-lg p-4';
      }
      // ========== √Ä VISTA ==========
      else if (modalidade === 'avista') {
        valorParcela = precoTabela + garantia;
        mensagemAviso = `üí∞ <strong>√Ä Vista:</strong> Produto + Garantia`;
        avisoDiv.className = 'mt-4 bg-green-100 border-2 border-green-400 rounded-lg p-4';
      }

      document.getElementById('inputValorParcelaPlano').value = 'R$ ' + valorParcela.toFixed(2);
      avisoDiv.innerHTML = `<p class="text-gray-800 font-semibold text-center text-sm">${mensagemAviso}</p>`;
    }

    function visualizarPropostaPreview() {
      showToast('üí° Salve a proposta primeiro para visualizar', 'error');
    }

    let contadorProdutos = 0;

    function adicionarProduto(produtoExistente = null) {
      const id = produtoExistente ? produtoExistente.id : `prod_${Date.now()}_${contadorProdutos++}`;
      
      const listaProdutos = document.getElementById('listaProdutos');
      const emptyState = document.getElementById('emptyProdutos');
      
      emptyState.classList.add('hidden');

      const produtoDiv = document.createElement('div');
      produtoDiv.className = 'produto-item bg-white border-2 border-green-300 rounded-xl overflow-hidden';
      produtoDiv.dataset.produtoId = id;
      produtoDiv.dataset.expandido = 'true';
      
      produtoDiv.innerHTML = `
        <!-- Cabe√ßalho do Produto -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4 flex justify-between items-center cursor-pointer" onclick="toggleProduto('${id}')">
          <div class="flex items-center gap-3">
            <span class="text-2xl">üìÇ</span>
            <div>
              <h4 class="text-lg font-bold">Produto #${listaProdutos.children.length + 1}</h4>
              <p class="text-sm text-green-100">Clique para recolher</p>
            </div>
          </div>
          <button type="button" onclick="event.stopPropagation(); removerProduto('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all text-sm flex items-center gap-2">
            <span>üóëÔ∏è</span>
          </button>
        </div>

        <!-- Conte√∫do Expans√≠vel -->
        <div class="produto-conteudo p-5 space-y-4">
          
          <!-- C√≥digo/Nome do Produto -->
          <div>
            <label class="block text-gray-700 font-semibold mb-2">C√≥digo / Nome do Produto</label>
            <input type="text" data-field="nome" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Ex: COD123 - Nome do Produto" value="${produtoExistente ? produtoExistente.nome : ''}">
          </div>

          <!-- Pre√ßos -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">üíµ Pre√ßo Normal</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-600 font-semibold">R$</span>
                <input type="text" data-field="preco_normal" class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0,00" value="${produtoExistente ? formatarMoeda(produtoExistente.preco_normal || 0) : ''}" oninput="formatarCampoMoeda(this, '${id}'); atualizarPrecoTabelaPlano()">
              </div>
            </div>
            
            <div>
              <label class="block text-gray-700 font-semibold mb-2">üè∑Ô∏è Pre√ßo Promocional</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-600 font-semibold">R$</span>
                <input type="text" data-field="preco_promocional" class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0,00" value="${produtoExistente ? formatarMoeda(produtoExistente.preco_promocional || 0) : ''}" oninput="formatarCampoMoeda(this, '${id}')">
              </div>
            </div>
          </div>

          <!-- Servi√ßos (Garantia e Prestamista) - Aparece apenas para Carn√™ -->
          <div id="secaoServicos_${id}" class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4 hidden">
            <div class="flex justify-between items-center mb-4">
              <label class="block text-gray-700 font-semibold">üõ†Ô∏è Adicionar Servi√ßos?</label>
              <button type="button" onclick="fecharSecaoServicos('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg font-semibold transition-all text-sm">
                ‚úï Fechar
              </button>
            </div>

            <!-- Op√ß√£o Garantia (G.E) -->
            <div class="bg-white border-2 border-blue-300 rounded-lg p-4 mb-3">
              <div class="flex items-center gap-3 mb-3">
                <input type="checkbox" id="checkGarantia_${id}" data-field="tem_garantia" class="w-5 h-5 text-blue-600" ${produtoExistente && produtoExistente.tem_garantia ? 'checked' : ''} onchange="toggleCampoGarantia('${id}')">
                <label for="checkGarantia_${id}" class="font-semibold text-gray-800 cursor-pointer">üõ°Ô∏è Garantia Estendida (G.E)</label>
              </div>
              
              <div id="campoGarantia_${id}" class="hidden">
                <label class="block text-gray-700 font-semibold mb-2">üí∞ Valor da Garantia</label>
                <div class="relative">
                  <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-600 font-semibold">R$</span>
                  <input type="text" data-field="valor_garantia" class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0,00" value="${produtoExistente && produtoExistente.valor_garantia ? formatarMoeda(produtoExistente.valor_garantia) : ''}" oninput="formatarCampoMoeda(this, '${id}')">
                </div>
              </div>
            </div>

            <!-- Op√ß√£o Prestamista (P.M) - Calculado automaticamente -->
            <div class="bg-white border-2 border-purple-300 rounded-lg p-4">
              <div class="flex items-center gap-3 mb-3">
                <input type="checkbox" id="checkPrestamista_${id}" data-field="tem_prestamista" class="w-5 h-5 text-purple-600" ${produtoExistente && produtoExistente.tem_prestamista ? 'checked' : ''} onchange="toggleCampoPrestamista('${id}')">
                <label for="checkPrestamista_${id}" class="font-semibold text-gray-800 cursor-pointer">üè• Prestamista (P.M)</label>
              </div>
              
              <div id="campoPrestamista_${id}" class="hidden">
                <div class="bg-purple-50 border border-purple-300 rounded-lg p-3">
                  <p class="text-sm text-purple-800 mb-2">
                    <strong>üìã P.M - Adiciona 6% na parcela</strong>
                  </p>
                  <p class="text-xs text-purple-700">
                    ‚ÑπÔ∏è O valor do Prestamista ser√° calculado automaticamente como 6% sobre a parcela (Produto + G.E)
                  </p>
                </div>
              </div>
            </div>

            <div class="mt-3 bg-blue-100 border border-blue-300 rounded-lg p-3">
              <p class="text-xs text-blue-800">
                ‚ÑπÔ∏è <strong>Carn√™:</strong> P.M adiciona 6% sobre a parcela calculada
              </p>
            </div>
          </div>

          <!-- Modalidade e Parcelas -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Modalidade de Pagamento</label>
              <select data-field="modalidade" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" onchange="toggleSecaoServicos('${id}')">
                <option value="avista" ${produtoExistente && produtoExistente.modalidade === 'avista' ? 'selected' : ''}>√Ä Vista</option>
                <option value="carne" ${produtoExistente && produtoExistente.modalidade === 'carne' ? 'selected' : ''}>üé´ Carn√™</option>
                <option value="cartao" ${produtoExistente && produtoExistente.modalidade === 'cartao' ? 'selected' : ''}>üí≥ Cart√£o</option>
              </select>
            </div>
            
            <div>
              <label class="block text-gray-700 font-semibold mb-2">N√∫mero de Parcelas</label>
              <select data-field="num_parcelas" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" onchange="calcularResumoFinanceiro('${id}')">
                ${Array.from({length: 12}, (_, i) => {
                  const selected = produtoExistente && produtoExistente.num_parcelas === (i + 1) ? 'selected' : '';
                  return `<option value="${i + 1}" ${selected}>${i + 1}x</option>`;
                }).join('')}
              </select>
            </div>
          </div>

          <!-- Resumo Financeiro -->
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-5">
            <h5 class="text-lg font-bold text-blue-800 mb-4">üí∞ Resumo Financeiro</h5>
            
            <!-- Comparativo de Parcelas -->
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-lg p-4 text-center shadow-lg">
                <p class="text-xs mb-2 opacity-90">üè∑Ô∏è PARCELA PROMOCIONAL</p>
                <p class="text-3xl font-bold" data-resumo="parcela_promocional">R$ 0,00</p>
                <p class="text-sm mt-1 opacity-90" data-resumo="num_parcelas_texto">1x</p>
              </div>
              
              <div class="bg-white rounded-lg p-4 text-center border-2 border-gray-300">
                <p class="text-xs text-gray-600 mb-2">üíµ PARCELA NORMAL</p>
                <p class="text-3xl font-bold text-gray-600" data-resumo="parcela_normal">R$ 0,00</p>
                <p class="text-sm text-gray-500 mt-1" data-resumo="num_parcelas_texto2">1x</p>
              </div>
            </div>

            <!-- Comparativo de Totais -->
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="bg-white rounded-lg p-4 text-center border-2 border-green-400">
                <p class="text-xs text-gray-600 mb-2">üí∞ TOTAL PROMOCIONAL</p>
                <p class="text-2xl font-bold text-green-600" data-resumo="total_promocional">R$ 0,00</p>
              </div>
              
              <div class="bg-white rounded-lg p-4 text-center border-2 border-gray-300">
                <p class="text-xs text-gray-600 mb-2">üíµ TOTAL NORMAL</p>
                <p class="text-2xl font-bold text-gray-600" data-resumo="total_normal">R$ 0,00</p>
              </div>
            </div>

            <!-- Economia Total -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg p-4 text-center shadow-lg">
              <p class="text-sm mb-2 font-semibold">üéâ ECONOMIA TOTAL</p>
              <p class="text-4xl font-bold mb-1" data-resumo="economia_total">R$ 0,00</p>
              <p class="text-sm font-semibold" data-resumo="economia_percentual">(0% de desconto)</p>
              <p class="text-xs mt-2 opacity-90" data-resumo="economia_por_parcela">Economize R$ 0,00 por parcela!</p>
            </div>
          </div>

        </div>
      `;

      listaProdutos.appendChild(produtoDiv);

      // Calcula resumo se tiver valores
      if (produtoExistente && (produtoExistente.preco_normal || produtoExistente.preco_promocional)) {
        setTimeout(() => calcularResumoFinanceiro(id), 100);
      }

      // Atualiza pre√ßo de tabela do plano exclusivo
      setTimeout(() => atualizarPrecoTabelaPlano(), 100);
    }

    function toggleProduto(id) {
      const produtoDiv = document.querySelector(`[data-produto-id="${id}"]`);
      if (!produtoDiv) return;

      const conteudo = produtoDiv.querySelector('.produto-conteudo');
      const expandido = produtoDiv.dataset.expandido === 'true';
      
      if (expandido) {
        conteudo.style.display = 'none';
        produtoDiv.dataset.expandido = 'false';
        produtoDiv.querySelector('.bg-gradient-to-r p').textContent = 'Clique para expandir';
      } else {
        conteudo.style.display = 'block';
        produtoDiv.dataset.expandido = 'true';
        produtoDiv.querySelector('.bg-gradient-to-r p').textContent = 'Clique para recolher';
      }
    }

    function toggleSecaoServicos(produtoId) {
      const produtoDiv = document.querySelector(`[data-produto-id="${produtoId}"]`);
      if (!produtoDiv) return;

      const modalidade = produtoDiv.querySelector('[data-field="modalidade"]').value;
      const secaoServicos = produtoDiv.querySelector(`#secaoServicos_${produtoId}`);
      
      // Mostra se√ß√£o de servi√ßos APENAS para Carn√™
      if (modalidade === 'carne') {
        secaoServicos.classList.remove('hidden');
      } else {
        secaoServicos.classList.add('hidden');
        // Reseta valores quando oculta
        const checkGarantia = produtoDiv.querySelector('[data-field="tem_garantia"]');
        const checkPrestamista = produtoDiv.querySelector('[data-field="tem_prestamista"]');
        if (checkGarantia) checkGarantia.checked = false;
        if (checkPrestamista) checkPrestamista.checked = false;
        
        const campoGarantia = produtoDiv.querySelector(`#campoGarantia_${produtoId}`);
        const campoPrestamista = produtoDiv.querySelector(`#campoPrestamista_${produtoId}`);
        if (campoGarantia) campoGarantia.classList.add('hidden');
        if (campoPrestamista) campoPrestamista.classList.add('hidden');
        
        const inputGarantia = produtoDiv.querySelector('[data-field="valor_garantia"]');
        const inputPrestamista = produtoDiv.querySelector('[data-field="valor_prestamista"]');
        if (inputGarantia) inputGarantia.value = '';
        if (inputPrestamista) inputPrestamista.value = '';
      }
      
      calcularResumoFinanceiro(produtoId);
    }

    function fecharSecaoServicos(produtoId) {
      const produtoDiv = document.querySelector(`[data-produto-id="${produtoId}"]`);
      if (!produtoDiv) return;

      const secaoServicos = produtoDiv.querySelector(`#secaoServicos_${produtoId}`);
      secaoServicos.classList.add('hidden');
      
      // Reseta todos os valores
      const checkGarantia = produtoDiv.querySelector('[data-field="tem_garantia"]');
      const checkPrestamista = produtoDiv.querySelector('[data-field="tem_prestamista"]');
      if (checkGarantia) checkGarantia.checked = false;
      if (checkPrestamista) checkPrestamista.checked = false;
      
      const campoGarantia = produtoDiv.querySelector(`#campoGarantia_${produtoId}`);
      const campoPrestamista = produtoDiv.querySelector(`#campoPrestamista_${produtoId}`);
      if (campoGarantia) campoGarantia.classList.add('hidden');
      if (campoPrestamista) campoPrestamista.classList.add('hidden');
      
      const inputGarantia = produtoDiv.querySelector('[data-field="valor_garantia"]');
      const inputPrestamista = produtoDiv.querySelector('[data-field="valor_prestamista"]');
      if (inputGarantia) inputGarantia.value = '';
      if (inputPrestamista) inputPrestamista.value = '';
      
      calcularResumoFinanceiro(produtoId);
    }

    function toggleCampoGarantia(produtoId) {
      const produtoDiv = document.querySelector(`[data-produto-id="${produtoId}"]`);
      if (!produtoDiv) return;

      const checkGarantia = produtoDiv.querySelector('[data-field="tem_garantia"]');
      const campoGarantia = produtoDiv.querySelector(`#campoGarantia_${produtoId}`);
      
      if (checkGarantia.checked) {
        campoGarantia.classList.remove('hidden');
      } else {
        campoGarantia.classList.add('hidden');
        const inputGarantia = produtoDiv.querySelector('[data-field="valor_garantia"]');
        if (inputGarantia) inputGarantia.value = '';
      }
      
      calcularResumoFinanceiro(produtoId);
    }

    function toggleCampoPrestamista(produtoId) {
      const produtoDiv = document.querySelector(`[data-produto-id="${produtoId}"]`);
      if (!produtoDiv) return;

      const checkPrestamista = produtoDiv.querySelector('[data-field="tem_prestamista"]');
      const campoPrestamista = produtoDiv.querySelector(`#campoPrestamista_${produtoId}`);
      
      if (checkPrestamista.checked) {
        campoPrestamista.classList.remove('hidden');
      } else {
        campoPrestamista.classList.add('hidden');
        const inputPrestamista = produtoDiv.querySelector('[data-field="valor_prestamista"]');
        if (inputPrestamista) inputPrestamista.value = '';
      }
      
      calcularResumoFinanceiro(produtoId);
    }

    // Fun√ß√£o para formatar valor em moeda brasileira
    function formatarMoeda(valor) {
      if (!valor || valor === 0) return '';
      const numero = typeof valor === 'string' ? parseFloat(valor) : valor;
      return numero.toFixed(2).replace('.', ',');
    }

    // Fun√ß√£o para converter moeda formatada em n√∫mero
    function converterMoedaParaNumero(valorFormatado) {
      if (!valorFormatado) return 0;
      return parseFloat(valorFormatado.replace(/\./g, '').replace(',', '.')) || 0;
    }

    // Fun√ß√£o para formatar campo de moeda enquanto digita
    function formatarCampoMoeda(input, produtoId) {
      let valor = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito
      
      if (valor === '') {
        input.value = '';
        calcularResumoFinanceiro(produtoId);
        return;
      }
      
      // Converte para n√∫mero e formata
      valor = parseInt(valor);
      const valorFormatado = (valor / 100).toFixed(2).replace('.', ',');
      
      // Adiciona separador de milhares
      const partes = valorFormatado.split(',');
      partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      input.value = partes.join(',');
      
      calcularResumoFinanceiro(produtoId);
    }

    function calcularResumoFinanceiro(produtoId) {
      const produtoDiv = document.querySelector(`[data-produto-id="${produtoId}"]`);
      if (!produtoDiv) return;

      const precoNormal = converterMoedaParaNumero(produtoDiv.querySelector('[data-field="preco_normal"]').value);
      const precoPromocional = converterMoedaParaNumero(produtoDiv.querySelector('[data-field="preco_promocional"]').value);
      const modalidade = produtoDiv.querySelector('[data-field="modalidade"]').value;
      const numParcelas = parseInt(produtoDiv.querySelector('[data-field="num_parcelas"]').value);
      
      // Verifica se tem garantia e prestamista MARCADOS (apenas para carn√™)
      const temGarantia = produtoDiv.querySelector('[data-field="tem_garantia"]')?.checked || false;
      const temPrestamista = produtoDiv.querySelector('[data-field="tem_prestamista"]')?.checked || false;
      
      // S√≥ pega os valores se estiverem MARCADOS
      const valorGarantia = temGarantia ? converterMoedaParaNumero(produtoDiv.querySelector('[data-field="valor_garantia"]')?.value) : 0;

      // ========== C√ÅLCULO DO PRE√áO PROMOCIONAL ==========
      let valorBasePromocional = precoPromocional > 0 ? precoPromocional : precoNormal;
      let parcelaPromocional = 0;
      let totalPromocional = 0;
      
      if (valorBasePromocional > 0) {
        if (modalidade === 'avista') {
          // √Ä vista: s√≥ o pre√ßo do produto
          parcelaPromocional = valorBasePromocional;
          totalPromocional = valorBasePromocional;
        } else if (modalidade === 'carne') {
          const taxa = TAXAS_CARNE[numParcelas - 1];
          
          // Soma produto + garantia (se marcada)
          const totalComServicos = valorBasePromocional + valorGarantia;
          parcelaPromocional = totalComServicos * taxa;
          
          // Adiciona 6% sobre a parcela APENAS SE P.M ESTIVER MARCADO
          if (temPrestamista) {
            parcelaPromocional = parcelaPromocional * 1.06;
          }
          
          totalPromocional = parcelaPromocional * numParcelas;
        } else if (modalidade === 'cartao') {
          const taxa = TAXAS_CARTAO[numParcelas - 1];
          // Cart√£o: s√≥ o pre√ßo do produto (n√£o tem servi√ßos)
          parcelaPromocional = valorBasePromocional * taxa;
          totalPromocional = parcelaPromocional * numParcelas;
        }
      }

      // ========== C√ÅLCULO DO PRE√áO NORMAL (TABELA) ==========
      let parcelaNormal = 0;
      let totalNormal = 0;
      
      if (precoNormal > 0) {
        if (modalidade === 'avista') {
          // √Ä vista: s√≥ o pre√ßo do produto
          parcelaNormal = precoNormal;
          totalNormal = precoNormal;
        } else if (modalidade === 'carne') {
          const taxa = TAXAS_CARNE[numParcelas - 1];
          
          // Soma produto + garantia (se marcada)
          const totalComServicos = precoNormal + valorGarantia;
          parcelaNormal = totalComServicos * taxa;
          
          // Adiciona 6% sobre a parcela APENAS SE P.M ESTIVER MARCADO
          if (temPrestamista) {
            parcelaNormal = parcelaNormal * 1.06;
          }
          
          totalNormal = parcelaNormal * numParcelas;
        } else if (modalidade === 'cartao') {
          const taxa = TAXAS_CARTAO[numParcelas - 1];
          // Cart√£o: s√≥ o pre√ßo do produto (n√£o tem servi√ßos)
          parcelaNormal = precoNormal * taxa;
          totalNormal = parcelaNormal * numParcelas;
        }
      }

      // ========== C√ÅLCULO DA ECONOMIA (NUNCA NEGATIVO) ==========
      let economiaTotal = totalNormal - totalPromocional;
      let economiaPorParcela = parcelaNormal - parcelaPromocional;
      
      // Garante que nunca seja negativo
      if (economiaTotal < 0) economiaTotal = 0;
      if (economiaPorParcela < 0) economiaPorParcela = 0;
      
      const percentualEconomia = totalNormal > 0 ? (economiaTotal / totalNormal) * 100 : 0;

      // ========== ATUALIZA O RESUMO ==========
      // Parcelas
      produtoDiv.querySelector('[data-resumo="parcela_promocional"]').textContent = 'R$ ' + parcelaPromocional.toFixed(2);
      produtoDiv.querySelector('[data-resumo="parcela_normal"]').textContent = 'R$ ' + parcelaNormal.toFixed(2);
      produtoDiv.querySelector('[data-resumo="num_parcelas_texto"]').textContent = numParcelas + 'x';
      produtoDiv.querySelector('[data-resumo="num_parcelas_texto2"]').textContent = numParcelas + 'x';
      
      // Totais
      produtoDiv.querySelector('[data-resumo="total_promocional"]').textContent = 'R$ ' + totalPromocional.toFixed(2);
      produtoDiv.querySelector('[data-resumo="total_normal"]').textContent = 'R$ ' + totalNormal.toFixed(2);
      
      // Economia
      produtoDiv.querySelector('[data-resumo="economia_total"]').textContent = 'R$ ' + economiaTotal.toFixed(2);
      produtoDiv.querySelector('[data-resumo="economia_percentual"]').textContent = '(' + percentualEconomia.toFixed(1) + '% de desconto)';
      produtoDiv.querySelector('[data-resumo="economia_por_parcela"]').textContent = 'Economize R$ ' + economiaPorParcela.toFixed(2) + ' por parcela!';
    }

    function removerProduto(id) {
      const produto = document.querySelector(`[data-produto-id="${id}"]`);
      if (produto) {
        produto.remove();
        
        // Atualiza numera√ß√£o
        const produtos = document.querySelectorAll('.produto-item');
        produtos.forEach((prod, index) => {
          prod.querySelector('h4').textContent = `Produto #${index + 1}`;
        });

        // Mostra empty state se n√£o houver produtos
        if (produtos.length === 0) {
          document.getElementById('emptyProdutos').classList.remove('hidden');
        }

        // Atualiza pre√ßo de tabela do plano exclusivo
        atualizarPrecoTabelaPlano();
      }
    }

    function coletarProdutos() {
      const produtos = [];
      const produtosDiv = document.querySelectorAll('.produto-item');

      produtosDiv.forEach(produtoDiv => {
        const produto = {
          id: produtoDiv.dataset.produtoId,
          nome: produtoDiv.querySelector('[data-field="nome"]').value,
          preco_normal: converterMoedaParaNumero(produtoDiv.querySelector('[data-field="preco_normal"]').value),
          preco_promocional: converterMoedaParaNumero(produtoDiv.querySelector('[data-field="preco_promocional"]').value),
          modalidade: produtoDiv.querySelector('[data-field="modalidade"]').value,
          num_parcelas: parseInt(produtoDiv.querySelector('[data-field="num_parcelas"]').value),
          tem_garantia: produtoDiv.querySelector('[data-field="tem_garantia"]')?.checked || false,
          valor_garantia: converterMoedaParaNumero(produtoDiv.querySelector('[data-field="valor_garantia"]')?.value),
          tem_prestamista: produtoDiv.querySelector('[data-field="tem_prestamista"]')?.checked || false,
          valor_prestamista: converterMoedaParaNumero(produtoDiv.querySelector('[data-field="valor_prestamista"]')?.value)
        };
        produtos.push(produto);
      });

      return produtos;
    }

    async function salvarProposta(isEdicao, propostaOriginal) {
      const clienteNome = document.getElementById('inputCliente').value.trim();
      const clienteContato = document.getElementById('inputContato').value.trim();
      
      if (!clienteNome || !clienteContato) {
        showToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      const produtos = coletarProdutos();

      if (produtos.length === 0) {
        showToast('‚ö†Ô∏è Adicione pelo menos um produto', 'error');
        return;
      }

      const proposta = {
        vendedor: nomeVendedorLogado,
        cliente_nome: clienteNome,
        cliente_contato: clienteContato,
        titulo: document.getElementById('inputTitulo').value || 'Proposta Comercial',
        data: document.getElementById('inputDataAtual').value,
        validade: document.getElementById('inputValidade').value,
        produtos: produtos,
        criado_em: isEdicao ? propostaOriginal.criado_em : new Date().toISOString(),
        atualizado_em: new Date().toISOString()
      };

      // Salva dados do plano exclusivo se existir
      const modalidadePlano = document.getElementById('inputModalidadePlano').value;
      if (modalidadePlano) {
        proposta.modalidade_plano = modalidadePlano;
        proposta.preco_tabela_plano = document.getElementById('inputPrecoTabelaPlano').value;
        proposta.garantia_plano = converterMoedaParaNumero(document.getElementById('inputGarantiaPlano').value);
        proposta.parcelas_plano = parseInt(document.getElementById('inputParcelamentoPlano').value);
        proposta.valor_parcela_plano = document.getElementById('inputValorParcelaPlano').value;
      }

      // Mostra loading
      const btnSalvar = document.querySelector('#formNovaProposta button[type="submit"]');
      const textoOriginal = btnSalvar.innerHTML;
      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<span class="animate-spin">‚è≥</span> Salvando...';

      let result;
      
      if (isEdicao) {
        proposta.__backendId = propostaOriginal.__backendId;
        result = await window.dataSdk.update(proposta);
      } else {
        result = await window.dataSdk.create(proposta);
      }
      
      if (result.isOk) {
        voltarParaLista();
        showToast(`‚úÖ Proposta ${isEdicao ? 'atualizada' : 'criada'} com sucesso!`, 'success');
      } else {
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
        showToast('‚ùå Erro ao salvar proposta. Tente novamente.', 'error');
      }
    }

    function visualizarProposta(id) {
      const proposta = allProposals.find(p => p.__backendId === id);
      if (!proposta) return;

      propostaAtual = proposta;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.style.overflowY = 'auto';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-y-auto my-4">
          <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
            <div>
              <h2 class="text-2xl font-bold">üëÅÔ∏è Visualizar Proposta</h2>
              <p class="text-purple-100 text-sm mt-1">${proposta.titulo}</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold transition-colors">
              ‚úï
            </button>
          </div>

          <div class="p-6">
            <!-- Tabs -->
            <div class="flex gap-2 mb-6 border-b-2 border-gray-200">
              <button onclick="trocarTab('cliente')" id="tabCliente" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 transition-all tab-active">
                üë§ Vis√£o Cliente
              </button>
              <button onclick="trocarTab('diretoria')" id="tabDiretoria" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 transition-all">
                üìä Vis√£o Diretoria
              </button>
            </div>

            <!-- Conte√∫do Vis√£o Cliente -->
            <div id="conteudoCliente" class="space-y-6">
              ${gerarVisaoCliente(proposta)}
            </div>

            <!-- Conte√∫do Vis√£o Diretoria -->
            <div id="conteudoDiretoria" class="hidden space-y-6">
              ${gerarVisaoDiretoria(proposta)}
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex gap-3 mt-6 no-print">
              <button onclick="imprimirProposta()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                <span>üñ®Ô∏è</span>
                <span>Imprimir</span>
              </button>
              
              <button onclick="enviarWhatsApp('${id}')" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition-all flex items-center justify-center gap-2">
                <span>üì±</span>
                <span>Enviar WhatsApp</span>
              </button>
              
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-700 transition-all">
                Fechar
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function trocarTab(tab) {
      document.getElementById('tabCliente').classList.remove('tab-active');
      document.getElementById('tabDiretoria').classList.remove('tab-active');
      document.getElementById('conteudoCliente').classList.add('hidden');
      document.getElementById('conteudoDiretoria').classList.add('hidden');

      if (tab === 'cliente') {
        document.getElementById('tabCliente').classList.add('tab-active');
        document.getElementById('conteudoCliente').classList.remove('hidden');
      } else {
        document.getElementById('tabDiretoria').classList.add('tab-active');
        document.getElementById('conteudoDiretoria').classList.remove('hidden');
      }
    }

    function gerarVisaoCliente(proposta) {
      let html = `
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-xl">
          <h3 class="text-2xl font-bold mb-2">${proposta.titulo}</h3>
          <p class="text-blue-100">Proposta preparada especialmente para voc√™</p>
        </div>

        <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-6">
          <h4 class="text-lg font-bold text-blue-800 mb-3">üìã Informa√ß√µes</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <p><strong>Cliente:</strong> ${proposta.cliente_nome}</p>
            <p><strong>Data:</strong> ${proposta.data || 'N√£o informada'}</p>
            <p><strong>Validade:</strong> ${proposta.validade || 'N√£o informada'}</p>
            <p><strong>Vendedor:</strong> ${proposta.vendedor}</p>
          </div>
        </div>

        <div class="space-y-4">
          <h4 class="text-xl font-bold text-gray-800">üì¶ Produtos</h4>
      `;

      proposta.produtos.forEach((produto, index) => {
        const precoNormal = parseFloat(produto.preco_normal) || 0;
        const precoPromocional = parseFloat(produto.preco_promocional) || 0;
        const valorAvista = precoPromocional > 0 ? precoPromocional : precoNormal;
        
        let economia = 0;
        let desconto = 0;
        if (precoNormal > 0 && precoPromocional > 0 && precoPromocional < precoNormal) {
          economia = precoNormal - precoPromocional;
          desconto = (economia / precoNormal) * 100;
        }
        
        let valorParcela = 0;
        if (valorAvista > 0) {
          if (produto.modalidade === 'avista') {
            valorParcela = valorAvista;
          } else {
            const taxas = produto.modalidade === 'carne' ? TAXAS_CARNE : TAXAS_CARTAO;
            const taxa = taxas[produto.num_parcelas - 1];
            valorParcela = valorAvista * taxa;
          }
        }
        
        html += `
          <div class="bg-white border-2 border-green-300 rounded-xl p-5">
            <h5 class="text-lg font-bold text-gray-800 mb-3">Produto ${index + 1}: ${produto.nome}</h5>
            
            ${desconto > 0 ? `
            <div class="bg-orange-50 border border-orange-300 rounded-lg p-3 mb-3">
              <p class="text-sm text-orange-800"><strong>üè∑Ô∏è Desconto:</strong> ${desconto.toFixed(1)}% | <strong>Economia:</strong> R$ ${economia.toFixed(2)}</p>
            </div>
            ` : ''}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="bg-green-50 p-3 rounded-lg">
                <p class="text-sm text-gray-600">Valor √† Vista</p>
                <p class="text-2xl font-bold text-green-600">R$ ${valorAvista.toFixed(2)}</p>
              </div>
              <div class="bg-blue-50 p-3 rounded-lg">
                <p class="text-sm text-gray-600">Parcelado</p>
                <p class="text-2xl font-bold text-blue-600">${produto.num_parcelas}x de R$ ${valorParcela.toFixed(2)}</p>
                <p class="text-xs text-gray-500">${produto.modalidade === 'carne' ? 'üé´ Carn√™' : produto.modalidade === 'cartao' ? 'üí≥ Cart√£o' : 'üíµ √Ä Vista'}</p>
              </div>
            </div>
          </div>
        `;
      });

      html += `</div>`;
      return html;
    }

    function gerarVisaoDiretoria(proposta) {
      let totalVista = 0;
      let totalParcelado = 0;

      proposta.produtos.forEach(produto => {
        const precoNormal = parseFloat(produto.preco_normal) || 0;
        const precoPromocional = parseFloat(produto.preco_promocional) || 0;
        const valorAvista = precoPromocional > 0 ? precoPromocional : precoNormal;
        
        let valorParcela = 0;
        if (valorAvista > 0) {
          if (produto.modalidade === 'avista') {
            valorParcela = valorAvista;
          } else {
            const taxas = produto.modalidade === 'carne' ? TAXAS_CARNE : TAXAS_CARTAO;
            const taxa = taxas[produto.num_parcelas - 1];
            valorParcela = valorAvista * taxa;
          }
        }
        
        totalVista += valorAvista;
        totalParcelado += valorParcela * produto.num_parcelas;
      });

      let html = `
        <div class="bg-gradient-to-r from-gray-700 to-gray-900 text-white p-6 rounded-xl">
          <h3 class="text-2xl font-bold mb-2">üìä An√°lise Gerencial</h3>
          <p class="text-gray-300">Vis√£o completa para tomada de decis√£o</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-green-50 border-2 border-green-300 rounded-xl p-5 text-center">
            <p class="text-sm text-gray-600 mb-2">üí∞ Total √† Vista</p>
            <p class="text-3xl font-bold text-green-600">R$ ${totalVista.toFixed(2)}</p>
          </div>
          
          <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-5 text-center">
            <p class="text-sm text-gray-600 mb-2">üìä Total Parcelado</p>
            <p class="text-3xl font-bold text-blue-600">R$ ${totalParcelado.toFixed(2)}</p>
          </div>
          
          <div class="bg-purple-50 border-2 border-purple-300 rounded-xl p-5 text-center">
            <p class="text-sm text-gray-600 mb-2">üìà Margem</p>
            <p class="text-3xl font-bold text-purple-600">R$ ${(totalParcelado - totalVista).toFixed(2)}</p>
          </div>
        </div>

        <div class="bg-gray-50 border-2 border-gray-300 rounded-xl p-6">
          <h4 class="text-lg font-bold text-gray-800 mb-4">üìã Detalhamento por Produto</h4>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-700 text-white">
                <tr>
                  <th class="px-4 py-3 text-left">Produto</th>
                  <th class="px-4 py-3 text-center">√Ä Vista</th>
                  <th class="px-4 py-3 text-center">Parcelas</th>
                  <th class="px-4 py-3 text-center">Valor Parcela</th>
                  <th class="px-4 py-3 text-center">Total</th>
                  <th class="px-4 py-3 text-center">Margem</th>
                </tr>
              </thead>
              <tbody class="bg-white">
      `;

      proposta.produtos.forEach(produto => {
        const precoNormal = parseFloat(produto.preco_normal) || 0;
        const precoPromocional = parseFloat(produto.preco_promocional) || 0;
        const valorAvista = precoPromocional > 0 ? precoPromocional : precoNormal;
        
        let valorParcela = 0;
        if (valorAvista > 0) {
          if (produto.modalidade === 'avista') {
            valorParcela = valorAvista;
          } else {
            const taxas = produto.modalidade === 'carne' ? TAXAS_CARNE : TAXAS_CARTAO;
            const taxa = taxas[produto.num_parcelas - 1];
            valorParcela = valorAvista * taxa;
          }
        }
        
        const totalProd = valorParcela * produto.num_parcelas;
        const margem = totalProd - valorAvista;
        
        html += `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3">${produto.nome}</td>
            <td class="px-4 py-3 text-center">R$ ${valorAvista.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">${produto.num_parcelas}x</td>
            <td class="px-4 py-3 text-center">R$ ${valorParcela.toFixed(2)}</td>
            <td class="px-4 py-3 text-center font-bold">R$ ${totalProd.toFixed(2)}</td>
            <td class="px-4 py-3 text-center font-bold text-green-600">R$ ${margem.toFixed(2)}</td>
          </tr>
        `;
      });

      html += `
              </tbody>
            </table>
          </div>
        </div>

        <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-6">
          <h4 class="text-lg font-bold text-blue-800 mb-3">üë§ Dados do Cliente</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <p><strong>Nome:</strong> ${proposta.cliente_nome}</p>
            <p><strong>Contato:</strong> ${proposta.cliente_contato}</p>
            <p><strong>Vendedor:</strong> ${proposta.vendedor}</p>
            <p><strong>Data:</strong> ${proposta.data || 'N√£o informada'}</p>
          </div>
        </div>
      `;

      return html;
    }

    function imprimirProposta() {
      window.print();
    }

    function enviarWhatsApp(id) {
      const proposta = allProposals.find(p => p.__backendId === id);
      if (!proposta) return;

      let mensagem = `*${proposta.titulo}*\n\n`;
      mensagem += `Ol√° *${proposta.cliente_nome}*! üëã\n\n`;
      mensagem += `Segue sua proposta comercial:\n\n`;
      
      proposta.produtos.forEach((produto, index) => {
        const precoNormal = parseFloat(produto.preco_normal) || 0;
        const precoPromocional = parseFloat(produto.preco_promocional) || 0;
        const valorAvista = precoPromocional > 0 ? precoPromocional : precoNormal;
        
        let valorParcela = 0;
        if (valorAvista > 0) {
          if (produto.modalidade === 'avista') {
            valorParcela = valorAvista;
          } else {
            const taxas = produto.modalidade === 'carne' ? TAXAS_CARNE : TAXAS_CARTAO;
            const taxa = taxas[produto.num_parcelas - 1];
            valorParcela = valorAvista * taxa;
          }
        }
        
        mensagem += `*Produto ${index + 1}: ${produto.nome}*\n`;
        mensagem += `üí∞ √Ä Vista: R$ ${valorAvista.toFixed(2)}\n`;
        mensagem += `üí≥ Parcelado: ${produto.num_parcelas}x de R$ ${valorParcela.toFixed(2)}\n`;
        mensagem += `\n`;
      });

      mensagem += `üìÖ Validade: ${proposta.validade || 'Consultar'}\n`;
      mensagem += `üë§ Vendedor: ${proposta.vendedor}\n\n`;
      mensagem += `Qualquer d√∫vida, estou √† disposi√ß√£o! üòä`;

      const telefone = proposta.cliente_contato.replace(/\D/g, '');
      const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
      
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    function editarProposta(id) {
      const proposta = allProposals.find(p => p.__backendId === id);
      if (!proposta) return;
      
      mostrarFormularioProposta(proposta);
    }

    function confirmarExclusao(id) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
          <div class="bg-gradient-to-r from-red-600 to-rose-600 text-white p-6 rounded-t-2xl text-center">
            <div class="text-5xl mb-3">üóëÔ∏è</div>
            <h2 class="text-2xl font-bold">Excluir Proposta</h2>
          </div>
          
          <div class="p-6">
            <p class="text-gray-700 mb-4 text-center">
              Tem certeza que deseja excluir esta proposta?
            </p>
            <p class="text-sm text-red-600 mb-6 text-center font-semibold">
              ‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!
            </p>
            
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 transition-all">
                Cancelar
              </button>
              <button onclick="excluirProposta('${id}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all">
                Excluir
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function excluirProposta(id) {
      const proposta = allProposals.find(p => p.__backendId === id);
      if (!proposta) return;

      const result = await window.dataSdk.delete(proposta);
      
      document.querySelectorAll('.fixed').forEach(el => el.remove());
      
      if (result.isOk) {
        showToast('‚úÖ Proposta exclu√≠da com sucesso!', 'success');
      } else {
        showToast('‚ùå Erro ao excluir proposta', 'error');
      }
    }

    // ========== FILTROS ==========
    function filtrarPorData(tipo) {
      const statusFiltro = document.getElementById('statusFiltro');
      statusFiltro.classList.remove('hidden');
      statusFiltro.innerHTML = '<span class="font-semibold">Pesquisando...</span>';

      setTimeout(() => {
        if (tipo === 'hoje') {
          const hoje = new Date().toLocaleDateString('pt-BR');
          const propostasFiltradas = allProposals.filter(p => {
            if (!p.data) return false;
            return p.data === hoje;
          });
          
          renderListaPropostas(propostasFiltradas);
          statusFiltro.innerHTML = `<span class="font-semibold text-blue-600">üìÖ Mostrando propostas de hoje (${propostasFiltradas.length})</span>`;
        } else {
          renderListaPropostas(allProposals);
          statusFiltro.innerHTML = `<span class="font-semibold text-gray-600">üîÑ Mostrando todas as propostas (${allProposals.length})</span>`;
        }
      }, 300);
    }

    // Event listener para filtro por data espec√≠fica
    document.addEventListener('DOMContentLoaded', () => {
      const filtroDataInput = document.getElementById('filtroData');
      if (filtroDataInput) {
        filtroDataInput.addEventListener('change', (e) => {
          const dataSelecionada = e.target.value;
          if (!dataSelecionada) {
            renderListaPropostas(allProposals);
            return;
          }

          const statusFiltro = document.getElementById('statusFiltro');
          statusFiltro.classList.remove('hidden');
          statusFiltro.innerHTML = '<span class="font-semibold">Pesquisando...</span>';

          setTimeout(() => {
            const dataFormatada = new Date(dataSelecionada + 'T00:00:00').toLocaleDateString('pt-BR');
            const propostasFiltradas = allProposals.filter(p => {
              if (!p.data) return false;
              return p.data === dataFormatada;
            });
            
            renderListaPropostas(propostasFiltradas);
            statusFiltro.innerHTML = `<span class="font-semibold text-blue-600">üìÖ Mostrando propostas de ${dataFormatada} (${propostasFiltradas.length})</span>`;
          }, 300);
        });
      }
    });

    // Inicializa o app quando o DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a3b144831fff61f',t:'MTc2NDAxMDA5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
